var Nr=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);import"./modulepreload-polyfill-B5Qt9EMX.js";import{i as Br}from"./initMap-C2oZVlU5.js";import{l as Tr,p as Pr}from"./dataParser-CB48iPA-.js";var ci=Nr((Q,J)=>{var ar=typeof global=="object"&&global&&global.Object===Object&&global,zr=typeof self=="object"&&self&&self.Object===Object&&self,K=ar||zr||Function("return this")(),Y=K.Symbol,lr=Object.prototype,Rr=lr.hasOwnProperty,qr=lr.toString,be=Y?Y.toStringTag:void 0,Dr=Object.prototype.toString,Hr="[object Null]",Wr="[object Undefined]",wt=Y?Y.toStringTag:void 0;function ye(r){return r==null?r===void 0?Wr:Hr:wt&&wt in Object(r)?function(e){var t=Rr.call(e,be),n=e[be];try{e[be]=void 0;var s=!0}catch{}var i=qr.call(e);return s&&(t?e[be]=n:delete e[be]),i}(r):function(e){return Dr.call(e)}(r)}function re(r){return r!=null&&typeof r=="object"}var Ur="[object Symbol]";function ge(r){return typeof r=="symbol"||re(r)&&ye(r)==Ur}function fe(r,e){for(var t=-1,n=r==null?0:r.length,s=Array(n);++t<n;)s[t]=e(r[t],t,r);return s}var U=Array.isArray,Vr=1/0,bt=Y?Y.prototype:void 0,xt=bt?bt.toString:void 0;function cr(r){if(typeof r=="string")return r;if(U(r))return fe(r,cr)+"";if(ge(r))return xt?xt.call(r):"";var e=r+"";return e=="0"&&1/r==-Vr?"-0":e}function oe(r){var e=typeof r;return r!=null&&(e=="object"||e=="function")}function Re(r){return r}var Gr="[object AsyncFunction]",Zr="[object Function]",Qr="[object GeneratorFunction]",Jr="[object Proxy]";function dr(r){if(!oe(r))return!1;var e=ye(r);return e==Zr||e==Qr||e==Gr||e==Jr}var _t,We=K["__core-js_shared__"],kt=(_t=/[^.]+$/.exec(We&&We.keys&&We.keys.IE_PROTO||""))?"Symbol(src)_1."+_t:"",Yr=Function.prototype.toString;function ae(r){if(r!=null){try{return Yr.call(r)}catch{}try{return r+""}catch{}}return""}var Xr=/^\[object .+?Constructor\]$/,Kr=RegExp("^"+Function.prototype.toString.call(Object.prototype.hasOwnProperty).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function le(r,e){var t=function(n,s){return n==null?void 0:n[s]}(r,e);return function(n){return!(!oe(n)||(s=n,kt&&kt in s))&&(dr(n)?Kr:Xr).test(ae(n));var s}(t)?t:void 0}var Ct,Ue,Ve,Xe=le(K,"WeakMap"),St=Object.create,en=function(){function r(){}return function(e){if(!oe(e))return{};if(St)return St(e);r.prototype=e;var t=new r;return r.prototype=void 0,t}}(),tn=Date.now,rn=function(){try{var r=le(Object,"defineProperty");return r({},"",{}),r}catch{}}(),Te=rn,nn=Te?function(r,e){return Te(r,"toString",{configurable:!0,enumerable:!1,value:(t=e,function(){return t}),writable:!0});var t}:Re,sn=(Ct=nn,Ue=0,Ve=0,function(){var r=tn(),e=16-(r-Ve);if(Ve=r,e>0){if(++Ue>=800)return arguments[0]}else Ue=0;return Ct.apply(void 0,arguments)});function on(r){return r!=r}function an(r,e){return!(r==null||!r.length)&&function(t,n,s){return n==n?function(i,o,l){for(var a=-1,d=i.length;++a<d;)if(i[a]===o)return a;return-1}(t,n):function(i,o,l,a){for(var d=i.length,u=-1;++u<d;)if(o(i[u],u,i))return u;return-1}(t,on)}(r,e)>-1}var ln=9007199254740991,cn=/^(?:0|[1-9]\d*)$/;function lt(r,e){var t=typeof r;return!!(e=e??ln)&&(t=="number"||t!="symbol"&&cn.test(r))&&r>-1&&r%1==0&&r<e}function ct(r,e,t){e=="__proto__"&&Te?Te(r,e,{configurable:!0,enumerable:!0,value:t,writable:!0}):r[e]=t}function qe(r,e){return r===e||r!=r&&e!=e}var dn=Object.prototype.hasOwnProperty;function ur(r,e,t){var n=r[e];dn.call(r,e)&&qe(n,t)&&(t!==void 0||e in r)||ct(r,e,t)}function Le(r,e,t,n){var s=!t;t||(t={});for(var i=-1,o=e.length;++i<o;){var l=e[i],a=void 0;a===void 0&&(a=r[l]),s?ct(t,l,a):ur(t,l,a)}return t}var Et=Math.max;function hr(r,e){return sn(function(t,n,s){return n=Et(n===void 0?t.length-1:n,0),function(){for(var i=arguments,o=-1,l=Et(i.length-n,0),a=Array(l);++o<l;)a[o]=i[n+o];o=-1;for(var d=Array(n+1);++o<n;)d[o]=i[o];return d[n]=s(a),function(u,g,p){switch(p.length){case 0:return u.call(g);case 1:return u.call(g,p[0]);case 2:return u.call(g,p[0],p[1]);case 3:return u.call(g,p[0],p[1],p[2])}return u.apply(g,p)}(t,this,d)}}(r,e,Re),r+"")}var un=9007199254740991;function dt(r){return typeof r=="number"&&r>-1&&r%1==0&&r<=un}function ve(r){return r!=null&&dt(r.length)&&!dr(r)}function Mt(r,e,t){if(!oe(t))return!1;var n=typeof e;return!!(n=="number"?ve(t)&&lt(e,t.length):n=="string"&&e in t)&&qe(t[e],r)}var hn=Object.prototype;function ut(r){var e=r&&r.constructor;return r===(typeof e=="function"&&e.prototype||hn)}function jt(r){return re(r)&&ye(r)=="[object Arguments]"}var pr=Object.prototype,pn=pr.hasOwnProperty,fn=pr.propertyIsEnumerable,ht=jt(function(){return arguments}())?jt:function(r){return re(r)&&pn.call(r,"callee")&&!fn.call(r,"callee")},fr=typeof Q=="object"&&Q&&!Q.nodeType&&Q,At=fr&&typeof J=="object"&&J&&!J.nodeType&&J,Lt=At&&At.exports===fr?K.Buffer:void 0,Pe=(Lt?Lt.isBuffer:void 0)||function(){return!1},B={};function De(r){return function(e){return r(e)}}B["[object Float32Array]"]=B["[object Float64Array]"]=B["[object Int8Array]"]=B["[object Int16Array]"]=B["[object Int32Array]"]=B["[object Uint8Array]"]=B["[object Uint8ClampedArray]"]=B["[object Uint16Array]"]=B["[object Uint32Array]"]=!0,B["[object Arguments]"]=B["[object Array]"]=B["[object ArrayBuffer]"]=B["[object Boolean]"]=B["[object DataView]"]=B["[object Date]"]=B["[object Error]"]=B["[object Function]"]=B["[object Map]"]=B["[object Number]"]=B["[object Object]"]=B["[object RegExp]"]=B["[object Set]"]=B["[object String]"]=B["[object WeakMap]"]=!1;var gr=typeof Q=="object"&&Q&&!Q.nodeType&&Q,_e=gr&&typeof J=="object"&&J&&!J.nodeType&&J,Ge=_e&&_e.exports===gr&&ar.process,me=function(){try{return _e&&_e.require&&_e.require("util").types||Ge&&Ge.binding&&Ge.binding("util")}catch{}}(),Ft=me&&me.isTypedArray,mr=Ft?De(Ft):function(r){return re(r)&&dt(r.length)&&!!B[ye(r)]},gn=Object.prototype.hasOwnProperty;function yr(r,e){var t=U(r),n=!t&&ht(r),s=!t&&!n&&Pe(r),i=!t&&!n&&!s&&mr(r),o=t||n||s||i,l=o?function(u,g){for(var p=-1,y=Array(u);++p<u;)y[p]=g(p);return y}(r.length,String):[],a=l.length;for(var d in r)!e&&!gn.call(r,d)||o&&(d=="length"||s&&(d=="offset"||d=="parent")||i&&(d=="buffer"||d=="byteLength"||d=="byteOffset")||lt(d,a))||l.push(d);return l}function vr(r,e){return function(t){return r(e(t))}}var mn=vr(Object.keys,Object),yn=Object.prototype.hasOwnProperty;function Ee(r){return ve(r)?yr(r):function(e){if(!ut(e))return mn(e);var t=[];for(var n in Object(e))yn.call(e,n)&&n!="constructor"&&t.push(n);return t}(r)}var vn=Object.prototype.hasOwnProperty;function wn(r){return ve(r)?yr(r,!0):function(e){if(!oe(e))return function(i){var o=[];if(i!=null)for(var l in Object(i))o.push(l);return o}(e);var t=ut(e),n=[];for(var s in e)(s!="constructor"||!t&&vn.call(e,s))&&n.push(s);return n}(r)}var bn=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,xn=/^\w*$/;function Ke(r,e){if(U(r))return!1;var t=typeof r;return!(t!="number"&&t!="symbol"&&t!="boolean"&&r!=null&&!ge(r))||xn.test(r)||!bn.test(r)||e!=null&&r in Object(e)}var xe=le(Object,"create"),_n=Object.prototype.hasOwnProperty,kn=Object.prototype.hasOwnProperty;function ie(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var n=r[e];this.set(n[0],n[1])}}function Fe(r,e){for(var t=r.length;t--;)if(qe(r[t][0],e))return t;return-1}ie.prototype.clear=function(){this.__data__=xe?xe(null):{},this.size=0},ie.prototype.delete=function(r){var e=this.has(r)&&delete this.__data__[r];return this.size-=e?1:0,e},ie.prototype.get=function(r){var e=this.__data__;if(xe){var t=e[r];return t==="__lodash_hash_undefined__"?void 0:t}return _n.call(e,r)?e[r]:void 0},ie.prototype.has=function(r){var e=this.__data__;return xe?e[r]!==void 0:kn.call(e,r)},ie.prototype.set=function(r,e){var t=this.__data__;return this.size+=this.has(r)?0:1,t[r]=xe&&e===void 0?"__lodash_hash_undefined__":e,this};var Cn=Array.prototype.splice;function te(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var n=r[e];this.set(n[0],n[1])}}te.prototype.clear=function(){this.__data__=[],this.size=0},te.prototype.delete=function(r){var e=this.__data__,t=Fe(e,r);return!(t<0||(t==e.length-1?e.pop():Cn.call(e,t,1),--this.size,0))},te.prototype.get=function(r){var e=this.__data__,t=Fe(e,r);return t<0?void 0:e[t][1]},te.prototype.has=function(r){return Fe(this.__data__,r)>-1},te.prototype.set=function(r,e){var t=this.__data__,n=Fe(t,r);return n<0?(++this.size,t.push([r,e])):t[n][1]=e,this};var Ce=le(K,"Map");function Ie(r,e){var t,n,s=r.__data__;return((n=typeof(t=e))=="string"||n=="number"||n=="symbol"||n=="boolean"?t!=="__proto__":t===null)?s[typeof e=="string"?"string":"hash"]:s.map}function ee(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var n=r[e];this.set(n[0],n[1])}}function pt(r,e){if(typeof r!="function"||e!=null&&typeof e!="function")throw new TypeError("Expected a function");var t=function(){var n=arguments,s=e?e.apply(this,n):n[0],i=t.cache;if(i.has(s))return i.get(s);var o=r.apply(this,n);return t.cache=i.set(s,o)||i,o};return t.cache=new(pt.Cache||ee),t}ee.prototype.clear=function(){this.size=0,this.__data__={hash:new ie,map:new(Ce||te),string:new ie}},ee.prototype.delete=function(r){var e=Ie(this,r).delete(r);return this.size-=e?1:0,e},ee.prototype.get=function(r){return Ie(this,r).get(r)},ee.prototype.has=function(r){return Ie(this,r).has(r)},ee.prototype.set=function(r,e){var t=Ie(this,r),n=t.size;return t.set(r,e),this.size+=t.size==n?0:1,this},pt.Cache=ee;var Ze,Qe,Sn=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,En=/\\(\\)?/g,Mn=(Ze=pt(function(r){var e=[];return r.charCodeAt(0)===46&&e.push(""),r.replace(Sn,function(t,n,s,i){e.push(s?i.replace(En,"$1"):n||t)}),e},function(r){return Qe.size===500&&Qe.clear(),r}),Qe=Ze.cache,Ze);function wr(r,e){return U(r)?r:Ke(r,e)?[r]:Mn(function(t){return t==null?"":cr(t)}(r))}var jn=1/0;function Ne(r){if(typeof r=="string"||ge(r))return r;var e=r+"";return e=="0"&&1/r==-jn?"-0":e}function et(r,e){for(var t=0,n=(e=wr(e,r)).length;r!=null&&t<n;)r=r[Ne(e[t++])];return t&&t==n?r:void 0}function ft(r,e){for(var t=-1,n=e.length,s=r.length;++t<n;)r[s+t]=e[t];return r}var It=Y?Y.isConcatSpreadable:void 0;function An(r){return U(r)||ht(r)||!!(It&&r&&r[It])}function Ln(r,e,t,n,s){var i=-1,o=r.length;for(t||(t=An),s||(s=[]);++i<o;){var l=r[i];t(l)?ft(s,l):s[s.length]=l}return s}var br=vr(Object.getPrototypeOf,Object);function X(r){var e=this.__data__=new te(r);this.size=e.size}X.prototype.clear=function(){this.__data__=new te,this.size=0},X.prototype.delete=function(r){var e=this.__data__,t=e.delete(r);return this.size=e.size,t},X.prototype.get=function(r){return this.__data__.get(r)},X.prototype.has=function(r){return this.__data__.has(r)},X.prototype.set=function(r,e){var t=this.__data__;if(t instanceof te){var n=t.__data__;if(!Ce||n.length<199)return n.push([r,e]),this.size=++t.size,this;t=this.__data__=new ee(n)}return t.set(r,e),this.size=t.size,this};var xr=typeof Q=="object"&&Q&&!Q.nodeType&&Q,$t=xr&&typeof J=="object"&&J&&!J.nodeType&&J,Ot=$t&&$t.exports===xr?K.Buffer:void 0,Nt=Ot?Ot.allocUnsafe:void 0;function _r(){return[]}var Fn=Object.prototype.propertyIsEnumerable,Bt=Object.getOwnPropertySymbols,In=Bt?function(r){return r==null?[]:(r=Object(r),function(e,t){for(var n=-1,s=e==null?0:e.length,i=0,o=[];++n<s;){var l=e[n];Fn.call(r,l)&&(o[i++]=l)}return o}(Bt(r)))}:_r,gt=In,$n=Object.getOwnPropertySymbols?function(r){for(var e=[];r;)ft(e,gt(r)),r=br(r);return e}:_r;function On(r,e,t){var n=e(r);return U(r)?n:ft(n,t(r))}function tt(r){return On(r,Ee,gt)}var rt=le(K,"DataView"),nt=le(K,"Promise"),st=le(K,"Set"),Tt="[object Map]",Pt="[object Promise]",zt="[object Set]",Rt="[object WeakMap]",qt="[object DataView]",Nn=ae(rt),Bn=ae(Ce),Tn=ae(nt),Pn=ae(st),zn=ae(Xe),se=ye;(rt&&se(new rt(new ArrayBuffer(1)))!=qt||Ce&&se(new Ce)!=Tt||nt&&se(nt.resolve())!=Pt||st&&se(new st)!=zt||Xe&&se(new Xe)!=Rt)&&(se=function(r){var e=ye(r),t=e=="[object Object]"?r.constructor:void 0,n=t?ae(t):"";if(n)switch(n){case Nn:return qt;case Bn:return Tt;case Tn:return Pt;case Pn:return zt;case zn:return Rt}return e});var Se=se,Rn=Object.prototype.hasOwnProperty,ze=K.Uint8Array;function qn(r){var e=new r.constructor(r.byteLength);return new ze(e).set(new ze(r)),e}var Dn=/\w*$/,Dt=Y?Y.prototype:void 0,Ht=Dt?Dt.valueOf:void 0,Hn="[object Boolean]",Wn="[object Date]",Un="[object Map]",Vn="[object Number]",Gn="[object RegExp]",Zn="[object Set]",Qn="[object String]",Jn="[object Symbol]",Yn="[object ArrayBuffer]",Xn="[object DataView]",Kn="[object Float32Array]",es="[object Float64Array]",ts="[object Int8Array]",rs="[object Int16Array]",ns="[object Int32Array]",ss="[object Uint8Array]",is="[object Uint8ClampedArray]",os="[object Uint16Array]",as="[object Uint32Array]",Wt=me&&me.isMap,ls=Wt?De(Wt):function(r){return re(r)&&Se(r)=="[object Map]"},Ut=me&&me.isSet,cs=Ut?De(Ut):function(r){return re(r)&&Se(r)=="[object Set]"},ds=1,us=2,kr="[object Arguments]",Cr="[object Function]",hs="[object GeneratorFunction]",Sr="[object Object]",N={};function Be(r,e,t,n,s,i){var o,l=e&ds,a=e&us;if(o!==void 0)return o;if(!oe(r))return r;var d=U(r);if(d){if(o=function(f){var v=f.length,x=new f.constructor(v);return v&&typeof f[0]=="string"&&Rn.call(f,"index")&&(x.index=f.index,x.input=f.input),x}(r),!l)return function(f,v){var x=-1,k=f.length;for(v||(v=Array(k));++x<k;)v[x]=f[x];return v}(r,o)}else{var u=Se(r),g=u==Cr||u==hs;if(Pe(r))return function(f,v){var x=f.length,k=Nt?Nt(x):new f.constructor(x);return f.copy(k),k}(r);if(u==Sr||u==kr||g&&!s){if(o=g?{}:function(f){return typeof f.constructor!="function"||ut(f)?{}:en(br(f))}(r),!l)return a?function(f,v){return Le(f,$n(f),v)}(r,function(f,v){return f&&Le(v,wn(v),f)}(o,r)):function(f,v){return Le(f,gt(f),v)}(r,function(f,v){return f&&Le(v,Ee(v),f)}(o,r))}else{if(!N[u])return s?r:{};o=function(f,v,x){var k,I,P=f.constructor;switch(v){case Yn:return qn(f);case Hn:case Wn:return new P(+f);case Xn:return function(M,z){var S=M.buffer;return new M.constructor(S,M.byteOffset,M.byteLength)}(f);case Kn:case es:case ts:case rs:case ns:case ss:case is:case os:case as:return function(M,z){var S=M.buffer;return new M.constructor(S,M.byteOffset,M.length)}(f);case Un:return new P;case Vn:case Qn:return new P(f);case Gn:return(I=new(k=f).constructor(k.source,Dn.exec(k))).lastIndex=k.lastIndex,I;case Zn:return new P;case Jn:return Ht?Object(Ht.call(f)):{}}}(r,u)}}i||(i=new X);var p=i.get(r);if(p)return p;i.set(r,o),cs(r)?r.forEach(function(f){o.add(Be(f,e,t,f,r,i))}):ls(r)&&r.forEach(function(f,v){o.set(v,Be(f,e,t,v,r,i))});var y=d?void 0:tt(r);return function(f,v){for(var x=-1,k=f==null?0:f.length;++x<k&&v(f[x],x)!==!1;);}(y||r,function(f,v){y&&(f=r[v=f]),ur(o,v,Be(f,e,t,v,r,i))}),o}function Je(r){return Be(r,4)}function ke(r){var e=-1,t=r==null?0:r.length;for(this.__data__=new ee;++e<t;)this.add(r[e])}function ps(r,e){for(var t=-1,n=r==null?0:r.length;++t<n;)if(e(r[t],t,r))return!0;return!1}function it(r,e){return r.has(e)}N[kr]=N["[object Array]"]=N["[object ArrayBuffer]"]=N["[object DataView]"]=N["[object Boolean]"]=N["[object Date]"]=N["[object Float32Array]"]=N["[object Float64Array]"]=N["[object Int8Array]"]=N["[object Int16Array]"]=N["[object Int32Array]"]=N["[object Map]"]=N["[object Number]"]=N[Sr]=N["[object RegExp]"]=N["[object Set]"]=N["[object String]"]=N["[object Symbol]"]=N["[object Uint8Array]"]=N["[object Uint8ClampedArray]"]=N["[object Uint16Array]"]=N["[object Uint32Array]"]=!0,N["[object Error]"]=N[Cr]=N["[object WeakMap]"]=!1,ke.prototype.add=ke.prototype.push=function(r){return this.__data__.set(r,"__lodash_hash_undefined__"),this},ke.prototype.has=function(r){return this.__data__.has(r)};var fs=1,gs=2;function Vt(r,e,t,n,s,i){var o=t&fs,l=r.length,a=e.length;if(l!=a&&!(o&&a>l))return!1;var d=i.get(r),u=i.get(e);if(d&&u)return d==e&&u==r;var g=-1,p=!0,y=t&gs?new ke:void 0;for(i.set(r,e),i.set(e,r);++g<l;){var f=r[g],v=e[g];if(n)var x=o?n(v,f,g,e,r,i):n(f,v,g,r,e,i);if(x!==void 0){if(x)continue;p=!1;break}if(y){if(!ps(e,function(k,I){if(!it(y,I)&&(f===k||s(f,k,t,n,i)))return y.push(I)})){p=!1;break}}else if(f!==v&&!s(f,v,t,n,i)){p=!1;break}}return i.delete(r),i.delete(e),p}function ms(r){var e=-1,t=Array(r.size);return r.forEach(function(n,s){t[++e]=[s,n]}),t}function ys(r){var e=-1,t=Array(r.size);return r.forEach(function(n){t[++e]=n}),t}var vs=1,ws=2,bs="[object Boolean]",xs="[object Date]",_s="[object Error]",ks="[object Map]",Cs="[object Number]",Ss="[object RegExp]",Es="[object Set]",Ms="[object String]",js="[object Symbol]",As="[object ArrayBuffer]",Ls="[object DataView]",Gt=Y?Y.prototype:void 0,Ye=Gt?Gt.valueOf:void 0,Fs=1,Is=Object.prototype.hasOwnProperty,$s=1,Zt="[object Arguments]",Qt="[object Array]",$e="[object Object]",Jt=Object.prototype.hasOwnProperty;function ot(r,e,t,n,s){return r===e||(r==null||e==null||!re(r)&&!re(e)?r!=r&&e!=e:function(i,o,l,a,d,u){var g=U(i),p=U(o),y=g?Qt:Se(i),f=p?Qt:Se(o),v=(y=y==Zt?$e:y)==$e,x=(f=f==Zt?$e:f)==$e,k=y==f;if(k&&Pe(i)){if(!Pe(o))return!1;g=!0,v=!1}if(k&&!v)return u||(u=new X),g||mr(i)?Vt(i,o,l,a,d,u):function(S,E,q,Z,W,D,V){switch(q){case Ls:if(S.byteLength!=E.byteLength||S.byteOffset!=E.byteOffset)return!1;S=S.buffer,E=E.buffer;case As:return!(S.byteLength!=E.byteLength||!D(new ze(S),new ze(E)));case bs:case xs:case Cs:return qe(+S,+E);case _s:return S.name==E.name&&S.message==E.message;case Ss:case Ms:return S==E+"";case ks:var F=ms;case Es:if(F||(F=ys),S.size!=E.size&&!(Z&vs))return!1;var T=V.get(S);if(T)return T==E;Z|=ws,V.set(S,E);var R=Vt(F(S),F(E),Z,W,D,V);return V.delete(S),R;case js:if(Ye)return Ye.call(S)==Ye.call(E)}return!1}(i,o,y,l,a,d,u);if(!(l&$s)){var I=v&&Jt.call(i,"__wrapped__"),P=x&&Jt.call(o,"__wrapped__");if(I||P){var M=I?i.value():i,z=P?o.value():o;return u||(u=new X),d(M,z,l,a,u)}}return!!k&&(u||(u=new X),function(S,E,q,Z,W,D){var V=q&Fs,F=tt(S),T=F.length;if(T!=tt(E).length&&!V)return!1;for(var R=T;R--;){var m=F[R];if(!(V?m in E:Is.call(E,m)))return!1}var c=D.get(S),h=D.get(E);if(c&&h)return c==E&&h==S;var w=!0;D.set(S,E),D.set(E,S);for(var b=V;++R<T;){var _=S[m=F[R]],C=E[m];if(Z)var $=V?Z(C,_,m,E,S,D):Z(_,C,m,S,E,D);if(!($===void 0?_===C||W(_,C,q,Z,D):$)){w=!1;break}b||(b=m=="constructor")}if(w&&!b){var H=S.constructor,O=E.constructor;H==O||!("constructor"in S)||!("constructor"in E)||typeof H=="function"&&H instanceof H&&typeof O=="function"&&O instanceof O||(w=!1)}return D.delete(S),D.delete(E),w}(i,o,l,a,d,u))}(r,e,t,n,ot,s))}var Os=1,Ns=2;function Yt(r){return r==r&&!oe(r)}function Xt(r,e){return function(t){return t!=null&&t[r]===e&&(e!==void 0||r in Object(t))}}function Bs(r,e){return r!=null&&e in Object(r)}var Ts=1,Ps=2;function ce(r){return typeof r=="function"?r:r==null?Re:typeof r=="object"?U(r)?function(i,o){return Ke(i)&&Yt(o)?Xt(Ne(i),o):function(l){var a=function(d,u,g){var p=d==null?void 0:et(d,u);return p===void 0?void 0:p}(l,i);return a===void 0&&a===o?function(d,u){return d!=null&&function(g,p,y){for(var f=-1,v=(p=wr(p,g)).length,x=!1;++f<v;){var k=Ne(p[f]);if(!(x=g!=null&&y(g,k)))break;g=g[k]}return x||++f!=v?x:!!(v=g==null?0:g.length)&&dt(v)&&lt(k,v)&&(U(g)||ht(g))}(d,u,Bs)}(l,i):ot(o,a,Ts|Ps)}}(r[0],r[1]):(s=function(i){for(var o=Ee(i),l=o.length;l--;){var a=o[l],d=i[a];o[l]=[a,d,Yt(d)]}return o}(n=r),s.length==1&&s[0][2]?Xt(s[0][0],s[0][1]):function(i){return i===n||function(o,l,a,d){var u=a.length,g=u;if(o==null)return!g;for(o=Object(o);u--;){var p=a[u];if(p[2]?p[1]!==o[p[0]]:!(p[0]in o))return!1}for(;++u<g;){var y=(p=a[u])[0],f=o[y],v=p[1];if(p[2]){if(f===void 0&&!(y in o))return!1}else{var x=new X;if(!ot(v,f,Os|Ns,void 0,x))return!1}}return!0}(i,0,s)}):Ke(e=r)?(t=Ne(e),function(i){return i==null?void 0:i[t]}):function(i){return function(o){return et(o,i)}}(e);var e,t,n,s}var zs=function(r,e,t){for(var n=-1,s=Object(r),i=t(r),o=i.length;o--;){var l=i[++n];if(e(s[l],l,s)===!1)break}return r};function Er(r,e){return r&&zs(r,e,Ee)}var Kt,Rs=(Kt=Er,function(r,e){if(r==null)return r;if(!ve(r))return Kt(r,e);for(var t=r.length,n=-1,s=Object(r);++n<t&&e(s[n],n,s)!==!1;);return r});function Mr(r,e){var t=-1,n=ve(r)?Array(r.length):[];return Rs(r,function(s,i,o){n[++t]=e(s,i,o)}),n}function qs(r,e){return r>e}var Ds=Math.min;function Hs(r){return function(e){return re(e)&&ve(e)}(r)?r:[]}var Ws=hr(function(r){var e=fe(r,Hs);return e.length&&e[0]===r[0]?function(t,n,s){for(var i=an,o=t[0].length,l=t.length,a=l,d=Array(l),u=1/0,g=[];a--;){var p=t[a];u=Ds(p.length,u),d[a]=o>=120&&p.length>=120?new ke(a&&p):void 0}p=t[0];var y=-1,f=d[0];e:for(;++y<o&&g.length<u;){var v=p[y],x=v;if(v=v!==0?v:0,!(f?it(f,x):i(g,x,s))){for(a=l;--a;){var k=d[a];if(!(k?it(k,x):i(t[a],x,s)))continue e}f&&f.push(x),g.push(v)}}return g}(e):[]}),Us=Ws;function Vs(r,e){return r<e}function A(r,e){var t={};return e=ce(e),Er(r,function(n,s,i){ct(t,s,e(n,s,i))}),t}function jr(r,e,t){for(var n=-1,s=r.length;++n<s;){var i=r[n],o=e(i);if(o!=null&&(l===void 0?o==o&&!ge(o):t(o,l)))var l=o,a=i}return a}function Gs(r,e){return r&&r.length?jr(r,ce(e),qs):void 0}function Ar(r,e){for(var t,n=-1,s=r.length;++n<s;){var i=e(r[n]);i!==void 0&&(t=t===void 0?i:t+i)}return t}function Zs(r,e){return function(t,n){var s=t==null?0:t.length;return s?Ar(t,n)/s:NaN}(r,ce(e))}function Qs(r,e){if(r!==e){var t=r!==void 0,n=r===null,s=r==r,i=ge(r),o=e!==void 0,l=e===null,a=e==e,d=ge(e);if(!l&&!d&&!i&&r>e||i&&o&&a&&!l&&!d||n&&o&&a||!t&&a||!s)return 1;if(!n&&!i&&!d&&r<e||d&&t&&s&&!n&&!i||l&&t&&s||!o&&s||!a)return-1}return 0}function Lr(r,e,t){e=e.length?fe(e,function(s){return U(s)?function(i){return et(i,s.length===1?s[0]:s)}:s}):[Re];var n=-1;return e=fe(e,De(ce)),function(s,i){var o=s.length;for(s.sort(function(l,a){return function(d,u,g){for(var p=-1,y=d.criteria,f=u.criteria,v=y.length,x=g.length;++p<v;){var k=Qs(y[p],f[p]);if(k)return p>=x?k:k*(g[p]=="desc"?-1:1)}return d.index-u.index}(l,a,t)});o--;)s[o]=s[o].value;return s}(Mr(r,function(s,i,o){return{criteria:fe(e,function(l){return l(s)}),index:++n,value:s}}))}function mt(r,e,t,n){return r==null?[]:(U(e)||(e=e==null?[]:[e]),U(t=t)||(t=t==null?[]:[t]),Lr(r,e,t))}var Js=hr(function(r,e){if(r==null)return[];var t=e.length;return t>1&&Mt(r,e[0],e[1])?e=[]:t>2&&Mt(e[0],e[1],e[2])&&(e=[e[0]]),Lr(r,Ln(e),[])});function Ys(r,e){return r&&r.length?Ar(r,ce(e)):0}function j(r){if(this.words=[],r)if(Symbol&&Symbol.iterator&&r[Symbol.iterator]!==void 0){const e=r[Symbol.iterator]();let t=e.next();for(;!t.done;)this.add(t.value),t=e.next()}else for(let e=0;e<r.length;e++)this.add(r[e])}j.fromWords=function(r){const e=Object.create(j.prototype);return e.words=r,e},j.prototype.add=function(r){this.resize(r),this.words[r>>>5]|=1<<r},j.prototype.flip=function(r){this.resize(r),this.words[r>>>5]^=1<<r},j.prototype.clear=function(){this.words.length=0},j.prototype.remove=function(r){this.resize(r),this.words[r>>>5]&=~(1<<r)},j.prototype.isEmpty=function(r){const e=this.words.length;for(let t=0;t<e;t++)if(this.words[t]!==0)return!1;return!0},j.prototype.has=function(r){return(this.words[r>>>5]&1<<r)!=0},j.prototype.checkedAdd=function(r){this.resize(r);const e=this.words[r>>>5],t=e|1<<r;return this.words[r>>>5]=t,(t^e)>>>r},j.prototype.trim=function(r){let e=this.words.length;for(;e>0&&this.words[e-1]===0;)e--;this.words.length=e},j.prototype.resize=function(r){const e=r+32>>>5;for(let t=this.words.length;t<e;t++)this.words[t]=0},j.prototype.hammingWeight=function(r){return 16843009*((r=(858993459&(r-=r>>>1&1431655765))+(r>>>2&858993459))+(r>>>4)&252645135)>>>24},j.prototype.hammingWeight4=function(r,e,t,n){return 16843009*((r=(r=(858993459&(r-=r>>>1&1431655765))+(r>>>2&858993459))+(r>>>4)&252645135)+(e=(e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)+(t=(t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)+(n=(n=(858993459&(n-=n>>>1&1431655765))+(n>>>2&858993459))+(n>>>4)&252645135))>>>24},j.prototype.size=function(){let r=0;const e=this.words.length,t=this.words;for(let n=0;n<e;n++)r+=this.hammingWeight(t[n]);return r},j.prototype.array=function(){const r=new Array(this.size());let e=0;const t=this.words.length;for(let n=0;n<t;++n){let s=this.words[n];for(;s!=0;){const i=s&-s;r[e++]=(n<<5)+this.hammingWeight(i-1|0),s^=i}}return r},j.prototype.forEach=function(r){const e=this.words.length;for(let t=0;t<e;++t){let n=this.words[t];for(;n!=0;){const s=n&-n;r((t<<5)+this.hammingWeight(s-1|0)),n^=s}}},j.prototype[Symbol.iterator]=function(){const r=this.words.length;let e=0,t=this.words[e],n=this.hammingWeight,s=this.words;return{[Symbol.iterator](){return this},next(){for(;e<r;){if(t!==0){const i=t&-t,o=(e<<5)+n(i-1|0);return t^=i,{done:!1,value:o}}e++,e<r&&(t=s[e])}return{done:!0,value:void 0}}}},j.prototype.clone=function(){const r=Object.create(j.prototype);return r.words=this.words.slice(),r},j.prototype.intersects=function(r){const e=Math.min(this.words.length,r.words.length);for(let t=0;t<e;++t)if(this.words[t]&r.words[t])return!0;return!1},j.prototype.intersection=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]&=r.words[t],this.words[t+1]&=r.words[t+1],this.words[t+2]&=r.words[t+2],this.words[t+3]&=r.words[t+3],this.words[t+4]&=r.words[t+4],this.words[t+5]&=r.words[t+5],this.words[t+6]&=r.words[t+6],this.words[t+7]&=r.words[t+7];for(;t<e;++t)this.words[t]&=r.words[t];const n=this.words.length;for(t=e;t<n;++t)this.words[t]=0;return this},j.prototype.intersection_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(let n=0;n<e;++n)t+=this.hammingWeight(this.words[n]&r.words[n]);return t},j.prototype.new_intersection=function(r){const e=Object.create(j.prototype),t=Math.min(this.words.length,r.words.length);e.words=new Array(t);let n=0;for(;n+7<t;n+=8)e.words[n]=this.words[n]&r.words[n],e.words[n+1]=this.words[n+1]&r.words[n+1],e.words[n+2]=this.words[n+2]&r.words[n+2],e.words[n+3]=this.words[n+3]&r.words[n+3],e.words[n+4]=this.words[n+4]&r.words[n+4],e.words[n+5]=this.words[n+5]&r.words[n+5],e.words[n+6]=this.words[n+6]&r.words[n+6],e.words[n+7]=this.words[n+7]&r.words[n+7];for(;n<t;++n)e.words[n]=this.words[n]&r.words[n];return e},j.prototype.equals=function(r){const e=Math.min(this.words.length,r.words.length);for(let t=0;t<e;++t)if(this.words[t]!=r.words[t])return!1;if(this.words.length<r.words.length){const t=r.words.length;for(let n=this.words.length;n<t;++n)if(r.words[n]!=0)return!1}else if(r.words.length<this.words.length){const t=this.words.length;for(let n=r.words.length;n<t;++n)if(this.words[n]!=0)return!1}return!0},j.prototype.difference=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]&=~r.words[t],this.words[t+1]&=~r.words[t+1],this.words[t+2]&=~r.words[t+2],this.words[t+3]&=~r.words[t+3],this.words[t+4]&=~r.words[t+4],this.words[t+5]&=~r.words[t+5],this.words[t+6]&=~r.words[t+6],this.words[t+7]&=~r.words[t+7];for(;t<e;++t)this.words[t]&=~r.words[t];return this},j.prototype.new_difference=function(r){return this.clone().difference(r)},j.prototype.difference2=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)r.words[t]=this.words[t]&~r.words[t],r.words[t+1]=this.words[t+1]&~r.words[t+1],r.words[t+2]=this.words[t+2]&~r.words[t+2],r.words[t+3]=this.words[t+3]&~r.words[t+3],r.words[t+4]=this.words[t+4]&~r.words[t+4],r.words[t+5]=this.words[t+5]&~r.words[t+5],r.words[t+6]=this.words[t+6]&~r.words[t+6],r.words[t+7]=this.words[t+7]&~r.words[t+7];for(;t<e;++t)r.words[t]=this.words[t]&~r.words[t];for(t=this.words.length-1;t>=e;--t)r.words[t]=this.words[t];return r.words.length=this.words.length,r},j.prototype.difference_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0,n=0;for(;n<e;++n)t+=this.hammingWeight(this.words[n]&~r.words[n]);const s=this.words.length;for(;n<s;++n)t+=this.hammingWeight(this.words[n]);return t},j.prototype.change=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]^=r.words[t],this.words[t+1]^=r.words[t+1],this.words[t+2]^=r.words[t+2],this.words[t+3]^=r.words[t+3],this.words[t+4]^=r.words[t+4],this.words[t+5]^=r.words[t+5],this.words[t+6]^=r.words[t+6],this.words[t+7]^=r.words[t+7];for(;t<e;++t)this.words[t]^=r.words[t];for(t=r.words.length-1;t>=e;--t)this.words[t]=r.words[t];return this},j.prototype.new_change=function(r){const e=Object.create(j.prototype),t=Math.max(this.words.length,r.words.length);e.words=new Array(t);const n=Math.min(this.words.length,r.words.length);let s=0;for(;s+7<n;s+=8)e.words[s]=this.words[s]^r.words[s],e.words[s+1]=this.words[s+1]^r.words[s+1],e.words[s+2]=this.words[s+2]^r.words[s+2],e.words[s+3]=this.words[s+3]^r.words[s+3],e.words[s+4]=this.words[s+4]^r.words[s+4],e.words[s+5]=this.words[s+5]^r.words[s+5],e.words[s+6]=this.words[s+6]^r.words[s+6],e.words[s+7]=this.words[s+7]^r.words[s+7];for(;s<n;++s)e.words[s]=this.words[s]^r.words[s];const i=this.words.length;for(s=n;s<i;++s)e.words[s]=this.words[s];const o=r.words.length;for(s=n;s<o;++s)e.words[s]=r.words[s];return e},j.prototype.change_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0,n=0;for(;n<e;++n)t+=this.hammingWeight(this.words[n]^r.words[n]);const s=this.words.length>r.words.length?this:r,i=s.words.length;for(;n<i;++n)t+=this.hammingWeight(s.words[n]);return t},j.prototype.toString=function(){return"{"+this.array().join(",")+"}"},j.prototype.union=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]|=r.words[t],this.words[t+1]|=r.words[t+1],this.words[t+2]|=r.words[t+2],this.words[t+3]|=r.words[t+3],this.words[t+4]|=r.words[t+4],this.words[t+5]|=r.words[t+5],this.words[t+6]|=r.words[t+6],this.words[t+7]|=r.words[t+7];for(;t<e;++t)this.words[t]|=r.words[t];if(this.words.length<r.words.length){this.resize((r.words.length<<5)-1);const n=r.words.length;for(let s=e;s<n;++s)this.words[s]=r.words[s]}return this},j.prototype.new_union=function(r){const e=Object.create(j.prototype),t=Math.max(this.words.length,r.words.length);e.words=new Array(t);const n=Math.min(this.words.length,r.words.length);let s=0;for(;s+7<n;s+=8)e.words[s]=this.words[s]|r.words[s],e.words[s+1]=this.words[s+1]|r.words[s+1],e.words[s+2]=this.words[s+2]|r.words[s+2],e.words[s+3]=this.words[s+3]|r.words[s+3],e.words[s+4]=this.words[s+4]|r.words[s+4],e.words[s+5]=this.words[s+5]|r.words[s+5],e.words[s+6]=this.words[s+6]|r.words[s+6],e.words[s+7]=this.words[s+7]|r.words[s+7];for(;s<n;++s)e.words[s]=this.words[s]|r.words[s];const i=this.words.length;for(s=n;s<i;++s)e.words[s]=this.words[s];const o=r.words.length;for(s=n;s<o;++s)e.words[s]=r.words[s];return e},j.prototype.union_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(let n=0;n<e;++n)t+=this.hammingWeight(this.words[n]|r.words[n]);if(this.words.length<r.words.length){const n=r.words.length;for(let s=this.words.length;s<n;++s)t+=this.hammingWeight(0|r.words[s])}else{const n=this.words.length;for(let s=r.words.length;s<n;++s)t+=this.hammingWeight(0|this.words[s])}return t};var G=j;function at(){return at=Object.assign||function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r},at.apply(this,arguments)}function Xs(r,e){var t=[];return r.forEach(function(n){e.forEach(function(s){t.push(n.concat(s))})}),t}function Fr(r){return!!~r.search(/\(|\)/)}function er(r,e){for(var t=e.split(" "+r+" "),n=[],s=[],i=0;i<t.length;i++)if(Fr(t[i])||s.length>0){s.push(t[i]);var o=""+s;(o.match(/\(/g)||[]).length===(o.match(/\)/g)||[]).length&&(n.push(s.join(" "+r+" ")),s=[])}else n.push(t[i]);return n}var Ks=function r(e){return function(n){for(var s=n[0],i=1;i<n.length;i++)s=s.concat(n[i]);return s}(er("OR",(t=e=function(n){if(n.charAt(0)==="("){for(var s=0,i=0;i<n.length;i++)if(n.charAt(i)==="("?s++:n.charAt(i)===")"&&s--,s===0)return i!==n.length-1?n:n.substring(1,n.length-1)}return n}(e),e=t.replace(/[\s]+/g," "))).map(function(n){for(var s=er("AND",n),i=[],o=[],l=0;l<s.length;l++)Fr(s[l])?i.push(r(s[l])):o.push(s[l]);return i.push([o]),function(a){for(var d=[[]],u=0;u<a.length;u++)d=Xs(d,a[u]);return d}(i)}));var t};const tr=function(r){try{return structuredClone(r)}catch{try{return JSON.parse(JSON.stringify(r))}catch{return r}}},rr=function(r,e){let t=new G([]),n=0;return A(e,function(s,i){s.forEach(o=>{++n,t=t.new_union(r[i][o]||new G([]))})}),n===0?null:t},ei=function(r,e,t){let n=1;return A(r.bits_data_temp,(s,i)=>{let o,l,a,d,u,g,p;t[i]&&(o=t[i].order,l=t[i].sort,a=t[i].size,d=t[i].title,u=t[i].show_facet_stats||!1,g=t[i].chosen_filters_on_top!==!1,p=t[i].hide_zero_doc_count||!1);let y,f,v,x,k=Object.entries(s).map(M=>{let z=[];e&&e.filters&&e.filters[i]&&(z=e.filters[i]);const S=M[1].array().length;if(!p||S!==0||z.indexOf(M[0])!==-1)return{key:M[0],doc_count:S,selected:z.indexOf(M[0])!==-1}}).filter(Boolean);var I,P;return U(l)?(y=l||["key"],f=o||["asc"]):(l==="term"||l==="key"?(y=["key"],f=[o||"asc"]):(y=["doc_count","key"],f=[o||"desc","asc"]),g&&(y.unshift("selected"),f.unshift("desc"))),k=mt(k,y,f),k=k.slice(0,a||10),u&&(v=[],Object.entries(s).forEach(M=>{if(isNaN(M[0]))throw new Error("You cant use chars to calculate the facet_stats.");M[1].array().length>0&&M[1].forEach(()=>{v.push(parseInt(M[0]))})}),x={min:(I=v,I&&I.length?jr(I,ce(void 0),Vs):void 0),max:Gs(v),avg:Zs(v),sum:Ys(v)}),at({name:i,title:d||(P=i,P.replace(/^[\s_]+|[\s_]+$/g,"").replace(/[_\s]+/g," ").replace(/^[a-z]/,function(M){return M.toUpperCase()})),position:n++,buckets:k},u&&{facet_stats:x})})};function nr(r,e,t,n,s){e=e||Object.create(null);const i=parseInt(e.per_page||12),o=parseInt(e.page||1),l=e.is_all_filtered_items||!1;if(t.native_search_enabled===!1&&(e.query||e.filter))throw new Error('"query" and "filter" options are not working once native search is disabled');let a=0;const d=new Date().getTime();let u,g,p,y=s.bits_ids();if(e._ids)u=new G(e._ids),g=e._ids;else if(e.ids)g=s.internal_ids_from_ids_map(e.ids),u=new G(g);else if(n&&(e.query||e.filter)){const S=new Date().getTime();g=n.search(e.query,e.filter),a=new Date().getTime()-S,u=new G(g)}let f=new Date().getTime();const v=s.search(e,{query_ids:u});f=new Date().getTime()-f,u&&(y=u),v.ids&&(y=y.new_intersection(v.ids)),v.not_ids&&(y=y.new_difference(v.not_ids));let x=y.array(),k=x.map(S=>s.get_item(S)),I=!1;const P=new Date().getTime();let M=0;e.sort?k=function(S,E,q){return q&&q[E]&&(E=q[E]),E.field?mt(S,E.field,E.order||"asc"):S}(k,e.sort,t.sortings):g&&(x=g.filter(S=>y.has(S)),k=x.slice((o-1)*i,o*i).map(S=>s.get_item(S)),I=!0),I||(p=l?k:null,k=k.slice((o-1)*i,o*i)),M=new Date().getTime()-P;const z=new Date().getTime()-d;return{pagination:{per_page:i,page:o,total:x.length},timings:{total:z,facets:f,search:a,sorting:M},data:{items:k,allFilteredItems:p,aggregations:ei(v,e,t.aggregations)}}}var Oe=function(r){var e={exports:{}};return function(t,n){(function(){var s,i,o,l,a,d,u,g,p,y,f,v,x,k,I,P,M,z,S,E,q,Z,W,D,V,F,T,R,m=function(c){var h=new m.Index;return h.pipeline.add(m.trimmer,m.stopWordFilter,m.stemmer),c&&c.call(h,h),h};m.version="1.0.0",m.utils={},m.utils.warn=function(c){return function(h){c.console&&console.warn&&console.warn(h)}}(this),m.utils.asString=function(c){return c==null?"":c.toString()},m.EventEmitter=function(){this.events={}},m.EventEmitter.prototype.addListener=function(){var c=Array.prototype.slice.call(arguments),h=c.pop(),w=c;if(typeof h!="function")throw new TypeError("last argument must be a function");w.forEach(function(b){this.hasHandler(b)||(this.events[b]=[]),this.events[b].push(h)},this)},m.EventEmitter.prototype.removeListener=function(c,h){if(this.hasHandler(c)){var w=this.events[c].indexOf(h);this.events[c].splice(w,1),this.events[c].length||delete this.events[c]}},m.EventEmitter.prototype.emit=function(c){if(this.hasHandler(c)){var h=Array.prototype.slice.call(arguments,1);this.events[c].forEach(function(w){w.apply(void 0,h)})}},m.EventEmitter.prototype.hasHandler=function(c){return c in this.events},m.tokenizer=function(c){return arguments.length&&c!=null&&c!=null?Array.isArray(c)?c.map(function(h){return m.utils.asString(h).toLowerCase()}):c.toString().trim().toLowerCase().split(m.tokenizer.separator):[]},m.tokenizer.separator=/[\s\-]+/,m.tokenizer.load=function(c){var h=this.registeredFunctions[c];if(!h)throw new Error("Cannot load un-registered function: "+c);return h},m.tokenizer.label="default",m.tokenizer.registeredFunctions={default:m.tokenizer},m.tokenizer.registerFunction=function(c,h){h in this.registeredFunctions&&m.utils.warn("Overwriting existing tokenizer: "+h),c.label=h,this.registeredFunctions[h]=c},m.Pipeline=function(){this._stack=[]},m.Pipeline.registeredFunctions={},m.Pipeline.registerFunction=function(c,h){h in this.registeredFunctions&&m.utils.warn("Overwriting existing registered function: "+h),c.label=h,m.Pipeline.registeredFunctions[c.label]=c},m.Pipeline.warnIfFunctionNotRegistered=function(c){c.label&&c.label in this.registeredFunctions||m.utils.warn(`Function is not registered with pipeline. This may cause problems when serialising the index.
`,c)},m.Pipeline.load=function(c){var h=new m.Pipeline;return c.forEach(function(w){var b=m.Pipeline.registeredFunctions[w];if(!b)throw new Error("Cannot load un-registered function: "+w);h.add(b)}),h},m.Pipeline.prototype.add=function(){Array.prototype.slice.call(arguments).forEach(function(c){m.Pipeline.warnIfFunctionNotRegistered(c),this._stack.push(c)},this)},m.Pipeline.prototype.after=function(c,h){m.Pipeline.warnIfFunctionNotRegistered(h);var w=this._stack.indexOf(c);if(w==-1)throw new Error("Cannot find existingFn");this._stack.splice(w+=1,0,h)},m.Pipeline.prototype.before=function(c,h){m.Pipeline.warnIfFunctionNotRegistered(h);var w=this._stack.indexOf(c);if(w==-1)throw new Error("Cannot find existingFn");this._stack.splice(w,0,h)},m.Pipeline.prototype.remove=function(c){var h=this._stack.indexOf(c);h!=-1&&this._stack.splice(h,1)},m.Pipeline.prototype.run=function(c){for(var h=[],w=c.length,b=this._stack.length,_=0;_<w;_++){for(var C=c[_],$=0;$<b&&(C=this._stack[$](C,_,c))!==void 0&&C!=="";$++);C!==void 0&&C!==""&&h.push(C)}return h},m.Pipeline.prototype.reset=function(){this._stack=[]},m.Pipeline.prototype.toJSON=function(){return this._stack.map(function(c){return m.Pipeline.warnIfFunctionNotRegistered(c),c.label})},m.Vector=function(){this._magnitude=null,this.list=void 0,this.length=0},m.Vector.Node=function(c,h,w){this.idx=c,this.val=h,this.next=w},m.Vector.prototype.insert=function(c,h){this._magnitude=void 0;var w=this.list;if(!w)return this.list=new m.Vector.Node(c,h,w),this.length++;if(c<w.idx)return this.list=new m.Vector.Node(c,h,w),this.length++;for(var b=w,_=w.next;_!=null;){if(c<_.idx)return b.next=new m.Vector.Node(c,h,_),this.length++;b=_,_=_.next}return b.next=new m.Vector.Node(c,h,_),this.length++},m.Vector.prototype.magnitude=function(){if(this._magnitude)return this._magnitude;for(var c,h=this.list,w=0;h;)w+=(c=h.val)*c,h=h.next;return this._magnitude=Math.sqrt(w)},m.Vector.prototype.dot=function(c){for(var h=this.list,w=c.list,b=0;h&&w;)h.idx<w.idx?h=h.next:(h.idx>w.idx||(b+=h.val*w.val,h=h.next),w=w.next);return b},m.Vector.prototype.similarity=function(c){return this.dot(c)/(this.magnitude()*c.magnitude())},m.SortedSet=function(){this.length=0,this.elements=[]},m.SortedSet.load=function(c){var h=new this;return h.elements=c,h.length=c.length,h},m.SortedSet.prototype.add=function(){var c,h;for(c=0;c<arguments.length;c++)~this.indexOf(h=arguments[c])||this.elements.splice(this.locationFor(h),0,h);this.length=this.elements.length},m.SortedSet.prototype.toArray=function(){return this.elements.slice()},m.SortedSet.prototype.map=function(c,h){return this.elements.map(c,h)},m.SortedSet.prototype.forEach=function(c,h){return this.elements.forEach(c,h)},m.SortedSet.prototype.indexOf=function(c){for(var h=0,w=this.elements.length,b=w-h,_=h+Math.floor(b/2),C=this.elements[_];b>1;){if(C===c)return _;C<c&&(h=_),C>c&&(w=_),b=w-h,_=h+Math.floor(b/2),C=this.elements[_]}return C===c?_:-1},m.SortedSet.prototype.locationFor=function(c){for(var h=0,w=this.elements.length,b=w-h,_=h+Math.floor(b/2),C=this.elements[_];b>1;)C<c&&(h=_),C>c&&(w=_),b=w-h,_=h+Math.floor(b/2),C=this.elements[_];return C>c?_:C<c?_+1:void 0},m.SortedSet.prototype.intersect=function(c){for(var h=new m.SortedSet,w=0,b=0,_=this.length,C=c.length,$=this.elements,H=c.elements;!(w>_-1||b>C-1);)$[w]!==H[b]?$[w]<H[b]?w++:$[w]>H[b]&&b++:(h.add($[w]),w++,b++);return h},m.SortedSet.prototype.clone=function(){var c=new m.SortedSet;return c.elements=this.toArray(),c.length=c.elements.length,c},m.SortedSet.prototype.union=function(c){var h,w,b;this.length>=c.length?(h=this,w=c):(h=c,w=this),b=h.clone();for(var _=0,C=w.toArray();_<C.length;_++)b.add(C[_]);return b},m.SortedSet.prototype.toJSON=function(){return this.toArray()},m.Index=function(){this._fields=[],this._ref="id",this.pipeline=new m.Pipeline,this.documentStore=new m.Store,this.tokenStore=new m.TokenStore,this.corpusTokens=new m.SortedSet,this.eventEmitter=new m.EventEmitter,this.tokenizerFn=m.tokenizer,this._idfCache={},this.on("add","remove","update",(function(){this._idfCache={}}).bind(this))},m.Index.prototype.on=function(){var c=Array.prototype.slice.call(arguments);return this.eventEmitter.addListener.apply(this.eventEmitter,c)},m.Index.prototype.off=function(c,h){return this.eventEmitter.removeListener(c,h)},m.Index.load=function(c){c.version!==m.version&&m.utils.warn("version mismatch: current "+m.version+" importing "+c.version);var h=new this;return h._fields=c.fields,h._ref=c.ref,h.tokenizer(m.tokenizer.load(c.tokenizer)),h.documentStore=m.Store.load(c.documentStore),h.tokenStore=m.TokenStore.load(c.tokenStore),h.corpusTokens=m.SortedSet.load(c.corpusTokens),h.pipeline=m.Pipeline.load(c.pipeline),h},m.Index.prototype.field=function(c,h){return this._fields.push({name:c,boost:(h=h||{}).boost||1}),this},m.Index.prototype.ref=function(c){return this._ref=c,this},m.Index.prototype.tokenizer=function(c){return c.label&&c.label in m.tokenizer.registeredFunctions||m.utils.warn("Function is not a registered tokenizer. This may cause problems when serialising the index"),this.tokenizerFn=c,this},m.Index.prototype.add=function(c,h){var w={},b=new m.SortedSet,_=c[this._ref];h=h===void 0||h,this._fields.forEach(function(je){var he=this.pipeline.run(this.tokenizerFn(c[je.name]));w[je.name]=he;for(var pe=0;pe<he.length;pe++){var Ae=he[pe];b.add(Ae),this.corpusTokens.add(Ae)}},this),this.documentStore.set(_,b);for(var C=0;C<b.length;C++){for(var $=b.elements[C],H=0,O=0;O<this._fields.length;O++){var de=this._fields[O],Me=w[de.name],we=Me.length;if(we){for(var ne=0,ue=0;ue<we;ue++)Me[ue]===$&&ne++;H+=ne/we*de.boost}}this.tokenStore.add($,{ref:_,tf:H})}h&&this.eventEmitter.emit("add",c,this)},m.Index.prototype.remove=function(c,h){var w=c[this._ref];if(h=h===void 0||h,this.documentStore.has(w)){var b=this.documentStore.get(w);this.documentStore.remove(w),b.forEach(function(_){this.tokenStore.remove(_,w)},this),h&&this.eventEmitter.emit("remove",c,this)}},m.Index.prototype.update=function(c,h){h=h===void 0||h,this.remove(c,!1),this.add(c,!1),h&&this.eventEmitter.emit("update",c,this)},m.Index.prototype.idf=function(c){var h="@"+c;if(Object.prototype.hasOwnProperty.call(this._idfCache,h))return this._idfCache[h];var w=this.tokenStore.count(c),b=1;return w>0&&(b=1+Math.log(this.documentStore.length/w)),this._idfCache[h]=b},m.Index.prototype.search=function(c){var h=this.pipeline.run(this.tokenizerFn(c)),w=new m.Vector,b=[],_=this._fields.reduce(function(C,$){return C+$.boost},0);return h.some(function(C){return this.tokenStore.has(C)},this)?(h.forEach(function(C,$,H){var O=1/H.length*this._fields.length*_,de=this,Me=this.tokenStore.expand(C).reduce(function(we,ne){var ue=de.corpusTokens.indexOf(ne),je=de.idf(ne),he=1,pe=new m.SortedSet;if(ne!==C){var Ae=Math.max(3,ne.length-C.length);he=1/Math.log(Ae)}ue>-1&&w.insert(ue,O*je*he);for(var yt=de.tokenStore.get(ne),vt=Object.keys(yt),Or=vt.length,He=0;He<Or;He++)pe.add(yt[vt[He]].ref);return we.union(pe)},new m.SortedSet);b.push(Me)},this),b.reduce(function(C,$){return C.intersect($)}).map(function(C){return{ref:C,score:w.similarity(this.documentVector(C))}},this).sort(function(C,$){return $.score-C.score})):[]},m.Index.prototype.documentVector=function(c){for(var h=this.documentStore.get(c),w=h.length,b=new m.Vector,_=0;_<w;_++){var C=h.elements[_],$=this.tokenStore.get(C)[c].tf,H=this.idf(C);b.insert(this.corpusTokens.indexOf(C),$*H)}return b},m.Index.prototype.toJSON=function(){return{version:m.version,fields:this._fields,ref:this._ref,tokenizer:this.tokenizerFn.label,documentStore:this.documentStore.toJSON(),tokenStore:this.tokenStore.toJSON(),corpusTokens:this.corpusTokens.toJSON(),pipeline:this.pipeline.toJSON()}},m.Index.prototype.use=function(c){var h=Array.prototype.slice.call(arguments,1);h.unshift(this),c.apply(this,h)},m.Store=function(){this.store={},this.length=0},m.Store.load=function(c){var h=new this;return h.length=c.length,h.store=Object.keys(c.store).reduce(function(w,b){return w[b]=m.SortedSet.load(c.store[b]),w},{}),h},m.Store.prototype.set=function(c,h){this.has(c)||this.length++,this.store[c]=h},m.Store.prototype.get=function(c){return this.store[c]},m.Store.prototype.has=function(c){return c in this.store},m.Store.prototype.remove=function(c){this.has(c)&&(delete this.store[c],this.length--)},m.Store.prototype.toJSON=function(){return{store:this.store,length:this.length}},m.stemmer=(s={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},i={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},d="^("+(l="[^aeiou][^aeiouy]*")+")?"+(a=(o="[aeiouy]")+"[aeiou]*")+l+"("+a+")?$",u="^("+l+")?"+a+l+a+l,g="^("+l+")?"+o,p=new RegExp("^("+l+")?"+a+l),y=new RegExp(u),f=new RegExp(d),v=new RegExp(g),x=/^(.+?)(ss|i)es$/,k=/^(.+?)([^s])s$/,I=/^(.+?)eed$/,P=/^(.+?)(ed|ing)$/,M=/.$/,z=/(at|bl|iz)$/,S=new RegExp("([^aeiouylsz])\\1$"),E=new RegExp("^"+l+o+"[^aeiouwxy]$"),q=/^(.+?[^aeiou])y$/,Z=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/,W=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,D=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/,V=/^(.+?)(s|t)(ion)$/,F=/^(.+?)e$/,T=/ll$/,R=new RegExp("^"+l+o+"[^aeiouwxy]$"),function(c){var h,w,b,_,C,$,H;if(c.length<3)return c;if((b=c.substr(0,1))=="y"&&(c=b.toUpperCase()+c.substr(1)),C=k,(_=x).test(c)?c=c.replace(_,"$1$2"):C.test(c)&&(c=c.replace(C,"$1$2")),C=P,(_=I).test(c)){var O=_.exec(c);(_=p).test(O[1])&&(c=c.replace(_=M,""))}else C.test(c)&&(O=C.exec(c),(C=v).test(h=O[1])&&($=S,H=E,(C=z).test(c=h)?c+="e":$.test(c)?c=c.replace(_=M,""):H.test(c)&&(c+="e")));return(_=q).test(c)&&(c=(h=(O=_.exec(c))[1])+"i"),(_=Z).test(c)&&(w=(O=_.exec(c))[2],(_=p).test(h=O[1])&&(c=h+s[w])),(_=W).test(c)&&(w=(O=_.exec(c))[2],(_=p).test(h=O[1])&&(c=h+i[w])),C=V,(_=D).test(c)?(O=_.exec(c),(_=y).test(h=O[1])&&(c=h)):C.test(c)&&(O=C.exec(c),(C=y).test(h=O[1]+O[2])&&(c=h)),(_=F).test(c)&&(O=_.exec(c),C=f,$=R,((_=y).test(h=O[1])||C.test(h)&&!$.test(h))&&(c=h)),C=y,(_=T).test(c)&&C.test(c)&&(c=c.replace(_=M,"")),b=="y"&&(c=b.toLowerCase()+c.substr(1)),c}),m.Pipeline.registerFunction(m.stemmer,"stemmer"),m.generateStopWordFilter=function(c){var h=c.reduce(function(w,b){return w[b]=b,w},{});return function(w){if(w&&h[w]!==w)return w}},m.stopWordFilter=m.generateStopWordFilter(["a","able","about","across","after","all","almost","also","am","among","an","and","any","are","as","at","be","because","been","but","by","can","cannot","could","dear","did","do","does","either","else","ever","every","for","from","get","got","had","has","have","he","her","hers","him","his","how","however","i","if","in","into","is","it","its","just","least","let","like","likely","may","me","might","most","must","my","neither","no","nor","not","of","off","often","on","only","or","other","our","own","rather","said","say","says","she","should","since","so","some","than","that","the","their","them","then","there","these","they","this","tis","to","too","twas","us","wants","was","we","were","what","when","where","which","while","who","whom","why","will","with","would","yet","you","your"]),m.Pipeline.registerFunction(m.stopWordFilter,"stopWordFilter"),m.trimmer=function(c){return c.replace(/^\W+/,"").replace(/\W+$/,"")},m.Pipeline.registerFunction(m.trimmer,"trimmer"),m.TokenStore=function(){this.root={docs:{}},this.length=0},m.TokenStore.load=function(c){var h=new this;return h.root=c.root,h.length=c.length,h},m.TokenStore.prototype.add=function(c,h,w){w=w||this.root;var b=c.charAt(0),_=c.slice(1);return b in w||(w[b]={docs:{}}),_.length===0?(w[b].docs[h.ref]=h,void(this.length+=1)):this.add(_,h,w[b])},m.TokenStore.prototype.has=function(c){if(!c)return!1;for(var h=this.root,w=0;w<c.length;w++){if(!h[c.charAt(w)])return!1;h=h[c.charAt(w)]}return!0},m.TokenStore.prototype.getNode=function(c){if(!c)return{};for(var h=this.root,w=0;w<c.length;w++){if(!h[c.charAt(w)])return{};h=h[c.charAt(w)]}return h},m.TokenStore.prototype.get=function(c,h){return this.getNode(c,h).docs||{}},m.TokenStore.prototype.count=function(c,h){return Object.keys(this.get(c,h)).length},m.TokenStore.prototype.remove=function(c,h){if(c){for(var w=this.root,b=0;b<c.length;b++){if(!(c.charAt(b)in w))return;w=w[c.charAt(b)]}delete w.docs[h]}},m.TokenStore.prototype.expand=function(c,h){var w=this.getNode(c);return h=h||[],Object.keys(w.docs||{}).length&&h.push(c),Object.keys(w).forEach(function(b){b!=="docs"&&h.concat(this.expand(c+b,h))},this),h},m.TokenStore.prototype.toJSON=function(){return{root:this.root,length:this.length}},t.exports=m})()}(e),e.exports}();class sr{constructor(e,t){this.store=new Map,this.idx=Oe(function(){this.field("name",{boost:10}),((t==null?void 0:t.searchableFields)||[]).forEach(s=>this.field(s)),this.ref("_id"),t!=null&&t.isExactSearch&&(this.pipeline.remove(Oe.stemmer),this.pipeline.remove(Oe.stopWordFilter)),t!=null&&t.removeStopWordFilter&&this.pipeline.remove(Oe.stopWordFilter)});let n=1;(e||[]).map(s=>{s._id=n,++n,this.idx.add(s),this.store.set(s._id,s)})}search_full(e,t){return this.search(e,t).map(n=>this.store.get(n))}search(e,t){return t instanceof Function?(e?this.idx.search(e).map(n=>this.store.get(n.ref)):[...this.store.values()]).filter(t).map(n=>n._id):e?this.idx.search(e).map(n=>n.ref):[...this.store.keys()]}}class ir{constructor(e,t){(t=t||Object.create(null)).aggregations=t.aggregations||Object.create(null),this._items=e,this.config=t.aggregations,this.facets=function(o,l){l=l||[];const a={data:Object.create(null),bits_data:Object.create(null),bits_data_temp:Object.create(null)};let d=1;return l.forEach(u=>{a.data[u]=Object.create(null)}),o&&o.map(u=>(u._id||(u._id=d,++d),u)),o&&o.map(u=>(l.forEach(g=>{if(u){if(Array.isArray(u[g]))u[g].forEach(p=>{u[g]&&(a.data[g][p]||(a.data[g][p]=[]),a.data[g][p].push(parseInt(u._id)))});else if(u[g]!==void 0){const p=u[g];a.data[g][p]||(a.data[g][p]=[]),a.data[g][p].push(parseInt(u._id))}}}),u)),a.data=A(a.data,function(u,g){return a.bits_data[g]||(a.bits_data[g]=Object.create(null),a.bits_data_temp[g]=Object.create(null)),A(u,function(p,y){const f=Js(p);return a.bits_data[g][y]=new G(f),f})}),a}(e,Ee(t.aggregations)),this._items_map=Object.create(null),this._ids=[];let n=1;var s,i;i=o=>{this._ids.push(n),this._items_map[n]=o,o._id=n,++n},(U(s=e)?fe:Mr)(s,ce(i)),this.ids_map=Object.create(null),e&&e.forEach(o=>{const l=t.custom_id_field||"id";o[l]&&o._id&&(this.ids_map[o[l]]=o._id)}),this._bits_ids=new G(this._ids)}items(){return this._items}bits_ids(e){return e?new G(e):this._bits_ids}internal_ids_from_ids_map(e){return e.map(t=>this.ids_map[t])}index(){return this.facets}get_item(e){return this._items_map[e]}search(e,t){const n=this.config;t=t||Object.create(null);const s=Je(this.facets);let i;s.not_ids=rr(s.bits_data,e.not_filters);const o=function(l,a){const d=[];return A(l.filters,function(u,g){if(u&&u.length)if(a[g].conjunction!==!1)A(u,function(p){d.push([g,p])});else{const p=[];A(u,function(y){p.push([g,y])}),d.push(p)}}),A(l.not_filters,function(u,g){u&&u.length&&A(u,function(p){d.push([g,"-",p])})}),d}(e,n);return i=function(l,a){const d=Je(l);let u;a=a||[],A(d.bits_data,function(p,y){A(d.bits_data[y],function(f,v){d.bits_data_temp[y][v]=d.bits_data[y][v]})}),d.is_temp_copied=!0;const g=function(p,y){const f=Object.create(null);return A(y,function(v){if(Array.isArray(v[0])){let x=new G([]);A(v,function(k){const I=k[0];x=x.new_union(p.bits_data[I][k[1]]||new G([])),f[I]=x})}}),f}(l,a);return A(a,function(p){if(!Array.isArray(p[0])){const y=p[0],f=p[1];u=u&&d.bits_data_temp[y][f]?d.bits_data_temp[y][f].new_intersection(u):u&&!d.bits_data_temp[y][f]?new G([]):d.bits_data_temp[y][f]}}),u&&A(d.bits_data_temp,function(p,y){A(d.bits_data_temp[y],function(f,v){d.bits_data_temp[y][v]=d.bits_data_temp[y][v].new_intersection(u)})}),A(a,function(p){if(p.length===3&&p[1]==="-"){const y=d.bits_data_temp[p[0]][p[2]].clone();A(d.bits_data_temp,function(f,v){A(d.bits_data_temp[v],function(x,k){d.bits_data_temp[v][k]=d.bits_data_temp[v][k].new_difference(y)})})}}),A(d.bits_data_temp,function(p,y){A(d.bits_data_temp[y],function(f,v){A(g,function(x,k){k!==y&&(d.bits_data_temp[y][v]=d.bits_data_temp[y][v].new_intersection(x))})})}),d}(this.facets,o),e.filters_query&&(i=function(l,a){const d=Je(l);d.is_temp_copied||A(d.bits_data,function(g,p){A(d.bits_data[p],function(y,f){d.bits_data_temp[p][f]=d.bits_data[p][f]})});let u=null;return A(a,function(g){let p=null;A(g,function(y){const f=y[0],v=y[1];if(!d.bits_data_temp[f])throw new Error("Panic. The key does not exist in facets lists.");p=p&&d.bits_data_temp[f][v]?d.bits_data_temp[f][v].new_intersection(p):p&&!d.bits_data_temp[f][v]?new G([]):d.bits_data_temp[f][v]}),u=(u||new G([])).new_union(p||new G([]))}),u!==null&&A(d.bits_data_temp,function(g,p){A(d.bits_data_temp[p],function(y,f){d.bits_data_temp[p][f]=d.bits_data_temp[p][f].new_intersection(u)})}),d}(i,Ks(e.filters_query).map(l=>Array.isArray(l)?l.map(a=>Array.isArray(a)?a.map(d=>d):a.split(":")):l.split(":")))),s.bits_data_temp=i.bits_data_temp,A(s.bits_data_temp,function(l,a){A(s.bits_data_temp[a],function(d,u){t.query_ids&&(s.bits_data_temp[a][u]=t.query_ids.new_intersection(s.bits_data_temp[a][u])),t.test&&(s.data[a][u]=s.bits_data_temp[a][u].array())})}),s.ids=e.filters_query?function(l){let a=new G([]);return A(l,function(d,u){A(l[u],function(g,p){a=a.new_union(l[u][p])})}),a}(s.bits_data_temp):rr(s.bits_data_temp,e.filters),s}}function ti(r,e){let t;(e=e||Object.create(null)).native_search_enabled!==!1&&(t=new sr(r,e));let n=new ir(r,e);return{search:function(s){return(s=s||Object.create(null)).aggregations=function(i,o){return A(tr(i),(l,a)=>{l.field||(l.field=a);let d=[];o.filters&&o.filters[a]&&(d=o.filters[a]),l.filters=d;let u=[];return o.not_filters&&o.not_filters[a]&&(u=o.not_filters[a]),o.exclude_filters&&o.exclude_filters[a]&&(u=o.exclude_filters[a]),l.not_filters=u,l})}(e.aggregations,s),nr(0,s,e,t,n)},similar:function(s,i){return function(o,l,a){const d=a.per_page||10,u=a.minimum||0,g=a.page||1;let p;for(let v=0;v<o.length;++v)if(o[v].id==l){p=o[v];break}if(!a.field)throw new Error("Please define field in options");const y=a.field;let f=[];for(let v=0;v<o.length;++v)if(o[v].id!==l){const x=Us(p[y],o[v][y]);x.length>=u&&(f.push(o[v]),f[f.length-1].intersection_length=x.length)}return f=mt(f,["intersection_length"],["desc"]),{pagination:{per_page:d,page:g,total:f.length},data:{items:f.slice((g-1)*d,g*d)}}}(r,s,i)},aggregation:function(s){return function(i,o,l,a,d){const u=o.per_page||10,g=o.page||1;if(o.name&&(!l.aggregations||!l.aggregations[o.name]))throw new Error('Please define aggregation "'.concat(o.name,'" in config'));const p=tr(o);if(p.page=1,p.per_page=0,!o.name)throw new Error("field name is required");l.aggregations[o.name].size=1e4;const y=nr(0,p,l,a,d).data.aggregations[o.name].buckets;return{pagination:{per_page:u,page:g,total:y.length},data:{buckets:y.slice((g-1)*u,g*u)}}}(0,s,e,t,n)},reindex:function(s){t=new sr(r=s,e),n=new ir(r,e)}}}class ri{constructor(){this.elements={},this.activeFiltersCount=0,this.resultsCount=0,this.uniqueResultsCount=0,this.isInitialized=!1,this.currentFilters={},this.currentQuery="",this.config=null,this.mapInstance=null,this.init()}init(){this.elements={filtersPanel:document.getElementById("filters-panel"),resultsPanel:document.getElementById("results-panel"),toggleFilters:document.getElementById("toggle-filters"),toggleResults:document.getElementById("toggle-results"),activeFiltersBadge:document.getElementById("active-filters-badge"),activeFiltersCount:document.getElementById("active-filters-count"),resultsCounter:document.getElementById("results-counter"),resultsCount:document.getElementById("results-count"),uniqueResultsCounter:document.getElementById("unique-results-counter"),uniqueResultsCount:document.getElementById("unique-results-count"),clearAllBtn:document.getElementById("clear-all-btn"),layerButton:document.getElementById("map-layer-selector"),markersButton:document.getElementById("map-markers-selector")},((t,n=1e4)=>{const s=Date.now(),i=setInterval(()=>{window.ledaSearch?(t(window.ledaSearch),clearInterval(i)):Date.now()-s>n&&(console.warn("Timeout waiting for ledaSearch"),clearInterval(i))},100)})(t=>{this.config=t.config,this.mapInstance=t.mapInstance,this.initializeLayerButton(this.config)}),this.initializeMarkersSelector(),this.bindEventHandlers(),this.initializePanelStates(),this.setupResponsiveBehavior(),this.styleClearAllButton(),this.isInitialized=!0}styleClearAllButton(){this.elements.clearAllBtn&&(this.elements.clearAllBtn.className="ml-2 px-3 py-1 bg-pink-100 hover:bg-pink-200 text-red-500 text-xs rounded-full hidden",this.elements.clearAllBtn.innerHTML='<i class="fas fa-times mr-1"></i>Cancella tutto')}updateFromSearchState(e,t=0,n={}){if(!e)return;this.currentFilters={...e.filters},this.currentQuery=e.query||"";const s=n.uniqueResultsCount||0;console.log("hhihiihhi",s);const i=this.calculateActiveFiltersCount(e.filters);this.updateActiveFiltersCount(i),this.updateResultsCount(t,s),console.log(s)}calculateActiveFiltersCount(e){if(!e||typeof e!="object")return 0;let t=0;return Object.values(e).forEach(n=>{Array.isArray(n)?n.length===2&&typeof n[0]=="number"&&typeof n[1]=="number"?t+=1:t+=n.length:n&&typeof n=="object"&&(n.min!==void 0||n.max!==void 0)&&(t+=1)}),t}updateActiveFiltersCount(e){this.activeFiltersCount=e,this.elements.activeFiltersCount.textContent=e,e>0?(this.showElement(this.elements.activeFiltersBadge),this.showElement(this.elements.clearAllBtn)):(this.hideElement(this.elements.activeFiltersBadge),this.hideElement(this.elements.clearAllBtn)),this.emitEvent("activeFiltersChanged",{count:e})}updateResultsCount(e,t=0){this.resultsCount=e,this.uniqueResultsCount=t,this.elements.resultsCount.textContent=e,this.updateUniqueResultsDisplay(t),e>0?this.showElement(this.elements.resultsCounter):this.hideElement(this.elements.resultsCounter),t>0&&this.elements.uniqueResultsCounter?this.showElement(this.elements.uniqueResultsCounter):this.elements.uniqueResultsCounter&&this.hideElement(this.elements.uniqueResultsCounter),this.emitEvent("resultsCountChanged",{totalCount:e,uniqueResultsCount:t})}updateUniqueResultsDisplay(e){let t=document.getElementById("unique-results-count");if(!t){t=document.createElement("span"),t.id="unique-results-count",t.className="ml-2 text-xs text-gray-600 bg-blue-100 px-2 py-1 rounded-full";const n=this.elements.resultsCounter;n&&n.appendChild(t)}e>0?(t.textContent=`${e}`,t.style.display="inline"):t.style.display="none"}showElement(e){e&&(e.classList.remove("hidden"),e.style.opacity="1")}hideElement(e){e&&(e.classList.add("hidden"),e.style.opacity="0")}showActiveFiltersPopup(){if(document.getElementById("active-filters-popup")){this.hideActiveFiltersPopup();return}const t=this.elements.activeFiltersBadge.getBoundingClientRect(),n=document.createElement("div");n.id="active-filters-popup",n.className="fixed p-2 w-72 max-w-sm bg-white rounded-lg shadow-2xl border border-gray-200 max-h-96 overflow-hidden",n.style.zIndex="9999",n.style.left=`${t.left}px`,n.style.bottom=`${window.innerHeight-t.top+10}px`;const s=288;t.left+s>window.innerWidth&&(n.style.left=`${window.innerWidth-s-16}px`);const i=document.createElement("div");i.className="flex items-center justify-between mb-2",i.innerHTML=`
            <h3 class="p-2 text-sm font-semibold text-gray-800 bg-primary-500">Filtri Attivi</h3>
            <button id="close-filters-popup" class="absolute top-2 right-2 p-1.5 bg-pink-100 hover:bg-pink-200 active:bg-pink-200 rounded-full text-red-500 shadow-md hover:shadow-lg group">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `;const o=document.createElement("div");o.className="space-y-1 max-h-64 overflow-y-auto overflow-x-hidden";const l=this.buildFiltersContent();o.innerHTML=l,n.appendChild(i),n.appendChild(o),document.body.appendChild(n),this.bindPopupEvents(n)}buildFiltersContent(){if(!this.currentFilters||Object.keys(this.currentFilters).length===0)return`
                <div class="flex items-center p-4 rounded-lg bg-gray-50">
                    <span class="text-sm text-gray-700">Nessun filtro attivo</span>
                </div>
            `;let e="";this.currentQuery&&this.currentQuery.trim()&&(e+=`
                <div class="mb-3 p-3 rounded-lg bg-primary-50 border border-primary-100">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 text-primary-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <div class="flex-1 min-w-0">
                            <span class="text-sm font-medium text-primary-700">Ricerca:</span>
                            <span class="text-sm text-primary-600 ml-1 font-mono bg-primary-100 px-2 py-1 rounded text-xs">"${this.escapeHtml(this.currentQuery)}"</span>
                        </div>
                    </div>
                </div>
            `);const t={};return Object.entries(this.currentFilters).forEach(([n,s])=>{if(!s||Array.isArray(s)&&s.length===0)return;const i=this.getFacetLabel(n);t[i]||(t[i]=[]),Array.isArray(s)?s.length===2&&typeof s[0]=="number"&&typeof s[1]=="number"?t[i].push({type:"range",value:this.formatRangeFilter({min:s[0],max:s[1]}),facetKey:n}):s.forEach(o=>{t[i].push({type:"value",value:o,facetKey:n})}):typeof s=="object"&&t[i].push({type:"range",value:this.formatRangeFilter(s),facetKey:n})}),Object.entries(t).forEach(([n,s])=>{e+=`
                <div class="mb-3 p-3 rounded-lg bg-gray-50 border border-gray-200">
                    <div class="flex items-start">
                        <div class="w-2 h-2 rounded-full bg-indigo-500 mt-2 mr-3 flex-shrink-0"></div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-sm font-semibold text-gray-800 mb-2">${n}</h4>
                            <div class="flex flex-wrap gap-1.5">
            `,s.forEach((i,o)=>{const l=i.type==="range";e+=`
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border ${l?"bg-orange-100 text-orange-700 border-orange-200":"bg-indigo-100 text-indigo-700 border-indigo-200"} hover:shadow-sm">
                        ${l?`<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>`:`<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`}
                        ${this.escapeHtml(i.value)}
                    </span>
                `}),e+=`
                            </div>
                        </div>
                    </div>
                </div>
            `}),e||`
            <div class="flex items-center p-4 rounded-lg bg-gray-50">
                <span class="text-sm text-gray-700">Nessun filtro attivo</span>
            </div>
        `}getFacetLabel(e){return this.config&&this.config.aggregations&&this.config.aggregations[e]?this.config.aggregations[e].title||e:e.replace(/[_-]/g," ").replace(/\b\w/g,t=>t.toUpperCase())}formatRangeFilter(e){return e.min!==void 0&&e.max!==void 0?`${e.min} - ${e.max}`:e.min!==void 0?` ${e.min}`:e.max!==void 0?` ${e.max}`:"Range filter"}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}hideActiveFiltersPopup(){const e=document.getElementById("active-filters-popup");e&&e.parentNode&&e.parentNode.removeChild(e)}bindPopupEvents(e){const t=e.querySelector("#close-filters-popup");t&&t.addEventListener("click",()=>this.hideActiveFiltersPopup());const n=e.querySelector("#popup-clear-all-btn");n&&n.addEventListener("click",()=>this.handleClearAllFilters());const s=o=>{o.key==="Escape"&&(this.hideActiveFiltersPopup(),document.removeEventListener("keydown",s))};document.addEventListener("keydown",s);const i=o=>{!e.contains(o.target)&&!this.elements.activeFiltersBadge.contains(o.target)&&(this.hideActiveFiltersPopup(),document.removeEventListener("click",i))};document.addEventListener("click",i)}bindEventHandlers(){this.elements.toggleFilters.addEventListener("click",()=>{this.togglePanel("filters")}),this.elements.toggleResults.addEventListener("click",()=>{this.togglePanel("results")}),this.elements.clearAllBtn.addEventListener("click",()=>{this.handleClearAllFilters()}),this.elements.layerButton.addEventListener("click",()=>{this.handleMapCenter()}),this.elements.activeFiltersBadge&&(this.elements.activeFiltersBadge.addEventListener("click",()=>{this.showActiveFiltersPopup()}),this.elements.activeFiltersBadge.style.cursor="pointer",this.elements.activeFiltersBadge.title="Clicca per vedere i filtri attivi")}initializePanelStates(){this.elements.filtersPanel.classList.add("panel-closed"),this.elements.resultsPanel.classList.add("panel-closed-right"),this.elements.toggleFilters.classList.remove("active"),this.elements.toggleResults.classList.remove("active")}togglePanel(e){if(e==="filters"){const t=!this.elements.filtersPanel.classList.contains("panel-closed");this.elements.filtersPanel.classList.toggle("panel-closed"),this.elements.toggleFilters.classList.toggle("active",!t),this.emitEvent("panelToggled",{type:"filters",isOpen:!t})}else if(e==="results"){const t=!this.elements.resultsPanel.classList.contains("panel-closed-right");this.elements.resultsPanel.classList.toggle("panel-closed-right"),this.elements.toggleResults.classList.toggle("active",!t),this.emitEvent("panelToggled",{type:"results",isOpen:!t})}}closeAllPanels(){this.elements.filtersPanel.classList.add("panel-closed"),this.elements.resultsPanel.classList.add("panel-closed-right"),this.elements.toggleFilters.classList.remove("active"),this.elements.toggleResults.classList.remove("active")}handleClearAllFilters(){this.hideActiveFiltersPopup(),this.currentFilters={},this.currentQuery="",this.updateActiveFiltersCount(0),this.updateResultsCount(0),this.emitEvent("clearAllFilters",{resetInterface:!0,clearSearch:!0,clearFacets:!0,clearMap:!0}),setTimeout(()=>{this.resetFacetsInterface()},100),this.clearSearchInput(),this.showNotification("Tutti i filtri sono stati rimossi","success",2e3)}handleMapCenter(){this.emitEvent("centerMap")}setupResponsiveBehavior(){window.addEventListener("resize",()=>{window.innerWidth<768&&this.closeAllPanels()}),window.innerWidth<768&&this.closeAllPanels()}getState(){return{activeFiltersCount:this.activeFiltersCount,resultsCount:this.resultsCount,uniqueResultsCount:this.uniqueResultsCount,isFiltersOpen:!this.elements.filtersPanel.classList.contains("panel-closed"),isResultsOpen:!this.elements.resultsPanel.classList.contains("panel-closed-right"),currentFilters:{...this.currentFilters},currentQuery:this.currentQuery}}setState(e){if(e.activeFiltersCount!==void 0&&this.updateActiveFiltersCount(e.activeFiltersCount),e.resultsCount!==void 0&&this.updateResultsCount(e.resultsCount),e.isFiltersOpen!==void 0){const t=!this.elements.filtersPanel.classList.contains("panel-closed");e.isFiltersOpen!==t&&this.togglePanel("filters")}if(e.isResultsOpen!==void 0){const t=!this.elements.resultsPanel.classList.contains("panel-closed-right");e.isResultsOpen!==t&&this.togglePanel("results")}e.currentFilters!==void 0&&(this.currentFilters={...e.currentFilters}),e.currentQuery!==void 0&&(this.currentQuery=e.currentQuery)}emitEvent(e,t={}){const n=new CustomEvent(`navbar:${e}`,{detail:t,bubbles:!0,cancelable:!0});document.dispatchEvent(n)}addEventListener(e,t){document.addEventListener(`navbar:${e}`,t)}removeEventListener(e,t){document.removeEventListener(`navbar:${e}`,t)}showNotification(e,t="info",n=3e3){const s=document.createElement("div");s.className=`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg ${this.getNotificationClasses(t)}`,s.style.opacity="1",s.textContent=e,document.body.appendChild(s),setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s)},n)}getNotificationClasses(e){const t={success:"bg-green-500 text-white",error:"bg-red-500 text-white",warning:"bg-yellow-500 text-white",info:"bg-primary-500 text-white"};return t[e]||t.info}destroy(){window.removeEventListener("resize",this.setupResponsiveBehavior),this.hideActiveFiltersPopup(),this.elements={},this.currentFilters={},this.currentQuery="",this.config=null,this.isInitialized=!1}resetInterface(){this.currentFilters={},this.currentQuery="",this.updateActiveFiltersCount(0),this.updateResultsCount(0),this.hideActiveFiltersPopup(),this.closeAllPanels(),this.resetFacetsInterface(),this.clearSearchInput()}resetFacetsInterface(){const e=document.getElementById("facets-container");if(!e)return;e.querySelectorAll('input[type="checkbox"]').forEach(i=>{i.checked=!1}),e.querySelectorAll('[id$="-slider"]').forEach(i=>{if(i.noUiSlider)try{const o=i.noUiSlider.options.range;i.noUiSlider.set([o.min,o.max]);const l=i.id.replace("-slider",""),a=document.getElementById(`${l}-min-input`),d=document.getElementById(`${l}-max-input`);a&&(a.value=o.min),d&&(d.value=o.max);const u=document.getElementById(`${l}-chart`);if(u){const g=u.querySelector(`#${l}-chart-highlight`);g&&(g.style.left="0%",g.style.width="100%")}}catch(o){console.warn(`Failed to reset slider ${i.id}:`,o)}}),e.querySelectorAll(".toggle-btn").forEach(i=>{const o=i.dataset.path,l=e.querySelector(`[data-parent="${o}"]`);l&&l.style.display!=="none"&&(l.style.display="none",i.textContent="")})}clearSearchInput(){const e=["#search-input","#query-input",".search-input",'input[type="search"]','input[placeholder*="search" i]','input[placeholder*="cerca" i]'];for(const t of e){const n=document.querySelector(t);if(n){n.value="",n.dispatchEvent(new Event("input",{bubbles:!0}));break}}}_updateChartHighlight(e,t,n,s){if(!e||!t||t.length===0)return;const i=e.querySelector(`#${e.id}-highlight`);if(!i)return;const o=t[t.length-1].value-t[0].value;if(o<=0)return;const l=(n-t[0].value)/o*100,a=(s-n)/o*100;i.style.left=`${Math.max(0,l)}%`,i.style.width=`${Math.max(0,Math.min(100,a))}%`}initializeLayerButton(e){const t=document.querySelector("#map-layer-selector");if(!t)return;const n=e.map.tileLayers;let s=null,i="Default";t.style.cursor="pointer",t.title="Clicca per cambiare layer",t.addEventListener("click",a=>{a.stopPropagation(),this.showLayerSelectionPopup()}),this.showLayerSelectionPopup=()=>{if(document.getElementById("layer-selection-popup")){this.hideLayerSelectionPopup();return}const d=t.getBoundingClientRect(),u=document.createElement("div");u.id="layer-selection-popup",u.className="fixed p-2 w-72 max-w-sm bg-white rounded-lg shadow-2xl border border-gray-200 max-h-96 overflow-hidden",u.style.zIndex="9999",u.style.left=`${d.left}px`,u.style.bottom=`${window.innerHeight-d.top+10}px`;const g=288;d.left+g>window.innerWidth&&(u.style.left=`${window.innerWidth-g-16}px`);const p=document.createElement("div");p.className="flex items-center justify-between mb-2",p.innerHTML=`
                <h3 class="p-2 text-sm font-semibold text-gray-800">Seleziona Layer</h3>
                <button id="close-layer-popup" class="absolute top-2 right-2 p-1.5 bg-pink-100 hover:bg-pink-200 active:bg-pink-200 rounded-full text-red-500 shadow-md hover:shadow-lg group">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;const y=document.createElement("div");y.className="space-y-1 max-h-64 overflow-y-auto overflow-x-hidden mb-3 p-3 rounded-lg bg-gray-50 border border-gray-200";const f=this.buildLayersContent(n);y.innerHTML=f,u.appendChild(p),u.appendChild(y),document.body.appendChild(u),this.bindLayerPopupEvents(u)},this.buildLayersContent=a=>{let d="";for(let u in a){const g=u===i,p=a[u];d+=`
                    <div class="layer-item flex items-center justify-between p-2 rounded hover:bg-gray-100 cursor-pointer" 
                        data-layer-name="${u}" 
                        data-layer-url="${p.tileLayer}"
                        data-layer-attribution="${p.attribution}">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-700">${u}</span>
                        </div>
                        <div class="flex items-center">
                            ${g?`
                                <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                            `:""}
                        </div>
                    </div>
                `}return d},this.bindLayerPopupEvents=a=>{const d=a.querySelector("#close-layer-popup");d&&d.addEventListener("click",()=>{this.hideLayerSelectionPopup()}),a.querySelectorAll(".layer-item").forEach(g=>{g.addEventListener("click",p=>{const y=g.dataset.layerName,f=g.dataset.layerUrl,v=g.dataset.layerAttribution;o(y,f,v),this.hideLayerSelectionPopup()})}),document.addEventListener("click",this.handleOutsideClick),document.addEventListener("keydown",this.handleEscapeKey)},this.hideLayerSelectionPopup=()=>{const a=document.getElementById("layer-selection-popup");a&&(a.remove(),document.removeEventListener("click",this.handleOutsideClick),document.removeEventListener("keydown",this.handleEscapeKey))},this.handleOutsideClick=a=>{const d=document.getElementById("layer-selection-popup");d&&!d.contains(a.target)&&!t.contains(a.target)&&this.hideLayerSelectionPopup()},this.handleEscapeKey=a=>{a.key==="Escape"&&this.hideLayerSelectionPopup()};function o(a,d,u){l(a),s&&window.map.removeLayer(s),s=L.tileLayer(d,{attribution:u,maxZoom:18}),s.addTo(window.map),i=a,console.log(`Layer changed to: ${a}`),window.dispatchEvent(new CustomEvent("layerChanged",{detail:{layerName:a,layerUrl:d,attribution:u}}))}function l(a){const d=t.querySelector("i")||t.querySelector(".icon");d?(t.innerHTML="",t.appendChild(d),t.appendChild(document.createTextNode("Strati cartografici"))):t.textContent=a}l(i)}initializeMarkersSelector(){const e=document.querySelector("#map-markers-selector");if(!e)return;const t={clusters:{name:"Clusters geografici",description:"Raggruppamenti dinamici"},pins:{name:"Pin con numeri",description:"Pin con conteggio occorrenze"},circles:{name:"Cerchi Proporzionali",description:"Cerchi con diametro basato su occorrenze"}};let n="clusters";e.style.cursor="pointer",e.title="Clicca per cambiare tipo di marker",e.addEventListener("click",o=>{o.stopPropagation(),this.showMarkersSelectionPopup()}),this.showMarkersSelectionPopup=()=>{if(document.getElementById("markers-selection-popup")){this.hideMarkersSelectionPopup();return}const l=e.getBoundingClientRect(),a=document.createElement("div");a.id="markers-selection-popup",a.className="fixed p-2 w-72 max-w-sm bg-white rounded-lg shadow-2xl border border-gray-200 max-h-96 overflow-hidden",a.style.zIndex="9999",a.style.left=`${l.left}px`,a.style.bottom=`${window.innerHeight-l.top+10}px`;const d=288;l.left+d>window.innerWidth&&(a.style.left=`${window.innerWidth-d-16}px`);const u=document.createElement("div");u.className="flex items-center justify-between mb-2",u.innerHTML=`
                <h3 class="p-2 text-sm font-semibold text-gray-800">Tipo di Marker</h3>
                <button id="close-markers-popup" class="absolute top-2 right-2 p-1.5 bg-pink-100 hover:bg-pink-200 active:bg-pink-200 rounded-full text-red-500 shadow-md hover:shadow-lg group">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;const g=document.createElement("div");g.className="space-y-1 max-h-64 overflow-y-auto overflow-x-hidden";const p=this.buildMarkersContent(t);g.innerHTML=p,a.appendChild(u),a.appendChild(g),document.body.appendChild(a),this.bindMarkersPopupEvents(a)},this.buildMarkersContent=o=>{let l="";for(let a in o){const d=a===n,u=o[a];let g="";switch(a){case"clusters":g=`
                            <svg class="w-4 h-4 text-primary-500" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"></path>
                            </svg>
                        `;break;case"pins":g=`
                            <svg class="w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                            </svg>
                        `;break;case"circles":g=`
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm0-2a6 6 0 100-12 6 6 0 000 12z" clip-rule="evenodd"></path>
                            </svg>
                        `;break}l+=`
                    <div class="marker-item flex items-center justify-between p-2 rounded hover:bg-gray-50 hover:shadow-md cursor-pointer" 
                         data-marker-type="${a}">
                        <div class="flex items-center space-x-3">
                            ${g}
                            <div>
                                <span class="text-sm font-medium text-gray-700">${u.name}</span>
                                <p class="text-xs text-gray-500">${u.description}</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            ${d?`
                                <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                            `:""}
                        </div>
                    </div>
                `}return l},this.bindMarkersPopupEvents=o=>{const l=o.querySelector("#close-markers-popup");l&&l.addEventListener("click",()=>{this.hideMarkersSelectionPopup()}),o.querySelectorAll(".marker-item").forEach(d=>{d.addEventListener("click",u=>{const g=d.dataset.markerType;s(g),this.hideMarkersSelectionPopup()})}),document.addEventListener("click",this.handleMarkersOutsideClick),document.addEventListener("keydown",this.handleMarkersEscapeKey)},this.hideMarkersSelectionPopup=()=>{const o=document.getElementById("markers-selection-popup");o&&(o.remove(),document.removeEventListener("click",this.handleMarkersOutsideClick),document.removeEventListener("keydown",this.handleMarkersEscapeKey))},this.handleMarkersOutsideClick=o=>{const l=document.getElementById("markers-selection-popup");l&&!l.contains(o.target)&&!e.contains(o.target)&&this.hideMarkersSelectionPopup()},this.handleMarkersEscapeKey=o=>{o.key==="Escape"&&this.hideMarkersSelectionPopup()};const s=o=>{i(t[o].name),n=o,window.switchMarkerType?window.switchMarkerType(o):this.mapInstance&&this.mapInstance.switchMarkerType?this.mapInstance.switchMarkerType(o):console.warn("No switchMarkerType function available"),console.log(`Marker type changed to: ${o}`),window.dispatchEvent(new CustomEvent("markerTypeChanged",{detail:{markerType:o,markerName:t[o].name}}))},i=o=>{const l=e.querySelector("i")||e.querySelector(".icon");l?(e.innerHTML="",e.appendChild(l),e.appendChild(document.createTextNode(` ${o}`))):e.textContent=o};i(t[n].name)}}const ni=new ri;class Ir{constructor(){this.originalFacetData=null}renderTaxonomy(e,t,n,s){this.originalFacetData||(this.originalFacetData=JSON.parse(JSON.stringify(t)));const i=this._buildHierarchy(this.originalFacetData);this._calculateTotalCounts(i),e.className="taxonomy-container max-w-full overflow-x-auto max-h-80 overflow-y-auto border border-gray-200 rounded-lg p-2",e.innerHTML=this._createTaxonomyHTML(i,[],0,n,s),this._addToggleListeners(e),this._addCheckboxListeners(e,i,n)}resetOriginalData(){this.originalFacetData=null}_buildHierarchy(e){const t={};return Array.isArray(e)&&e.forEach(n=>{const s=n.key.split(" > ");let i=t;s.forEach((o,l)=>{i[o]||(i[o]={children:{},docCount:0,selfCount:0}),l===s.length-1&&(i[o].selfCount=n.doc_count),i=i[o].children})}),t}_calculateTotalCounts(e){const t=n=>{let s=n.selfCount||0;return Object.values(n.children||{}).forEach(i=>{s+=t(i)}),n.docCount=s,s};Object.values(e).forEach(n=>{t(n)})}_hasSelectedChild(e,t,n=[]){for(const[s,i]of Object.entries(e)){if(["children","docCount","selfCount"].includes(s))continue;const o=[...n,s].join(" > ");if(t.includes(o)||Object.keys(i.children).length>0&&this._hasSelectedChild(i.children,t,[...n,s]))return!0}return!1}_createTaxonomyHTML(e,t=[],n=0,s,i){const o=i[s]||[];let l='<div class="space-y-1">';return Object.entries(e).forEach(([a,d])=>{if(["children","docCount","selfCount"].includes(a))return;const u=[...t,a],g=u.join(" > "),p=Object.keys(d.children).length>0,y=o.includes(g),f=p&&this._hasSelectedChild(d.children,o,u),v=y||f;l+=`
        <div class="taxonomy-item">
          <label class="cursor-pointer block facet-option" style="display: grid; grid-template-columns: ${n*20}px auto 1fr auto; gap: 8px; align-items: center;" data-search-text="${a.toLowerCase()}">
            <!-- Indentation spacer -->
            <div></div>
            
            <!-- Toggle button -->
            ${p?`<button class="toggle-btn flex-shrink-0 w-5 h-5 flex items-center justify-center rounded hover:bg-gray-200 transition-colors" data-path="${g}">
                <svg class="w-3 h-3 text-gray-600 transform transition-transform duration-200 ${v?"rotate-90":""}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </button>`:'<div class="w-5 h-5 flex-shrink-0"></div>'}
            
            <!-- Content container with checkbox and text -->
            <div class="flex items-center gap-2 min-w-0">
              <input type="checkbox" value="${g}" data-facet-type="${s}" class="form-checkbox flex-shrink-0" ${y?"checked":""}>
              <span class="text-sm ${y?"font-medium text-primary-700":""} truncate">${a}</span>
            </div>
            
            <!-- Count (always in the last column) -->
            <span class="text-xs text-secondary-500 bg-secondary-100 px-2 py-0.5 rounded-full flex-shrink-0 ${d.docCount===0?"text-secondary-800 bg-secondary-100":""}">${d.docCount}</span>
          </label>
          
          ${p?`<div class="children ${v?"":"hidden"}" data-parent="${g}">
              ${this._createTaxonomyHTML(d.children,u,n+1,s,i)}
            </div>`:""}
        </div>`}),l+"</div>"}_getParentPaths(e){const t=e.split(" > "),n=[];for(let s=1;s<t.length;s++)n.push(t.slice(0,s).join(" > "));return n}_getAllChildPaths(e,t=[]){const n=[];return Object.entries(e).forEach(([s,i])=>{if(["children","docCount","selfCount"].includes(s))return;const o=[...t,s].join(" > ");n.push(o),Object.keys(i.children).length>0&&n.push(...this._getAllChildPaths(i.children,[...t,s]))}),n}_getChildPathsForNode(e,t){const n=t.split(" > ");let s=e;for(const i of n)if(s[i])s=s[i];else return[];return this._getAllChildPaths(s.children,n)}_addToggleListeners(e){e.addEventListener("click",t=>{if(t.target.closest(".toggle-btn")){const n=t.target.closest(".toggle-btn"),s=n.dataset.path,i=e.querySelector(`[data-parent="${s}"]`),o=n.querySelector("svg");if(i&&o){const l=i.classList.contains("hidden");i.classList.toggle("hidden"),o.classList.toggle("rotate-90",l)}}})}_addCheckboxListeners(e,t,n){e._hierarchy=t,e.addEventListener("change",s=>{if(s.target.type==="checkbox"){const i=s.target,o=i.value,l=i.checked;s.stopPropagation();const a=this._getParentPaths(o)||[],d=this._getChildPathsForNode(t,o)||[];this._updateRelatedCheckboxes(e,t,o,l,a,d);const u=new CustomEvent("taxonomyChange",{detail:{facetKey:n,path:o,checked:l,action:l?"add":"remove"}});e.dispatchEvent(u)}})}_updateRelatedCheckboxes(e,t,n,s,i,o){s?(i==null||i.forEach(l=>{const a=e.querySelector(`input[value="${l}"]`);a&&!a.checked&&(a.checked=!0,this._updateCheckboxVisuals(a,!0))}),o==null||o.forEach(l=>{const a=e.querySelector(`input[value="${l}"]`);a&&!a.checked&&(a.checked=!0,this._updateCheckboxVisuals(a,!0))})):(o==null||o.forEach(l=>{const a=e.querySelector(`input[value="${l}"]`);a&&a.checked&&(a.checked=!1,this._updateCheckboxVisuals(a,!1))}),i==null||i.forEach(l=>{const a=e.querySelector(`input[value="${l}"]`);a&&a.checked&&((this._getChildPathsForNode(t,l)||[]).some(g=>{const p=e.querySelector(`input[value="${g}"]`);return p&&p.checked})||(a.checked=!1,this._updateCheckboxVisuals(a,!1)))})),this._updateCheckboxVisuals(e.querySelector(`input[value="${n}"]`),s)}_updateCheckboxVisuals(e,t){if(!e)return;const n=e.closest("label"),s=n==null?void 0:n.querySelector("span.text-sm");s&&(s.classList.toggle("font-medium",t),s.classList.toggle("text-primary-700",t))}_renderTaxonomyFacet(e,t,n,s,i,o){const l=document.createElement("div"),a=s[t]||[];this.renderTaxonomy(l,a,t,i),l.addEventListener("taxonomyChange",d=>{const{facetKey:u,path:g,checked:p,action:y}=d.detail;o({type:"FACET_CHANGE",facetType:u,value:g,checked:p})}),e.appendChild(l)}}class $r{constructor(){this.playIntervals=new Map,this.playStates=new Map}_renderRangeFacet(e,t,n,s,i,o,l){const a=document.createElement("div");a.className="facet-slider my-3";const u=(s[t]||[]).map(F=>{const T=parseInt(F.key,10);return isNaN(T)?null:{value:T,count:F.doc_count||0}}).filter(F=>F!==null),g=u.map(F=>F.value),p=Math.min(...g),y=Math.max(...g);a.innerHTML=`
      <div class="space-y-3">
        <!-- Play Controls -->
        <div class="flex items-center justify-center gap-2 pb-3 border-b border-gray-200">
          <button id="${t}-play-btn" class="group relative w-8 h-8 bg-gradient-to-r from-primary-400 to-primary-700 text-white text-xs rounded-full transition-colors duration-200 hover:from-primary-600 hover:to-primary-700 shadow-md hover:shadow-lg flex items-center justify-center" type="button">
            <div class="w-0 h-0 border-l-[5px] border-l-white border-y-[3px] border-y-transparent ml-0.5"></div>
            <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap">Play</span>
          </button>
          <button id="${t}-pause-btn" class="group relative w-8 h-8 bg-gradient-to-r from-secondary-400 to-secondary-700 text-white text-xs rounded-full transition-colors duration-200 hover:from-secondary-600 hover:to-secondary-700 shadow-md hover:shadow-lg flex items-center justify-center" type="button">
            <div class="flex gap-0.5">
              <div class="w-0.5 h-3 bg-white rounded-sm"></div>
              <div class="w-0.5 h-3 bg-white rounded-sm"></div>
            </div>
            <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap">Pause</span>
          </button>
        </div>

        <!-- Chart Container -->
        <div class="relative">
          <div id="${t}-chart" class="w-full h-16 mb-3 bg-gray-50 rounded-md p-2"></div>
        </div>
        
        <!-- Slider Container -->
        <div class="px-1">
          <div id="${t}-slider" class="slider-container"></div>
        </div>
        
        <!-- Value Display -->
        <div class="flex items-center justify-between text-xs text-gray-600 px-1">
          <span id="${t}-current-min" class="font-medium">${p}</span>
          <span id="${t}-current-max" class="font-medium">${y}</span>
        </div>
        
        <!-- Custom Range Inputs - Fixed Layout -->
        <div class="mt-4 pt-3 border-t border-gray-100">
          <div class="text-xs font-medium text-gray-700 mb-2">Custom range:</div>
          <div class="grid grid-cols-2 gap-2">
            <div class="min-w-0">
              <input id="${t}-min-input" type="number"
                     class="w-full px-2 py-1 text-xs border border-gray-200 rounded focus:ring-1 focus:ring-primary-400 focus:border-primary-400 focus:outline-none"
                     value="${p}"
                     placeholder="Min">
            </div>
            <div class="min-w-0">
              <input id="${t}-max-input" type="number"
                     class="w-full px-2 py-1 text-xs border border-gray-200 rounded focus:ring-1 focus:ring-primary-400 focus:border-primary-400 focus:outline-none"
                     value="${y}"
                     placeholder="Max">
            </div>
          </div>
        </div>
      </div>
    `,e.appendChild(a);const f=a.querySelector(`#${t}-chart`),v=a.querySelector(`#${t}-slider`),x=a.querySelector(`#${t}-min-input`),k=a.querySelector(`#${t}-max-input`),I=a.querySelector(`#${t}-current-min`),P=a.querySelector(`#${t}-current-max`),M=a.querySelector(`#${t}-play-btn`),z=a.querySelector(`#${t}-pause-btn`);this.renderBarChart(f,u,p,y);const S=o.filters[t];let E,q;!S||S.length===0?(E=p,q=y):(E=S[0],q=S[1]),noUiSlider.create(v,{start:[E,q],connect:!0,step:1,range:{min:p,max:y},format:{to:F=>Math.round(F),from:F=>parseInt(F,10)}}),a.slider=v,a.minInput=x,a.maxInput=k,a.currentMinSpan=I,a.currentMaxSpan=P,a.chartElement=f,v.classList.add("custom-slider");const Z=document.createElement("style");document.querySelector("#custom-slider-styles")||(Z.id="custom-slider-styles",document.head.appendChild(Z));let W=null;x.addEventListener("focus",()=>{W=x}),k.addEventListener("focus",()=>{W=k}),x.addEventListener("blur",()=>{setTimeout(()=>{W===x&&(W=null)},100)}),k.addEventListener("blur",()=>{setTimeout(()=>{W===k&&(W=null)},100)}),v.noUiSlider.on("update",F=>{const[T,R]=F.map(m=>Math.round(Number(m)));W!==x&&(x.value=T),W!==k&&(k.value=R),I.textContent=T.toString(),P.textContent=R.toString()}),v.noUiSlider.on("change",F=>{const[T,R]=F.map(m=>Math.round(Number(m)));!isNaN(T)&&!isNaN(R)&&(this.playStates.delete(t),l({type:"RANGE_CHANGE",facetKey:t,value:[T,R]}),this.updateChartHighlight(f,u,T,R))});const D=F=>{const T=F.target===x,R=parseInt(F.target.value,10),[m,c]=v.noUiSlider.get().map(Number);if(!isNaN(R)){const h=T?Math.max(p,Math.min(R,c)):m,w=T?c:Math.min(y,Math.max(R,m));this.playStates.delete(t);const b=W;v.noUiSlider.set([h,w]),b===x&&(x.value=h),b===k&&(k.value=w),l({type:"RANGE_CHANGE",facetKey:t,value:[h,w]}),this.updateChartHighlight(f,u,h,w)}};x.addEventListener("change",D),k.addEventListener("change",D);const V=F=>{F.key==="Enter"&&F.target.blur()};x.addEventListener("keypress",V),k.addEventListener("keypress",V),this.setupPlayControls(t,M,z,v,p,y,l,f,u),this.updateChartHighlight(f,u,E,q)}setupPlayControls(e,t,n,s,i,o,l,a,d){t.addEventListener("click",u=>{u.preventDefault(),u.stopPropagation(),console.log("Play button clicked for:",e),this.startPlay(e,t,n,s,i,o,l,a,d)}),n.addEventListener("click",u=>{u.preventDefault(),u.stopPropagation(),console.log("Pause button clicked for:",e),this.pausePlay(e,t,n)})}startPlay(e,t,n,s,i,o,l,a,d){if(this.playIntervals.has(e))return;const[u,g]=s.noUiSlider.get().map(Number);let p=this.playStates.get(e);p||(p={startMin:u,currentMax:u+1,originalMin:u,originalMax:g},this.playStates.set(e,p)),t.disabled=!0,t.innerHTML=`
      <div class="flex gap-0.5">
        <div class="w-0.5 h-3 bg-white rounded-sm"></div>
        <div class="w-0.5 h-3 bg-white rounded-sm"></div>
      </div>
      <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap">Playing...</span>
    `,t.className="group relative w-8 h-8 bg-gradient-to-r from-primary-500 to-indigo-600 text-white text-xs rounded-full transition-colors duration-200 shadow-md flex items-center justify-center opacity-75 cursor-not-allowed",n.disabled=!1,n.className="group relative w-8 h-8 bg-gradient-to-r from-red-500 to-pink-600 text-white text-xs rounded-full transition-colors duration-200 hover:from-red-600 hover:to-pink-700 shadow-md hover:shadow-lg flex items-center justify-center animate-pulse",console.log("Button states after start:",{playDisabled:t.disabled,pauseDisabled:n.disabled});const y=setInterval(()=>{const f=this.playStates.get(e);if(!f){clearInterval(y),this.playIntervals.delete(e);return}let{startMin:v,currentMax:x}=f;if(x=Math.min(x+1,o),x>=o){this.pausePlay(e,t,n);return}this.playStates.set(e,{...f,currentMax:x}),s.noUiSlider.set([v,x]),l({type:"RANGE_CHANGE",facetKey:e,value:[v,x]}),this.updateChartHighlight(a,d,v,x)},500);this.playIntervals.set(e,y)}pausePlay(e,t,n){const s=this.playIntervals.get(e);s&&(clearInterval(s),this.playIntervals.delete(e)),t.disabled=!1,t.innerHTML=`
      <div class="w-0 h-0 border-l-[5px] border-l-white border-y-[3px] border-y-transparent ml-0.5"></div>
      <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap">Play</span>
    `,t.className="group relative w-8 h-8 bg-gradient-to-r from-primary-500 to-primary-600 text-white text-xs rounded-full transition-colors duration-200 hover:from-primary-600 hover:to-primary-700 shadow-md hover:shadow-lg flex items-center justify-center",n.disabled=!0,n.className="group relative w-8 h-8 bg-gradient-to-r from-secondary-500 to-secondary-600 text-white text-xs rounded-full transition-colors duration-200 shadow-md flex items-center justify-center opacity-50 cursor-not-allowed"}updateRangeFacet(e,t,n,s,i,o,l){const a=e.querySelector(".facet-slider");if(!a)return;const d=a.querySelector(`#${t}-play-btn`),u=a.querySelector(`#${t}-pause-btn`);d&&u&&this.pausePlay(t,d,u);const p=(s[t]||[]).map(E=>{const q=parseInt(E.key,10);return isNaN(q)?null:{value:q,count:E.doc_count||0}}).filter(E=>E!==null),y=p.map(E=>E.value),f=Math.min(...y),v=Math.max(...y),x=a.slider,k=a.minInput,I=a.maxInput;a.currentMinSpan,a.currentMaxSpan;const P=a.chartElement;if(!x||!x.noUiSlider)return;this.renderBarChart(P,p,f,v),x.noUiSlider.get().map(Number),x.noUiSlider.updateOptions({range:{min:f,max:v}});const M=o.filters[t];let z,S;!M||M.length===0?(z=f,S=v):(z=Math.max(f,Math.min(M[0],v)),S=Math.min(v,Math.max(M[1],f))),x.noUiSlider.set([z,S]),k.setAttribute("min",f),k.setAttribute("max",v),k.placeholder=`Min (${f})`,I.setAttribute("min",f),I.setAttribute("max",v),I.placeholder=`Max (${v})`,this.updateChartHighlight(P,p,z,S),(!M||M.length===0||M[0]!==z||M[1]!==S)&&l({type:"RANGE_CHANGE",facetKey:t,value:[z,S]})}renderBarChart(e,t,n,s,i=null){e.innerHTML="";const o=Math.max(...t.map(u=>u.count));this.sortedBuckets=[...t].sort((u,g)=>u.value-g.value);const l=document.createElement("div");l.className="w-full h-full flex flex-col",e.appendChild(l);const a=document.createElement("div");a.className="w-full flex-1 rounded px-1 overflow-hidden",a.style.height="150px",l.appendChild(a);const d=document.createElement("div");d.className="flex items-end w-full h-full",a.appendChild(d),this.sortedBuckets.forEach(u=>{const g=o>0?u.count/o*90:0,p=document.createElement("div");p.className="flex-1 mx-px transition-colors duration-200",p.style.height=`${Math.max(g,1)}%`,p.dataset.value=u.value,p.dataset.count=u.count,p.title=`Value: ${u.value}, Count: ${u.count}`,d.appendChild(p)})}updateChartHighlight(e,t,n,s){const i=e.querySelector(".flex.items-end");if(!i){console.warn("Bars container not found");return}i.querySelectorAll("[data-value]").forEach(l=>{const a=parseInt(l.dataset.value);a>=n&&a<=s?l.style.backgroundColor="#b0c4de":l.style.backgroundColor="#d1d5db"})}_debounce(e,t){let n;return function(){clearTimeout(n),n=setTimeout(()=>e.apply(this,arguments),t)}}}class si{constructor(e){this.config=e,this.taxonomyRenderer=new Ir,this.rangeRenderer=new $r,this.searchTerms={}}renderFacets(e,t,n){if(!e||!this.config.aggregations){console.error("No aggregations data or configuration available.");return}const s=document.getElementById("facets-container"),i=this._getCheckedState();s.innerHTML="";const o={};Object.entries(this.config.aggregations).forEach(([l,a])=>{const d=a.category||"Other";o[d]||(o[d]=[]),o[d].push({facetKey:l,facetConfig:a})}),Object.entries(o).forEach(([l,a])=>{const d=document.createElement("div");d.className="facet-category",d.setAttribute("data-category",l);const u=document.createElement("h3");u.className="facet-category-title",u.textContent=l,d.appendChild(u);const g=document.createElement("div");g.className="facet-category-content",a.forEach(({facetKey:p,facetConfig:y})=>{const f=this._createFacetGroup(p,y);y.type==="range"?this.rangeRenderer._renderRangeFacet(f,p,y,e,i,t,n):y.type==="taxonomy"?this.taxonomyRenderer._renderTaxonomyFacet(f,p,y,e,i,n):this._renderStandardFacet(f,p,y,e,i),g.appendChild(f)}),d.appendChild(g),s.appendChild(d)}),this._addFacetEventListeners(n)}_filterFacetOptions(e,t){const n=e.querySelectorAll("label");let s=0;n.forEach(o=>{const l=o.textContent.toLowerCase(),a=t===""||l.includes(t);o.style.display=a?"block":"none",a&&s++}),(e.querySelector(".facet-options")||e.querySelector("div"))&&(e.style.display=s>0?"block":"none")}_updateCategoryVisibility(){document.querySelectorAll(".facet-category").forEach(t=>{const n=t.querySelectorAll('.facet-group[style*="display: block"], .facet-group:not([style*="display: none"])'),s=Array.from(n).some(i=>i.style.display!=="none");t.style.display=s?"block":"none"})}_getCheckedState(){const e={};return Object.keys(this.config.aggregations).forEach(t=>{const n=document.getElementById(`${t}-facet`);n&&(e[t]=Array.from(n.querySelectorAll("input:checked")).map(s=>s.value))}),e}_createFacetGroup(e,t){const n=document.createElement("div");n.className="facet-group mb-4 p-4 bg-white rounded-lg shadow",n.id=`${e}-facet`;const s=document.createElement("div");s.className="facet-header mb-3";const i=document.createElement("h3");if(i.className="text-lg font-semibold mb-2",i.textContent=t.title||e,s.appendChild(i),t.type!=="range"){const o=document.createElement("div");o.className="facet-search mb-2";const l=document.createElement("input");l.type="text",l.className="facet-search-input w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary-500",l.placeholder="Cerca...",l.id=`search-${e}`;const a=this._debounce(d=>{this._searchWithinFacet(e,d)},300);l.addEventListener("input",d=>{a(d.target.value)}),o.appendChild(l),s.appendChild(o)}return n.appendChild(s),n}_searchWithinFacet(e,t){const n=document.getElementById(`${e}-facet`);n&&(this.searchTerms[e]=t.toLowerCase().trim(),this._filterFacetOptions(n,this.searchTerms[e]))}_renderStandardFacet(e,t,n,s,i){const o=document.createElement("div");o.className="facet-options space-y-2",(s[t]||[]).forEach(a=>{var f;const d=document.createElement("label");d.className="cursor-pointer block facet-option flex items-center justify-between",d.style.display="flex",d.setAttribute("data-search-text",a.key.toLowerCase()),a.doc_count===0&&d.classList.add("text-gray-400");const u=document.createElement("div");u.className="flex items-center";const g=document.createElement("input");g.type="checkbox",g.value=a.key,g.className="form-checkbox mr-2",g.dataset.facetType=t,(f=i[t])!=null&&f.includes(a.key)&&(g.checked=!0);const p=document.createElement("span");p.textContent=a.key,p.className="text-sm";const y=document.createElement("span");y.textContent=a.doc_count,y.className=`text-xs text-secondary-500 bg-secondary-100 px-2 py-0.5 rounded-full flex-shrink-0 ml-auto ${a.doc_count===0?"text-seconday-800 bg-secondary-100":""}`,u.appendChild(g),u.appendChild(p),d.appendChild(u),d.appendChild(y),o.appendChild(d)}),e.appendChild(o)}_addFacetEventListeners(e){if(!this.config.aggregations){console.error("Aggregations configuration not found");return}Object.keys(this.config.aggregations).forEach(t=>{const n=document.getElementById(`${t}-facet`);n&&n.querySelectorAll('input[type="checkbox"]').forEach(s=>{s.addEventListener("change",i=>{this._onFacetChange(i,e)})})})}_onFacetChange(e,t){const{value:n,checked:s}=e.target,i=e.target.dataset.facetType;t({type:"FACET_CHANGE",facetType:i,value:n,checked:s})}clearAllSearches(){this.searchTerms={},Object.keys(this.config.aggregations).forEach(s=>{const i=document.getElementById(`search-${s}`);i&&(i.value="")}),document.querySelectorAll(".facet-option, label").forEach(s=>{s.style.display="block"}),document.querySelectorAll(".facet-group").forEach(s=>{s.style.display="block"}),document.querySelectorAll(".facet-category").forEach(s=>{s.style.display="block"})}_debounce(e,t){let n;return function(){clearTimeout(n),n=setTimeout(()=>e.apply(this,arguments),t)}}}class ii{constructor(e,t){this.searchEngine=e,this.config=t}performSearch(e,t={}){if(!this.searchEngine){console.error("Search engine not initialized");return}const{filters:n}=e,{regularFilters:s,dateFilters:i,taxonomyFilters:o}=this._separateFilters(n),l=this.searchEngine.search({query:e.query||"",filters:s,sort:e.sort||"title_asc",per_page:526,filter:d=>this._customFilter(d,i,o)}),a=this._extractCoordinates(l.data.items);if(t.onMarkersUpdate&&t.onMarkersUpdate(l.data.items),t.onResultsUpdate&&t.onResultsUpdate(l.data.items),t.onAggregationsUpdate){const d=this._formatAggregations(l.data.aggregations);t.onAggregationsUpdate(d)}return{items:l.data.items,coordinates:a,aggregations:this._formatAggregations(l.data.aggregations)}}_separateFilters(e){const t={},n={},s={};return Object.entries(e).forEach(([i,o])=>{if(!o||o.length===0)return;const l=this.config.aggregations[i];if(l)switch(l.type){case"range":n[i]=o;break;case"taxonomy":s[i]=o;break;default:t[i]=o}}),{regularFilters:t,dateFilters:n,taxonomyFilters:s}}_customFilter(e,t,n){for(const[s,i]of Object.entries(t))if(i.length===2){const[o,l]=i,a=new Date(e[s]).getTime();if(!(a>=o&&a<=l))return!1}for(const[s,i]of Object.entries(n)){if(!e[s])return!1;const o=e[s];let l;if(Array.isArray(o)?l=o.length>0?String(o[0]):"":typeof o=="string"?l=o:l=String(o||""),!i.some(d=>l===d||l.startsWith(d+" > ")))return!1}return!0}_extractCoordinates(e){return e.filter(t=>t.lat_long&&t.lat_long.length>0).map(t=>{const n=t.lat_long[0],[s,i]=n.split(",");return[parseFloat(s),parseFloat(i)]})}_formatAggregations(e){const t={};for(const n in e)e.hasOwnProperty(n)&&(t[n]=e[n].buckets);return t}}class oi{constructor(e,t=null){this.mapFocusCallback=e,this.config=t,this.allWorks=[],this.items=[],this.searchState=null,this.isModalOpen=!1,this.currentModalIndex=0,this.isAnimating=!1}setData(e,t){this.allWorks=e,this.items=t}setConfig(e){this.config=e}setSearchState(e){this.searchState=e}_getCompleteWorkData(e){const t=this.items.filter(o=>o.pivot_ID===e);if(t.length===0)return null;const n=t[0],s={pivot_ID:e,Title:n[window.ledaSearch.config.result_cards.card_title],Subtitle:n[window.ledaSearch.config.result_cards.card_subtitle],Subtitle2:n[window.ledaSearch.config.result_cards.card_subtitle_2],Location:[],coordinates:[],allEntries:t,geodataBySpace:new Map},i=new Map;return t.forEach(o=>{o.Location&&(Array.isArray(o.Location)?o.Location:[o.Location]).forEach((a,d)=>{if(!i.has(a)){const u=this._extractCoordinates(o,d);i.set(a,u);const g=this._getGeodataFields(),p={};g.forEach(y=>{o[y]!==void 0&&o[y]!==null&&o[y]!==""&&(Array.isArray(o[y])&&o[y].length>d?p[y]=o[y][d]:Array.isArray(o[y])||(p[y]=o[y]))}),s.geodataBySpace.set(a,p)}})}),s.Location=Array.from(i.keys()),s.coordinates=Array.from(i.values()),s}_getCatalogueFields(){var e,t,n;return((n=(t=(e=this.config)==null?void 0:e.datasetConfig)==null?void 0:t.fields)==null?void 0:n.catalogue)||[]}_getGeodataFields(){var e,t,n;return((n=(t=(e=this.config)==null?void 0:e.datasetConfig)==null?void 0:t.fields)==null?void 0:n.geodata)||[]}_getAllMetadataFields(){const e=this._getCatalogueFields(),t=this._getGeodataFields();return[...new Set([...e,...t])]}_renderSelectedFilters(){if(!this.searchState||!this.searchState.filters)return"";const e=[];return this.searchState.query&&this.searchState.query.trim()&&e.push(`
        <div class="inline-flex items-center gap-2 px-3 py-1 bg-secondary-100 text-secondary-800 rounded-full text-sm font-medium">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
            <path fill-rule="evenodd" d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z" clip-rule="evenodd" />
          </svg>
          <span>Ricerca: "${this.searchState.query}"</span>
        </div>
      `),Object.entries(this.searchState.filters).forEach(([t,n])=>{Array.isArray(n)&&n.length>0?n.forEach(s=>{e.push(`
            <div class="inline-flex items-center gap-2 px-3 py-1 bg-primary-100 text-primary-800 rounded-full text-sm font-medium">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
                <path d="M2 3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1a1 1 0 0 1-.293.707L10 8.414V12a1 1 0 0 1-.293.707l-2 2A1 1 0 0 1 6 14v-5.586L2.293 4.707A1 1 0 0 1 2 4V3Z" />
              </svg>
              <span>${t}: ${s}</span>
            </div>
          `)}):n&&!Array.isArray(n)&&e.push(`
          <div class="inline-flex items-center gap-2 px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
              <path d="M2 3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1a1 1 0 0 1-.293.707L10 8.414V12a1 1 0 0 1-.293.707l-2 2A1 1 0 0 1 6 14v-5.586L2.293 4.707A1 1 0 0 1 2 4V3Z" />
            </svg>
            <span>${t}: ${n}</span>
          </div>
        `)}),e.length===0?"":`
      <div class="flex flex-wrap items-center gap-2 bg-white/80 backdrop-blur-sm rounded-xl px-4 py-3 shadow-md ring-1 ring-gray-200/50 border border-gray-200/30">
        <div class="text-sm font-medium text-gray-700 mr-2">Filtri attivi:</div>
        ${e.join("")}
      </div>
    `}async toggleModal(e){this.isAnimating||(this.isModalOpen?await this._closeModal():(this.currentModalIndex=e,await this._openModal()))}async _openModal(){this.isAnimating=!0;let e=document.getElementById("works-modal");e||(e=this._createModal(),document.body.appendChild(e)),e.classList.remove("hidden"),e.style.opacity="0";const t=e.querySelector(".modal-container");t&&(t.style.transform="scale(0.8) translateY(20px)",t.style.opacity="0"),this._populateModal(),this.isModalOpen=!0,document.body.style.overflow="hidden",e.offsetHeight,e.style.transition="opacity 300ms cubic-bezier(0.4, 0, 0.2, 1)",e.style.opacity="1",t&&(t.style.transition="all 400ms cubic-bezier(0.34, 1.56, 0.64, 1)",t.style.transform="scale(1) translateY(0)",t.style.opacity="1"),setTimeout(()=>{this._animateContentItems(),this.isAnimating=!1},200)}async _closeModal(){if(!this.isModalOpen)return;this.isAnimating=!0;const e=document.getElementById("works-modal");if(e){const t=e.querySelector(".modal-container");e.style.transition="opacity 250ms cubic-bezier(0.4, 0, 1, 1)",e.style.opacity="0",t&&(t.style.transition="all 250ms cubic-bezier(0.4, 0, 1, 1)",t.style.transform="scale(0.95) translateY(-10px)",t.style.opacity="0"),await new Promise(n=>setTimeout(n,250)),e.classList.add("hidden"),e.style.opacity="",t&&(t.style.transform="",t.style.opacity="")}this.isModalOpen=!1,document.body.style.overflow="auto",this.isAnimating=!1}_animateContentItems(){const e=document.querySelector(".modal-header");e&&(e.style.opacity="0",e.style.transform="translateY(-20px)",e.style.transition="all 500ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{e.style.opacity="1",e.style.transform="translateY(0)"},100));const t=document.querySelector(".filters-section");t&&(t.style.opacity="0",t.style.transform="translateY(-10px)",t.style.transition="all 400ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{t.style.opacity="1",t.style.transform="translateY(0)"},150)),document.querySelectorAll(".metadata-card").forEach((i,o)=>{i.style.opacity="0",i.style.transform="translateY(20px)",i.style.transition="all 400ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{i.style.opacity="1",i.style.transform="translateY(0)"},200+o*50)}),document.querySelectorAll(".space-card").forEach((i,o)=>{i.style.opacity="0",i.style.transform="translateX(-20px)",i.style.transition="all 500ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{i.style.opacity="1",i.style.transform="translateX(0)"},300+o*75)})}_createModal(){const e=document.createElement("div");return e.id="works-modal",e.className="fixed inset-0 bg-gradient-to-br from-slate-900/90 to-gray-900/90 backdrop-blur-md z-50 hidden flex items-center justify-center p-4",e.innerHTML=`
      <div class="modal-container relative w-full max-w-7xl h-[90vh] overflow-hidden">
        <!-- Enhanced Header with Close Button and Filters -->
        <div class="absolute top-0 left-0 right-0 px-6 py-4 z-20">
          <div class="flex items-center justify-between">
            <!-- Filters section on the left -->
            <div class="filters-section flex-1 mr-6">
              <!-- Filters will be populated here -->
            </div>
            
            <!-- Close button on the right -->
            <button id="close-modal-btn" class="p-3 bg-white/90 hover:bg-white active:bg-gray-100 rounded-full text-gray-600 hover:text-red-500 shadow-lg hover:shadow-xl transition-all duration-300 group backdrop-blur-sm border border-gray-200/50 hover:border-red-200 flex-shrink-0">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 group-hover:rotate-90 transition-transform duration-300">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
        
        <!-- Content Container with fixed width to prevent resizing -->
        <div id="modal-content" class="h-full pt-20 pb-16 rounded-2xl w-full max-w-none overflow-hidden"></div>
        
        <!-- Enhanced Footer with Progress Indicator -->
        <div class="absolute bottom-0 left-0 right-0 px-6 py-4 z-20">
          <div class="flex items-center justify-center">
            <span id="modal-progress" class="text-sm font-semibold text-gray-700 bg-white/90 backdrop-blur-sm px-6 py-3 rounded-full shadow-lg ring-1 ring-white/20 border border-gray-200/50 transition-all duration-300 hover:shadow-xl">
            </span>
          </div>
        </div>
      </div>
    `,e.addEventListener("click",t=>{t.target===e&&this._closeModal()}),e.querySelector("#close-modal-btn").addEventListener("click",()=>{this._closeModal()}),document.addEventListener("keydown",t=>{!this.isModalOpen||this.isAnimating||(t.key==="Escape"?this._closeModal():t.key==="ArrowLeft"?this._navigateModal(-1):t.key==="ArrowRight"&&this._navigateModal(1))}),e}async _navigateModal(e){if(this.isAnimating)return;const t=this.currentModalIndex+e;if(t>=0&&t<this.allWorks.length){this.isAnimating=!0;const n=document.getElementById("modal-content");if(!n)return;const s=n.querySelector(".main-content-panel");if(!s)return;const i=document.createElement("div");i.className="relative w-full h-full overflow-hidden";const o=document.createElement("div");o.className="absolute inset-0 w-full h-full transition-transform duration-500 ease-out overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl border border-gray-200/50 ring-1 ring-white/20",o.innerHTML=s.innerHTML;const l=document.createElement("div");l.className="absolute inset-0 w-full h-full transition-transform duration-500 ease-out overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl border border-gray-200/50 ring-1 ring-white/20";const a="100%";l.style.transform=`translateX(${e>0?a:`-${a}`})`,this.currentModalIndex=t;const d=this.allWorks[this.currentModalIndex],u=this._getCompleteWorkData(d.pivot_ID);u&&(l.innerHTML=this._renderMainCard(u)),s.parentNode.replaceChild(i,s),i.appendChild(o),i.appendChild(l),this._updateNavigationButtons(),i.offsetHeight,o.style.transform=`translateX(${e>0?`-${a}`:a})`,l.style.transform="translateX(0)",o.style.opacity="0.8",l.style.opacity="1",await new Promise(y=>setTimeout(y,500));const g=document.createElement("div");g.className="main-content-panel flex-1 min-w-0 overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl hover:shadow-2xl transition-all duration-500 border border-gray-200/50 ring-1 ring-white/20",g.innerHTML=l.innerHTML,i.parentNode.replaceChild(g,i);const p=document.getElementById("modal-progress");p&&(p.textContent=`${this.currentModalIndex+1} di ${this.allWorks.length}`),this._addMapFocusListeners(),setTimeout(()=>{this._animateContentItems(),this.isAnimating=!1},100)}}_updateNavigationButtons(){const e=document.getElementById("prev-work-btn"),t=document.getElementById("next-work-btn");e&&(this.currentModalIndex===0?(e.disabled=!0,e.className=e.className.replace("hover:scale-110 hover:-translate-y-1","opacity-40 cursor-not-allowed")):(e.disabled=!1,e.className=e.className.replace("opacity-40 cursor-not-allowed","hover:scale-110 hover:-translate-y-1"))),t&&(this.currentModalIndex===this.allWorks.length-1?(t.disabled=!0,t.className=t.className.replace("hover:scale-110 hover:-translate-y-1","opacity-40 cursor-not-allowed")):(t.disabled=!1,t.className=t.className.replace("opacity-40 cursor-not-allowed","hover:scale-110 hover:-translate-y-1"))),this._updatePreviewCards()}_updatePreviewCards(){const e=this.currentModalIndex>0?this.allWorks[this.currentModalIndex-1]:null,t=this.currentModalIndex<this.allWorks.length-1?this.allWorks[this.currentModalIndex+1]:null,n=e?this._getCompleteWorkData(e.pivot_ID):null,s=t?this._getCompleteWorkData(t.pivot_ID):null,i=document.querySelector(".left-nav-panel .preview-card");i&&(n?(i.className="preview-card text-center bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 px-4 py-6 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1",i.innerHTML=`
          <div class="w-12 h-1 bg-gradient-to-r from-secondary-400 to-secondary-600 rounded-full mx-auto mb-4"></div>
          <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${n.Title}</h4>
          <p class="text-xs text-gray-600 font-medium">${n.Subtitle}</p>
          <p class="text-xs text-gray-500">(${n.Subtitle2})</p>
        `):(i.className="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48",i.innerHTML='<div class="text-sm text-gray-400 font-medium">Nessuna opera precedente</div>'));const o=document.querySelector(".right-nav-panel .preview-card");o&&(s?(o.className="preview-card text-center px-4 py-6 bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1",o.innerHTML=`
          <div class="w-12 h-1 bg-gradient-to-r from-secondary-400 to-secondary-600 rounded-full mx-auto mb-4"></div>
          <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${s.Title}</h4>
          <p class="text-xs text-gray-600 font-medium">${s.Subtitle}</p>
          <p class="text-xs text-gray-500">(${s.Subtitle2})</p>
        `):(o.className="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48",o.innerHTML='<div class="text-sm text-gray-400 font-medium">Nessuna opera successiva</div>'))}_addNavigationListeners(){const e=document.getElementById("prev-work-btn"),t=document.getElementById("next-work-btn");e&&this.currentModalIndex>0&&e.addEventListener("click",()=>this._navigateModal(-1)),t&&this.currentModalIndex<this.allWorks.length-1&&t.addEventListener("click",()=>this._navigateModal(1))}_populateModal(){const e=document.getElementById("modal-content"),t=document.getElementById("modal-progress"),n=document.querySelector(".filters-section");if(!e)return;n&&(n.innerHTML=this._renderSelectedFilters());const s=this.allWorks[this.currentModalIndex],i=this._getCompleteWorkData(s.pivot_ID),o=this.currentModalIndex>0?this.allWorks[this.currentModalIndex-1]:null,l=this.currentModalIndex<this.allWorks.length-1?this.allWorks[this.currentModalIndex+1]:null,a=o?this._getCompleteWorkData(o.pivot_ID):null,d=l?this._getCompleteWorkData(l.pivot_ID):null;if(!i){e.innerHTML='<div class="flex items-center justify-center h-full text-gray-500 text-lg">Dati non disponibili</div>';return}e.innerHTML=`
      <div class="flex h-full w-full">
        <!-- Enhanced Left Navigation Panel with fixed width -->
        <div class="left-nav-panel flex flex-col items-center justify-center p-6 space-y-6 w-64 flex-shrink-0">
          <button id="prev-work-btn" class="group p-4 bg-white/90 hover:bg-white active:bg-gray-50 rounded-2xl text-gray-600 hover:text-secondary-600 transition-all duration-300 shadow-lg hover:shadow-xl ring-1 ring-gray-200/50 hover:ring-secondary-200 backdrop-blur-sm border border-gray-200/30 ${this.currentModalIndex===0?"opacity-40 cursor-not-allowed":"hover:scale-110 hover:-translate-y-1"}" ${this.currentModalIndex===0?"disabled":""}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 group-hover:-translate-x-1 transition-transform duration-300">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
            </svg>
          </button>
          
          ${a?`
            <div class="preview-card text-center bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 px-4 py-6 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
              <div class="w-12 h-1 bg-gradient-to-r from-secondary-400 to-secondary-600 rounded-full mx-auto mb-4"></div>
              <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${a.Title}</h4>
              <p class="text-xs text-gray-600 font-medium">${a.Subtitle}</p>
              <p class="text-xs text-gray-500">(${a.Subtitle2})</p>
            </div>
          `:`
            <div class="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48">
              <div class="text-sm text-gray-400 font-medium">Nessuna opera precedente</div>
            </div>
          `}
        </div>

        <!-- Enhanced Main Content Area with fixed flex properties -->
        <div class="main-content-panel flex-1 min-w-0 overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl hover:shadow-2xl transition-all duration-500 border border-gray-200/50 ring-1 ring-white/20">
          ${this._renderMainCard(i)}
        </div>

        <!-- Enhanced Right Navigation Panel with fixed width -->
        <div class="right-nav-panel flex flex-col items-center justify-center p-6 space-y-6 w-64 flex-shrink-0">
          <button id="next-work-btn" class="group p-4 bg-white/90 hover:bg-white active:bg-gray-50 rounded-2xl text-gray-600 hover:text-secondary-600 transition-all duration-300 shadow-lg hover:shadow-xl ring-1 ring-gray-200/50 hover:ring-secondary-200 backdrop-blur-sm border border-gray-200/30 ${this.currentModalIndex===this.allWorks.length-1?"opacity-40 cursor-not-allowed":"hover:scale-110 hover:-translate-y-1"}" ${this.currentModalIndex===this.allWorks.length-1?"disabled":""}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 group-hover:translate-x-1 transition-transform duration-300">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
            </svg>
          </button>
          
          ${d?`
            <div class="preview-card text-center px-4 py-6 bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
              <div class="w-12 h-1 bg-gradient-to-r from-secondary-400 to-secondary-600 rounded-full mx-auto mb-4"></div>
              <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${d.Title}</h4>
              <p class="text-xs text-gray-600 font-medium">${d.Subtitle}</p>
              <p class="text-xs text-gray-500">(${d.Subtitle2})</p>
            </div>
          `:`
            <div class="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48">
              <div class="text-sm text-gray-400 font-medium">Nessuna opera successiva</div>
            </div>
          `}
        </div>
      </div>
    `,t&&(t.textContent=`${this.currentModalIndex+1} di ${this.allWorks.length}`),this._addNavigationListeners(),this._addMapFocusListeners()}_renderMainCard(e){const t=e.allEntries[0],n=this._renderCombinedMetadata(t),s=this._renderGeographicalSpaces(e);return`
      <div class="p-8 space-y-8 w-full">
        <!-- Enhanced Header Section -->
        <div class="modal-header bg-gradient-to-r from-slate-50/90 to-gray-50/90 backdrop-blur-sm rounded-2xl p-8 ring-1 ring-gray-200/50 border border-gray-200/30">
          <div class="flex items-start justify-between">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-1 h-12 bg-gradient-to-b from-secondary-500 to-secondary-600 rounded-full shadow-sm flex-shrink-0"></div>
                <div class="min-w-0 flex-1">
                  <h1 class="text-3xl font-bold text-gray-900 leading-tight truncate">${e.Title}</h1>
                  <div class="flex items-center gap-4 mt-2">
                    <p class="text-lg text-gray-700 font-medium truncate">${e.Subtitle}</p>
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full flex-shrink-0"></span>
                    <p class="text-lg text-gray-600 font-mono flex-shrink-0">${e.Subtitle2}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        ${n}
        ${s}
      </div>
    `}_renderCombinedMetadata(e){const t=this._getCatalogueFields(),n=[],s=t.filter(i=>!n.includes(i)&&e[i]!=null&&e[i]!=="").map(i=>{const o=e[i];let l=o;return Array.isArray(o)?l=o.join(", "):typeof o=="string"&&o.length>150&&(l=o.substring(0,147)+"..."),`
          <div class="metadata-card group bg-white/90 hover:bg-white backdrop-blur-sm hover:shadow-lg rounded-xl p-5 ring-1 ring-gray-200/50 hover:ring-gray-300/70 transition-all duration-300 border border-gray-200/30 hover:border-gray-300/50 hover:-translate-y-0.5">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-2 h-2 bg-gradient-to-r from-primary-400 to-primary-600 rounded-full group-hover:scale-125 transition-transform duration-300 shadow-sm"></div>
              <h4 class="text-sm font-semibold text-gray-800 uppercase tracking-wide">${i}</h4>
            </div>
            <div class="text-base text-gray-700 leading-relaxed pl-5">${l}</div>
          </div>
        `}).join("");return s?`
      <div>
        <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-primary-600">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0-1.125.504-1.125 1.125V11.25a9 9 0 0 0-9-9Z" />
          </svg>
          Metadati del catalogo
        </h2>
        <div class="grid gap-4">
          ${s}
        </div>
      </div>
    `:""}_renderGeographicalSpaces(e){return!e.Location||e.Location.length===0?`
        <div class="bg-gradient-to-r from-secondary-50/90 to-indigo-50/90 backdrop-blur-sm rounded-2xl p-8 ring-1 ring-secondary-200/50 border border-secondary-200/30">
          <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-secondary-600">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
            </svg>
            Location
          </h2>
          <div class="text-gray-500 italic">Nessun spazio geografico disponibile</div>
        </div>
      `:`
      <div class="bg-gradient-to-r from-secondary-50/90 to-indigo-50/90 backdrop-blur-sm rounded-2xl p-8 ring-1 ring-secondary-200/50 border border-secondary-200/30">
        <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-secondary-600">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
          </svg>
          Location
        </h2>
        <div class="grid gap-6">
          ${e.Location.map((n,s)=>{const i=e.coordinates[s],o=e.geodataBySpace.get(n)||{},l=this._getAllMetadataFields(),a=this._getCatalogueFields(),d=[],u=l.filter(p=>!d.includes(p)&&!a.includes(p)).map(p=>{let y=o[p];if(y==null||y==="")return"";let f=y;return typeof y=="string"&&y.length>100&&(f=y.substring(0,97)+"..."),`
            <div class="flex items-start gap-3 py-2">
              <div class="w-1.5 h-1.5 bg-secondary-400 rounded-full mt-2 flex-shrink-0"></div>
              <div class="min-w-0 flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-xs font-semibold text-gray-600 uppercase tracking-wide">${p}</span>
                </div>
                <span class="text-sm text-gray-800">${f}</span>
              </div>
            </div>
          `}).filter(Boolean).join(""),g=i&&i.lat&&i.lng;return`
        <div class="space-card bg-white/90 backdrop-blur-sm rounded-xl p-6 ring-1 ring-gray-200/50 hover:ring-secondary-300/70 transition-all duration-300 hover:shadow-lg border border-gray-200/30 hover:border-secondary-300/50 hover:-translate-y-1">
          <div class="flex items-start justify-between mb-4">
            <div class="flex items-center gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-5 h-5 text-secondary-600 flex-shrink-0">
                <path fill-rule="evenodd" d="m7.539 14.841.003.003.002.002a.755.755 0 0 0 .912 0l.002-.002.003-.003.012-.009a5.57 5.57 0 0 0 .19-.153 15.588 15.588 0 0 0 2.046-2.082c1.101-1.362 2.291-3.342 2.291-5.597A5 5 0 0 0 3 7c0 2.255 1.19 4.235 2.292 5.597a15.591 15.591 0 0 0 2.046 2.082 8.916 8.916 0 0 0 .189.153l.012.01ZM8 8.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" clip-rule="evenodd" />
              </svg>
              <h3 class="text-lg font-semibold text-gray-900">${n}</h3>
            </div>
            
            ${g?`
              <button class="map-btn group px-4 py-2 text-sm font-medium bg-gradient-to-r from-secondary-500 to-secondary-600 hover:from-secondary-600 hover:to-secondary-700 active:from-secondary-700 active:to-secondary-800 text-white rounded-lg shadow-md hover:shadow-lg transition-all duration-300 hover:scale-105 hover:-translate-y-0.5" 
                      data-lat="${i.lat}" 
                      data-lng="${i.lng}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 inline mr-1">
                  <path fill-rule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V6h4.5a.75.75 0 0 1 0 1.5H8.75v4.25a.75.75 0 0 1-1.5 0V7.5H2.75a.75.75 0 0 1 0-1.5h4.5V1.75A.75.75 0 0 1 8 1Z" clip-rule="evenodd" />
                </svg>
                Visualizza sulla mappa
              </button>
            `:`
              <span class="px-4 py-2 text-sm font-medium bg-gray-100/80 text-gray-500 rounded-lg ring-1 ring-gray-200/50 backdrop-blur-sm">
                Coordinate non disponibili
              </span>
            `}
          </div>
          
          ${u?`
            <div class="border-t border-gray-100/50 pt-4 mt-4">
              <h4 class="text-sm font-semibold text-gray-700 mb-3">Metadati geografici per questo spazio:</h4>
              <div class="space-y-2">
                ${u}
              </div>
            </div>
          `:`
            <div class="border-t border-gray-100/50 pt-4 mt-4">
              <div class="text-sm text-gray-500 italic">Nessun metadato geografico disponibile per questo spazio</div>
            </div>
          `}
        </div>
      `}).join("")}
        </div>
        <div class="mt-6 text-sm text-secondary-700 bg-secondary-100/80 backdrop-blur-sm rounded-lg p-3 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
            <path fill-rule="evenodd" d="M15 8A7 7 0 1 1 1 8a7 7 0 0 1 14 0ZM9 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0ZM6.75 8a.75.75 0 0 0 0 1.5h.75v1.75a.75.75 0 0 0 1.5 0v-2.5A.75.75 0 0 0 8.25 8h-1.5Z" clip-rule="evenodd" />
          </svg>
          <span>Clicca sui pulsanti per visualizzare i luoghi sulla mappa. Ogni spazio mostra solo i metadati geografici disponibili.</span>
        </div>
      </div>
    `}_addMapFocusListeners(){document.querySelectorAll(".map-btn").forEach(e=>{e.addEventListener("click",()=>{const t=parseFloat(e.getAttribute("data-lat")),n=parseFloat(e.getAttribute("data-lng"));t&&n&&this.mapFocusCallback&&(this.mapFocusCallback(t,n,8),this._closeModal())})})}_extractCoordinates(e,t){let n={lat:null,lng:null};if(Array.isArray(e.lat_long)&&e.lat_long.length>t){const s=e.lat_long[t];if(s&&typeof s=="string"){const i=s.split(",");if(i.length===2){const o=parseFloat(i[0].trim()),l=parseFloat(i[1].trim());!isNaN(o)&&!isNaN(l)&&(n={lat:o,lng:l})}}}else if(e.lat_long&&typeof e.lat_long=="string"){const s=e.lat_long.split(",");if(s.length===2){const i=parseFloat(s[0].trim()),o=parseFloat(s[1].trim());!isNaN(i)&&!isNaN(o)&&(n={lat:i,lng:o})}}return n}}class ai{constructor(e){this.mapFocusCallback=e,this.allWorks=[],this.modalRenderer=new oi(e)}updateResultsList(e,t,n={}){const s=document.getElementById("results");if(!s){console.error("Results container not found");return}this.items=e,this.searchState=n;const i=this._groupByIdOpera(e);this.allWorks=Object.values(i),this.modalRenderer.setData(this.allWorks,this.items),this.modalRenderer.setConfig(t),this.modalRenderer.setSearchState(n),s.innerHTML=this.allWorks.map((o,l)=>this._renderResultItem(o,l)).join(""),this._addMapFocusListeners(),this._addModalListeners()}focusOnResult(e){const t=document.querySelector(`[data-result-id="${e}"]`);return t?(this._openFiltersPanel(),t.scrollIntoView({behavior:"smooth",block:"center"}),this._highlightResult(t),console.log(`Focused on result with pivot_ID: ${e}`),!0):(console.warn(`Result with pivot_ID ${e} not found in current results`),!1)}_openFiltersPanel(){const e=document.getElementById("results-panel");e?(e.classList.remove("panel-closed-right"),console.log("Filters panel opened")):console.warn('Filters panel with ID "results-panel" not found')}_highlightResult(e){const t=document.querySelector(".result-highlighted");t&&t.classList.remove("result-highlighted"),e.classList.add("result-highlighted"),e.style.transition="all 0.3s ease",e.style.transform="scale(1.02)",setTimeout(()=>{e.style.transform=""},1e3),setTimeout(()=>{e.classList.remove("result-highlighted")},3e3)}_groupByIdOpera(e){const t={};return e.forEach(n=>{const s=n.pivot_ID;t[s]||(t[s]={pivot_ID:s,Title:n[window.ledaSearch.config.result_cards.card_title],Subtitle:n[window.ledaSearch.config.result_cards.card_subtitle]||"",Subtitle2:n[window.ledaSearch.config.result_cards.card_subtitle_2]||"",Description:n[window.ledaSearch.config.result_cards.card_description]||"",Location:[],coordinates:[]}),n.Location&&(Array.isArray(n.Location)?n.Location:[n.Location]).forEach((o,l)=>{if(!t[s].Location.includes(o)){t[s].Location.push(o);const a=this._extractCoordinatesFromItem(n,l);t[s].coordinates.push(a)}})}),t}_renderResultItem(e,t){const n=e.Location.map((s,i)=>{const o=e.coordinates[i],l=o&&o.lat&&o.lng;return`
        <button class="focus-map-btn inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium transition-all duration-200 hover:shadow-sm hover:scale-105 active:scale-95 cursor-pointer transform 
                       ${l?"bg-secondary-100 hover:bg-secondary-200 text-secondary-700 border border-secondary-200":"bg-gray-100 text-gray-500 border border-gray-200"}" 
                data-space="${encodeURIComponent(s)}" 
                ${l?`data-lat="${o.lat}" data-lng="${o.lng}"`:""}
                title="${l?"Clicca per visualizzare sulla mappa":"Coordinate non disponibili"}">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 mr-1 ${l?"":"opacity-50"}">
            <path fill-rule="evenodd" d="m7.539 14.841.003.003.002.002a.755.755 0 0 0 .912 0l.002-.002.003-.003.012-.009a5.57 5.57 0 0 0 .19-.153 15.588 15.588 0 0 0 2.046-2.082c1.101-1.362 2.291-3.342 2.291-5.597A5 5 0 0 0 3 7c0 2.255 1.19 4.235 2.292 5.597a15.591 15.591 0 0 0 2.046 2.082 8.916 8.916 0 0 0 .189.153l.012.01ZM8 8.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" clip-rule="evenodd" />
          </svg>
          ${s}
        </button>
      `}).join("");return`
      <div class="result-card bg-white rounded-lg shadow-md border border-gray-200 hover:shadow-lg transition-all duration-300 p-6" 
     data-result-id="${e.pivot_ID}">
  <!-- Header -->
  <div class="flex items-start justify-between gap-4">
    <div class="min-w-0 flex-1">
      <!-- Title and Subtitles -->
      <div class="mb-4">
        <h1 class="text-xl font-bold text-gray-900 leading-tight">${e.Title}</h1>
        <div class="flex items-center gap-4 mt-2">
          ${e.Subtitle?`<p class="text-lg text-gray-700 font-medium break-words">${e.Subtitle}</p>`:""}
          ${e.Subtitle&&e.Subtitle2?'<span class="w-1.5 h-1.5 bg-gray-400 rounded-full flex-shrink-0 break-words"></span>':""}
          ${e.Subtitle2?`<p class="text-lg text-gray-600 font-mono break-words w-full">${e.Subtitle2}</p>`:""}
        </div>
      </div>
      
      <!-- Description with vertical bar -->
      ${e.Description?`
        <div class="flex items-start gap-2">
          <div class="w-1 bg-gradient-to-b from-primary-500 to-primary-600 rounded-full shadow-sm flex-shrink-0" style="height: auto; min-height: 1.5rem;"></div>
          <p class="text-base text-gray-600 flex-1">${e.Description}</p>
        </div>
      `:""}
    </div>
    
    <!-- More button -->
    <button class="modal-toggle-btn inline-flex items-center px-4 py-2 rounded-full shadow-md hover:shadow-lg transition-all duration-200 flex-shrink-0 bg-primary-500 hover:bg-primary-600 text-white"
            data-work-index="${t}"
            title="Visualizza tutte le opere">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
      </svg>
    </button>
  </div>
  
  <!-- Locations -->
  ${n?`
    <div class="pt-4 border-t border-gray-200">
      <div class="flex flex-wrap gap-2">
        ${n}
      </div>
    </div>
  `:""}
</div>
    `}_addModalListeners(){document.querySelectorAll(".modal-toggle-btn").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const n=parseInt(e.getAttribute("data-work-index"));this.modalRenderer.toggleModal(n)})})}_extractCoordinatesFromItem(e,t){let n={lat:null,lng:null};if(Array.isArray(e.lat_long)&&e.lat_long.length>t){const s=e.lat_long[t];if(s&&typeof s=="string"){const i=s.split(",");if(i.length===2){const o=parseFloat(i[0].trim()),l=parseFloat(i[1].trim());!isNaN(o)&&!isNaN(l)&&(n.lat=o,n.lng=l)}}}else if(e.lat_long&&typeof e.lat_long=="string"){const s=e.lat_long.split(",");if(s.length===2){const i=parseFloat(s[0].trim()),o=parseFloat(s[1].trim());!isNaN(i)&&!isNaN(o)&&(n.lat=i,n.lng=o)}}return n}_addMapFocusListeners(){document.querySelectorAll(".focus-map-btn").forEach(e=>{e.addEventListener("click",t=>{const n=e.getAttribute("data-lat"),s=e.getAttribute("data-lng");n&&s&&this.mapFocusCallback?this.mapFocusCallback(parseFloat(n),parseFloat(s),8):console.warn("Coordinate non disponibili per questa opera:",e.getAttribute("data-space"))})})}}class or{static debounce(e,t){let n;return function(){clearTimeout(n),n=setTimeout(()=>e.apply(this,arguments),t)}}static parseCoordinates(e){if(!e||typeof e!="string")return{lat:null,lng:null};const t=e.split(",");return t.length===2?{lat:parseFloat(t[0].trim()),lng:parseFloat(t[1].trim())}:{lat:null,lng:null}}static encodeForAttribute(e){return encodeURIComponent(e||"")}static createUniqueId(e="element"){return`${e}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}static isEmpty(e){return e==null?!0:typeof e=="string"?e.trim()==="":Array.isArray(e)?e.length===0:typeof e=="object"?Object.keys(e).length===0:!1}}class li{constructor(){this.config=null,this.searchEngine=null,this.state={query:"",filters:{},sort:"",bounds:null},this.isLoading=!1,this.isInitialLoad=!0,this.isFullyLoaded=!1,this.initialize()}async initialize(){try{this.showFullScreenLoader(),this.config=await Tr();const e=await Pr();this.config.searchConfig.per_page=e.length,this.searchEngine=ti(e,this.config),this.state.sort=this.config.searchConfig.defaultSort,this.state.filters=this.createEmptyFilters(),await this.initializeComponents(),this.bindEvents(),this.bindNavBarEvents(),await this.performSearch(),this.isInitialLoad=!1,this.isFullyLoaded=!0,this.hideFullScreenLoader()}catch(e){console.error("Initialization error:",e),this.showNotification("Error loading application","error"),this.hideFullScreenLoader()}}createEmptyFilters(){const e={};for(const[t]of Object.entries(this.config.aggregations))e[t]=[];return e}async initializeComponents(){const e=Br(this.config);this.map=e.map,this.markers=e.markers,this.renderMarkers=e.renderMarkers,this.setFocusResultCallback=e.setFocusResultCallback,this.mapInstance=e,window.ledaSearch||(window.ledaSearch={}),window.ledaSearch.config=this.config,window.ledaSearch.mapInstance=this.mapInstance,window.switchMarkerType=t=>{this.mapInstance&&this.mapInstance.switchMarkerType&&this.mapInstance.switchMarkerType(t)},this.facetRenderer=new si(this.config),this.rangeRenderer=new $r,this.taxonomyRenderer=new Ir,this.searchHandler=new ii(this.searchEngine,this.config),this.resultsRenderer=new ai((t,n,s)=>this.focusOnMap(t,n,s)),this.navBar=ni,this.connectMapToResults(),this.debouncedSearch=or.debounce(async()=>{await this.performSearch()},300)}connectMapToResults(){this.setFocusResultCallback&&this.setFocusResultCallback(e=>{const t=this.resultsRenderer.focusOnResult(e);return t||this.showNotification("Item not found in current results","warning"),t})}showFullScreenLoader(){this.fullScreenLoader||(this.fullScreenLoader=document.createElement("div"),this.fullScreenLoader.className="fixed inset-0 z-[9999] bg-white flex items-center justify-center",this.fullScreenLoader.innerHTML=`
        <div class="text-center">
          <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-primary-500 mx-auto mb-4"></div>
          <h2 class="text-xl font-semibold text-gray-700 mb-2">Loading LEDA Search</h2>
          <p class="text-gray-500">Initializing map, data, and components...</p>
        </div>
      `,document.body.appendChild(this.fullScreenLoader)),this.fullScreenLoader.style.display="flex"}hideFullScreenLoader(){this.fullScreenLoader&&(this.fullScreenLoader.style.opacity="0",this.fullScreenLoader.style.transition="opacity 0.3s ease-out",setTimeout(()=>{this.fullScreenLoader&&(this.fullScreenLoader.style.display="none")},300))}showNotification(e,t="info"){const n=document.createElement("div");n.className=`fixed top-4 right-4 z-50 p-3 rounded-lg shadow-lg max-w-sm text-white transition-all duration-300 ${t==="error"?"bg-red-500":t==="warning"?"bg-yellow-500":"bg-blue-500"}`,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",setTimeout(()=>n.remove(),300)},300)}async performSearch(){var e,t;try{const n=this.searchHandler.performSearch(this.state,{onMarkersUpdate:i=>this.renderMarkers(i),onResultsUpdate:i=>this.resultsRenderer.updateResultsList(i,this.config,{filters:this.state.filters,query:this.state.query,sort:this.state.sort}),onAggregationsUpdate:i=>this.renderFacets(i)}),s=this.calculateUniqueResultsCount(n.items);return this.updateNavBar(((e=n.items)==null?void 0:e.length)||0,{uniqueResultsCount:s}),console.log("Search completed:",((t=n.items)==null?void 0:t.length)||0,"items found"),n}catch(n){console.error("Search error:",n),this.showNotification("Search failed","error")}}calculateUniqueResultsCount(e){if(!e||!Array.isArray(e))return 0;const t=new Set;return e.forEach(n=>{var i,o,l,a,d,u;const s=n.pivot_ID||n.pivotID||n.pivot_id||((i=n._source)==null?void 0:i.pivot_ID)||((o=n._source)==null?void 0:o.pivotID)||((l=n._source)==null?void 0:l.pivot_id)||((a=n.source)==null?void 0:a.pivot_ID)||((d=n.source)==null?void 0:d.pivotID)||((u=n.source)==null?void 0:u.pivot_id);s!=null&&s!==""&&t.add(s)}),t.size}async handleStateChange(e){var t,n;console.log("handleStateChange called with action:",e);try{switch(e.type){case"FACET_CHANGE":this.updateFilters(e.facetType,e.value,e.checked);break;case"RANGE_CHANGE":this.state.filters[e.facetKey]=e.value;break;case"QUERY_CHANGE":this.state.query=e.query;break;case"SORT_CHANGE":this.state.sort=e.sort;break}console.log("State updated, triggering search. New state:",this.state),this.isLoading=!1;const s=this.searchHandler.performSearch(this.state,{onMarkersUpdate:o=>this.renderMarkers(o),onResultsUpdate:o=>this.resultsRenderer.updateResultsList(o,this.config,{filters:this.state.filters,query:this.state.query,sort:this.state.sort}),onAggregationsUpdate:o=>this.renderFacets(o)}),i=this.calculateUniqueResultsCount(s.items);this.updateNavBar(((t=s.items)==null?void 0:t.length)||0,{uniqueResultsCount:i}),console.log("Filter search completed:",((n=s.items)==null?void 0:n.length)||0,"items found")}catch(s){console.error("Error in handleStateChange:",s)}}hasActiveFilters(){if(!this.state.filters)return!1;for(const[e,t]of Object.entries(this.state.filters))if(Array.isArray(t)&&t.length>0||!Array.isArray(t)&&t)return!0;return!1}updateFilters(e,t,n){var s;console.log(`Updating filter: ${e}, value: ${t}, checked: ${n}`),n?(this.state.filters[e]||(this.state.filters[e]=[]),this.state.filters[e].push(t)):this.state.filters[e]=((s=this.state.filters[e])==null?void 0:s.filter(i=>i!==t))||[],console.log("Updated filters:",this.state.filters)}bindEvents(){this.setupSearchInput(),this.setupSortSelect(),this.setupMapEvents()}bindNavBarEvents(){this.navBar.addEventListener("clearAllFilters",()=>this.clearAllFilters()),this.navBar.addEventListener("removeFilter",e=>{const{facetKey:t,value:n}=e.detail;this.removeFilter(t,n)}),this.navBar.addEventListener("clearSearchQuery",()=>this.clearSearchQuery())}setupSearchInput(){const e=document.getElementById("search-input");e&&e.addEventListener("input",()=>{this.state.query=e.value,this.debouncedSearch()})}setupSortSelect(){const e=document.getElementById("sort-select");e&&this.config.searchConfig.sortOptions&&(e.innerHTML=this.config.searchConfig.sortOptions.map(t=>`<option value="${t.value}">${t.label}</option>`).join(""),e.addEventListener("change",t=>{this.state.sort=t.target.value,this.performSearch()}))}setupMapEvents(){const e=or.debounce(async()=>{await this.performSearch()},500);this.map.on("moveend",e)}focusOnMap(e,t,n=15){this.map&&this.map.setView([parseFloat(e),parseFloat(t)],n)}renderFacets(e){this.facetRenderer.renderFacets(e,this.state,t=>this.handleStateChange(t))}updateNavBar(e=0,t={}){this.navBar.updateFromSearchState(this.state,e,t)}clearAllFilters(){this.state.query="",this.state.filters=this.createEmptyFilters();const e=document.getElementById("search-input");e&&(e.value=""),this.performSearch()}removeFilter(e,t){this.state.filters[e]&&(t?this.state.filters[e]=this.state.filters[e].filter(n=>n!==t):this.state.filters[e]=[],this.performSearch())}clearSearchQuery(){this.state.query="";const e=document.getElementById("search-input");e&&(e.value=""),this.performSearch()}getLoadingStatus(){return{isLoading:this.isLoading,isFullyLoaded:this.isFullyLoaded,searchEngineReady:!!this.searchEngine,mapReady:!!this.map,configLoaded:!!this.config}}}document.addEventListener("DOMContentLoaded",()=>{window.ledaSearch=new li})});export default ci();
