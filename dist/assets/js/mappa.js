var Or=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);import"./modulepreload-polyfill-B5Qt9EMX.js";import{l as Nr,p as Br}from"./dataParser-DPL0y_Ss.js";import{i as zr}from"./initMap-CCiNHD7G.js";var li=Or((V,G)=>{var or=typeof global=="object"&&global&&global.Object===Object&&global,Tr=typeof self=="object"&&self&&self.Object===Object&&self,J=or||Tr||Function("return this")(),Y=J.Symbol,ar=Object.prototype,Pr=ar.hasOwnProperty,Rr=ar.toString,be=Y?Y.toStringTag:void 0,qr=Object.prototype.toString,Wr="[object Null]",Hr="[object Undefined]",yt=Y?Y.toStringTag:void 0;function me(r){return r==null?r===void 0?Hr:Wr:yt&&yt in Object(r)?function(e){var t=Pr.call(e,be),n=e[be];try{e[be]=void 0;var s=!0}catch{}var i=Rr.call(e);return s&&(t?e[be]=n:delete e[be]),i}(r):function(e){return qr.call(e)}(r)}function te(r){return r!=null&&typeof r=="object"}var Dr="[object Symbol]";function pe(r){return typeof r=="symbol"||te(r)&&me(r)==Dr}function fe(r,e){for(var t=-1,n=r==null?0:r.length,s=Array(n);++t<n;)s[t]=e(r[t],t,r);return s}var H=Array.isArray,Ur=1/0,bt=Y?Y.prototype:void 0,wt=bt?bt.toString:void 0;function lr(r){if(typeof r=="string")return r;if(H(r))return fe(r,lr)+"";if(pe(r))return wt?wt.call(r):"";var e=r+"";return e=="0"&&1/r==-Ur?"-0":e}function ie(r){var e=typeof r;return r!=null&&(e=="object"||e=="function")}function Pe(r){return r}var Vr="[object AsyncFunction]",Gr="[object Function]",Zr="[object GeneratorFunction]",Yr="[object Proxy]";function cr(r){if(!ie(r))return!1;var e=me(r);return e==Gr||e==Zr||e==Vr||e==Yr}var xt,He=J["__core-js_shared__"],_t=(xt=/[^.]+$/.exec(He&&He.keys&&He.keys.IE_PROTO||""))?"Symbol(src)_1."+xt:"",Qr=Function.prototype.toString;function oe(r){if(r!=null){try{return Qr.call(r)}catch{}try{return r+""}catch{}}return""}var Jr=/^\[object .+?Constructor\]$/,Xr=RegExp("^"+Function.prototype.toString.call(Object.prototype.hasOwnProperty).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function ae(r,e){var t=function(n,s){return n==null?void 0:n[s]}(r,e);return function(n){return!(!ie(n)||(s=n,_t&&_t in s))&&(cr(n)?Xr:Jr).test(oe(n));var s}(t)?t:void 0}var kt,De,Ue,Je=ae(J,"WeakMap"),Ct=Object.create,Kr=function(){function r(){}return function(e){if(!ie(e))return{};if(Ct)return Ct(e);r.prototype=e;var t=new r;return r.prototype=void 0,t}}(),en=Date.now,tn=function(){try{var r=ae(Object,"defineProperty");return r({},"",{}),r}catch{}}(),Be=tn,rn=Be?function(r,e){return Be(r,"toString",{configurable:!0,enumerable:!1,value:(t=e,function(){return t}),writable:!0});var t}:Pe,nn=(kt=rn,De=0,Ue=0,function(){var r=en(),e=16-(r-Ue);if(Ue=r,e>0){if(++De>=800)return arguments[0]}else De=0;return kt.apply(void 0,arguments)});function sn(r){return r!=r}function on(r,e){return!(r==null||!r.length)&&function(t,n,s){return n==n?function(i,o,l){for(var c=-1,u=i.length;++c<u;)if(i[c]===o)return c;return-1}(t,n):function(i,o,l,c){for(var u=i.length,h=-1;++h<u;)if(o(i[h],h,i))return h;return-1}(t,sn)}(r,e)>-1}var an=9007199254740991,ln=/^(?:0|[1-9]\d*)$/;function at(r,e){var t=typeof r;return!!(e=e??an)&&(t=="number"||t!="symbol"&&ln.test(r))&&r>-1&&r%1==0&&r<e}function lt(r,e,t){e=="__proto__"&&Be?Be(r,e,{configurable:!0,enumerable:!0,value:t,writable:!0}):r[e]=t}function Re(r,e){return r===e||r!=r&&e!=e}var cn=Object.prototype.hasOwnProperty;function dr(r,e,t){var n=r[e];cn.call(r,e)&&Re(n,t)&&(t!==void 0||e in r)||lt(r,e,t)}function Fe(r,e,t,n){var s=!t;t||(t={});for(var i=-1,o=e.length;++i<o;){var l=e[i],c=void 0;c===void 0&&(c=r[l]),s?lt(t,l,c):dr(t,l,c)}return t}var St=Math.max;function ur(r,e){return nn(function(t,n,s){return n=St(n===void 0?t.length-1:n,0),function(){for(var i=arguments,o=-1,l=St(i.length-n,0),c=Array(l);++o<l;)c[o]=i[n+o];o=-1;for(var u=Array(n+1);++o<n;)u[o]=i[o];return u[n]=s(c),function(h,m,f){switch(f.length){case 0:return h.call(m);case 1:return h.call(m,f[0]);case 2:return h.call(m,f[0],f[1]);case 3:return h.call(m,f[0],f[1],f[2])}return h.apply(m,f)}(t,this,u)}}(r,e,Pe),r+"")}var dn=9007199254740991;function ct(r){return typeof r=="number"&&r>-1&&r%1==0&&r<=dn}function ve(r){return r!=null&&ct(r.length)&&!cr(r)}function Et(r,e,t){if(!ie(t))return!1;var n=typeof e;return!!(n=="number"?ve(t)&&at(e,t.length):n=="string"&&e in t)&&Re(t[e],r)}var un=Object.prototype;function dt(r){var e=r&&r.constructor;return r===(typeof e=="function"&&e.prototype||un)}function At(r){return te(r)&&me(r)=="[object Arguments]"}var hr=Object.prototype,hn=hr.hasOwnProperty,fn=hr.propertyIsEnumerable,ut=At(function(){return arguments}())?At:function(r){return te(r)&&hn.call(r,"callee")&&!fn.call(r,"callee")},fr=typeof V=="object"&&V&&!V.nodeType&&V,Lt=fr&&typeof G=="object"&&G&&!G.nodeType&&G,Ft=Lt&&Lt.exports===fr?J.Buffer:void 0,ze=(Ft?Ft.isBuffer:void 0)||function(){return!1},z={};function qe(r){return function(e){return r(e)}}z["[object Float32Array]"]=z["[object Float64Array]"]=z["[object Int8Array]"]=z["[object Int16Array]"]=z["[object Int32Array]"]=z["[object Uint8Array]"]=z["[object Uint8ClampedArray]"]=z["[object Uint16Array]"]=z["[object Uint32Array]"]=!0,z["[object Arguments]"]=z["[object Array]"]=z["[object ArrayBuffer]"]=z["[object Boolean]"]=z["[object DataView]"]=z["[object Date]"]=z["[object Error]"]=z["[object Function]"]=z["[object Map]"]=z["[object Number]"]=z["[object Object]"]=z["[object RegExp]"]=z["[object Set]"]=z["[object String]"]=z["[object WeakMap]"]=!1;var pr=typeof V=="object"&&V&&!V.nodeType&&V,xe=pr&&typeof G=="object"&&G&&!G.nodeType&&G,Ve=xe&&xe.exports===pr&&or.process,ge=function(){try{return xe&&xe.require&&xe.require("util").types||Ve&&Ve.binding&&Ve.binding("util")}catch{}}(),jt=ge&&ge.isTypedArray,gr=jt?qe(jt):function(r){return te(r)&&ct(r.length)&&!!z[me(r)]},pn=Object.prototype.hasOwnProperty;function mr(r,e){var t=H(r),n=!t&&ut(r),s=!t&&!n&&ze(r),i=!t&&!n&&!s&&gr(r),o=t||n||s||i,l=o?function(h,m){for(var f=-1,v=Array(h);++f<h;)v[f]=m(f);return v}(r.length,String):[],c=l.length;for(var u in r)!e&&!pn.call(r,u)||o&&(u=="length"||s&&(u=="offset"||u=="parent")||i&&(u=="buffer"||u=="byteLength"||u=="byteOffset")||at(u,c))||l.push(u);return l}function vr(r,e){return function(t){return r(e(t))}}var gn=vr(Object.keys,Object),mn=Object.prototype.hasOwnProperty;function Se(r){return ve(r)?mr(r):function(e){if(!dt(e))return gn(e);var t=[];for(var n in Object(e))mn.call(e,n)&&n!="constructor"&&t.push(n);return t}(r)}var vn=Object.prototype.hasOwnProperty;function yn(r){return ve(r)?mr(r,!0):function(e){if(!ie(e))return function(i){var o=[];if(i!=null)for(var l in Object(i))o.push(l);return o}(e);var t=dt(e),n=[];for(var s in e)(s!="constructor"||!t&&vn.call(e,s))&&n.push(s);return n}(r)}var bn=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,wn=/^\w*$/;function Xe(r,e){if(H(r))return!1;var t=typeof r;return!(t!="number"&&t!="symbol"&&t!="boolean"&&r!=null&&!pe(r))||wn.test(r)||!bn.test(r)||e!=null&&r in Object(e)}var we=ae(Object,"create"),xn=Object.prototype.hasOwnProperty,_n=Object.prototype.hasOwnProperty;function se(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var n=r[e];this.set(n[0],n[1])}}function je(r,e){for(var t=r.length;t--;)if(Re(r[t][0],e))return t;return-1}se.prototype.clear=function(){this.__data__=we?we(null):{},this.size=0},se.prototype.delete=function(r){var e=this.has(r)&&delete this.__data__[r];return this.size-=e?1:0,e},se.prototype.get=function(r){var e=this.__data__;if(we){var t=e[r];return t==="__lodash_hash_undefined__"?void 0:t}return xn.call(e,r)?e[r]:void 0},se.prototype.has=function(r){var e=this.__data__;return we?e[r]!==void 0:_n.call(e,r)},se.prototype.set=function(r,e){var t=this.__data__;return this.size+=this.has(r)?0:1,t[r]=we&&e===void 0?"__lodash_hash_undefined__":e,this};var kn=Array.prototype.splice;function ee(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var n=r[e];this.set(n[0],n[1])}}ee.prototype.clear=function(){this.__data__=[],this.size=0},ee.prototype.delete=function(r){var e=this.__data__,t=je(e,r);return!(t<0||(t==e.length-1?e.pop():kn.call(e,t,1),--this.size,0))},ee.prototype.get=function(r){var e=this.__data__,t=je(e,r);return t<0?void 0:e[t][1]},ee.prototype.has=function(r){return je(this.__data__,r)>-1},ee.prototype.set=function(r,e){var t=this.__data__,n=je(t,r);return n<0?(++this.size,t.push([r,e])):t[n][1]=e,this};var ke=ae(J,"Map");function Me(r,e){var t,n,s=r.__data__;return((n=typeof(t=e))=="string"||n=="number"||n=="symbol"||n=="boolean"?t!=="__proto__":t===null)?s[typeof e=="string"?"string":"hash"]:s.map}function K(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var n=r[e];this.set(n[0],n[1])}}function ht(r,e){if(typeof r!="function"||e!=null&&typeof e!="function")throw new TypeError("Expected a function");var t=function(){var n=arguments,s=e?e.apply(this,n):n[0],i=t.cache;if(i.has(s))return i.get(s);var o=r.apply(this,n);return t.cache=i.set(s,o)||i,o};return t.cache=new(ht.Cache||K),t}K.prototype.clear=function(){this.size=0,this.__data__={hash:new se,map:new(ke||ee),string:new se}},K.prototype.delete=function(r){var e=Me(this,r).delete(r);return this.size-=e?1:0,e},K.prototype.get=function(r){return Me(this,r).get(r)},K.prototype.has=function(r){return Me(this,r).has(r)},K.prototype.set=function(r,e){var t=Me(this,r),n=t.size;return t.set(r,e),this.size+=t.size==n?0:1,this},ht.Cache=K;var Ge,Ze,Cn=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Sn=/\\(\\)?/g,En=(Ge=ht(function(r){var e=[];return r.charCodeAt(0)===46&&e.push(""),r.replace(Cn,function(t,n,s,i){e.push(s?i.replace(Sn,"$1"):n||t)}),e},function(r){return Ze.size===500&&Ze.clear(),r}),Ze=Ge.cache,Ge);function yr(r,e){return H(r)?r:Xe(r,e)?[r]:En(function(t){return t==null?"":lr(t)}(r))}var An=1/0;function Oe(r){if(typeof r=="string"||pe(r))return r;var e=r+"";return e=="0"&&1/r==-An?"-0":e}function Ke(r,e){for(var t=0,n=(e=yr(e,r)).length;r!=null&&t<n;)r=r[Oe(e[t++])];return t&&t==n?r:void 0}function ft(r,e){for(var t=-1,n=e.length,s=r.length;++t<n;)r[s+t]=e[t];return r}var Mt=Y?Y.isConcatSpreadable:void 0;function Ln(r){return H(r)||ut(r)||!!(Mt&&r&&r[Mt])}function Fn(r,e,t,n,s){var i=-1,o=r.length;for(t||(t=Ln),s||(s=[]);++i<o;){var l=r[i];t(l)?ft(s,l):s[s.length]=l}return s}var br=vr(Object.getPrototypeOf,Object);function Q(r){var e=this.__data__=new ee(r);this.size=e.size}Q.prototype.clear=function(){this.__data__=new ee,this.size=0},Q.prototype.delete=function(r){var e=this.__data__,t=e.delete(r);return this.size=e.size,t},Q.prototype.get=function(r){return this.__data__.get(r)},Q.prototype.has=function(r){return this.__data__.has(r)},Q.prototype.set=function(r,e){var t=this.__data__;if(t instanceof ee){var n=t.__data__;if(!ke||n.length<199)return n.push([r,e]),this.size=++t.size,this;t=this.__data__=new K(n)}return t.set(r,e),this.size=t.size,this};var wr=typeof V=="object"&&V&&!V.nodeType&&V,It=wr&&typeof G=="object"&&G&&!G.nodeType&&G,$t=It&&It.exports===wr?J.Buffer:void 0,Ot=$t?$t.allocUnsafe:void 0;function xr(){return[]}var jn=Object.prototype.propertyIsEnumerable,Nt=Object.getOwnPropertySymbols,Mn=Nt?function(r){return r==null?[]:(r=Object(r),function(e,t){for(var n=-1,s=e==null?0:e.length,i=0,o=[];++n<s;){var l=e[n];jn.call(r,l)&&(o[i++]=l)}return o}(Nt(r)))}:xr,pt=Mn,In=Object.getOwnPropertySymbols?function(r){for(var e=[];r;)ft(e,pt(r)),r=br(r);return e}:xr;function $n(r,e,t){var n=e(r);return H(r)?n:ft(n,t(r))}function et(r){return $n(r,Se,pt)}var tt=ae(J,"DataView"),rt=ae(J,"Promise"),nt=ae(J,"Set"),Bt="[object Map]",zt="[object Promise]",Tt="[object Set]",Pt="[object WeakMap]",Rt="[object DataView]",On=oe(tt),Nn=oe(ke),Bn=oe(rt),zn=oe(nt),Tn=oe(Je),ne=me;(tt&&ne(new tt(new ArrayBuffer(1)))!=Rt||ke&&ne(new ke)!=Bt||rt&&ne(rt.resolve())!=zt||nt&&ne(new nt)!=Tt||Je&&ne(new Je)!=Pt)&&(ne=function(r){var e=me(r),t=e=="[object Object]"?r.constructor:void 0,n=t?oe(t):"";if(n)switch(n){case On:return Rt;case Nn:return Bt;case Bn:return zt;case zn:return Tt;case Tn:return Pt}return e});var Ce=ne,Pn=Object.prototype.hasOwnProperty,Te=J.Uint8Array;function Rn(r){var e=new r.constructor(r.byteLength);return new Te(e).set(new Te(r)),e}var qn=/\w*$/,qt=Y?Y.prototype:void 0,Wt=qt?qt.valueOf:void 0,Wn="[object Boolean]",Hn="[object Date]",Dn="[object Map]",Un="[object Number]",Vn="[object RegExp]",Gn="[object Set]",Zn="[object String]",Yn="[object Symbol]",Qn="[object ArrayBuffer]",Jn="[object DataView]",Xn="[object Float32Array]",Kn="[object Float64Array]",es="[object Int8Array]",ts="[object Int16Array]",rs="[object Int32Array]",ns="[object Uint8Array]",ss="[object Uint8ClampedArray]",is="[object Uint16Array]",os="[object Uint32Array]",Ht=ge&&ge.isMap,as=Ht?qe(Ht):function(r){return te(r)&&Ce(r)=="[object Map]"},Dt=ge&&ge.isSet,ls=Dt?qe(Dt):function(r){return te(r)&&Ce(r)=="[object Set]"},cs=1,ds=2,_r="[object Arguments]",kr="[object Function]",us="[object GeneratorFunction]",Cr="[object Object]",O={};function Ne(r,e,t,n,s,i){var o,l=e&cs,c=e&ds;if(o!==void 0)return o;if(!ie(r))return r;var u=H(r);if(u){if(o=function(p){var y=p.length,_=new p.constructor(y);return y&&typeof p[0]=="string"&&Pn.call(p,"index")&&(_.index=p.index,_.input=p.input),_}(r),!l)return function(p,y){var _=-1,k=p.length;for(y||(y=Array(k));++_<k;)y[_]=p[_];return y}(r,o)}else{var h=Ce(r),m=h==kr||h==us;if(ze(r))return function(p,y){var _=p.length,k=Ot?Ot(_):new p.constructor(_);return p.copy(k),k}(r);if(h==Cr||h==_r||m&&!s){if(o=m?{}:function(p){return typeof p.constructor!="function"||dt(p)?{}:Kr(br(p))}(r),!l)return c?function(p,y){return Fe(p,In(p),y)}(r,function(p,y){return p&&Fe(y,yn(y),p)}(o,r)):function(p,y){return Fe(p,pt(p),y)}(r,function(p,y){return p&&Fe(y,Se(y),p)}(o,r))}else{if(!O[h])return s?r:{};o=function(p,y,_){var k,j,N=p.constructor;switch(y){case Qn:return Rn(p);case Wn:case Hn:return new N(+p);case Jn:return function(E,T){var S=E.buffer;return new E.constructor(S,E.byteOffset,E.byteLength)}(p);case Xn:case Kn:case es:case ts:case rs:case ns:case ss:case is:case os:return function(E,T){var S=E.buffer;return new E.constructor(S,E.byteOffset,E.length)}(p);case Dn:return new N;case Un:case Zn:return new N(p);case Vn:return(j=new(k=p).constructor(k.source,qn.exec(k))).lastIndex=k.lastIndex,j;case Gn:return new N;case Yn:return Wt?Object(Wt.call(p)):{}}}(r,h)}}i||(i=new Q);var f=i.get(r);if(f)return f;i.set(r,o),ls(r)?r.forEach(function(p){o.add(Ne(p,e,t,p,r,i))}):as(r)&&r.forEach(function(p,y){o.set(y,Ne(p,e,t,y,r,i))});var v=u?void 0:et(r);return function(p,y){for(var _=-1,k=p==null?0:p.length;++_<k&&y(p[_],_)!==!1;);}(v||r,function(p,y){v&&(p=r[y=p]),dr(o,y,Ne(p,e,t,y,r,i))}),o}function Ye(r){return Ne(r,4)}function _e(r){var e=-1,t=r==null?0:r.length;for(this.__data__=new K;++e<t;)this.add(r[e])}function hs(r,e){for(var t=-1,n=r==null?0:r.length;++t<n;)if(e(r[t],t,r))return!0;return!1}function st(r,e){return r.has(e)}O[_r]=O["[object Array]"]=O["[object ArrayBuffer]"]=O["[object DataView]"]=O["[object Boolean]"]=O["[object Date]"]=O["[object Float32Array]"]=O["[object Float64Array]"]=O["[object Int8Array]"]=O["[object Int16Array]"]=O["[object Int32Array]"]=O["[object Map]"]=O["[object Number]"]=O[Cr]=O["[object RegExp]"]=O["[object Set]"]=O["[object String]"]=O["[object Symbol]"]=O["[object Uint8Array]"]=O["[object Uint8ClampedArray]"]=O["[object Uint16Array]"]=O["[object Uint32Array]"]=!0,O["[object Error]"]=O[kr]=O["[object WeakMap]"]=!1,_e.prototype.add=_e.prototype.push=function(r){return this.__data__.set(r,"__lodash_hash_undefined__"),this},_e.prototype.has=function(r){return this.__data__.has(r)};var fs=1,ps=2;function Ut(r,e,t,n,s,i){var o=t&fs,l=r.length,c=e.length;if(l!=c&&!(o&&c>l))return!1;var u=i.get(r),h=i.get(e);if(u&&h)return u==e&&h==r;var m=-1,f=!0,v=t&ps?new _e:void 0;for(i.set(r,e),i.set(e,r);++m<l;){var p=r[m],y=e[m];if(n)var _=o?n(y,p,m,e,r,i):n(p,y,m,r,e,i);if(_!==void 0){if(_)continue;f=!1;break}if(v){if(!hs(e,function(k,j){if(!st(v,j)&&(p===k||s(p,k,t,n,i)))return v.push(j)})){f=!1;break}}else if(p!==y&&!s(p,y,t,n,i)){f=!1;break}}return i.delete(r),i.delete(e),f}function gs(r){var e=-1,t=Array(r.size);return r.forEach(function(n,s){t[++e]=[s,n]}),t}function ms(r){var e=-1,t=Array(r.size);return r.forEach(function(n){t[++e]=n}),t}var vs=1,ys=2,bs="[object Boolean]",ws="[object Date]",xs="[object Error]",_s="[object Map]",ks="[object Number]",Cs="[object RegExp]",Ss="[object Set]",Es="[object String]",As="[object Symbol]",Ls="[object ArrayBuffer]",Fs="[object DataView]",Vt=Y?Y.prototype:void 0,Qe=Vt?Vt.valueOf:void 0,js=1,Ms=Object.prototype.hasOwnProperty,Is=1,Gt="[object Arguments]",Zt="[object Array]",Ie="[object Object]",Yt=Object.prototype.hasOwnProperty;function it(r,e,t,n,s){return r===e||(r==null||e==null||!te(r)&&!te(e)?r!=r&&e!=e:function(i,o,l,c,u,h){var m=H(i),f=H(o),v=m?Zt:Ce(i),p=f?Zt:Ce(o),y=(v=v==Gt?Ie:v)==Ie,_=(p=p==Gt?Ie:p)==Ie,k=v==p;if(k&&ze(i)){if(!ze(o))return!1;m=!0,y=!1}if(k&&!y)return h||(h=new Q),m||gr(i)?Ut(i,o,l,c,u,h):function(S,A,R,U,X,F,B){switch(R){case Fs:if(S.byteLength!=A.byteLength||S.byteOffset!=A.byteOffset)return!1;S=S.buffer,A=A.buffer;case Ls:return!(S.byteLength!=A.byteLength||!F(new Te(S),new Te(A)));case bs:case ws:case ks:return Re(+S,+A);case xs:return S.name==A.name&&S.message==A.message;case Cs:case Es:return S==A+"";case _s:var P=gs;case Ss:if(P||(P=ms),S.size!=A.size&&!(U&vs))return!1;var W=B.get(S);if(W)return W==A;U|=ys,B.set(S,A);var Z=Ut(P(S),P(A),U,X,F,B);return B.delete(S),Z;case As:if(Qe)return Qe.call(S)==Qe.call(A)}return!1}(i,o,v,l,c,u,h);if(!(l&Is)){var j=y&&Yt.call(i,"__wrapped__"),N=_&&Yt.call(o,"__wrapped__");if(j||N){var E=j?i.value():i,T=N?o.value():o;return h||(h=new Q),u(E,T,l,c,h)}}return!!k&&(h||(h=new Q),function(S,A,R,U,X,F){var B=R&js,P=et(S),W=P.length;if(W!=et(A).length&&!B)return!1;for(var Z=W;Z--;){var g=P[Z];if(!(B?g in A:Ms.call(A,g)))return!1}var a=F.get(S),d=F.get(A);if(a&&d)return a==A&&d==S;var b=!0;F.set(S,A),F.set(A,S);for(var w=B;++Z<W;){var x=S[g=P[Z]],C=A[g];if(U)var I=B?U(C,x,g,A,S,F):U(x,C,g,S,A,F);if(!(I===void 0?x===C||X(x,C,R,U,F):I)){b=!1;break}w||(w=g=="constructor")}if(b&&!w){var q=S.constructor,$=A.constructor;q==$||!("constructor"in S)||!("constructor"in A)||typeof q=="function"&&q instanceof q&&typeof $=="function"&&$ instanceof $||(b=!1)}return F.delete(S),F.delete(A),b}(i,o,l,c,u,h))}(r,e,t,n,it,s))}var $s=1,Os=2;function Qt(r){return r==r&&!ie(r)}function Jt(r,e){return function(t){return t!=null&&t[r]===e&&(e!==void 0||r in Object(t))}}function Ns(r,e){return r!=null&&e in Object(r)}var Bs=1,zs=2;function le(r){return typeof r=="function"?r:r==null?Pe:typeof r=="object"?H(r)?function(i,o){return Xe(i)&&Qt(o)?Jt(Oe(i),o):function(l){var c=function(u,h,m){var f=u==null?void 0:Ke(u,h);return f===void 0?void 0:f}(l,i);return c===void 0&&c===o?function(u,h){return u!=null&&function(m,f,v){for(var p=-1,y=(f=yr(f,m)).length,_=!1;++p<y;){var k=Oe(f[p]);if(!(_=m!=null&&v(m,k)))break;m=m[k]}return _||++p!=y?_:!!(y=m==null?0:m.length)&&ct(y)&&at(k,y)&&(H(m)||ut(m))}(u,h,Ns)}(l,i):it(o,c,Bs|zs)}}(r[0],r[1]):(s=function(i){for(var o=Se(i),l=o.length;l--;){var c=o[l],u=i[c];o[l]=[c,u,Qt(u)]}return o}(n=r),s.length==1&&s[0][2]?Jt(s[0][0],s[0][1]):function(i){return i===n||function(o,l,c,u){var h=c.length,m=h;if(o==null)return!m;for(o=Object(o);h--;){var f=c[h];if(f[2]?f[1]!==o[f[0]]:!(f[0]in o))return!1}for(;++h<m;){var v=(f=c[h])[0],p=o[v],y=f[1];if(f[2]){if(p===void 0&&!(v in o))return!1}else{var _=new Q;if(!it(y,p,$s|Os,void 0,_))return!1}}return!0}(i,0,s)}):Xe(e=r)?(t=Oe(e),function(i){return i==null?void 0:i[t]}):function(i){return function(o){return Ke(o,i)}}(e);var e,t,n,s}var Ts=function(r,e,t){for(var n=-1,s=Object(r),i=t(r),o=i.length;o--;){var l=i[++n];if(e(s[l],l,s)===!1)break}return r};function Sr(r,e){return r&&Ts(r,e,Se)}var Xt,Ps=(Xt=Sr,function(r,e){if(r==null)return r;if(!ve(r))return Xt(r,e);for(var t=r.length,n=-1,s=Object(r);++n<t&&e(s[n],n,s)!==!1;);return r});function Er(r,e){var t=-1,n=ve(r)?Array(r.length):[];return Ps(r,function(s,i,o){n[++t]=e(s,i,o)}),n}function Rs(r,e){return r>e}var qs=Math.min;function Ws(r){return function(e){return te(e)&&ve(e)}(r)?r:[]}var Hs=ur(function(r){var e=fe(r,Ws);return e.length&&e[0]===r[0]?function(t,n,s){for(var i=on,o=t[0].length,l=t.length,c=l,u=Array(l),h=1/0,m=[];c--;){var f=t[c];h=qs(f.length,h),u[c]=o>=120&&f.length>=120?new _e(c&&f):void 0}f=t[0];var v=-1,p=u[0];e:for(;++v<o&&m.length<h;){var y=f[v],_=y;if(y=y!==0?y:0,!(p?st(p,_):i(m,_,s))){for(c=l;--c;){var k=u[c];if(!(k?st(k,_):i(t[c],_,s)))continue e}p&&p.push(_),m.push(y)}}return m}(e):[]}),Ds=Hs;function Us(r,e){return r<e}function M(r,e){var t={};return e=le(e),Sr(r,function(n,s,i){lt(t,s,e(n,s,i))}),t}function Ar(r,e,t){for(var n=-1,s=r.length;++n<s;){var i=r[n],o=e(i);if(o!=null&&(l===void 0?o==o&&!pe(o):t(o,l)))var l=o,c=i}return c}function Vs(r,e){return r&&r.length?Ar(r,le(e),Rs):void 0}function Lr(r,e){for(var t,n=-1,s=r.length;++n<s;){var i=e(r[n]);i!==void 0&&(t=t===void 0?i:t+i)}return t}function Gs(r,e){return function(t,n){var s=t==null?0:t.length;return s?Lr(t,n)/s:NaN}(r,le(e))}function Zs(r,e){if(r!==e){var t=r!==void 0,n=r===null,s=r==r,i=pe(r),o=e!==void 0,l=e===null,c=e==e,u=pe(e);if(!l&&!u&&!i&&r>e||i&&o&&c&&!l&&!u||n&&o&&c||!t&&c||!s)return 1;if(!n&&!i&&!u&&r<e||u&&t&&s&&!n&&!i||l&&t&&s||!o&&s||!c)return-1}return 0}function Fr(r,e,t){e=e.length?fe(e,function(s){return H(s)?function(i){return Ke(i,s.length===1?s[0]:s)}:s}):[Pe];var n=-1;return e=fe(e,qe(le)),function(s,i){var o=s.length;for(s.sort(function(l,c){return function(u,h,m){for(var f=-1,v=u.criteria,p=h.criteria,y=v.length,_=m.length;++f<y;){var k=Zs(v[f],p[f]);if(k)return f>=_?k:k*(m[f]=="desc"?-1:1)}return u.index-h.index}(l,c,t)});o--;)s[o]=s[o].value;return s}(Er(r,function(s,i,o){return{criteria:fe(e,function(l){return l(s)}),index:++n,value:s}}))}function gt(r,e,t,n){return r==null?[]:(H(e)||(e=e==null?[]:[e]),H(t=t)||(t=t==null?[]:[t]),Fr(r,e,t))}var Ys=ur(function(r,e){if(r==null)return[];var t=e.length;return t>1&&Et(r,e[0],e[1])?e=[]:t>2&&Et(e[0],e[1],e[2])&&(e=[e[0]]),Fr(r,Fn(e),[])});function Qs(r,e){return r&&r.length?Lr(r,le(e)):0}function L(r){if(this.words=[],r)if(Symbol&&Symbol.iterator&&r[Symbol.iterator]!==void 0){const e=r[Symbol.iterator]();let t=e.next();for(;!t.done;)this.add(t.value),t=e.next()}else for(let e=0;e<r.length;e++)this.add(r[e])}L.fromWords=function(r){const e=Object.create(L.prototype);return e.words=r,e},L.prototype.add=function(r){this.resize(r),this.words[r>>>5]|=1<<r},L.prototype.flip=function(r){this.resize(r),this.words[r>>>5]^=1<<r},L.prototype.clear=function(){this.words.length=0},L.prototype.remove=function(r){this.resize(r),this.words[r>>>5]&=~(1<<r)},L.prototype.isEmpty=function(r){const e=this.words.length;for(let t=0;t<e;t++)if(this.words[t]!==0)return!1;return!0},L.prototype.has=function(r){return(this.words[r>>>5]&1<<r)!=0},L.prototype.checkedAdd=function(r){this.resize(r);const e=this.words[r>>>5],t=e|1<<r;return this.words[r>>>5]=t,(t^e)>>>r},L.prototype.trim=function(r){let e=this.words.length;for(;e>0&&this.words[e-1]===0;)e--;this.words.length=e},L.prototype.resize=function(r){const e=r+32>>>5;for(let t=this.words.length;t<e;t++)this.words[t]=0},L.prototype.hammingWeight=function(r){return 16843009*((r=(858993459&(r-=r>>>1&1431655765))+(r>>>2&858993459))+(r>>>4)&252645135)>>>24},L.prototype.hammingWeight4=function(r,e,t,n){return 16843009*((r=(r=(858993459&(r-=r>>>1&1431655765))+(r>>>2&858993459))+(r>>>4)&252645135)+(e=(e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)+(t=(t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)+(n=(n=(858993459&(n-=n>>>1&1431655765))+(n>>>2&858993459))+(n>>>4)&252645135))>>>24},L.prototype.size=function(){let r=0;const e=this.words.length,t=this.words;for(let n=0;n<e;n++)r+=this.hammingWeight(t[n]);return r},L.prototype.array=function(){const r=new Array(this.size());let e=0;const t=this.words.length;for(let n=0;n<t;++n){let s=this.words[n];for(;s!=0;){const i=s&-s;r[e++]=(n<<5)+this.hammingWeight(i-1|0),s^=i}}return r},L.prototype.forEach=function(r){const e=this.words.length;for(let t=0;t<e;++t){let n=this.words[t];for(;n!=0;){const s=n&-n;r((t<<5)+this.hammingWeight(s-1|0)),n^=s}}},L.prototype[Symbol.iterator]=function(){const r=this.words.length;let e=0,t=this.words[e],n=this.hammingWeight,s=this.words;return{[Symbol.iterator](){return this},next(){for(;e<r;){if(t!==0){const i=t&-t,o=(e<<5)+n(i-1|0);return t^=i,{done:!1,value:o}}e++,e<r&&(t=s[e])}return{done:!0,value:void 0}}}},L.prototype.clone=function(){const r=Object.create(L.prototype);return r.words=this.words.slice(),r},L.prototype.intersects=function(r){const e=Math.min(this.words.length,r.words.length);for(let t=0;t<e;++t)if(this.words[t]&r.words[t])return!0;return!1},L.prototype.intersection=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]&=r.words[t],this.words[t+1]&=r.words[t+1],this.words[t+2]&=r.words[t+2],this.words[t+3]&=r.words[t+3],this.words[t+4]&=r.words[t+4],this.words[t+5]&=r.words[t+5],this.words[t+6]&=r.words[t+6],this.words[t+7]&=r.words[t+7];for(;t<e;++t)this.words[t]&=r.words[t];const n=this.words.length;for(t=e;t<n;++t)this.words[t]=0;return this},L.prototype.intersection_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(let n=0;n<e;++n)t+=this.hammingWeight(this.words[n]&r.words[n]);return t},L.prototype.new_intersection=function(r){const e=Object.create(L.prototype),t=Math.min(this.words.length,r.words.length);e.words=new Array(t);let n=0;for(;n+7<t;n+=8)e.words[n]=this.words[n]&r.words[n],e.words[n+1]=this.words[n+1]&r.words[n+1],e.words[n+2]=this.words[n+2]&r.words[n+2],e.words[n+3]=this.words[n+3]&r.words[n+3],e.words[n+4]=this.words[n+4]&r.words[n+4],e.words[n+5]=this.words[n+5]&r.words[n+5],e.words[n+6]=this.words[n+6]&r.words[n+6],e.words[n+7]=this.words[n+7]&r.words[n+7];for(;n<t;++n)e.words[n]=this.words[n]&r.words[n];return e},L.prototype.equals=function(r){const e=Math.min(this.words.length,r.words.length);for(let t=0;t<e;++t)if(this.words[t]!=r.words[t])return!1;if(this.words.length<r.words.length){const t=r.words.length;for(let n=this.words.length;n<t;++n)if(r.words[n]!=0)return!1}else if(r.words.length<this.words.length){const t=this.words.length;for(let n=r.words.length;n<t;++n)if(this.words[n]!=0)return!1}return!0},L.prototype.difference=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]&=~r.words[t],this.words[t+1]&=~r.words[t+1],this.words[t+2]&=~r.words[t+2],this.words[t+3]&=~r.words[t+3],this.words[t+4]&=~r.words[t+4],this.words[t+5]&=~r.words[t+5],this.words[t+6]&=~r.words[t+6],this.words[t+7]&=~r.words[t+7];for(;t<e;++t)this.words[t]&=~r.words[t];return this},L.prototype.new_difference=function(r){return this.clone().difference(r)},L.prototype.difference2=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)r.words[t]=this.words[t]&~r.words[t],r.words[t+1]=this.words[t+1]&~r.words[t+1],r.words[t+2]=this.words[t+2]&~r.words[t+2],r.words[t+3]=this.words[t+3]&~r.words[t+3],r.words[t+4]=this.words[t+4]&~r.words[t+4],r.words[t+5]=this.words[t+5]&~r.words[t+5],r.words[t+6]=this.words[t+6]&~r.words[t+6],r.words[t+7]=this.words[t+7]&~r.words[t+7];for(;t<e;++t)r.words[t]=this.words[t]&~r.words[t];for(t=this.words.length-1;t>=e;--t)r.words[t]=this.words[t];return r.words.length=this.words.length,r},L.prototype.difference_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0,n=0;for(;n<e;++n)t+=this.hammingWeight(this.words[n]&~r.words[n]);const s=this.words.length;for(;n<s;++n)t+=this.hammingWeight(this.words[n]);return t},L.prototype.change=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]^=r.words[t],this.words[t+1]^=r.words[t+1],this.words[t+2]^=r.words[t+2],this.words[t+3]^=r.words[t+3],this.words[t+4]^=r.words[t+4],this.words[t+5]^=r.words[t+5],this.words[t+6]^=r.words[t+6],this.words[t+7]^=r.words[t+7];for(;t<e;++t)this.words[t]^=r.words[t];for(t=r.words.length-1;t>=e;--t)this.words[t]=r.words[t];return this},L.prototype.new_change=function(r){const e=Object.create(L.prototype),t=Math.max(this.words.length,r.words.length);e.words=new Array(t);const n=Math.min(this.words.length,r.words.length);let s=0;for(;s+7<n;s+=8)e.words[s]=this.words[s]^r.words[s],e.words[s+1]=this.words[s+1]^r.words[s+1],e.words[s+2]=this.words[s+2]^r.words[s+2],e.words[s+3]=this.words[s+3]^r.words[s+3],e.words[s+4]=this.words[s+4]^r.words[s+4],e.words[s+5]=this.words[s+5]^r.words[s+5],e.words[s+6]=this.words[s+6]^r.words[s+6],e.words[s+7]=this.words[s+7]^r.words[s+7];for(;s<n;++s)e.words[s]=this.words[s]^r.words[s];const i=this.words.length;for(s=n;s<i;++s)e.words[s]=this.words[s];const o=r.words.length;for(s=n;s<o;++s)e.words[s]=r.words[s];return e},L.prototype.change_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0,n=0;for(;n<e;++n)t+=this.hammingWeight(this.words[n]^r.words[n]);const s=this.words.length>r.words.length?this:r,i=s.words.length;for(;n<i;++n)t+=this.hammingWeight(s.words[n]);return t},L.prototype.toString=function(){return"{"+this.array().join(",")+"}"},L.prototype.union=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]|=r.words[t],this.words[t+1]|=r.words[t+1],this.words[t+2]|=r.words[t+2],this.words[t+3]|=r.words[t+3],this.words[t+4]|=r.words[t+4],this.words[t+5]|=r.words[t+5],this.words[t+6]|=r.words[t+6],this.words[t+7]|=r.words[t+7];for(;t<e;++t)this.words[t]|=r.words[t];if(this.words.length<r.words.length){this.resize((r.words.length<<5)-1);const n=r.words.length;for(let s=e;s<n;++s)this.words[s]=r.words[s]}return this},L.prototype.new_union=function(r){const e=Object.create(L.prototype),t=Math.max(this.words.length,r.words.length);e.words=new Array(t);const n=Math.min(this.words.length,r.words.length);let s=0;for(;s+7<n;s+=8)e.words[s]=this.words[s]|r.words[s],e.words[s+1]=this.words[s+1]|r.words[s+1],e.words[s+2]=this.words[s+2]|r.words[s+2],e.words[s+3]=this.words[s+3]|r.words[s+3],e.words[s+4]=this.words[s+4]|r.words[s+4],e.words[s+5]=this.words[s+5]|r.words[s+5],e.words[s+6]=this.words[s+6]|r.words[s+6],e.words[s+7]=this.words[s+7]|r.words[s+7];for(;s<n;++s)e.words[s]=this.words[s]|r.words[s];const i=this.words.length;for(s=n;s<i;++s)e.words[s]=this.words[s];const o=r.words.length;for(s=n;s<o;++s)e.words[s]=r.words[s];return e},L.prototype.union_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(let n=0;n<e;++n)t+=this.hammingWeight(this.words[n]|r.words[n]);if(this.words.length<r.words.length){const n=r.words.length;for(let s=this.words.length;s<n;++s)t+=this.hammingWeight(0|r.words[s])}else{const n=this.words.length;for(let s=r.words.length;s<n;++s)t+=this.hammingWeight(0|this.words[s])}return t};var D=L;function ot(){return ot=Object.assign||function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r},ot.apply(this,arguments)}function Js(r,e){var t=[];return r.forEach(function(n){e.forEach(function(s){t.push(n.concat(s))})}),t}function jr(r){return!!~r.search(/\(|\)/)}function Kt(r,e){for(var t=e.split(" "+r+" "),n=[],s=[],i=0;i<t.length;i++)if(jr(t[i])||s.length>0){s.push(t[i]);var o=""+s;(o.match(/\(/g)||[]).length===(o.match(/\)/g)||[]).length&&(n.push(s.join(" "+r+" ")),s=[])}else n.push(t[i]);return n}var Xs=function r(e){return function(n){for(var s=n[0],i=1;i<n.length;i++)s=s.concat(n[i]);return s}(Kt("OR",(t=e=function(n){if(n.charAt(0)==="("){for(var s=0,i=0;i<n.length;i++)if(n.charAt(i)==="("?s++:n.charAt(i)===")"&&s--,s===0)return i!==n.length-1?n:n.substring(1,n.length-1)}return n}(e),e=t.replace(/[\s]+/g," "))).map(function(n){for(var s=Kt("AND",n),i=[],o=[],l=0;l<s.length;l++)jr(s[l])?i.push(r(s[l])):o.push(s[l]);return i.push([o]),function(c){for(var u=[[]],h=0;h<c.length;h++)u=Js(u,c[h]);return u}(i)}));var t};const er=function(r){try{return structuredClone(r)}catch{try{return JSON.parse(JSON.stringify(r))}catch{return r}}},tr=function(r,e){let t=new D([]),n=0;return M(e,function(s,i){s.forEach(o=>{++n,t=t.new_union(r[i][o]||new D([]))})}),n===0?null:t},Ks=function(r,e,t){let n=1;return M(r.bits_data_temp,(s,i)=>{let o,l,c,u,h,m,f;t[i]&&(o=t[i].order,l=t[i].sort,c=t[i].size,u=t[i].title,h=t[i].show_facet_stats||!1,m=t[i].chosen_filters_on_top!==!1,f=t[i].hide_zero_doc_count||!1);let v,p,y,_,k=Object.entries(s).map(E=>{let T=[];e&&e.filters&&e.filters[i]&&(T=e.filters[i]);const S=E[1].array().length;if(!f||S!==0||T.indexOf(E[0])!==-1)return{key:E[0],doc_count:S,selected:T.indexOf(E[0])!==-1}}).filter(Boolean);var j,N;return H(l)?(v=l||["key"],p=o||["asc"]):(l==="term"||l==="key"?(v=["key"],p=[o||"asc"]):(v=["doc_count","key"],p=[o||"desc","asc"]),m&&(v.unshift("selected"),p.unshift("desc"))),k=gt(k,v,p),k=k.slice(0,c||10),h&&(y=[],Object.entries(s).forEach(E=>{if(isNaN(E[0]))throw new Error("You cant use chars to calculate the facet_stats.");E[1].array().length>0&&E[1].forEach(()=>{y.push(parseInt(E[0]))})}),_={min:(j=y,j&&j.length?Ar(j,le(void 0),Us):void 0),max:Vs(y),avg:Gs(y),sum:Qs(y)}),ot({name:i,title:u||(N=i,N.replace(/^[\s_]+|[\s_]+$/g,"").replace(/[_\s]+/g," ").replace(/^[a-z]/,function(E){return E.toUpperCase()})),position:n++,buckets:k},h&&{facet_stats:_})})};function rr(r,e,t,n,s){e=e||Object.create(null);const i=parseInt(e.per_page||12),o=parseInt(e.page||1),l=e.is_all_filtered_items||!1;if(t.native_search_enabled===!1&&(e.query||e.filter))throw new Error('"query" and "filter" options are not working once native search is disabled');let c=0;const u=new Date().getTime();let h,m,f,v=s.bits_ids();if(e._ids)h=new D(e._ids),m=e._ids;else if(e.ids)m=s.internal_ids_from_ids_map(e.ids),h=new D(m);else if(n&&(e.query||e.filter)){const S=new Date().getTime();m=n.search(e.query,e.filter),c=new Date().getTime()-S,h=new D(m)}let p=new Date().getTime();const y=s.search(e,{query_ids:h});p=new Date().getTime()-p,h&&(v=h),y.ids&&(v=v.new_intersection(y.ids)),y.not_ids&&(v=v.new_difference(y.not_ids));let _=v.array(),k=_.map(S=>s.get_item(S)),j=!1;const N=new Date().getTime();let E=0;e.sort?k=function(S,A,R){return R&&R[A]&&(A=R[A]),A.field?gt(S,A.field,A.order||"asc"):S}(k,e.sort,t.sortings):m&&(_=m.filter(S=>v.has(S)),k=_.slice((o-1)*i,o*i).map(S=>s.get_item(S)),j=!0),j||(f=l?k:null,k=k.slice((o-1)*i,o*i)),E=new Date().getTime()-N;const T=new Date().getTime()-u;return{pagination:{per_page:i,page:o,total:_.length},timings:{total:T,facets:p,search:c,sorting:E},data:{items:k,allFilteredItems:f,aggregations:Ks(y,e,t.aggregations)}}}var $e=function(r){var e={exports:{}};return function(t,n){(function(){var s,i,o,l,c,u,h,m,f,v,p,y,_,k,j,N,E,T,S,A,R,U,X,F,B,P,W,Z,g=function(a){var d=new g.Index;return d.pipeline.add(g.trimmer,g.stopWordFilter,g.stemmer),a&&a.call(d,d),d};g.version="1.0.0",g.utils={},g.utils.warn=function(a){return function(d){a.console&&console.warn&&console.warn(d)}}(this),g.utils.asString=function(a){return a==null?"":a.toString()},g.EventEmitter=function(){this.events={}},g.EventEmitter.prototype.addListener=function(){var a=Array.prototype.slice.call(arguments),d=a.pop(),b=a;if(typeof d!="function")throw new TypeError("last argument must be a function");b.forEach(function(w){this.hasHandler(w)||(this.events[w]=[]),this.events[w].push(d)},this)},g.EventEmitter.prototype.removeListener=function(a,d){if(this.hasHandler(a)){var b=this.events[a].indexOf(d);this.events[a].splice(b,1),this.events[a].length||delete this.events[a]}},g.EventEmitter.prototype.emit=function(a){if(this.hasHandler(a)){var d=Array.prototype.slice.call(arguments,1);this.events[a].forEach(function(b){b.apply(void 0,d)})}},g.EventEmitter.prototype.hasHandler=function(a){return a in this.events},g.tokenizer=function(a){return arguments.length&&a!=null&&a!=null?Array.isArray(a)?a.map(function(d){return g.utils.asString(d).toLowerCase()}):a.toString().trim().toLowerCase().split(g.tokenizer.separator):[]},g.tokenizer.separator=/[\s\-]+/,g.tokenizer.load=function(a){var d=this.registeredFunctions[a];if(!d)throw new Error("Cannot load un-registered function: "+a);return d},g.tokenizer.label="default",g.tokenizer.registeredFunctions={default:g.tokenizer},g.tokenizer.registerFunction=function(a,d){d in this.registeredFunctions&&g.utils.warn("Overwriting existing tokenizer: "+d),a.label=d,this.registeredFunctions[d]=a},g.Pipeline=function(){this._stack=[]},g.Pipeline.registeredFunctions={},g.Pipeline.registerFunction=function(a,d){d in this.registeredFunctions&&g.utils.warn("Overwriting existing registered function: "+d),a.label=d,g.Pipeline.registeredFunctions[a.label]=a},g.Pipeline.warnIfFunctionNotRegistered=function(a){a.label&&a.label in this.registeredFunctions||g.utils.warn(`Function is not registered with pipeline. This may cause problems when serialising the index.
`,a)},g.Pipeline.load=function(a){var d=new g.Pipeline;return a.forEach(function(b){var w=g.Pipeline.registeredFunctions[b];if(!w)throw new Error("Cannot load un-registered function: "+b);d.add(w)}),d},g.Pipeline.prototype.add=function(){Array.prototype.slice.call(arguments).forEach(function(a){g.Pipeline.warnIfFunctionNotRegistered(a),this._stack.push(a)},this)},g.Pipeline.prototype.after=function(a,d){g.Pipeline.warnIfFunctionNotRegistered(d);var b=this._stack.indexOf(a);if(b==-1)throw new Error("Cannot find existingFn");this._stack.splice(b+=1,0,d)},g.Pipeline.prototype.before=function(a,d){g.Pipeline.warnIfFunctionNotRegistered(d);var b=this._stack.indexOf(a);if(b==-1)throw new Error("Cannot find existingFn");this._stack.splice(b,0,d)},g.Pipeline.prototype.remove=function(a){var d=this._stack.indexOf(a);d!=-1&&this._stack.splice(d,1)},g.Pipeline.prototype.run=function(a){for(var d=[],b=a.length,w=this._stack.length,x=0;x<b;x++){for(var C=a[x],I=0;I<w&&(C=this._stack[I](C,x,a))!==void 0&&C!=="";I++);C!==void 0&&C!==""&&d.push(C)}return d},g.Pipeline.prototype.reset=function(){this._stack=[]},g.Pipeline.prototype.toJSON=function(){return this._stack.map(function(a){return g.Pipeline.warnIfFunctionNotRegistered(a),a.label})},g.Vector=function(){this._magnitude=null,this.list=void 0,this.length=0},g.Vector.Node=function(a,d,b){this.idx=a,this.val=d,this.next=b},g.Vector.prototype.insert=function(a,d){this._magnitude=void 0;var b=this.list;if(!b)return this.list=new g.Vector.Node(a,d,b),this.length++;if(a<b.idx)return this.list=new g.Vector.Node(a,d,b),this.length++;for(var w=b,x=b.next;x!=null;){if(a<x.idx)return w.next=new g.Vector.Node(a,d,x),this.length++;w=x,x=x.next}return w.next=new g.Vector.Node(a,d,x),this.length++},g.Vector.prototype.magnitude=function(){if(this._magnitude)return this._magnitude;for(var a,d=this.list,b=0;d;)b+=(a=d.val)*a,d=d.next;return this._magnitude=Math.sqrt(b)},g.Vector.prototype.dot=function(a){for(var d=this.list,b=a.list,w=0;d&&b;)d.idx<b.idx?d=d.next:(d.idx>b.idx||(w+=d.val*b.val,d=d.next),b=b.next);return w},g.Vector.prototype.similarity=function(a){return this.dot(a)/(this.magnitude()*a.magnitude())},g.SortedSet=function(){this.length=0,this.elements=[]},g.SortedSet.load=function(a){var d=new this;return d.elements=a,d.length=a.length,d},g.SortedSet.prototype.add=function(){var a,d;for(a=0;a<arguments.length;a++)~this.indexOf(d=arguments[a])||this.elements.splice(this.locationFor(d),0,d);this.length=this.elements.length},g.SortedSet.prototype.toArray=function(){return this.elements.slice()},g.SortedSet.prototype.map=function(a,d){return this.elements.map(a,d)},g.SortedSet.prototype.forEach=function(a,d){return this.elements.forEach(a,d)},g.SortedSet.prototype.indexOf=function(a){for(var d=0,b=this.elements.length,w=b-d,x=d+Math.floor(w/2),C=this.elements[x];w>1;){if(C===a)return x;C<a&&(d=x),C>a&&(b=x),w=b-d,x=d+Math.floor(w/2),C=this.elements[x]}return C===a?x:-1},g.SortedSet.prototype.locationFor=function(a){for(var d=0,b=this.elements.length,w=b-d,x=d+Math.floor(w/2),C=this.elements[x];w>1;)C<a&&(d=x),C>a&&(b=x),w=b-d,x=d+Math.floor(w/2),C=this.elements[x];return C>a?x:C<a?x+1:void 0},g.SortedSet.prototype.intersect=function(a){for(var d=new g.SortedSet,b=0,w=0,x=this.length,C=a.length,I=this.elements,q=a.elements;!(b>x-1||w>C-1);)I[b]!==q[w]?I[b]<q[w]?b++:I[b]>q[w]&&w++:(d.add(I[b]),b++,w++);return d},g.SortedSet.prototype.clone=function(){var a=new g.SortedSet;return a.elements=this.toArray(),a.length=a.elements.length,a},g.SortedSet.prototype.union=function(a){var d,b,w;this.length>=a.length?(d=this,b=a):(d=a,b=this),w=d.clone();for(var x=0,C=b.toArray();x<C.length;x++)w.add(C[x]);return w},g.SortedSet.prototype.toJSON=function(){return this.toArray()},g.Index=function(){this._fields=[],this._ref="id",this.pipeline=new g.Pipeline,this.documentStore=new g.Store,this.tokenStore=new g.TokenStore,this.corpusTokens=new g.SortedSet,this.eventEmitter=new g.EventEmitter,this.tokenizerFn=g.tokenizer,this._idfCache={},this.on("add","remove","update",(function(){this._idfCache={}}).bind(this))},g.Index.prototype.on=function(){var a=Array.prototype.slice.call(arguments);return this.eventEmitter.addListener.apply(this.eventEmitter,a)},g.Index.prototype.off=function(a,d){return this.eventEmitter.removeListener(a,d)},g.Index.load=function(a){a.version!==g.version&&g.utils.warn("version mismatch: current "+g.version+" importing "+a.version);var d=new this;return d._fields=a.fields,d._ref=a.ref,d.tokenizer(g.tokenizer.load(a.tokenizer)),d.documentStore=g.Store.load(a.documentStore),d.tokenStore=g.TokenStore.load(a.tokenStore),d.corpusTokens=g.SortedSet.load(a.corpusTokens),d.pipeline=g.Pipeline.load(a.pipeline),d},g.Index.prototype.field=function(a,d){return this._fields.push({name:a,boost:(d=d||{}).boost||1}),this},g.Index.prototype.ref=function(a){return this._ref=a,this},g.Index.prototype.tokenizer=function(a){return a.label&&a.label in g.tokenizer.registeredFunctions||g.utils.warn("Function is not a registered tokenizer. This may cause problems when serialising the index"),this.tokenizerFn=a,this},g.Index.prototype.add=function(a,d){var b={},w=new g.SortedSet,x=a[this._ref];d=d===void 0||d,this._fields.forEach(function(Ae){var ue=this.pipeline.run(this.tokenizerFn(a[Ae.name]));b[Ae.name]=ue;for(var he=0;he<ue.length;he++){var Le=ue[he];w.add(Le),this.corpusTokens.add(Le)}},this),this.documentStore.set(x,w);for(var C=0;C<w.length;C++){for(var I=w.elements[C],q=0,$=0;$<this._fields.length;$++){var ce=this._fields[$],Ee=b[ce.name],ye=Ee.length;if(ye){for(var re=0,de=0;de<ye;de++)Ee[de]===I&&re++;q+=re/ye*ce.boost}}this.tokenStore.add(I,{ref:x,tf:q})}d&&this.eventEmitter.emit("add",a,this)},g.Index.prototype.remove=function(a,d){var b=a[this._ref];if(d=d===void 0||d,this.documentStore.has(b)){var w=this.documentStore.get(b);this.documentStore.remove(b),w.forEach(function(x){this.tokenStore.remove(x,b)},this),d&&this.eventEmitter.emit("remove",a,this)}},g.Index.prototype.update=function(a,d){d=d===void 0||d,this.remove(a,!1),this.add(a,!1),d&&this.eventEmitter.emit("update",a,this)},g.Index.prototype.idf=function(a){var d="@"+a;if(Object.prototype.hasOwnProperty.call(this._idfCache,d))return this._idfCache[d];var b=this.tokenStore.count(a),w=1;return b>0&&(w=1+Math.log(this.documentStore.length/b)),this._idfCache[d]=w},g.Index.prototype.search=function(a){var d=this.pipeline.run(this.tokenizerFn(a)),b=new g.Vector,w=[],x=this._fields.reduce(function(C,I){return C+I.boost},0);return d.some(function(C){return this.tokenStore.has(C)},this)?(d.forEach(function(C,I,q){var $=1/q.length*this._fields.length*x,ce=this,Ee=this.tokenStore.expand(C).reduce(function(ye,re){var de=ce.corpusTokens.indexOf(re),Ae=ce.idf(re),ue=1,he=new g.SortedSet;if(re!==C){var Le=Math.max(3,re.length-C.length);ue=1/Math.log(Le)}de>-1&&b.insert(de,$*Ae*ue);for(var mt=ce.tokenStore.get(re),vt=Object.keys(mt),$r=vt.length,We=0;We<$r;We++)he.add(mt[vt[We]].ref);return ye.union(he)},new g.SortedSet);w.push(Ee)},this),w.reduce(function(C,I){return C.intersect(I)}).map(function(C){return{ref:C,score:b.similarity(this.documentVector(C))}},this).sort(function(C,I){return I.score-C.score})):[]},g.Index.prototype.documentVector=function(a){for(var d=this.documentStore.get(a),b=d.length,w=new g.Vector,x=0;x<b;x++){var C=d.elements[x],I=this.tokenStore.get(C)[a].tf,q=this.idf(C);w.insert(this.corpusTokens.indexOf(C),I*q)}return w},g.Index.prototype.toJSON=function(){return{version:g.version,fields:this._fields,ref:this._ref,tokenizer:this.tokenizerFn.label,documentStore:this.documentStore.toJSON(),tokenStore:this.tokenStore.toJSON(),corpusTokens:this.corpusTokens.toJSON(),pipeline:this.pipeline.toJSON()}},g.Index.prototype.use=function(a){var d=Array.prototype.slice.call(arguments,1);d.unshift(this),a.apply(this,d)},g.Store=function(){this.store={},this.length=0},g.Store.load=function(a){var d=new this;return d.length=a.length,d.store=Object.keys(a.store).reduce(function(b,w){return b[w]=g.SortedSet.load(a.store[w]),b},{}),d},g.Store.prototype.set=function(a,d){this.has(a)||this.length++,this.store[a]=d},g.Store.prototype.get=function(a){return this.store[a]},g.Store.prototype.has=function(a){return a in this.store},g.Store.prototype.remove=function(a){this.has(a)&&(delete this.store[a],this.length--)},g.Store.prototype.toJSON=function(){return{store:this.store,length:this.length}},g.stemmer=(s={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},i={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},u="^("+(l="[^aeiou][^aeiouy]*")+")?"+(c=(o="[aeiouy]")+"[aeiou]*")+l+"("+c+")?$",h="^("+l+")?"+c+l+c+l,m="^("+l+")?"+o,f=new RegExp("^("+l+")?"+c+l),v=new RegExp(h),p=new RegExp(u),y=new RegExp(m),_=/^(.+?)(ss|i)es$/,k=/^(.+?)([^s])s$/,j=/^(.+?)eed$/,N=/^(.+?)(ed|ing)$/,E=/.$/,T=/(at|bl|iz)$/,S=new RegExp("([^aeiouylsz])\\1$"),A=new RegExp("^"+l+o+"[^aeiouwxy]$"),R=/^(.+?[^aeiou])y$/,U=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/,X=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,F=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/,B=/^(.+?)(s|t)(ion)$/,P=/^(.+?)e$/,W=/ll$/,Z=new RegExp("^"+l+o+"[^aeiouwxy]$"),function(a){var d,b,w,x,C,I,q;if(a.length<3)return a;if((w=a.substr(0,1))=="y"&&(a=w.toUpperCase()+a.substr(1)),C=k,(x=_).test(a)?a=a.replace(x,"$1$2"):C.test(a)&&(a=a.replace(C,"$1$2")),C=N,(x=j).test(a)){var $=x.exec(a);(x=f).test($[1])&&(a=a.replace(x=E,""))}else C.test(a)&&($=C.exec(a),(C=y).test(d=$[1])&&(I=S,q=A,(C=T).test(a=d)?a+="e":I.test(a)?a=a.replace(x=E,""):q.test(a)&&(a+="e")));return(x=R).test(a)&&(a=(d=($=x.exec(a))[1])+"i"),(x=U).test(a)&&(b=($=x.exec(a))[2],(x=f).test(d=$[1])&&(a=d+s[b])),(x=X).test(a)&&(b=($=x.exec(a))[2],(x=f).test(d=$[1])&&(a=d+i[b])),C=B,(x=F).test(a)?($=x.exec(a),(x=v).test(d=$[1])&&(a=d)):C.test(a)&&($=C.exec(a),(C=v).test(d=$[1]+$[2])&&(a=d)),(x=P).test(a)&&($=x.exec(a),C=p,I=Z,((x=v).test(d=$[1])||C.test(d)&&!I.test(d))&&(a=d)),C=v,(x=W).test(a)&&C.test(a)&&(a=a.replace(x=E,"")),w=="y"&&(a=w.toLowerCase()+a.substr(1)),a}),g.Pipeline.registerFunction(g.stemmer,"stemmer"),g.generateStopWordFilter=function(a){var d=a.reduce(function(b,w){return b[w]=w,b},{});return function(b){if(b&&d[b]!==b)return b}},g.stopWordFilter=g.generateStopWordFilter(["a","able","about","across","after","all","almost","also","am","among","an","and","any","are","as","at","be","because","been","but","by","can","cannot","could","dear","did","do","does","either","else","ever","every","for","from","get","got","had","has","have","he","her","hers","him","his","how","however","i","if","in","into","is","it","its","just","least","let","like","likely","may","me","might","most","must","my","neither","no","nor","not","of","off","often","on","only","or","other","our","own","rather","said","say","says","she","should","since","so","some","than","that","the","their","them","then","there","these","they","this","tis","to","too","twas","us","wants","was","we","were","what","when","where","which","while","who","whom","why","will","with","would","yet","you","your"]),g.Pipeline.registerFunction(g.stopWordFilter,"stopWordFilter"),g.trimmer=function(a){return a.replace(/^\W+/,"").replace(/\W+$/,"")},g.Pipeline.registerFunction(g.trimmer,"trimmer"),g.TokenStore=function(){this.root={docs:{}},this.length=0},g.TokenStore.load=function(a){var d=new this;return d.root=a.root,d.length=a.length,d},g.TokenStore.prototype.add=function(a,d,b){b=b||this.root;var w=a.charAt(0),x=a.slice(1);return w in b||(b[w]={docs:{}}),x.length===0?(b[w].docs[d.ref]=d,void(this.length+=1)):this.add(x,d,b[w])},g.TokenStore.prototype.has=function(a){if(!a)return!1;for(var d=this.root,b=0;b<a.length;b++){if(!d[a.charAt(b)])return!1;d=d[a.charAt(b)]}return!0},g.TokenStore.prototype.getNode=function(a){if(!a)return{};for(var d=this.root,b=0;b<a.length;b++){if(!d[a.charAt(b)])return{};d=d[a.charAt(b)]}return d},g.TokenStore.prototype.get=function(a,d){return this.getNode(a,d).docs||{}},g.TokenStore.prototype.count=function(a,d){return Object.keys(this.get(a,d)).length},g.TokenStore.prototype.remove=function(a,d){if(a){for(var b=this.root,w=0;w<a.length;w++){if(!(a.charAt(w)in b))return;b=b[a.charAt(w)]}delete b.docs[d]}},g.TokenStore.prototype.expand=function(a,d){var b=this.getNode(a);return d=d||[],Object.keys(b.docs||{}).length&&d.push(a),Object.keys(b).forEach(function(w){w!=="docs"&&d.concat(this.expand(a+w,d))},this),d},g.TokenStore.prototype.toJSON=function(){return{root:this.root,length:this.length}},t.exports=g})()}(e),e.exports}();class nr{constructor(e,t){this.store=new Map,this.idx=$e(function(){this.field("name",{boost:10}),((t==null?void 0:t.searchableFields)||[]).forEach(s=>this.field(s)),this.ref("_id"),t!=null&&t.isExactSearch&&(this.pipeline.remove($e.stemmer),this.pipeline.remove($e.stopWordFilter)),t!=null&&t.removeStopWordFilter&&this.pipeline.remove($e.stopWordFilter)});let n=1;(e||[]).map(s=>{s._id=n,++n,this.idx.add(s),this.store.set(s._id,s)})}search_full(e,t){return this.search(e,t).map(n=>this.store.get(n))}search(e,t){return t instanceof Function?(e?this.idx.search(e).map(n=>this.store.get(n.ref)):[...this.store.values()]).filter(t).map(n=>n._id):e?this.idx.search(e).map(n=>n.ref):[...this.store.keys()]}}class sr{constructor(e,t){(t=t||Object.create(null)).aggregations=t.aggregations||Object.create(null),this._items=e,this.config=t.aggregations,this.facets=function(o,l){l=l||[];const c={data:Object.create(null),bits_data:Object.create(null),bits_data_temp:Object.create(null)};let u=1;return l.forEach(h=>{c.data[h]=Object.create(null)}),o&&o.map(h=>(h._id||(h._id=u,++u),h)),o&&o.map(h=>(l.forEach(m=>{if(h){if(Array.isArray(h[m]))h[m].forEach(f=>{h[m]&&(c.data[m][f]||(c.data[m][f]=[]),c.data[m][f].push(parseInt(h._id)))});else if(h[m]!==void 0){const f=h[m];c.data[m][f]||(c.data[m][f]=[]),c.data[m][f].push(parseInt(h._id))}}}),h)),c.data=M(c.data,function(h,m){return c.bits_data[m]||(c.bits_data[m]=Object.create(null),c.bits_data_temp[m]=Object.create(null)),M(h,function(f,v){const p=Ys(f);return c.bits_data[m][v]=new D(p),p})}),c}(e,Se(t.aggregations)),this._items_map=Object.create(null),this._ids=[];let n=1;var s,i;i=o=>{this._ids.push(n),this._items_map[n]=o,o._id=n,++n},(H(s=e)?fe:Er)(s,le(i)),this.ids_map=Object.create(null),e&&e.forEach(o=>{const l=t.custom_id_field||"id";o[l]&&o._id&&(this.ids_map[o[l]]=o._id)}),this._bits_ids=new D(this._ids)}items(){return this._items}bits_ids(e){return e?new D(e):this._bits_ids}internal_ids_from_ids_map(e){return e.map(t=>this.ids_map[t])}index(){return this.facets}get_item(e){return this._items_map[e]}search(e,t){const n=this.config;t=t||Object.create(null);const s=Ye(this.facets);let i;s.not_ids=tr(s.bits_data,e.not_filters);const o=function(l,c){const u=[];return M(l.filters,function(h,m){if(h&&h.length)if(c[m].conjunction!==!1)M(h,function(f){u.push([m,f])});else{const f=[];M(h,function(v){f.push([m,v])}),u.push(f)}}),M(l.not_filters,function(h,m){h&&h.length&&M(h,function(f){u.push([m,"-",f])})}),u}(e,n);return i=function(l,c){const u=Ye(l);let h;c=c||[],M(u.bits_data,function(f,v){M(u.bits_data[v],function(p,y){u.bits_data_temp[v][y]=u.bits_data[v][y]})}),u.is_temp_copied=!0;const m=function(f,v){const p=Object.create(null);return M(v,function(y){if(Array.isArray(y[0])){let _=new D([]);M(y,function(k){const j=k[0];_=_.new_union(f.bits_data[j][k[1]]||new D([])),p[j]=_})}}),p}(l,c);return M(c,function(f){if(!Array.isArray(f[0])){const v=f[0],p=f[1];h=h&&u.bits_data_temp[v][p]?u.bits_data_temp[v][p].new_intersection(h):h&&!u.bits_data_temp[v][p]?new D([]):u.bits_data_temp[v][p]}}),h&&M(u.bits_data_temp,function(f,v){M(u.bits_data_temp[v],function(p,y){u.bits_data_temp[v][y]=u.bits_data_temp[v][y].new_intersection(h)})}),M(c,function(f){if(f.length===3&&f[1]==="-"){const v=u.bits_data_temp[f[0]][f[2]].clone();M(u.bits_data_temp,function(p,y){M(u.bits_data_temp[y],function(_,k){u.bits_data_temp[y][k]=u.bits_data_temp[y][k].new_difference(v)})})}}),M(u.bits_data_temp,function(f,v){M(u.bits_data_temp[v],function(p,y){M(m,function(_,k){k!==v&&(u.bits_data_temp[v][y]=u.bits_data_temp[v][y].new_intersection(_))})})}),u}(this.facets,o),e.filters_query&&(i=function(l,c){const u=Ye(l);u.is_temp_copied||M(u.bits_data,function(m,f){M(u.bits_data[f],function(v,p){u.bits_data_temp[f][p]=u.bits_data[f][p]})});let h=null;return M(c,function(m){let f=null;M(m,function(v){const p=v[0],y=v[1];if(!u.bits_data_temp[p])throw new Error("Panic. The key does not exist in facets lists.");f=f&&u.bits_data_temp[p][y]?u.bits_data_temp[p][y].new_intersection(f):f&&!u.bits_data_temp[p][y]?new D([]):u.bits_data_temp[p][y]}),h=(h||new D([])).new_union(f||new D([]))}),h!==null&&M(u.bits_data_temp,function(m,f){M(u.bits_data_temp[f],function(v,p){u.bits_data_temp[f][p]=u.bits_data_temp[f][p].new_intersection(h)})}),u}(i,Xs(e.filters_query).map(l=>Array.isArray(l)?l.map(c=>Array.isArray(c)?c.map(u=>u):c.split(":")):l.split(":")))),s.bits_data_temp=i.bits_data_temp,M(s.bits_data_temp,function(l,c){M(s.bits_data_temp[c],function(u,h){t.query_ids&&(s.bits_data_temp[c][h]=t.query_ids.new_intersection(s.bits_data_temp[c][h])),t.test&&(s.data[c][h]=s.bits_data_temp[c][h].array())})}),s.ids=e.filters_query?function(l){let c=new D([]);return M(l,function(u,h){M(l[h],function(m,f){c=c.new_union(l[h][f])})}),c}(s.bits_data_temp):tr(s.bits_data_temp,e.filters),s}}function ei(r,e){let t;(e=e||Object.create(null)).native_search_enabled!==!1&&(t=new nr(r,e));let n=new sr(r,e);return{search:function(s){return(s=s||Object.create(null)).aggregations=function(i,o){return M(er(i),(l,c)=>{l.field||(l.field=c);let u=[];o.filters&&o.filters[c]&&(u=o.filters[c]),l.filters=u;let h=[];return o.not_filters&&o.not_filters[c]&&(h=o.not_filters[c]),o.exclude_filters&&o.exclude_filters[c]&&(h=o.exclude_filters[c]),l.not_filters=h,l})}(e.aggregations,s),rr(0,s,e,t,n)},similar:function(s,i){return function(o,l,c){const u=c.per_page||10,h=c.minimum||0,m=c.page||1;let f;for(let y=0;y<o.length;++y)if(o[y].id==l){f=o[y];break}if(!c.field)throw new Error("Please define field in options");const v=c.field;let p=[];for(let y=0;y<o.length;++y)if(o[y].id!==l){const _=Ds(f[v],o[y][v]);_.length>=h&&(p.push(o[y]),p[p.length-1].intersection_length=_.length)}return p=gt(p,["intersection_length"],["desc"]),{pagination:{per_page:u,page:m,total:p.length},data:{items:p.slice((m-1)*u,m*u)}}}(r,s,i)},aggregation:function(s){return function(i,o,l,c,u){const h=o.per_page||10,m=o.page||1;if(o.name&&(!l.aggregations||!l.aggregations[o.name]))throw new Error('Please define aggregation "'.concat(o.name,'" in config'));const f=er(o);if(f.page=1,f.per_page=0,!o.name)throw new Error("field name is required");l.aggregations[o.name].size=1e4;const v=rr(0,f,l,c,u).data.aggregations[o.name].buckets;return{pagination:{per_page:h,page:m,total:v.length},data:{buckets:v.slice((m-1)*h,m*h)}}}(0,s,e,t,n)},reindex:function(s){t=new nr(r=s,e),n=new sr(r,e)}}}class ti{constructor(){this.elements={},this.activeFiltersCount=0,this.resultsCount=0,this.isInitialized=!1,this.currentFilters={},this.currentQuery="",this.config=null,this.init()}init(){this.elements={filtersPanel:document.getElementById("filters-panel"),resultsPanel:document.getElementById("results-panel"),toggleFilters:document.getElementById("toggle-filters"),toggleResults:document.getElementById("toggle-results"),activeFiltersBadge:document.getElementById("active-filters-badge"),activeFiltersCount:document.getElementById("active-filters-count"),resultsCounter:document.getElementById("results-counter"),resultsCount:document.getElementById("results-count"),clearAllBtn:document.getElementById("clear-all-btn"),mapCenterBtn:document.getElementById("map-center-btn"),toggleLegendBtn:document.getElementById("toggle-legend-btn"),mapLegend:document.getElementById("map-legend"),closeLegendBtn:document.getElementById("close-legend-btn")},this.bindEventHandlers(),this.initializePanelStates(),this.setupResponsiveBehavior(),this.styleClearAllButton(),this.isInitialized=!0}styleClearAllButton(){this.elements.clearAllBtn&&(this.elements.clearAllBtn.className="ml-2 px-3 py-1 bg-pink-100 hover:bg-pink-200 text-red-500 text-xs rounded-full transition-colors duration-200 hidden",this.elements.clearAllBtn.innerHTML='<i class="fas fa-times mr-1"></i>Cancella tutto')}setConfig(e){this.config=e}updateFromSearchState(e,t=0,n={}){if(!e)return;this.currentFilters={...e.filters},this.currentQuery=e.query||"";const s=this.calculateActiveFiltersCount(e.filters);this.updateActiveFiltersCount(s,n.skipAnimation),this.updateResultsCount(t,n.skipAnimation)}calculateActiveFiltersCount(e){if(!e||typeof e!="object")return 0;let t=0;return Object.values(e).forEach(n=>{Array.isArray(n)?n.length===2&&typeof n[0]=="number"&&typeof n[1]=="number"?t+=1:t+=n.length:n&&typeof n=="object"&&(n.min!==void 0||n.max!==void 0)&&(t+=1)}),t}updateActiveFiltersCount(e,t=!1){this.activeFiltersCount=e,this.elements.activeFiltersCount.textContent=e,e>0?(this.showElementWithAnimation(this.elements.activeFiltersBadge,t),this.showElementWithAnimation(this.elements.clearAllBtn,t)):(this.hideElementWithAnimation(this.elements.activeFiltersBadge),this.hideElementWithAnimation(this.elements.clearAllBtn)),this.emitEvent("activeFiltersChanged",{count:e})}updateResultsCount(e,t=!1){this.resultsCount=e,this.elements.resultsCount.textContent=e,e>0?this.showElementWithAnimation(this.elements.resultsCounter,t):this.hideElementWithAnimation(this.elements.resultsCounter),this.emitEvent("resultsCountChanged",{count:e})}showElementWithAnimation(e,t=!1){if(e){if(t){e.classList.remove("hidden"),e.style.opacity="1",e.style.transform="scale(1) translateY(0px)",e.style.transition="none";return}e.dataset.animating!=="true"&&(e.dataset.animating="true",e.classList.remove("hidden"),e.classList.remove("opacity-0","scale-95","-translate-y-2","opacity-100","scale-100","translate-y-0"),e.style.opacity="0",e.style.transform="scale(0.7) translateY(-25px)",e.style.transition="none",e.offsetHeight,requestAnimationFrame(()=>{e.style.transition="all 0.15s cubic-bezier(0.68, -0.55, 0.265, 1.55)",e.style.opacity="1",e.style.transform="scale(1.08) translateY(-3px)",setTimeout(()=>{e.style.transition="all 0.12s cubic-bezier(0.25, 0.46, 0.45, 0.94)",e.style.transform="scale(0.98) translateY(2px)",setTimeout(()=>{e.style.transition="all 0.1s ease-out",e.style.transform="scale(1) translateY(0px)",setTimeout(()=>{e.dataset.animating="false"},100)},120)},150)}))}}hideElementWithAnimation(e){e&&(e.classList.remove("opacity-100","scale-100","translate-y-0"),e.classList.add("opacity-0","scale-95","-translate-y-2"),setTimeout(()=>{e.classList.contains("opacity-0")&&e.classList.add("hidden")},300))}showActiveFiltersPopup(){if(document.getElementById("active-filters-popup")){this.hideActiveFiltersPopup();return}const t=this.elements.activeFiltersBadge.getBoundingClientRect(),n=document.createElement("div");n.id="active-filters-popup",n.className="fixed p-2 w-72 max-w-sm bg-white rounded-lg shadow-2xl border border-gray-200 transform transition-all duration-300 translate-y-4 opacity-0 max-h-96 overflow-hidden",n.style.zIndex="9999",n.style.left=`${t.left}px`,n.style.bottom=`${window.innerHeight-t.top+10}px`;const s=288;t.left+s>window.innerWidth&&(n.style.left=`${window.innerWidth-s-16}px`);const i=document.createElement("div");i.className="flex items-center justify-between mb-2",i.innerHTML=`
            <h3 class="p-2 text-sm font-semibold text-gray-800">Filtri Attivi</h3>
            <button id="close-filters-popup" class="absolute top-2 right-2 p-1.5 bg-pink-100 hover:bg-pink-200 active:bg-pink-200 rounded-full text-red-500 shadow-md hover:shadow-lg transition-all duration-200 group">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4 group-hover:rotate-90 transition-transform duration-200">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `;const o=document.createElement("div");o.className="space-y-1 max-h-64 overflow-y-auto overflow-x-hidden";const l=this.buildFiltersContent();o.innerHTML=l,n.appendChild(i),n.appendChild(o),document.body.appendChild(n),requestAnimationFrame(()=>{n.classList.remove("translate-y-4","opacity-0"),n.classList.add("translate-y-0","opacity-100")}),this.bindPopupEvents(n)}buildFiltersContent(){if(!this.currentFilters||Object.keys(this.currentFilters).length===0)return`
                <div class="flex items-center p-4 rounded-lg bg-gray-50">
                    <span class="text-sm text-gray-700">Nessun filtro attivo</span>
                </div>
            `;let e="";this.currentQuery&&this.currentQuery.trim()&&(e+=`
                <div class="mb-3 p-3 rounded-lg bg-blue-50 border border-blue-100">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 text-blue-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <div class="flex-1 min-w-0">
                            <span class="text-sm font-medium text-blue-700">Ricerca:</span>
                            <span class="text-sm text-blue-600 ml-1 font-mono bg-blue-100 px-2 py-1 rounded text-xs">"${this.escapeHtml(this.currentQuery)}"</span>
                        </div>
                    </div>
                </div>
            `);const t={};return Object.entries(this.currentFilters).forEach(([n,s])=>{if(!s||Array.isArray(s)&&s.length===0)return;const i=this.getFacetLabel(n);t[i]||(t[i]=[]),Array.isArray(s)?s.length===2&&typeof s[0]=="number"&&typeof s[1]=="number"?t[i].push({type:"range",value:this.formatRangeFilter({min:s[0],max:s[1]}),facetKey:n}):s.forEach(o=>{t[i].push({type:"value",value:o,facetKey:n})}):typeof s=="object"&&t[i].push({type:"range",value:this.formatRangeFilter(s),facetKey:n})}),Object.entries(t).forEach(([n,s])=>{e+=`
                <div class="mb-3 p-3 rounded-lg bg-gray-50 border border-gray-200">
                    <div class="flex items-start">
                        <div class="w-2 h-2 rounded-full bg-indigo-500 mt-2 mr-3 flex-shrink-0"></div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-sm font-semibold text-gray-800 mb-2">${n}</h4>
                            <div class="flex flex-wrap gap-1.5">
            `,s.forEach((i,o)=>{const l=i.type==="range";e+=`
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border ${l?"bg-orange-100 text-orange-700 border-orange-200":"bg-indigo-100 text-indigo-700 border-indigo-200"} transition-all duration-200 hover:shadow-sm">
                        ${l?`<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>`:`<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`}
                        ${this.escapeHtml(i.value)}
                    </span>
                `}),e+=`
                            </div>
                        </div>
                    </div>
                </div>
            `}),e||`
            <div class="flex items-center p-4 rounded-lg bg-gray-50">
                <span class="text-sm text-gray-700">Nessun filtro attivo</span>
            </div>
        `}getFacetLabel(e){return this.config&&this.config.aggregations&&this.config.aggregations[e]?this.config.aggregations[e].title||e:e.replace(/[_-]/g," ").replace(/\b\w/g,t=>t.toUpperCase())}formatRangeFilter(e){return e.min!==void 0&&e.max!==void 0?`${e.min} - ${e.max}`:e.min!==void 0?`≥ ${e.min}`:e.max!==void 0?`≤ ${e.max}`:"Range filter"}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}hideActiveFiltersPopup(){const e=document.getElementById("active-filters-popup");e&&(e.classList.add("translate-y-4","opacity-0"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300))}bindPopupEvents(e){const t=e.querySelector("#close-filters-popup");t&&t.addEventListener("click",()=>this.hideActiveFiltersPopup());const n=e.querySelector("#popup-clear-all-btn");n&&n.addEventListener("click",()=>this.handleClearAllFilters());const s=o=>{o.key==="Escape"&&(this.hideActiveFiltersPopup(),document.removeEventListener("keydown",s))};document.addEventListener("keydown",s);const i=o=>{!e.contains(o.target)&&!this.elements.activeFiltersBadge.contains(o.target)&&(this.hideActiveFiltersPopup(),document.removeEventListener("click",i))};setTimeout(()=>{document.addEventListener("click",i)},100)}bindEventHandlers(){this.elements.toggleFilters.addEventListener("click",()=>{this.togglePanel("filters")}),this.elements.toggleResults.addEventListener("click",()=>{this.togglePanel("results")}),this.elements.clearAllBtn.addEventListener("click",()=>{this.handleClearAllFilters()}),this.elements.mapCenterBtn.addEventListener("click",()=>{this.handleMapCenter()}),this.elements.toggleLegendBtn.addEventListener("click",()=>{this.toggleLegend()}),this.elements.closeLegendBtn.addEventListener("click",()=>{this.closeLegend()}),this.elements.activeFiltersBadge&&(this.elements.activeFiltersBadge.addEventListener("click",()=>{this.showActiveFiltersPopup()}),this.elements.activeFiltersBadge.style.cursor="pointer",this.elements.activeFiltersBadge.title="Clicca per vedere i filtri attivi")}initializePanelStates(){this.elements.filtersPanel.classList.add("panel-closed"),this.elements.resultsPanel.classList.add("panel-closed-right"),this.elements.toggleFilters.classList.remove("active"),this.elements.toggleResults.classList.remove("active")}togglePanel(e){if(e==="filters"){const t=!this.elements.filtersPanel.classList.contains("panel-closed");this.elements.filtersPanel.classList.toggle("panel-closed"),this.elements.toggleFilters.classList.toggle("active",!t),this.emitEvent("panelToggled",{type:"filters",isOpen:!t})}else if(e==="results"){const t=!this.elements.resultsPanel.classList.contains("panel-closed-right");this.elements.resultsPanel.classList.toggle("panel-closed-right"),this.elements.toggleResults.classList.toggle("active",!t),this.emitEvent("panelToggled",{type:"results",isOpen:!t})}}closeAllPanels(){this.elements.filtersPanel.classList.add("panel-closed"),this.elements.resultsPanel.classList.add("panel-closed-right"),this.elements.toggleFilters.classList.remove("active"),this.elements.toggleResults.classList.remove("active")}handleClearAllFilters(){this.hideActiveFiltersPopup(),this.currentFilters={},this.currentQuery="",this.updateActiveFiltersCount(0),this.updateResultsCount(0),this.emitEvent("clearAllFilters",{resetInterface:!0,clearSearch:!0,clearFacets:!0,clearMap:!0}),setTimeout(()=>{this.resetFacetsInterface()},100),this.clearSearchInput(),this.showNotification("Tutti i filtri sono stati rimossi","success",2e3)}handleMapCenter(){this.emitEvent("centerMap")}toggleLegend(){const e=this.elements.mapLegend.classList.contains("legend-hidden");this.elements.mapLegend.classList.toggle("legend-hidden"),this.elements.toggleLegendBtn.classList.toggle("active",e),this.emitEvent("legendToggled",{isVisible:e})}closeLegend(){this.elements.mapLegend.classList.add("legend-hidden"),this.elements.toggleLegendBtn.classList.remove("active"),this.emitEvent("legendClosed")}updateMapLegend(e){const t=document.querySelector(".map-legend-content");t&&(t.innerHTML="",e.forEach((n,s)=>{const i=document.createElement("div");i.className="legend-item flex items-center p-2 rounded-lg cursor-pointer",i.dataset.legendIndex=s,i.innerHTML=`
                <div class="w-4 h-4 rounded-full mr-3 flex-shrink-0" style="background-color: ${n.color}"></div>
                <span class="text-sm text-gray-700 flex-1">${n.label}</span>
                ${n.count!==void 0?`<span class="text-xs text-gray-500 ml-2">${n.count}</span>`:""}
            `,n.onClick&&typeof n.onClick=="function"&&i.addEventListener("click",o=>{n.onClick(n,s,o)}),t.appendChild(i)}),this.emitEvent("legendUpdated",{items:e}))}setupResponsiveBehavior(){window.addEventListener("resize",()=>{window.innerWidth<768&&this.closeAllPanels()}),window.innerWidth<768&&this.closeAllPanels()}getState(){return{activeFiltersCount:this.activeFiltersCount,resultsCount:this.resultsCount,isFiltersOpen:!this.elements.filtersPanel.classList.contains("panel-closed"),isResultsOpen:!this.elements.resultsPanel.classList.contains("panel-closed-right"),isLegendVisible:!this.elements.mapLegend.classList.contains("legend-hidden"),currentFilters:{...this.currentFilters},currentQuery:this.currentQuery}}setState(e){if(e.activeFiltersCount!==void 0&&this.updateActiveFiltersCount(e.activeFiltersCount),e.resultsCount!==void 0&&this.updateResultsCount(e.resultsCount),e.isFiltersOpen!==void 0){const t=!this.elements.filtersPanel.classList.contains("panel-closed");e.isFiltersOpen!==t&&this.togglePanel("filters")}if(e.isResultsOpen!==void 0){const t=!this.elements.resultsPanel.classList.contains("panel-closed-right");e.isResultsOpen!==t&&this.togglePanel("results")}if(e.isLegendVisible!==void 0){const t=!this.elements.mapLegend.classList.contains("legend-hidden");e.isLegendVisible!==t&&this.toggleLegend()}e.currentFilters!==void 0&&(this.currentFilters={...e.currentFilters}),e.currentQuery!==void 0&&(this.currentQuery=e.currentQuery)}emitEvent(e,t={}){const n=new CustomEvent(`navbar:${e}`,{detail:t,bubbles:!0,cancelable:!0});document.dispatchEvent(n)}addEventListener(e,t){document.addEventListener(`navbar:${e}`,t)}removeEventListener(e,t){document.removeEventListener(`navbar:${e}`,t)}showNotification(e,t="info",n=3e3){const s=document.createElement("div");s.className=`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg transition-all duration-300 ${this.getNotificationClasses(t)}`,s.textContent=e,document.body.appendChild(s),setTimeout(()=>{s.style.opacity="1",s.style.transform="translateX(-50%) translateY(0)"},10),setTimeout(()=>{s.style.opacity="0",s.style.transform="translateX(-50%) translateY(-20px)",setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s)},300)},n)}getNotificationClasses(e){const t={success:"bg-green-500 text-white",error:"bg-red-500 text-white",warning:"bg-yellow-500 text-white",info:"bg-blue-500 text-white"};return t[e]||t.info}destroy(){window.removeEventListener("resize",this.setupResponsiveBehavior),this.hideActiveFiltersPopup(),this.elements={},this.currentFilters={},this.currentQuery="",this.config=null,this.isInitialized=!1}forceUpdate(e={},t="",n=0){this.currentFilters={...e},this.currentQuery=t;const s=this.calculateActiveFiltersCount(e);this.updateActiveFiltersCount(s),this.updateResultsCount(n),this.hideActiveFiltersPopup(),Object.keys(e).length===0&&!t&&setTimeout(()=>{this.resetFacetsInterface()},50)}resetInterface(){this.currentFilters={},this.currentQuery="",this.updateActiveFiltersCount(0),this.updateResultsCount(0),this.hideActiveFiltersPopup(),this.closeAllPanels(),this.resetFacetsInterface(),this.clearSearchInput()}resetFacetsInterface(){const e=document.getElementById("facets-container");if(!e)return;e.querySelectorAll('input[type="checkbox"]').forEach(i=>{i.checked=!1}),e.querySelectorAll('[id$="-slider"]').forEach(i=>{if(i.noUiSlider)try{const o=i.noUiSlider.options.range;i.noUiSlider.set([o.min,o.max]);const l=i.id.replace("-slider",""),c=document.getElementById(`${l}-min-input`),u=document.getElementById(`${l}-max-input`);c&&(c.value=o.min),u&&(u.value=o.max);const h=document.getElementById(`${l}-chart`);if(h){const m=h.querySelector(`#${l}-chart-highlight`);m&&(m.style.left="0%",m.style.width="100%")}}catch(o){console.warn(`Failed to reset slider ${i.id}:`,o)}}),e.querySelectorAll(".toggle-btn").forEach(i=>{const o=i.dataset.path,l=e.querySelector(`[data-parent="${o}"]`);l&&l.style.display!=="none"&&(l.style.display="none",i.textContent="▶")})}clearSearchInput(){const e=["#search-input","#query-input",".search-input",'input[type="search"]','input[placeholder*="search" i]','input[placeholder*="cerca" i]'];for(const t of e){const n=document.querySelector(t);if(n){n.value="",n.dispatchEvent(new Event("input",{bubbles:!0}));break}}}_updateChartHighlight(e,t,n,s){if(!e||!t||t.length===0)return;const i=e.querySelector(`#${e.id}-highlight`);if(!i)return;const o=t[t.length-1].value-t[0].value;if(o<=0)return;const l=(n-t[0].value)/o*100,c=(s-n)/o*100;i.style.left=`${Math.max(0,l)}%`,i.style.width=`${Math.max(0,Math.min(100,c))}%`}}const ri=new ti;class Mr{renderTaxonomy(e,t,n,s){const i=this._buildHierarchy(t);this._calculateTotalCounts(i),e.className="taxonomy-container max-w-full overflow-x-auto max-h-80 overflow-y-auto border border-gray-200 rounded-lg p-2",e.innerHTML=this._createTaxonomyHTML(i,[],0,n,s),this._addToggleListeners(e),this._addCheckboxListeners(e,i,n)}_buildHierarchy(e){const t={};return Array.isArray(e)&&e.forEach(n=>{const s=n.key.split(" > ");let i=t;s.forEach((o,l)=>{i[o]||(i[o]={children:{},docCount:0,selfCount:0}),l===s.length-1&&(i[o].selfCount=n.doc_count),i=i[o].children})}),t}_calculateTotalCounts(e){const t=n=>{let s=n.selfCount||0;return Object.values(n.children||{}).forEach(i=>{s+=t(i)}),n.docCount=s,s};Object.values(e).forEach(n=>{t(n)})}_hasSelectedChild(e,t,n=[]){for(const[s,i]of Object.entries(e)){if(["children","docCount","selfCount"].includes(s))continue;const o=[...n,s].join(" > ");if(t.includes(o)||Object.keys(i.children).length>0&&this._hasSelectedChild(i.children,t,[...n,s]))return!0}return!1}_createTaxonomyHTML(e,t=[],n=0,s,i){const o=i[s]||[];let l='<div class="space-y-1">';return Object.entries(e).forEach(([c,u])=>{if(["children","docCount","selfCount"].includes(c))return;const h=[...t,c],m=h.join(" > "),f=Object.keys(u.children).length>0,v=o.includes(m),p=f&&this._hasSelectedChild(u.children,o,h),y=v||p,_=n>0?`ml-${Math.min(n*4,12)}`:"";l+=`
        <div class="taxonomy-item ${_}">
          <div class="flex items-center gap-2 py-1 px-2 rounded hover:bg-gray-50 transition-colors whitespace-nowrap min-w-max">
            ${f?`<button class="toggle-btn flex-shrink-0 w-5 h-5 flex items-center justify-center rounded hover:bg-gray-200 transition-colors" data-path="${m}">
                <svg class="w-3 h-3 text-gray-600 transform transition-transform duration-200 ${y?"rotate-90":""}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </button>`:'<div class="w-5 h-5 flex-shrink-0"></div>'}
            <label class="flex items-center gap-2 cursor-pointer flex-grow min-w-0">
              <input type="checkbox" value="${m}" data-facet-type="${s}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2 flex-shrink-0" ${v?"checked":""}>
              <span class="text-sm text-gray-700 whitespace-nowrap flex-shrink-0 ${v?"font-medium text-blue-700":""}">${c}</span>
              <span class="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full flex-shrink-0 ml-auto">${u.docCount}</span>
            </label>
          </div>
          ${f?`<div class="children ml-2 ${y?"":"hidden"}" data-parent="${m}">
              ${this._createTaxonomyHTML(u.children,h,n+1,s,i)}
            </div>`:""}
        </div>`}),l+"</div>"}_getParentPaths(e){const t=e.split(" > "),n=[];for(let s=1;s<t.length;s++)n.push(t.slice(0,s).join(" > "));return n}_getAllChildPaths(e,t=[]){const n=[];return Object.entries(e).forEach(([s,i])=>{if(["children","docCount","selfCount"].includes(s))return;const o=[...t,s].join(" > ");n.push(o),Object.keys(i.children).length>0&&n.push(...this._getAllChildPaths(i.children,[...t,s]))}),n}_getChildPathsForNode(e,t){const n=t.split(" > ");let s=e;for(const i of n)if(s[i])s=s[i];else return[];return this._getAllChildPaths(s.children,n)}_addToggleListeners(e){e.addEventListener("click",t=>{if(t.target.closest(".toggle-btn")){const n=t.target.closest(".toggle-btn"),s=n.dataset.path,i=e.querySelector(`[data-parent="${s}"]`),o=n.querySelector("svg");if(i&&o){const l=i.classList.contains("hidden");i.classList.toggle("hidden"),o.classList.toggle("rotate-90",l)}}})}_addCheckboxListeners(e,t,n){e._hierarchy=t,e.addEventListener("change",s=>{if(s.target.type==="checkbox"){const i=s.target,o=i.value,l=i.checked;s.stopPropagation();const c=this._getParentPaths(o)||[],u=this._getChildPathsForNode(t,o)||[];this._updateRelatedCheckboxes(e,t,o,l,c,u);const h=new CustomEvent("taxonomyChange",{detail:{facetKey:n,path:o,checked:l,action:l?"add":"remove"}});e.dispatchEvent(h)}})}_updateRelatedCheckboxes(e,t,n,s,i,o){s?(i==null||i.forEach(l=>{const c=e.querySelector(`input[value="${l}"]`);c&&!c.checked&&(c.checked=!0,this._updateCheckboxVisuals(c,!0))}),o==null||o.forEach(l=>{const c=e.querySelector(`input[value="${l}"]`);c&&!c.checked&&(c.checked=!0,this._updateCheckboxVisuals(c,!0))})):(o==null||o.forEach(l=>{const c=e.querySelector(`input[value="${l}"]`);c&&c.checked&&(c.checked=!1,this._updateCheckboxVisuals(c,!1))}),i==null||i.forEach(l=>{const c=e.querySelector(`input[value="${l}"]`);c&&c.checked&&((this._getChildPathsForNode(t,l)||[]).some(m=>{const f=e.querySelector(`input[value="${m}"]`);return f&&f.checked})||(c.checked=!1,this._updateCheckboxVisuals(c,!1)))})),this._updateCheckboxVisuals(e.querySelector(`input[value="${n}"]`),s)}_updateCheckboxVisuals(e,t){if(!e)return;const n=e.closest("label"),s=n==null?void 0:n.querySelector("span.text-sm");s&&(s.classList.toggle("font-medium",t),s.classList.toggle("text-blue-700",t))}_renderTaxonomyFacet(e,t,n,s,i,o){const l=document.createElement("div"),c=s[t]||[];this.renderTaxonomy(l,c,t,i),l.addEventListener("taxonomyChange",u=>{const{facetKey:h,path:m,checked:f,action:v}=u.detail;o({type:"FACET_CHANGE",facetType:h,value:m,checked:f})}),e.appendChild(l)}}class Ir{_renderRangeFacet(e,t,n,s,i,o,l){const c=document.createElement("div");c.className="facet-slider my-3";const h=(s[t]||[]).map(F=>{const B=parseInt(F.key,10);return isNaN(B)?null:{value:B,count:F.doc_count||0}}).filter(F=>F!==null),m=h.map(F=>F.value),f=Math.min(...m),v=Math.max(...m);c.innerHTML=`
      <div class="space-y-3">
        <!-- Chart Container -->
        <div class="relative">
          <div id="${t}-chart" class="w-full h-16 mb-3 bg-gray-50 rounded-md p-2"></div>
        </div>
        
        <!-- Slider Container -->
        <div class="px-1">
          <div id="${t}-slider" class="slider-container"></div>
        </div>
        
        <!-- Value Display -->
        <div class="flex items-center justify-between text-xs text-gray-600 px-1">
          <span id="${t}-current-min" class="font-medium">${f}</span>
          <span id="${t}-current-max" class="font-medium">${v}</span>
        </div>
        
        <!-- Custom Range Inputs - Fixed Layout -->
        <div class="mt-4 pt-3 border-t border-gray-100">
          <div class="text-xs font-medium text-gray-700 mb-2">Custom range:</div>
          <div class="grid grid-cols-2 gap-2">
            <div class="min-w-0">
              <input id="${t}-min-input" type="number"
                     class="w-full px-2 py-1 text-xs border border-gray-200 rounded focus:ring-1 focus:ring-blue-400 focus:border-blue-400 focus:outline-none"
                     value="${f}"
                     placeholder="Min">
            </div>
            <div class="min-w-0">
              <input id="${t}-max-input" type="number"
                     class="w-full px-2 py-1 text-xs border border-gray-200 rounded focus:ring-1 focus:ring-blue-400 focus:border-blue-400 focus:outline-none"
                     value="${v}"
                     placeholder="Max">
            </div>
          </div>
        </div>
      </div>
    `,e.appendChild(c);const p=c.querySelector(`#${t}-chart`),y=c.querySelector(`#${t}-slider`),_=c.querySelector(`#${t}-min-input`),k=c.querySelector(`#${t}-max-input`),j=c.querySelector(`#${t}-current-min`),N=c.querySelector(`#${t}-current-max`);this.renderBarChart(p,h,f,v);const E=o.filters[t];let T,S;!E||E.length===0?(T=f,S=v):(T=E[0],S=E[1]),noUiSlider.create(y,{start:[T,S],connect:!0,step:1,range:{min:f,max:v},format:{to:F=>Math.round(F),from:F=>parseInt(F,10)}}),c.slider=y,c.minInput=_,c.maxInput=k,c.currentMinSpan=j,c.currentMaxSpan=N,c.chartElement=p,y.classList.add("custom-slider");const A=document.createElement("style");A.textContent=`
      .custom-slider {
        height: 4px !important;
      }
      
      .custom-slider .noUi-base,
      .custom-slider .noUi-connects {
        height: 4px !important;
      }
      
      .custom-slider .noUi-connect {
        background: linear-gradient(90deg, #3b82f6, #1d4ed8) !important;
        height: 4px !important;
      }
      
      .custom-slider .noUi-origin {
        height: 4px !important;
      }
      
      .custom-slider .noUi-handle {
        height: 16px !important;
        width: 16px !important;
        top: -6px !important;
        right: -8px !important;
        background: white !important;
        border: 2px solid #3b82f6 !important;
        border-radius: 50% !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        cursor: grab !important;
      }
      
      .custom-slider .noUi-handle:active {
        cursor: grabbing !important;
        transform: scale(1.1) !important;
        border-color: #1d4ed8 !important;
      }
      
      .custom-slider .noUi-handle:before,
      .custom-slider .noUi-handle:after {
        display: none !important;
      }
      
      .custom-slider .noUi-target {
        background: #e5e7eb !important;
        border-radius: 2px !important;
        border: none !important;
        box-shadow: none !important;
      }
      
      .custom-slider .noUi-handle:hover {
        background: #f8fafc !important;
        border-color: #2563eb !important;
      }
      
      .custom-slider .noUi-handle:focus {
        outline: none !important;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
      }
    `,document.querySelector("#custom-slider-styles")||(A.id="custom-slider-styles",document.head.appendChild(A));let R=null;_.addEventListener("focus",()=>{R=_}),k.addEventListener("focus",()=>{R=k}),_.addEventListener("blur",()=>{setTimeout(()=>{R===_&&(R=null)},100)}),k.addEventListener("blur",()=>{setTimeout(()=>{R===k&&(R=null)},100)}),y.noUiSlider.on("update",F=>{const[B,P]=F.map(W=>Math.round(Number(W)));R!==_&&(_.value=B),R!==k&&(k.value=P),j.textContent=B.toString(),N.textContent=P.toString()}),y.noUiSlider.on("change",F=>{const[B,P]=F.map(W=>Math.round(Number(W)));!isNaN(B)&&!isNaN(P)&&(l({type:"RANGE_CHANGE",facetKey:t,value:[B,P]}),this.updateChartHighlight(p,h,B,P))});const U=F=>{const B=F.target===_,P=parseInt(F.target.value,10),[W,Z]=y.noUiSlider.get().map(Number);if(!isNaN(P)){const g=B?Math.max(f,Math.min(P,Z)):W,a=B?Z:Math.min(v,Math.max(P,W)),d=R;y.noUiSlider.set([g,a]),d===_&&(_.value=g),d===k&&(k.value=a),l({type:"RANGE_CHANGE",facetKey:t,value:[g,a]}),this.updateChartHighlight(p,h,g,a)}};_.addEventListener("change",U),k.addEventListener("change",U);const X=F=>{F.key==="Enter"&&F.target.blur()};_.addEventListener("keypress",X),k.addEventListener("keypress",X),this.updateChartHighlight(p,h,T,S)}updateRangeFacet(e,t,n,s,i,o,l){const c=e.querySelector(".facet-slider");if(!c)return;const h=(s[t]||[]).map(T=>{const S=parseInt(T.key,10);return isNaN(S)?null:{value:S,count:T.doc_count||0}}).filter(T=>T!==null),m=h.map(T=>T.value),f=Math.min(...m),v=Math.max(...m),p=c.slider,y=c.minInput,_=c.maxInput;c.currentMinSpan,c.currentMaxSpan;const k=c.chartElement;if(!p||!p.noUiSlider)return;this.renderBarChart(k,h,f,v),p.noUiSlider.get().map(Number),p.noUiSlider.updateOptions({range:{min:f,max:v}});const j=o.filters[t];let N,E;!j||j.length===0?(N=f,E=v):(N=Math.max(f,Math.min(j[0],v)),E=Math.min(v,Math.max(j[1],f))),p.noUiSlider.set([N,E]),y.setAttribute("min",f),y.setAttribute("max",v),y.placeholder=`Min (${f})`,_.setAttribute("min",f),_.setAttribute("max",v),_.placeholder=`Max (${v})`,this.updateChartHighlight(k,h,N,E),(!j||j.length===0||j[0]!==N||j[1]!==E)&&l({type:"RANGE_CHANGE",facetKey:t,value:[N,E]})}renderBarChart(e,t,n,s,i=null){e.innerHTML="";const o=Math.max(...t.map(h=>h.count));this.sortedBuckets=[...t].sort((h,m)=>h.value-m.value);const l=document.createElement("div");if(l.className="w-full h-full flex flex-col",e.appendChild(l),i){const h=document.createElement("div");h.className="flex items-center justify-center mb-2 flex-shrink-0",l.appendChild(h);const m=document.createElement("button");m.className="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors",m.textContent="▶ Play",m.onclick=()=>this.togglePlay(e,i),h.appendChild(m)}const c=document.createElement("div");c.className="w-full flex-1 rounded px-1 overflow-hidden",c.style.height="150px",l.appendChild(c);const u=document.createElement("div");u.className="flex items-end w-full h-full",c.appendChild(u),this.sortedBuckets.forEach(h=>{const m=o>0?h.count/o*90:0,f=document.createElement("div");f.className="flex-1 mx-px transition-colors duration-200",f.style.height=`${Math.max(m,1)}%`,f.style.backgroundColor="#b0c4de",f.dataset.value=h.value,f.dataset.count=h.count,f.title=`Value: ${h.value}, Count: ${h.count}`,u.appendChild(f)})}updateChartHighlight(e,t,n,s){const i=e.querySelector(".flex.items-end");if(!i){console.warn("Bars container not found");return}i.querySelectorAll("[data-value]").forEach(l=>{const c=parseInt(l.dataset.value);c>=n&&c<=s?l.style.backgroundColor="#b0c4de":l.style.backgroundColor="#d1d5db"})}_debounce(e,t){let n;return function(){clearTimeout(n),n=setTimeout(()=>e.apply(this,arguments),t)}}}class ni{constructor(e){this.config=e,this.taxonomyRenderer=new Mr,this.rangeRenderer=new Ir,this.searchTerms={}}renderFacets(e,t,n){if(!e||!this.config.aggregations){console.error("No aggregations data or configuration available.");return}const s=document.getElementById("facets-container"),i=this._getCheckedState();s.innerHTML="";const o={};Object.entries(this.config.aggregations).forEach(([l,c])=>{const u=c.category||"Other";o[u]||(o[u]=[]),o[u].push({facetKey:l,facetConfig:c})}),Object.entries(o).forEach(([l,c])=>{const u=document.createElement("div");u.className="facet-category",u.setAttribute("data-category",l);const h=document.createElement("h3");h.className="facet-category-title",h.textContent=l,u.appendChild(h);const m=document.createElement("div");m.className="facet-category-content",c.forEach(({facetKey:f,facetConfig:v})=>{const p=this._createFacetGroup(f,v);v.type==="range"?this.rangeRenderer._renderRangeFacet(p,f,v,e,i,t,n):v.type==="taxonomy"?this.taxonomyRenderer._renderTaxonomyFacet(p,f,v,e,i,n):this._renderStandardFacet(p,f,v,e,i),m.appendChild(p)}),u.appendChild(m),s.appendChild(u)}),this._addFacetEventListeners(n)}_filterFacetOptions(e,t){const n=e.querySelectorAll("label");let s=0;n.forEach(o=>{const l=o.textContent.toLowerCase(),c=t===""||l.includes(t);o.style.display=c?"block":"none",c&&s++}),(e.querySelector(".facet-options")||e.querySelector("div"))&&(e.style.display=s>0?"block":"none")}_updateCategoryVisibility(){document.querySelectorAll(".facet-category").forEach(t=>{const n=t.querySelectorAll('.facet-group[style*="display: block"], .facet-group:not([style*="display: none"])'),s=Array.from(n).some(i=>i.style.display!=="none");t.style.display=s?"block":"none"})}_getCheckedState(){const e={};return Object.keys(this.config.aggregations).forEach(t=>{const n=document.getElementById(`${t}-facet`);n&&(e[t]=Array.from(n.querySelectorAll("input:checked")).map(s=>s.value))}),e}_createFacetGroup(e,t){const n=document.createElement("div");n.className="facet-group mb-4 p-4 bg-white rounded-lg shadow",n.id=`${e}-facet`;const s=document.createElement("div");s.className="facet-header mb-3";const i=document.createElement("h3");if(i.className="text-lg font-semibold mb-2",i.textContent=t.title||e,s.appendChild(i),t.type!=="range"){const o=document.createElement("div");o.className="facet-search mb-2";const l=document.createElement("input");l.type="text",l.className="facet-search-input w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500",l.placeholder="Cerca...",l.id=`search-${e}`;const c=this._debounce(u=>{this._searchWithinFacet(e,u)},300);l.addEventListener("input",u=>{c(u.target.value)}),o.appendChild(l),s.appendChild(o)}return n.appendChild(s),n}_searchWithinFacet(e,t){const n=document.getElementById(`${e}-facet`);n&&(this.searchTerms[e]=t.toLowerCase().trim(),this._filterFacetOptions(n,this.searchTerms[e]))}_renderStandardFacet(e,t,n,s,i){const o=document.createElement("div");o.className="facet-options space-y-2",(s[t]||[]).forEach(c=>{var p;const u=document.createElement("label");u.className="cursor-pointer block facet-option flex items-center justify-between",u.style.display="flex",u.setAttribute("data-search-text",c.key.toLowerCase()),c.doc_count===0&&u.classList.add("text-gray-400");const h=document.createElement("div");h.className="flex items-center";const m=document.createElement("input");m.type="checkbox",m.value=c.key,m.className="form-checkbox mr-2",m.dataset.facetType=t,(p=i[t])!=null&&p.includes(c.key)&&(m.checked=!0);const f=document.createElement("span");f.textContent=c.key,f.className="text-sm";const v=document.createElement("span");v.textContent=c.doc_count,v.className=`text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full flex-shrink-0 ml-auto ${c.doc_count===0?"text-gray-400 bg-gray-50":""}`,h.appendChild(m),h.appendChild(f),u.appendChild(h),u.appendChild(v),o.appendChild(u)}),e.appendChild(o)}_addFacetEventListeners(e){if(!this.config.aggregations){console.error("Aggregations configuration not found");return}Object.keys(this.config.aggregations).forEach(t=>{const n=document.getElementById(`${t}-facet`);n&&n.querySelectorAll('input[type="checkbox"]').forEach(s=>{s.addEventListener("change",i=>{this._onFacetChange(i,e)})})})}_onFacetChange(e,t){const{value:n,checked:s}=e.target,i=e.target.dataset.facetType;t({type:"FACET_CHANGE",facetType:i,value:n,checked:s})}clearAllSearches(){this.searchTerms={},Object.keys(this.config.aggregations).forEach(s=>{const i=document.getElementById(`search-${s}`);i&&(i.value="")}),document.querySelectorAll(".facet-option, label").forEach(s=>{s.style.display="block"}),document.querySelectorAll(".facet-group").forEach(s=>{s.style.display="block"}),document.querySelectorAll(".facet-category").forEach(s=>{s.style.display="block"})}_debounce(e,t){let n;return function(){clearTimeout(n),n=setTimeout(()=>e.apply(this,arguments),t)}}}class si{constructor(e,t){this.searchEngine=e,this.config=t}performSearch(e,t={}){if(!this.searchEngine){console.error("Search engine not initialized");return}const{filters:n}=e,{regularFilters:s,dateFilters:i,taxonomyFilters:o}=this._separateFilters(n),l=this.searchEngine.search({query:e.query||"",filters:s,sort:e.sort||"title_asc",per_page:526,filter:u=>this._customFilter(u,i,o)}),c=this._extractCoordinates(l.data.items);if(t.onMarkersUpdate&&t.onMarkersUpdate(l.data.items),t.onResultsUpdate&&t.onResultsUpdate(l.data.items),t.onAggregationsUpdate){const u=this._formatAggregations(l.data.aggregations);t.onAggregationsUpdate(u)}return{items:l.data.items,coordinates:c,aggregations:this._formatAggregations(l.data.aggregations)}}_separateFilters(e){const t={},n={},s={};return Object.entries(e).forEach(([i,o])=>{if(!o||o.length===0)return;const l=this.config.aggregations[i];if(l)switch(l.type){case"range":n[i]=o;break;case"taxonomy":s[i]=o;break;default:t[i]=o}}),{regularFilters:t,dateFilters:n,taxonomyFilters:s}}_customFilter(e,t,n){for(const[s,i]of Object.entries(t))if(i.length===2){const[o,l]=i,c=new Date(e[s]).getTime();if(!(c>=o&&c<=l))return!1}for(const[s,i]of Object.entries(n)){if(!e[s])return!1;const o=e[s];let l;if(Array.isArray(o)?l=o.length>0?String(o[0]):"":typeof o=="string"?l=o:l=String(o||""),!i.some(u=>l===u||l.startsWith(u+" > ")))return!1}return!0}_extractCoordinates(e){return e.filter(t=>t.lat_long&&t.lat_long.length>0).map(t=>{const n=t.lat_long[0],[s,i]=n.split(",");return[parseFloat(s),parseFloat(i)]})}_formatAggregations(e){const t={};for(const n in e)e.hasOwnProperty(n)&&(t[n]=e[n].buckets);return t}}class ii{constructor(e,t=null){this.mapFocusCallback=e,this.config=t,this.allWorks=[],this.items=[],this.searchState=null,this.isModalOpen=!1,this.currentModalIndex=0,this.isAnimating=!1}setData(e,t){this.allWorks=e,this.items=t}setConfig(e){this.config=e}setSearchState(e){this.searchState=e}_getCompleteWorkData(e){const t=this.items.filter(o=>o.ID_opera===e);if(t.length===0)return null;const n=t[0],s={ID_opera:e,Titolo:n.Titolo,Autore:n.Autore,Anno:n.Anno,"Spazi geografici":[],coordinates:[],allEntries:t,geodataBySpace:new Map},i=new Map;return t.forEach(o=>{o["Spazi geografici"]&&(Array.isArray(o["Spazi geografici"])?o["Spazi geografici"]:[o["Spazi geografici"]]).forEach((c,u)=>{if(!i.has(c)){const h=this._extractCoordinates(o,u);i.set(c,h);const m=this._getGeodataFields(),f={};m.forEach(v=>{o[v]!==void 0&&o[v]!==null&&o[v]!==""&&(Array.isArray(o[v])&&o[v].length>u?f[v]=o[v][u]:Array.isArray(o[v])||(f[v]=o[v]))}),s.geodataBySpace.set(c,f)}})}),s["Spazi geografici"]=Array.from(i.keys()),s.coordinates=Array.from(i.values()),s}_getCatalogueFields(){var e,t,n;return((n=(t=(e=this.config)==null?void 0:e.datasetConfig)==null?void 0:t.fields)==null?void 0:n.catalogue)||[]}_getGeodataFields(){var e,t,n;return((n=(t=(e=this.config)==null?void 0:e.datasetConfig)==null?void 0:t.fields)==null?void 0:n.geodata)||[]}_getAllMetadataFields(){const e=this._getCatalogueFields(),t=this._getGeodataFields();return[...new Set([...e,...t])]}_renderSelectedFilters(){if(!this.searchState||!this.searchState.filters)return"";const e=[];return this.searchState.query&&this.searchState.query.trim()&&e.push(`
        <div class="inline-flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
            <path fill-rule="evenodd" d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z" clip-rule="evenodd" />
          </svg>
          <span>Ricerca: "${this.searchState.query}"</span>
        </div>
      `),Object.entries(this.searchState.filters).forEach(([t,n])=>{Array.isArray(n)&&n.length>0?n.forEach(s=>{e.push(`
            <div class="inline-flex items-center gap-2 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
                <path d="M2 3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1a1 1 0 0 1-.293.707L10 8.414V12a1 1 0 0 1-.293.707l-2 2A1 1 0 0 1 6 14v-5.586L2.293 4.707A1 1 0 0 1 2 4V3Z" />
              </svg>
              <span>${t}: ${s}</span>
            </div>
          `)}):n&&!Array.isArray(n)&&e.push(`
          <div class="inline-flex items-center gap-2 px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
              <path d="M2 3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1a1 1 0 0 1-.293.707L10 8.414V12a1 1 0 0 1-.293.707l-2 2A1 1 0 0 1 6 14v-5.586L2.293 4.707A1 1 0 0 1 2 4V3Z" />
            </svg>
            <span>${t}: ${n}</span>
          </div>
        `)}),e.length===0?"":`
      <div class="flex flex-wrap items-center gap-2 bg-white/80 backdrop-blur-sm rounded-xl px-4 py-3 shadow-md ring-1 ring-gray-200/50 border border-gray-200/30">
        <div class="text-sm font-medium text-gray-700 mr-2">Filtri attivi:</div>
        ${e.join("")}
      </div>
    `}async toggleModal(e){this.isAnimating||(this.isModalOpen?await this._closeModal():(this.currentModalIndex=e,await this._openModal()))}async _openModal(){this.isAnimating=!0;let e=document.getElementById("works-modal");e||(e=this._createModal(),document.body.appendChild(e)),e.classList.remove("hidden"),e.style.opacity="0";const t=e.querySelector(".modal-container");t&&(t.style.transform="scale(0.8) translateY(20px)",t.style.opacity="0"),this._populateModal(),this.isModalOpen=!0,document.body.style.overflow="hidden",e.offsetHeight,e.style.transition="opacity 300ms cubic-bezier(0.4, 0, 0.2, 1)",e.style.opacity="1",t&&(t.style.transition="all 400ms cubic-bezier(0.34, 1.56, 0.64, 1)",t.style.transform="scale(1) translateY(0)",t.style.opacity="1"),setTimeout(()=>{this._animateContentItems(),this.isAnimating=!1},200)}async _closeModal(){if(!this.isModalOpen)return;this.isAnimating=!0;const e=document.getElementById("works-modal");if(e){const t=e.querySelector(".modal-container");e.style.transition="opacity 250ms cubic-bezier(0.4, 0, 1, 1)",e.style.opacity="0",t&&(t.style.transition="all 250ms cubic-bezier(0.4, 0, 1, 1)",t.style.transform="scale(0.95) translateY(-10px)",t.style.opacity="0"),await new Promise(n=>setTimeout(n,250)),e.classList.add("hidden"),e.style.opacity="",t&&(t.style.transform="",t.style.opacity="")}this.isModalOpen=!1,document.body.style.overflow="auto",this.isAnimating=!1}_animateContentItems(){const e=document.querySelector(".modal-header");e&&(e.style.opacity="0",e.style.transform="translateY(-20px)",e.style.transition="all 500ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{e.style.opacity="1",e.style.transform="translateY(0)"},100));const t=document.querySelector(".filters-section");t&&(t.style.opacity="0",t.style.transform="translateY(-10px)",t.style.transition="all 400ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{t.style.opacity="1",t.style.transform="translateY(0)"},150)),document.querySelectorAll(".metadata-card").forEach((i,o)=>{i.style.opacity="0",i.style.transform="translateY(20px)",i.style.transition="all 400ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{i.style.opacity="1",i.style.transform="translateY(0)"},200+o*50)}),document.querySelectorAll(".space-card").forEach((i,o)=>{i.style.opacity="0",i.style.transform="translateX(-20px)",i.style.transition="all 500ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{i.style.opacity="1",i.style.transform="translateX(0)"},300+o*75)})}_createModal(){const e=document.createElement("div");return e.id="works-modal",e.className="fixed inset-0 bg-gradient-to-br from-slate-900/90 to-gray-900/90 backdrop-blur-md z-50 hidden flex items-center justify-center p-4",e.innerHTML=`
      <div class="modal-container relative w-full max-w-7xl h-[90vh] overflow-hidden">
        <!-- Enhanced Header with Close Button and Filters -->
        <div class="absolute top-0 left-0 right-0 px-6 py-4 z-20">
          <div class="flex items-center justify-between">
            <!-- Filters section on the left -->
            <div class="filters-section flex-1 mr-6">
              <!-- Filters will be populated here -->
            </div>
            
            <!-- Close button on the right -->
            <button id="close-modal-btn" class="p-3 bg-white/90 hover:bg-white active:bg-gray-100 rounded-full text-gray-600 hover:text-red-500 shadow-lg hover:shadow-xl transition-all duration-300 group backdrop-blur-sm border border-gray-200/50 hover:border-red-200 flex-shrink-0">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 group-hover:rotate-90 transition-transform duration-300">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
        
        <!-- Content Container with fixed width to prevent resizing -->
        <div id="modal-content" class="h-full pt-20 pb-16 rounded-2xl w-full max-w-none overflow-hidden"></div>
        
        <!-- Enhanced Footer with Progress Indicator -->
        <div class="absolute bottom-0 left-0 right-0 px-6 py-4 z-20">
          <div class="flex items-center justify-center">
            <span id="modal-progress" class="text-sm font-semibold text-gray-700 bg-white/90 backdrop-blur-sm px-6 py-3 rounded-full shadow-lg ring-1 ring-white/20 border border-gray-200/50 transition-all duration-300 hover:shadow-xl">
            </span>
          </div>
        </div>
      </div>
    `,e.addEventListener("click",t=>{t.target===e&&this._closeModal()}),e.querySelector("#close-modal-btn").addEventListener("click",()=>{this._closeModal()}),document.addEventListener("keydown",t=>{!this.isModalOpen||this.isAnimating||(t.key==="Escape"?this._closeModal():t.key==="ArrowLeft"?this._navigateModal(-1):t.key==="ArrowRight"&&this._navigateModal(1))}),e}async _navigateModal(e){if(this.isAnimating)return;const t=this.currentModalIndex+e;if(t>=0&&t<this.allWorks.length){this.isAnimating=!0;const n=document.getElementById("modal-content");if(!n)return;const s=n.querySelector(".main-content-panel");if(!s)return;const i=document.createElement("div");i.className="relative w-full h-full overflow-hidden";const o=document.createElement("div");o.className="absolute inset-0 w-full h-full transition-transform duration-500 ease-out overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl border border-gray-200/50 ring-1 ring-white/20",o.innerHTML=s.innerHTML;const l=document.createElement("div");l.className="absolute inset-0 w-full h-full transition-transform duration-500 ease-out overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl border border-gray-200/50 ring-1 ring-white/20";const c="100%";l.style.transform=`translateX(${e>0?c:`-${c}`})`,this.currentModalIndex=t;const u=this.allWorks[this.currentModalIndex],h=this._getCompleteWorkData(u.ID_opera);h&&(l.innerHTML=this._renderMainCard(h)),s.parentNode.replaceChild(i,s),i.appendChild(o),i.appendChild(l),this._updateNavigationButtons(),i.offsetHeight,o.style.transform=`translateX(${e>0?`-${c}`:c})`,l.style.transform="translateX(0)",o.style.opacity="0.8",l.style.opacity="1",await new Promise(v=>setTimeout(v,500));const m=document.createElement("div");m.className="main-content-panel flex-1 min-w-0 overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl hover:shadow-2xl transition-all duration-500 border border-gray-200/50 ring-1 ring-white/20",m.innerHTML=l.innerHTML,i.parentNode.replaceChild(m,i);const f=document.getElementById("modal-progress");f&&(f.textContent=`${this.currentModalIndex+1} di ${this.allWorks.length}`),this._addMapFocusListeners(),setTimeout(()=>{this._animateContentItems(),this.isAnimating=!1},100)}}_updateNavigationButtons(){const e=document.getElementById("prev-work-btn"),t=document.getElementById("next-work-btn");e&&(this.currentModalIndex===0?(e.disabled=!0,e.className=e.className.replace("hover:scale-110 hover:-translate-y-1","opacity-40 cursor-not-allowed")):(e.disabled=!1,e.className=e.className.replace("opacity-40 cursor-not-allowed","hover:scale-110 hover:-translate-y-1"))),t&&(this.currentModalIndex===this.allWorks.length-1?(t.disabled=!0,t.className=t.className.replace("hover:scale-110 hover:-translate-y-1","opacity-40 cursor-not-allowed")):(t.disabled=!1,t.className=t.className.replace("opacity-40 cursor-not-allowed","hover:scale-110 hover:-translate-y-1"))),this._updatePreviewCards()}_updatePreviewCards(){const e=this.currentModalIndex>0?this.allWorks[this.currentModalIndex-1]:null,t=this.currentModalIndex<this.allWorks.length-1?this.allWorks[this.currentModalIndex+1]:null,n=e?this._getCompleteWorkData(e.ID_opera):null,s=t?this._getCompleteWorkData(t.ID_opera):null,i=document.querySelector(".left-nav-panel .preview-card");i&&(n?(i.className="preview-card text-center bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 px-4 py-6 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1",i.innerHTML=`
          <div class="w-12 h-1 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full mx-auto mb-4"></div>
          <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${n.Titolo}</h4>
          <p class="text-xs text-gray-600 font-medium">${n.Autore}</p>
          <p class="text-xs text-gray-500">(${n.Anno})</p>
        `):(i.className="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48",i.innerHTML='<div class="text-sm text-gray-400 font-medium">Nessuna opera precedente</div>'));const o=document.querySelector(".right-nav-panel .preview-card");o&&(s?(o.className="preview-card text-center px-4 py-6 bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1",o.innerHTML=`
          <div class="w-12 h-1 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full mx-auto mb-4"></div>
          <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${s.Titolo}</h4>
          <p class="text-xs text-gray-600 font-medium">${s.Autore}</p>
          <p class="text-xs text-gray-500">(${s.Anno})</p>
        `):(o.className="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48",o.innerHTML='<div class="text-sm text-gray-400 font-medium">Nessuna opera successiva</div>'))}_addNavigationListeners(){const e=document.getElementById("prev-work-btn"),t=document.getElementById("next-work-btn");e&&this.currentModalIndex>0&&e.addEventListener("click",()=>this._navigateModal(-1)),t&&this.currentModalIndex<this.allWorks.length-1&&t.addEventListener("click",()=>this._navigateModal(1))}_populateModal(){const e=document.getElementById("modal-content"),t=document.getElementById("modal-progress"),n=document.querySelector(".filters-section");if(!e)return;n&&(n.innerHTML=this._renderSelectedFilters());const s=this.allWorks[this.currentModalIndex],i=this._getCompleteWorkData(s.ID_opera),o=this.currentModalIndex>0?this.allWorks[this.currentModalIndex-1]:null,l=this.currentModalIndex<this.allWorks.length-1?this.allWorks[this.currentModalIndex+1]:null,c=o?this._getCompleteWorkData(o.ID_opera):null,u=l?this._getCompleteWorkData(l.ID_opera):null;if(!i){e.innerHTML='<div class="flex items-center justify-center h-full text-gray-500 text-lg">Dati non disponibili</div>';return}e.innerHTML=`
      <div class="flex h-full w-full">
        <!-- Enhanced Left Navigation Panel with fixed width -->
        <div class="left-nav-panel flex flex-col items-center justify-center p-6 space-y-6 w-64 flex-shrink-0">
          <button id="prev-work-btn" class="group p-4 bg-white/90 hover:bg-white active:bg-gray-50 rounded-2xl text-gray-600 hover:text-blue-600 transition-all duration-300 shadow-lg hover:shadow-xl ring-1 ring-gray-200/50 hover:ring-blue-200 backdrop-blur-sm border border-gray-200/30 ${this.currentModalIndex===0?"opacity-40 cursor-not-allowed":"hover:scale-110 hover:-translate-y-1"}" ${this.currentModalIndex===0?"disabled":""}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 group-hover:-translate-x-1 transition-transform duration-300">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
            </svg>
          </button>
          
          ${c?`
            <div class="preview-card text-center bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 px-4 py-6 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
              <div class="w-12 h-1 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full mx-auto mb-4"></div>
              <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${c.Titolo}</h4>
              <p class="text-xs text-gray-600 font-medium">${c.Autore}</p>
              <p class="text-xs text-gray-500">(${c.Anno})</p>
            </div>
          `:`
            <div class="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48">
              <div class="text-sm text-gray-400 font-medium">Nessuna opera precedente</div>
            </div>
          `}
        </div>

        <!-- Enhanced Main Content Area with fixed flex properties -->
        <div class="main-content-panel flex-1 min-w-0 overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl hover:shadow-2xl transition-all duration-500 border border-gray-200/50 ring-1 ring-white/20">
          ${this._renderMainCard(i)}
        </div>

        <!-- Enhanced Right Navigation Panel with fixed width -->
        <div class="right-nav-panel flex flex-col items-center justify-center p-6 space-y-6 w-64 flex-shrink-0">
          <button id="next-work-btn" class="group p-4 bg-white/90 hover:bg-white active:bg-gray-50 rounded-2xl text-gray-600 hover:text-blue-600 transition-all duration-300 shadow-lg hover:shadow-xl ring-1 ring-gray-200/50 hover:ring-blue-200 backdrop-blur-sm border border-gray-200/30 ${this.currentModalIndex===this.allWorks.length-1?"opacity-40 cursor-not-allowed":"hover:scale-110 hover:-translate-y-1"}" ${this.currentModalIndex===this.allWorks.length-1?"disabled":""}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 group-hover:translate-x-1 transition-transform duration-300">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
            </svg>
          </button>
          
          ${u?`
            <div class="preview-card text-center px-4 py-6 bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
              <div class="w-12 h-1 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full mx-auto mb-4"></div>
              <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${u.Titolo}</h4>
              <p class="text-xs text-gray-600 font-medium">${u.Autore}</p>
              <p class="text-xs text-gray-500">(${u.Anno})</p>
            </div>
          `:`
            <div class="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48">
              <div class="text-sm text-gray-400 font-medium">Nessuna opera successiva</div>
            </div>
          `}
        </div>
      </div>
    `,t&&(t.textContent=`${this.currentModalIndex+1} di ${this.allWorks.length}`),this._addNavigationListeners(),this._addMapFocusListeners()}_renderMainCard(e){const t=e.allEntries[0],n=this._renderCombinedMetadata(t),s=this._renderGeographicalSpaces(e);return`
      <div class="p-8 space-y-8 w-full">
        <!-- Enhanced Header Section -->
        <div class="modal-header bg-gradient-to-r from-slate-50/90 to-gray-50/90 backdrop-blur-sm rounded-2xl p-8 ring-1 ring-gray-200/50 border border-gray-200/30">
          <div class="flex items-start justify-between">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-1 h-12 bg-gradient-to-b from-blue-500 to-blue-600 rounded-full shadow-sm flex-shrink-0"></div>
                <div class="min-w-0 flex-1">
                  <h1 class="text-3xl font-bold text-gray-900 leading-tight truncate">${e.Titolo}</h1>
                  <div class="flex items-center gap-4 mt-2">
                    <p class="text-lg text-gray-700 font-medium truncate">${e.Autore}</p>
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full flex-shrink-0"></span>
                    <p class="text-lg text-gray-600 font-mono flex-shrink-0">${e.Anno}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        ${n}
        ${s}
      </div>
    `}_renderCombinedMetadata(e){const t=this._getCatalogueFields(),n=[],s=t.filter(i=>!n.includes(i)&&e[i]!=null&&e[i]!=="").map(i=>{const o=e[i];let l=o;return Array.isArray(o)?l=o.join(", "):typeof o=="string"&&o.length>150&&(l=o.substring(0,147)+"..."),`
          <div class="metadata-card group bg-white/90 hover:bg-white backdrop-blur-sm hover:shadow-lg rounded-xl p-5 ring-1 ring-gray-200/50 hover:ring-gray-300/70 transition-all duration-300 border border-gray-200/30 hover:border-gray-300/50 hover:-translate-y-0.5">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-2 h-2 bg-gradient-to-r from-green-400 to-green-600 rounded-full group-hover:scale-125 transition-transform duration-300 shadow-sm"></div>
              <h4 class="text-sm font-semibold text-gray-800 uppercase tracking-wide">${i}</h4>
            </div>
            <div class="text-base text-gray-700 leading-relaxed pl-5">${l}</div>
          </div>
        `}).join("");return s?`
      <div>
        <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-green-600">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0-1.125.504-1.125 1.125V11.25a9 9 0 0 0-9-9Z" />
          </svg>
          Metadati del catalogo
        </h2>
        <div class="grid gap-4">
          ${s}
        </div>
      </div>
    `:""}_renderGeographicalSpaces(e){return!e["Spazi geografici"]||e["Spazi geografici"].length===0?`
        <div class="bg-gradient-to-r from-blue-50/90 to-indigo-50/90 backdrop-blur-sm rounded-2xl p-8 ring-1 ring-blue-200/50 border border-blue-200/30">
          <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-blue-600">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
            </svg>
            Spazi geografici
          </h2>
          <div class="text-gray-500 italic">Nessun spazio geografico disponibile</div>
        </div>
      `:`
      <div class="bg-gradient-to-r from-blue-50/90 to-indigo-50/90 backdrop-blur-sm rounded-2xl p-8 ring-1 ring-blue-200/50 border border-blue-200/30">
        <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-blue-600">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
          </svg>
          Spazi geografici
        </h2>
        <div class="grid gap-6">
          ${e["Spazi geografici"].map((n,s)=>{const i=e.coordinates[s],o=e.geodataBySpace.get(n)||{},l=this._getAllMetadataFields(),c=this._getCatalogueFields(),u=[],h=l.filter(f=>!u.includes(f)&&!c.includes(f)).map(f=>{let v=o[f];if(v==null||v==="")return"";let p=v;return typeof v=="string"&&v.length>100&&(p=v.substring(0,97)+"..."),`
            <div class="flex items-start gap-3 py-2">
              <div class="w-1.5 h-1.5 bg-blue-400 rounded-full mt-2 flex-shrink-0"></div>
              <div class="min-w-0 flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-xs font-semibold text-gray-600 uppercase tracking-wide">${f}</span>
                </div>
                <span class="text-sm text-gray-800">${p}</span>
              </div>
            </div>
          `}).filter(Boolean).join(""),m=i&&i.lat&&i.lng;return`
        <div class="space-card bg-white/90 backdrop-blur-sm rounded-xl p-6 ring-1 ring-gray-200/50 hover:ring-blue-300/70 transition-all duration-300 hover:shadow-lg border border-gray-200/30 hover:border-blue-300/50 hover:-translate-y-1">
          <div class="flex items-start justify-between mb-4">
            <div class="flex items-center gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-5 h-5 text-blue-600 flex-shrink-0">
                <path fill-rule="evenodd" d="m7.539 14.841.003.003.002.002a.755.755 0 0 0 .912 0l.002-.002.003-.003.012-.009a5.57 5.57 0 0 0 .19-.153 15.588 15.588 0 0 0 2.046-2.082c1.101-1.362 2.291-3.342 2.291-5.597A5 5 0 0 0 3 7c0 2.255 1.19 4.235 2.292 5.597a15.591 15.591 0 0 0 2.046 2.082 8.916 8.916 0 0 0 .189.153l.012.01ZM8 8.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" clip-rule="evenodd" />
              </svg>
              <h3 class="text-lg font-semibold text-gray-900">${n}</h3>
            </div>
            
            ${m?`
              <button class="map-btn group px-4 py-2 text-sm font-medium bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 active:from-blue-700 active:to-blue-800 text-white rounded-lg shadow-md hover:shadow-lg transition-all duration-300 hover:scale-105 hover:-translate-y-0.5" 
                      data-lat="${i.lat}" 
                      data-lng="${i.lng}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 inline mr-1">
                  <path fill-rule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V6h4.5a.75.75 0 0 1 0 1.5H8.75v4.25a.75.75 0 0 1-1.5 0V7.5H2.75a.75.75 0 0 1 0-1.5h4.5V1.75A.75.75 0 0 1 8 1Z" clip-rule="evenodd" />
                </svg>
                Visualizza sulla mappa
              </button>
            `:`
              <span class="px-4 py-2 text-sm font-medium bg-gray-100/80 text-gray-500 rounded-lg ring-1 ring-gray-200/50 backdrop-blur-sm">
                Coordinate non disponibili
              </span>
            `}
          </div>
          
          ${h?`
            <div class="border-t border-gray-100/50 pt-4 mt-4">
              <h4 class="text-sm font-semibold text-gray-700 mb-3">Metadati geografici per questo spazio:</h4>
              <div class="space-y-2">
                ${h}
              </div>
            </div>
          `:`
            <div class="border-t border-gray-100/50 pt-4 mt-4">
              <div class="text-sm text-gray-500 italic">Nessun metadato geografico disponibile per questo spazio</div>
            </div>
          `}
        </div>
      `}).join("")}
        </div>
        <div class="mt-6 text-sm text-blue-700 bg-blue-100/80 backdrop-blur-sm rounded-lg p-3 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
            <path fill-rule="evenodd" d="M15 8A7 7 0 1 1 1 8a7 7 0 0 1 14 0ZM9 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0ZM6.75 8a.75.75 0 0 0 0 1.5h.75v1.75a.75.75 0 0 0 1.5 0v-2.5A.75.75 0 0 0 8.25 8h-1.5Z" clip-rule="evenodd" />
          </svg>
          <span>Clicca sui pulsanti per visualizzare i luoghi sulla mappa. Ogni spazio mostra solo i metadati geografici disponibili.</span>
        </div>
      </div>
    `}_addMapFocusListeners(){document.querySelectorAll(".map-btn").forEach(e=>{e.addEventListener("click",()=>{const t=parseFloat(e.getAttribute("data-lat")),n=parseFloat(e.getAttribute("data-lng"));t&&n&&this.mapFocusCallback&&(this.mapFocusCallback(t,n,8),this._closeModal())})})}_extractCoordinates(e,t){let n={lat:null,lng:null};if(Array.isArray(e.lat_long)&&e.lat_long.length>t){const s=e.lat_long[t];if(s&&typeof s=="string"){const i=s.split(",");if(i.length===2){const o=parseFloat(i[0].trim()),l=parseFloat(i[1].trim());!isNaN(o)&&!isNaN(l)&&(n={lat:o,lng:l})}}}else if(e.lat_long&&typeof e.lat_long=="string"){const s=e.lat_long.split(",");if(s.length===2){const i=parseFloat(s[0].trim()),o=parseFloat(s[1].trim());!isNaN(i)&&!isNaN(o)&&(n={lat:i,lng:o})}}return n}}class oi{constructor(e){this.mapFocusCallback=e,this.allWorks=[],this.modalRenderer=new ii(e)}updateResultsList(e,t,n={}){const s=document.getElementById("results");if(!s){console.error("Results container not found");return}this.items=e,this.searchState=n;const i=this._groupByIdOpera(e);this.allWorks=Object.values(i),this.modalRenderer.setData(this.allWorks,this.items),this.modalRenderer.setConfig(t),this.modalRenderer.setSearchState(n),s.innerHTML=this.allWorks.map((o,l)=>this._renderResultItem(o,l)).join(""),this._addMapFocusListeners(),this._addModalListeners()}focusOnResult(e){const t=document.querySelector(`[data-result-id="${e}"]`);return t?(this._openFiltersPanel(),t.scrollIntoView({behavior:"smooth",block:"center"}),this._highlightResult(t),console.log(`Focused on result with ID_opera: ${e}`),!0):(console.warn(`Result with ID_opera ${e} not found in current results`),!1)}_openFiltersPanel(){const e=document.getElementById("results-panel");e?(e.classList.remove("panel-closed-right"),console.log("Filters panel opened")):console.warn('Filters panel with ID "filters-panel" not found')}_highlightResult(e){const t=document.querySelector(".result-highlighted");t&&t.classList.remove("result-highlighted"),e.classList.add("result-highlighted"),e.style.transition="all 0.3s ease",e.style.boxShadow="0 0 20px rgba(59, 130, 246, 0.5)",e.style.transform="scale(1.02)",setTimeout(()=>{e.style.boxShadow="",e.style.transform=""},1e3),setTimeout(()=>{e.classList.remove("result-highlighted")},3e3)}_groupByIdOpera(e){const t={};return e.forEach(n=>{const s=n.ID_opera;t[s]||(t[s]={ID_opera:s,Titolo:n.Titolo,Autore:n.Autore,Anno:n.Anno,"Spazi geografici":[],coordinates:[]}),n["Spazi geografici"]&&(Array.isArray(n["Spazi geografici"])?n["Spazi geografici"]:[n["Spazi geografici"]]).forEach((o,l)=>{if(!t[s]["Spazi geografici"].includes(o)){t[s]["Spazi geografici"].push(o);const c=this._extractCoordinatesFromItem(n,l);t[s].coordinates.push(c)}})}),t}_renderResultItem(e,t){const n=e["Spazi geografici"].map((s,i)=>{const o=e.coordinates[i];return o&&o.lat&&o.lng?`
          <button class="focus-map-btn mr-2 mb-2 inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border bg-indigo-100 text-indigo-700 border-indigo-200 transition-all duration-200 hover:shadow-sm hover:bg-indigo-200 hover:scale-105 active:scale-95 cursor-pointer transform" 
                  data-space="${encodeURIComponent(s)}" 
                  data-lat="${o.lat}" 
                  data-lng="${o.lng}"
                  title="Clicca per visualizzare sulla mappa">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4 inline mr-1">
              <path fill-rule="evenodd" d="m7.539 14.841.003.003.002.002a.755.755 0 0 0 .912 0l.002-.002.003-.003.012-.009a5.57 5.57 0 0 0 .19-.153 15.588 15.588 0 0 0 2.046-2.082c1.101-1.362 2.291-3.342 2.291-5.597A5 5 0 0 0 3 7c0 2.255 1.19 4.235 2.292 5.597a15.591 15.591 0 0 0 2.046 2.082 8.916 8.916 0 0 0 .189.153l.012.01ZM8 8.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" clip-rule="evenodd" />
            </svg>
            ${s}
          </button>
        `:`
            <button class="focus-map-btn mr-2 mb-2 inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border bg-slate-100 text-slate-700 border-slate-200 transition-all duration-200 hover:shadow-sm hover:bg-slate-200 hover:scale-105 active:scale-95 cursor-pointer transform"
                  data-space="${encodeURIComponent(s)}"
                  title="Coordinate non disponibili">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4 inline mr-1 opacity-50">
              <path fill-rule="evenodd" d="m7.539 14.841.003.003.002.002a.755.755 0 0 0 .912 0l.002-.002.003-.003.012-.009a5.57 5.57 0 0 0 .19-.153 15.588 15.588 0 0 0 2.046-2.082c1.101-1.362 2.291-3.342 2.291-5.597A5 5 0 0 0 3 7c0 2.255 1.19 4.235 2.292 5.597a15.591 15.591 0 0 0 2.046 2.082 8.916 8.916 0 0 0 .189.153l.012.01ZM8 8.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" clip-rule="evenodd" />
            </svg>
            ${s}
          </button>
        `}).join("");return`
      <div class="result-card p-4 bg-white rounded-lg shadow hover:shadow-md transition-shadow" 
           data-result-id="${e.ID_opera}">
        <h3 class="font-semibold flex items-center justify-between mb-3">
          <span>${e.Titolo}, ${e.Autore} (${e.Anno})</span>
            <button class="modal-toggle-btn ml-2 inline-flex items-center justify-center p-2 rounded-full border bg-slate-100 text-slate-700 border-slate-200 transition-all duration-200 hover:shadow-sm hover:bg-slate-200 hover:scale-105 active:scale-95 cursor-pointer transform"
                    data-work-index="${t}"
                    title="Visualizza tutte le opere">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z" />
                </svg>
            </button>
        </h3>
<div class="w-full max-w-6xl mx-auto px-4">
    <div class="flex items-start mt-2">
        <div class="w-2 h-2 rounded-full bg-indigo-500 mt-2 mr-3 flex-shrink-0"></div>
        <div class="flex-1 min-w-0">
            <h4 class="text-sm font-semibold text-gray-800 mb-2">Spazi geografici descritti</h4>
            <div class="flex flex-wrap gap-1">
                ${n}
            </div>
        </div>
    </div>
</div>
      </div>
    `}_addModalListeners(){document.querySelectorAll(".modal-toggle-btn").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const n=parseInt(e.getAttribute("data-work-index"));this.modalRenderer.toggleModal(n)})})}_extractCoordinatesFromItem(e,t){let n={lat:null,lng:null};if(Array.isArray(e.lat_long)&&e.lat_long.length>t){const s=e.lat_long[t];if(s&&typeof s=="string"){const i=s.split(",");if(i.length===2){const o=parseFloat(i[0].trim()),l=parseFloat(i[1].trim());!isNaN(o)&&!isNaN(l)&&(n.lat=o,n.lng=l)}}}else if(e.lat_long&&typeof e.lat_long=="string"){const s=e.lat_long.split(",");if(s.length===2){const i=parseFloat(s[0].trim()),o=parseFloat(s[1].trim());!isNaN(i)&&!isNaN(o)&&(n.lat=i,n.lng=o)}}return n}_addMapFocusListeners(){document.querySelectorAll(".focus-map-btn").forEach(e=>{e.addEventListener("click",t=>{const n=e.getAttribute("data-lat"),s=e.getAttribute("data-lng");n&&s&&this.mapFocusCallback?this.mapFocusCallback(parseFloat(n),parseFloat(s),8):console.warn("Coordinate non disponibili per questa opera:",e.getAttribute("data-space"))})})}}class ir{static debounce(e,t){let n;return function(){clearTimeout(n),n=setTimeout(()=>e.apply(this,arguments),t)}}static parseCoordinates(e){if(!e||typeof e!="string")return{lat:null,lng:null};const t=e.split(",");return t.length===2?{lat:parseFloat(t[0].trim()),lng:parseFloat(t[1].trim())}:{lat:null,lng:null}}static encodeForAttribute(e){return encodeURIComponent(e||"")}static createUniqueId(e="element"){return`${e}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}static isEmpty(e){return e==null?!0:typeof e=="string"?e.trim()==="":Array.isArray(e)?e.length===0:typeof e=="object"?Object.keys(e).length===0:!1}}class ai{constructor(){this.config=null,this.searchEngine=null,this.state={query:"",filters:{},sort:"",bounds:null},this.isLoading=!1,this.isInitialLoad=!0,this.isFullyLoaded=!1,this.initialize()}async initialize(){try{this.showFullScreenLoader(),this.showProgressLoader(),this.config=await Nr();const e=await Br();this.config.searchConfig.per_page=e.length,this.searchEngine=ei(e,this.config),this.state.sort=this.config.searchConfig.defaultSort,this.state.filters=this.createEmptyFilters(),await this.initializeComponents(),this.bindEvents(),this.bindNavBarEvents(),await this.performSearch(),this.isInitialLoad=!1,this.isFullyLoaded=!0,this.hideProgressLoader(),this.hideFullScreenLoader()}catch(e){console.error("Initialization error:",e),this.showNotification("Error loading application","error"),this.hideProgressLoader(),this.hideFullScreenLoader()}}createEmptyFilters(){const e={};for(const[t]of Object.entries(this.config.aggregations))e[t]=[];return e}async initializeComponents(){const e=zr(this.config);this.map=e.map,this.markers=e.markers,this.renderMarkers=e.renderMarkers,this.setFocusResultCallback=e.setFocusResultCallback,this.facetRenderer=new ni(this.config),this.rangeRenderer=new Ir,this.taxonomyRenderer=new Mr,this.searchHandler=new si(this.searchEngine,this.config),this.resultsRenderer=new oi((t,n,s)=>this.focusOnMap(t,n,s)),this.navBar=ri,this.navBar.setConfig(this.config),this.connectMapToResults(),this.debouncedSearch=ir.debounce(async()=>{try{await this.performSearch()}finally{this.hideProgressLoader()}},300)}connectMapToResults(){this.setFocusResultCallback&&this.setFocusResultCallback(e=>{const t=this.resultsRenderer.focusOnResult(e);return t||this.showNotification("Item not found in current results","warning"),t})}showFullScreenLoader(){this.fullScreenLoader||(this.fullScreenLoader=document.createElement("div"),this.fullScreenLoader.className="fixed inset-0 z-[9999] bg-white flex items-center justify-center",this.fullScreenLoader.innerHTML=`
        <div class="text-center">
          <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div>
          <h2 class="text-xl font-semibold text-gray-700 mb-2">Loading LEDA Search</h2>
          <p class="text-gray-500">Initializing map, data, and components...</p>
        </div>
      `,document.body.appendChild(this.fullScreenLoader)),this.fullScreenLoader.style.display="flex"}hideFullScreenLoader(){this.fullScreenLoader&&(this.fullScreenLoader.style.opacity="0",this.fullScreenLoader.style.transition="opacity 0.3s ease-out",setTimeout(()=>{this.fullScreenLoader&&(this.fullScreenLoader.style.display="none")},300))}showProgressLoader(){if(!this.progressLoader){this.progressLoader=document.createElement("div"),this.progressLoader.className="fixed top-0 left-0 right-0 z-50 h-1 bg-gray-200",this.progressLoader.style.display="block";const t=document.createElement("div");t.className="h-full bg-gradient-to-r from-blue-500 to-purple-500 shadow-lg",t.style.width="0%",t.style.transition="width 0.3s ease-out",this.progressLoader.appendChild(t),document.body.appendChild(this.progressLoader),console.log("Progress loader created and added to DOM")}this.progressLoader.style.display="block";const e=this.progressLoader.querySelector("div");e&&(e.offsetHeight,e.style.width="100%",console.log("Progress bar animation started")),this.isLoading=!0}hideProgressLoader(){if(this.progressLoader){const e=this.progressLoader.querySelector("div");e&&(e.style.width="0%",console.log("Progress bar animation ended")),setTimeout(()=>{this.progressLoader&&(this.progressLoader.style.display="none")},300)}this.isLoading=!1}showNotification(e,t="info"){const n=document.createElement("div");n.className=`fixed top-4 right-4 z-50 p-3 rounded-lg shadow-lg max-w-sm text-white transition-all duration-300 ${t==="error"?"bg-red-500":t==="warning"?"bg-yellow-500":"bg-blue-500"}`,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",setTimeout(()=>n.remove(),300)},3e3)}async performSearch(){var e,t;!this.isInitialLoad&&!this.isLoading&&this.isFullyLoaded&&this.showProgressLoader();try{const n=this.searchHandler.performSearch(this.state,{onMarkersUpdate:s=>this.renderMarkers(s),onResultsUpdate:s=>this.resultsRenderer.updateResultsList(s,this.config,{filters:this.state.filters,query:this.state.query,sort:this.state.sort}),onAggregationsUpdate:s=>this.renderFacets(s)});return this.updateNavBar(((e=n.items)==null?void 0:e.length)||0),console.log("Search completed:",((t=n.items)==null?void 0:t.length)||0,"items found"),n}catch(n){console.error("Search error:",n),this.showNotification("Search failed","error")}finally{!this.isInitialLoad&&this.isFullyLoaded&&this.hideProgressLoader()}}async handleStateChange(e){var t,n;console.log("handleStateChange called with action:",e),this.isFullyLoaded&&this.showProgressLoader();try{switch(e.type){case"FACET_CHANGE":this.updateFilters(e.facetType,e.value,e.checked);break;case"RANGE_CHANGE":this.state.filters[e.facetKey]=e.value;break;case"QUERY_CHANGE":this.state.query=e.query;break;case"SORT_CHANGE":this.state.sort=e.sort;break}console.log("State updated, triggering search. New state:",this.state),this.isLoading=!1;const s=this.searchHandler.performSearch(this.state,{onMarkersUpdate:i=>this.renderMarkers(i),onResultsUpdate:i=>this.resultsRenderer.updateResultsList(i,this.config,{filters:this.state.filters,query:this.state.query,sort:this.state.sort}),onAggregationsUpdate:i=>this.renderFacets(i)});this.updateNavBar(((t=s.items)==null?void 0:t.length)||0),console.log("Filter search completed:",((n=s.items)==null?void 0:n.length)||0,"items found")}catch(s){console.error("Error in handleStateChange:",s)}finally{this.isFullyLoaded&&this.hideProgressLoader()}}hasActiveFilters(){if(!this.state.filters)return!1;for(const[e,t]of Object.entries(this.state.filters))if(Array.isArray(t)&&t.length>0||!Array.isArray(t)&&t)return!0;return!1}updateFilters(e,t,n){var s;console.log(`Updating filter: ${e}, value: ${t}, checked: ${n}`),n?(this.state.filters[e]||(this.state.filters[e]=[]),this.state.filters[e].push(t)):this.state.filters[e]=((s=this.state.filters[e])==null?void 0:s.filter(i=>i!==t))||[],console.log("Updated filters:",this.state.filters)}bindEvents(){this.setupSearchInput(),this.setupSortSelect(),this.setupMapEvents()}bindNavBarEvents(){this.navBar.addEventListener("clearAllFilters",()=>this.clearAllFilters()),this.navBar.addEventListener("removeFilter",e=>{const{facetKey:t,value:n}=e.detail;this.removeFilter(t,n)}),this.navBar.addEventListener("clearSearchQuery",()=>this.clearSearchQuery())}setupSearchInput(){const e=document.getElementById("search-input");e&&e.addEventListener("input",()=>{this.state.query=e.value,this.isFullyLoaded&&this.showProgressLoader(),this.debouncedSearch()})}setupSortSelect(){const e=document.getElementById("sort-select");e&&this.config.searchConfig.sortOptions&&(e.innerHTML=this.config.searchConfig.sortOptions.map(t=>`<option value="${t.value}">${t.label}</option>`).join(""),e.addEventListener("change",t=>{this.state.sort=t.target.value,this.isFullyLoaded&&this.showProgressLoader(),this.performSearch().finally(()=>{this.isFullyLoaded&&this.hideProgressLoader()})}))}setupMapEvents(){const e=ir.debounce(async()=>{this.isFullyLoaded&&this.showProgressLoader();try{await this.performSearch()}finally{this.isFullyLoaded&&this.hideProgressLoader()}},500);this.map.on("moveend",e)}focusOnMap(e,t,n=15){this.map&&this.map.setView([parseFloat(e),parseFloat(t)],n)}renderFacets(e){this.facetRenderer.renderFacets(e,this.state,t=>this.handleStateChange(t))}updateNavBar(e=0,t={}){this.navBar.updateFromSearchState(this.state,e,t)}clearAllFilters(){this.state.query="",this.state.filters=this.createEmptyFilters();const e=document.getElementById("search-input");e&&(e.value=""),this.isFullyLoaded&&this.showProgressLoader(),this.performSearch().finally(()=>{this.isFullyLoaded&&this.hideProgressLoader()})}removeFilter(e,t){this.state.filters[e]&&(t?this.state.filters[e]=this.state.filters[e].filter(n=>n!==t):this.state.filters[e]=[],this.isFullyLoaded&&this.showProgressLoader(),this.performSearch().finally(()=>{this.isFullyLoaded&&this.hideProgressLoader()}))}clearSearchQuery(){this.state.query="";const e=document.getElementById("search-input");e&&(e.value=""),this.isFullyLoaded&&this.showProgressLoader(),this.performSearch().finally(()=>{this.isFullyLoaded&&this.hideProgressLoader()})}getLoadingStatus(){return{isLoading:this.isLoading,isFullyLoaded:this.isFullyLoaded,searchEngineReady:!!this.searchEngine,mapReady:!!this.map,configLoaded:!!this.config}}}document.addEventListener("DOMContentLoaded",()=>{window.ledaSearch=new ai})});export default li();
