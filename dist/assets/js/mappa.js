var In=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports);import"./modulepreload-polyfill-B5Qt9EMX.js";import{l as Pn,p as zn}from"./dataParser-DPL0y_Ss.js";import{i as Bn}from"./initMap-BNVLy5BH.js";var hs=In((D,U)=>{var ln=typeof global=="object"&&global&&global.Object===Object&&global,Rn=typeof self=="object"&&self&&self.Object===Object&&self,J=ln||Rn||Function("return this")(),G=J.Symbol,cn=Object.prototype,Nn=cn.hasOwnProperty,Tn=cn.toString,be=G?G.toStringTag:void 0,Hn=Object.prototype.toString,Wn="[object Null]",qn="[object Undefined]",wt=G?G.toStringTag:void 0;function ye(n){return n==null?n===void 0?qn:Wn:wt&&wt in Object(n)?function(e){var t=Nn.call(e,be),r=e[be];try{e[be]=void 0;var o=!0}catch{}var s=Tn.call(e);return o&&(t?e[be]=r:delete e[be]),s}(n):function(e){return Hn.call(e)}(n)}function te(n){return n!=null&&typeof n=="object"}var Dn="[object Symbol]";function fe(n){return typeof n=="symbol"||te(n)&&ye(n)==Dn}function pe(n,e){for(var t=-1,r=n==null?0:n.length,o=Array(r);++t<r;)o[t]=e(n[t],t,n);return o}var T=Array.isArray,Un=1/0,bt=G?G.prototype:void 0,_t=bt?bt.toString:void 0;function dn(n){if(typeof n=="string")return n;if(T(n))return pe(n,dn)+"";if(fe(n))return _t?_t.call(n):"";var e=n+"";return e=="0"&&1/n==-Un?"-0":e}function ie(n){var e=typeof n;return n!=null&&(e=="object"||e=="function")}function Te(n){return n}var Vn="[object AsyncFunction]",Gn="[object Function]",Zn="[object GeneratorFunction]",Qn="[object Proxy]";function un(n){if(!ie(n))return!1;var e=ye(n);return e==Gn||e==Zn||e==Vn||e==Qn}var xt,De=J["__core-js_shared__"],St=(xt=/[^.]+$/.exec(De&&De.keys&&De.keys.IE_PROTO||""))?"Symbol(src)_1."+xt:"",Jn=Function.prototype.toString;function ae(n){if(n!=null){try{return Jn.call(n)}catch{}try{return n+""}catch{}}return""}var Yn=/^\[object .+?Constructor\]$/,Xn=RegExp("^"+Function.prototype.toString.call(Object.prototype.hasOwnProperty).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function le(n,e){var t=function(r,o){return r==null?void 0:r[o]}(n,e);return function(r){return!(!ie(r)||(o=r,St&&St in o))&&(un(r)?Xn:Yn).test(ae(r));var o}(t)?t:void 0}var Ct,Ue,Ve,Xe=le(J,"WeakMap"),kt=Object.create,Kn=function(){function n(){}return function(e){if(!ie(e))return{};if(kt)return kt(e);n.prototype=e;var t=new n;return n.prototype=void 0,t}}(),er=Date.now,tr=function(){try{var n=le(Object,"defineProperty");return n({},"",{}),n}catch{}}(),Be=tr,nr=Be?function(n,e){return Be(n,"toString",{configurable:!0,enumerable:!1,value:(t=e,function(){return t}),writable:!0});var t}:Te,rr=(Ct=nr,Ue=0,Ve=0,function(){var n=er(),e=16-(n-Ve);if(Ve=n,e>0){if(++Ue>=800)return arguments[0]}else Ue=0;return Ct.apply(void 0,arguments)});function or(n){return n!=n}function sr(n,e){return!(n==null||!n.length)&&function(t,r,o){return r==r?function(s,i,c){for(var d=-1,u=s.length;++d<u;)if(s[d]===i)return d;return-1}(t,r):function(s,i,c,d){for(var u=s.length,h=-1;++h<u;)if(i(s[h],h,s))return h;return-1}(t,or)}(n,e)>-1}var ir=9007199254740991,ar=/^(?:0|[1-9]\d*)$/;function lt(n,e){var t=typeof n;return!!(e=e??ir)&&(t=="number"||t!="symbol"&&ar.test(n))&&n>-1&&n%1==0&&n<e}function ct(n,e,t){e=="__proto__"&&Be?Be(n,e,{configurable:!0,enumerable:!0,value:t,writable:!0}):n[e]=t}function He(n,e){return n===e||n!=n&&e!=e}var lr=Object.prototype.hasOwnProperty;function hn(n,e,t){var r=n[e];lr.call(n,e)&&He(r,t)&&(t!==void 0||e in n)||ct(n,e,t)}function Le(n,e,t,r){var o=!t;t||(t={});for(var s=-1,i=e.length;++s<i;){var c=e[s],d=void 0;d===void 0&&(d=n[c]),o?ct(t,c,d):hn(t,c,d)}return t}var Et=Math.max;function gn(n,e){return rr(function(t,r,o){return r=Et(r===void 0?t.length-1:r,0),function(){for(var s=arguments,i=-1,c=Et(s.length-r,0),d=Array(c);++i<c;)d[i]=s[r+i];i=-1;for(var u=Array(r+1);++i<r;)u[i]=s[i];return u[r]=o(d),function(h,m,g){switch(g.length){case 0:return h.call(m);case 1:return h.call(m,g[0]);case 2:return h.call(m,g[0],g[1]);case 3:return h.call(m,g[0],g[1],g[2])}return h.apply(m,g)}(t,this,u)}}(n,e,Te),n+"")}var cr=9007199254740991;function dt(n){return typeof n=="number"&&n>-1&&n%1==0&&n<=cr}function ve(n){return n!=null&&dt(n.length)&&!un(n)}function jt(n,e,t){if(!ie(t))return!1;var r=typeof e;return!!(r=="number"?ve(t)&&lt(e,t.length):r=="string"&&e in t)&&He(t[e],n)}var dr=Object.prototype;function ut(n){var e=n&&n.constructor;return n===(typeof e=="function"&&e.prototype||dr)}function At(n){return te(n)&&ye(n)=="[object Arguments]"}var pn=Object.prototype,ur=pn.hasOwnProperty,hr=pn.propertyIsEnumerable,ht=At(function(){return arguments}())?At:function(n){return te(n)&&ur.call(n,"callee")&&!hr.call(n,"callee")},fn=typeof D=="object"&&D&&!D.nodeType&&D,Mt=fn&&typeof U=="object"&&U&&!U.nodeType&&U,Lt=Mt&&Mt.exports===fn?J.Buffer:void 0,Re=(Lt?Lt.isBuffer:void 0)||function(){return!1},z={};function We(n){return function(e){return n(e)}}z["[object Float32Array]"]=z["[object Float64Array]"]=z["[object Int8Array]"]=z["[object Int16Array]"]=z["[object Int32Array]"]=z["[object Uint8Array]"]=z["[object Uint8ClampedArray]"]=z["[object Uint16Array]"]=z["[object Uint32Array]"]=!0,z["[object Arguments]"]=z["[object Array]"]=z["[object ArrayBuffer]"]=z["[object Boolean]"]=z["[object DataView]"]=z["[object Date]"]=z["[object Error]"]=z["[object Function]"]=z["[object Map]"]=z["[object Number]"]=z["[object Object]"]=z["[object RegExp]"]=z["[object Set]"]=z["[object String]"]=z["[object WeakMap]"]=!1;var mn=typeof D=="object"&&D&&!D.nodeType&&D,xe=mn&&typeof U=="object"&&U&&!U.nodeType&&U,Ge=xe&&xe.exports===mn&&ln.process,me=function(){try{return xe&&xe.require&&xe.require("util").types||Ge&&Ge.binding&&Ge.binding("util")}catch{}}(),Ft=me&&me.isTypedArray,yn=Ft?We(Ft):function(n){return te(n)&&dt(n.length)&&!!z[ye(n)]},gr=Object.prototype.hasOwnProperty;function vn(n,e){var t=T(n),r=!t&&ht(n),o=!t&&!r&&Re(n),s=!t&&!r&&!o&&yn(n),i=t||r||o||s,c=i?function(h,m){for(var g=-1,y=Array(h);++g<h;)y[g]=m(g);return y}(n.length,String):[],d=c.length;for(var u in n)!e&&!gr.call(n,u)||i&&(u=="length"||o&&(u=="offset"||u=="parent")||s&&(u=="buffer"||u=="byteLength"||u=="byteOffset")||lt(u,d))||c.push(u);return c}function wn(n,e){return function(t){return n(e(t))}}var pr=wn(Object.keys,Object),fr=Object.prototype.hasOwnProperty;function Ee(n){return ve(n)?vn(n):function(e){if(!ut(e))return pr(e);var t=[];for(var r in Object(e))fr.call(e,r)&&r!="constructor"&&t.push(r);return t}(n)}var mr=Object.prototype.hasOwnProperty;function yr(n){return ve(n)?vn(n,!0):function(e){if(!ie(e))return function(s){var i=[];if(s!=null)for(var c in Object(s))i.push(c);return i}(e);var t=ut(e),r=[];for(var o in e)(o!="constructor"||!t&&mr.call(e,o))&&r.push(o);return r}(n)}var vr=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,wr=/^\w*$/;function Ke(n,e){if(T(n))return!1;var t=typeof n;return!(t!="number"&&t!="symbol"&&t!="boolean"&&n!=null&&!fe(n))||wr.test(n)||!vr.test(n)||e!=null&&n in Object(e)}var _e=le(Object,"create"),br=Object.prototype.hasOwnProperty,_r=Object.prototype.hasOwnProperty;function se(n){var e=-1,t=n==null?0:n.length;for(this.clear();++e<t;){var r=n[e];this.set(r[0],r[1])}}function Fe(n,e){for(var t=n.length;t--;)if(He(n[t][0],e))return t;return-1}se.prototype.clear=function(){this.__data__=_e?_e(null):{},this.size=0},se.prototype.delete=function(n){var e=this.has(n)&&delete this.__data__[n];return this.size-=e?1:0,e},se.prototype.get=function(n){var e=this.__data__;if(_e){var t=e[n];return t==="__lodash_hash_undefined__"?void 0:t}return br.call(e,n)?e[n]:void 0},se.prototype.has=function(n){var e=this.__data__;return _e?e[n]!==void 0:_r.call(e,n)},se.prototype.set=function(n,e){var t=this.__data__;return this.size+=this.has(n)?0:1,t[n]=_e&&e===void 0?"__lodash_hash_undefined__":e,this};var xr=Array.prototype.splice;function ee(n){var e=-1,t=n==null?0:n.length;for(this.clear();++e<t;){var r=n[e];this.set(r[0],r[1])}}ee.prototype.clear=function(){this.__data__=[],this.size=0},ee.prototype.delete=function(n){var e=this.__data__,t=Fe(e,n);return!(t<0||(t==e.length-1?e.pop():xr.call(e,t,1),--this.size,0))},ee.prototype.get=function(n){var e=this.__data__,t=Fe(e,n);return t<0?void 0:e[t][1]},ee.prototype.has=function(n){return Fe(this.__data__,n)>-1},ee.prototype.set=function(n,e){var t=this.__data__,r=Fe(t,n);return r<0?(++this.size,t.push([n,e])):t[r][1]=e,this};var Ce=le(J,"Map");function Oe(n,e){var t,r,o=n.__data__;return((r=typeof(t=e))=="string"||r=="number"||r=="symbol"||r=="boolean"?t!=="__proto__":t===null)?o[typeof e=="string"?"string":"hash"]:o.map}function K(n){var e=-1,t=n==null?0:n.length;for(this.clear();++e<t;){var r=n[e];this.set(r[0],r[1])}}function gt(n,e){if(typeof n!="function"||e!=null&&typeof e!="function")throw new TypeError("Expected a function");var t=function(){var r=arguments,o=e?e.apply(this,r):r[0],s=t.cache;if(s.has(o))return s.get(o);var i=n.apply(this,r);return t.cache=s.set(o,i)||s,i};return t.cache=new(gt.Cache||K),t}K.prototype.clear=function(){this.size=0,this.__data__={hash:new se,map:new(Ce||ee),string:new se}},K.prototype.delete=function(n){var e=Oe(this,n).delete(n);return this.size-=e?1:0,e},K.prototype.get=function(n){return Oe(this,n).get(n)},K.prototype.has=function(n){return Oe(this,n).has(n)},K.prototype.set=function(n,e){var t=Oe(this,n),r=t.size;return t.set(n,e),this.size+=t.size==r?0:1,this},gt.Cache=K;var Ze,Qe,Sr=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Cr=/\\(\\)?/g,kr=(Ze=gt(function(n){var e=[];return n.charCodeAt(0)===46&&e.push(""),n.replace(Sr,function(t,r,o,s){e.push(o?s.replace(Cr,"$1"):r||t)}),e},function(n){return Qe.size===500&&Qe.clear(),n}),Qe=Ze.cache,Ze);function bn(n,e){return T(n)?n:Ke(n,e)?[n]:kr(function(t){return t==null?"":dn(t)}(n))}var Er=1/0;function Pe(n){if(typeof n=="string"||fe(n))return n;var e=n+"";return e=="0"&&1/n==-Er?"-0":e}function et(n,e){for(var t=0,r=(e=bn(e,n)).length;n!=null&&t<r;)n=n[Pe(e[t++])];return t&&t==r?n:void 0}function pt(n,e){for(var t=-1,r=e.length,o=n.length;++t<r;)n[o+t]=e[t];return n}var Ot=G?G.isConcatSpreadable:void 0;function jr(n){return T(n)||ht(n)||!!(Ot&&n&&n[Ot])}function Ar(n,e,t,r,o){var s=-1,i=n.length;for(t||(t=jr),o||(o=[]);++s<i;){var c=n[s];t(c)?pt(o,c):o[o.length]=c}return o}var _n=wn(Object.getPrototypeOf,Object);function Q(n){var e=this.__data__=new ee(n);this.size=e.size}Q.prototype.clear=function(){this.__data__=new ee,this.size=0},Q.prototype.delete=function(n){var e=this.__data__,t=e.delete(n);return this.size=e.size,t},Q.prototype.get=function(n){return this.__data__.get(n)},Q.prototype.has=function(n){return this.__data__.has(n)},Q.prototype.set=function(n,e){var t=this.__data__;if(t instanceof ee){var r=t.__data__;if(!Ce||r.length<199)return r.push([n,e]),this.size=++t.size,this;t=this.__data__=new K(r)}return t.set(n,e),this.size=t.size,this};var xn=typeof D=="object"&&D&&!D.nodeType&&D,$t=xn&&typeof U=="object"&&U&&!U.nodeType&&U,It=$t&&$t.exports===xn?J.Buffer:void 0,Pt=It?It.allocUnsafe:void 0;function Sn(){return[]}var Mr=Object.prototype.propertyIsEnumerable,zt=Object.getOwnPropertySymbols,Lr=zt?function(n){return n==null?[]:(n=Object(n),function(e,t){for(var r=-1,o=e==null?0:e.length,s=0,i=[];++r<o;){var c=e[r];Mr.call(n,c)&&(i[s++]=c)}return i}(zt(n)))}:Sn,ft=Lr,Fr=Object.getOwnPropertySymbols?function(n){for(var e=[];n;)pt(e,ft(n)),n=_n(n);return e}:Sn;function Or(n,e,t){var r=e(n);return T(n)?r:pt(r,t(n))}function tt(n){return Or(n,Ee,ft)}var nt=le(J,"DataView"),rt=le(J,"Promise"),ot=le(J,"Set"),Bt="[object Map]",Rt="[object Promise]",Nt="[object Set]",Tt="[object WeakMap]",Ht="[object DataView]",$r=ae(nt),Ir=ae(Ce),Pr=ae(rt),zr=ae(ot),Br=ae(Xe),oe=ye;(nt&&oe(new nt(new ArrayBuffer(1)))!=Ht||Ce&&oe(new Ce)!=Bt||rt&&oe(rt.resolve())!=Rt||ot&&oe(new ot)!=Nt||Xe&&oe(new Xe)!=Tt)&&(oe=function(n){var e=ye(n),t=e=="[object Object]"?n.constructor:void 0,r=t?ae(t):"";if(r)switch(r){case $r:return Ht;case Ir:return Bt;case Pr:return Rt;case zr:return Nt;case Br:return Tt}return e});var ke=oe,Rr=Object.prototype.hasOwnProperty,Ne=J.Uint8Array;function Nr(n){var e=new n.constructor(n.byteLength);return new Ne(e).set(new Ne(n)),e}var Tr=/\w*$/,Wt=G?G.prototype:void 0,qt=Wt?Wt.valueOf:void 0,Hr="[object Boolean]",Wr="[object Date]",qr="[object Map]",Dr="[object Number]",Ur="[object RegExp]",Vr="[object Set]",Gr="[object String]",Zr="[object Symbol]",Qr="[object ArrayBuffer]",Jr="[object DataView]",Yr="[object Float32Array]",Xr="[object Float64Array]",Kr="[object Int8Array]",eo="[object Int16Array]",to="[object Int32Array]",no="[object Uint8Array]",ro="[object Uint8ClampedArray]",oo="[object Uint16Array]",so="[object Uint32Array]",Dt=me&&me.isMap,io=Dt?We(Dt):function(n){return te(n)&&ke(n)=="[object Map]"},Ut=me&&me.isSet,ao=Ut?We(Ut):function(n){return te(n)&&ke(n)=="[object Set]"},lo=1,co=2,Cn="[object Arguments]",kn="[object Function]",uo="[object GeneratorFunction]",En="[object Object]",I={};function ze(n,e,t,r,o,s){var i,c=e&lo,d=e&co;if(i!==void 0)return i;if(!ie(n))return n;var u=T(n);if(u){if(i=function(p){var v=p.length,C=new p.constructor(v);return v&&typeof p[0]=="string"&&Rr.call(p,"index")&&(C.index=p.index,C.input=p.input),C}(n),!c)return function(p,v){var C=-1,k=p.length;for(v||(v=Array(k));++C<k;)v[C]=p[C];return v}(n,i)}else{var h=ke(n),m=h==kn||h==uo;if(Re(n))return function(p,v){var C=p.length,k=Pt?Pt(C):new p.constructor(C);return p.copy(k),k}(n);if(h==En||h==Cn||m&&!o){if(i=m?{}:function(p){return typeof p.constructor!="function"||ut(p)?{}:Kn(_n(p))}(n),!c)return d?function(p,v){return Le(p,Fr(p),v)}(n,function(p,v){return p&&Le(v,yr(v),p)}(i,n)):function(p,v){return Le(p,ft(p),v)}(n,function(p,v){return p&&Le(v,Ee(v),p)}(i,n))}else{if(!I[h])return o?n:{};i=function(p,v,C){var k,F,P=p.constructor;switch(v){case Qr:return Nr(p);case Hr:case Wr:return new P(+p);case Jr:return function(j,R){var x=j.buffer;return new j.constructor(x,j.byteOffset,j.byteLength)}(p);case Yr:case Xr:case Kr:case eo:case to:case no:case ro:case oo:case so:return function(j,R){var x=j.buffer;return new j.constructor(x,j.byteOffset,j.length)}(p);case qr:return new P;case Dr:case Gr:return new P(p);case Ur:return(F=new(k=p).constructor(k.source,Tr.exec(k))).lastIndex=k.lastIndex,F;case Vr:return new P;case Zr:return qt?Object(qt.call(p)):{}}}(n,h)}}s||(s=new Q);var g=s.get(n);if(g)return g;s.set(n,i),ao(n)?n.forEach(function(p){i.add(ze(p,e,t,p,n,s))}):io(n)&&n.forEach(function(p,v){i.set(v,ze(p,e,t,v,n,s))});var y=u?void 0:tt(n);return function(p,v){for(var C=-1,k=p==null?0:p.length;++C<k&&v(p[C],C)!==!1;);}(y||n,function(p,v){y&&(p=n[v=p]),hn(i,v,ze(p,e,t,v,n,s))}),i}function Je(n){return ze(n,4)}function Se(n){var e=-1,t=n==null?0:n.length;for(this.__data__=new K;++e<t;)this.add(n[e])}function ho(n,e){for(var t=-1,r=n==null?0:n.length;++t<r;)if(e(n[t],t,n))return!0;return!1}function st(n,e){return n.has(e)}I[Cn]=I["[object Array]"]=I["[object ArrayBuffer]"]=I["[object DataView]"]=I["[object Boolean]"]=I["[object Date]"]=I["[object Float32Array]"]=I["[object Float64Array]"]=I["[object Int8Array]"]=I["[object Int16Array]"]=I["[object Int32Array]"]=I["[object Map]"]=I["[object Number]"]=I[En]=I["[object RegExp]"]=I["[object Set]"]=I["[object String]"]=I["[object Symbol]"]=I["[object Uint8Array]"]=I["[object Uint8ClampedArray]"]=I["[object Uint16Array]"]=I["[object Uint32Array]"]=!0,I["[object Error]"]=I[kn]=I["[object WeakMap]"]=!1,Se.prototype.add=Se.prototype.push=function(n){return this.__data__.set(n,"__lodash_hash_undefined__"),this},Se.prototype.has=function(n){return this.__data__.has(n)};var go=1,po=2;function Vt(n,e,t,r,o,s){var i=t&go,c=n.length,d=e.length;if(c!=d&&!(i&&d>c))return!1;var u=s.get(n),h=s.get(e);if(u&&h)return u==e&&h==n;var m=-1,g=!0,y=t&po?new Se:void 0;for(s.set(n,e),s.set(e,n);++m<c;){var p=n[m],v=e[m];if(r)var C=i?r(v,p,m,e,n,s):r(p,v,m,n,e,s);if(C!==void 0){if(C)continue;g=!1;break}if(y){if(!ho(e,function(k,F){if(!st(y,F)&&(p===k||o(p,k,t,r,s)))return y.push(F)})){g=!1;break}}else if(p!==v&&!o(p,v,t,r,s)){g=!1;break}}return s.delete(n),s.delete(e),g}function fo(n){var e=-1,t=Array(n.size);return n.forEach(function(r,o){t[++e]=[o,r]}),t}function mo(n){var e=-1,t=Array(n.size);return n.forEach(function(r){t[++e]=r}),t}var yo=1,vo=2,wo="[object Boolean]",bo="[object Date]",_o="[object Error]",xo="[object Map]",So="[object Number]",Co="[object RegExp]",ko="[object Set]",Eo="[object String]",jo="[object Symbol]",Ao="[object ArrayBuffer]",Mo="[object DataView]",Gt=G?G.prototype:void 0,Ye=Gt?Gt.valueOf:void 0,Lo=1,Fo=Object.prototype.hasOwnProperty,Oo=1,Zt="[object Arguments]",Qt="[object Array]",$e="[object Object]",Jt=Object.prototype.hasOwnProperty;function it(n,e,t,r,o){return n===e||(n==null||e==null||!te(n)&&!te(e)?n!=n&&e!=e:function(s,i,c,d,u,h){var m=T(s),g=T(i),y=m?Qt:ke(s),p=g?Qt:ke(i),v=(y=y==Zt?$e:y)==$e,C=(p=p==Zt?$e:p)==$e,k=y==p;if(k&&Re(s)){if(!Re(i))return!1;m=!0,v=!1}if(k&&!v)return h||(h=new Q),m||yn(s)?Vt(s,i,c,d,u,h):function(x,E,B,H,ne,W,V){switch(B){case Mo:if(x.byteLength!=E.byteLength||x.byteOffset!=E.byteOffset)return!1;x=x.buffer,E=E.buffer;case Ao:return!(x.byteLength!=E.byteLength||!W(new Ne(x),new Ne(E)));case wo:case bo:case So:return He(+x,+E);case _o:return x.name==E.name&&x.message==E.message;case Co:case Eo:return x==E+"";case xo:var Z=fo;case ko:if(Z||(Z=mo),x.size!=E.size&&!(H&yo))return!1;var Y=V.get(x);if(Y)return Y==E;H|=vo,V.set(x,E);var X=Vt(Z(x),Z(E),H,ne,W,V);return V.delete(x),X;case jo:if(Ye)return Ye.call(x)==Ye.call(E)}return!1}(s,i,y,c,d,u,h);if(!(c&Oo)){var F=v&&Jt.call(s,"__wrapped__"),P=C&&Jt.call(i,"__wrapped__");if(F||P){var j=F?s.value():s,R=P?i.value():i;return h||(h=new Q),u(j,R,c,d,h)}}return!!k&&(h||(h=new Q),function(x,E,B,H,ne,W){var V=B&Lo,Z=tt(x),Y=Z.length;if(Y!=tt(E).length&&!V)return!1;for(var X=Y;X--;){var f=Z[X];if(!(V?f in E:Fo.call(E,f)))return!1}var a=W.get(x),l=W.get(E);if(a&&l)return a==E&&l==x;var w=!0;W.set(x,E),W.set(E,x);for(var b=V;++X<Y;){var _=x[f=Z[X]],S=E[f];if(H)var O=V?H(S,_,f,E,x,W):H(_,S,f,x,E,W);if(!(O===void 0?_===S||ne(_,S,B,H,W):O)){w=!1;break}b||(b=f=="constructor")}if(w&&!b){var N=x.constructor,$=E.constructor;N==$||!("constructor"in x)||!("constructor"in E)||typeof N=="function"&&N instanceof N&&typeof $=="function"&&$ instanceof $||(w=!1)}return W.delete(x),W.delete(E),w}(s,i,c,d,u,h))}(n,e,t,r,it,o))}var $o=1,Io=2;function Yt(n){return n==n&&!ie(n)}function Xt(n,e){return function(t){return t!=null&&t[n]===e&&(e!==void 0||n in Object(t))}}function Po(n,e){return n!=null&&e in Object(n)}var zo=1,Bo=2;function ce(n){return typeof n=="function"?n:n==null?Te:typeof n=="object"?T(n)?function(s,i){return Ke(s)&&Yt(i)?Xt(Pe(s),i):function(c){var d=function(u,h,m){var g=u==null?void 0:et(u,h);return g===void 0?void 0:g}(c,s);return d===void 0&&d===i?function(u,h){return u!=null&&function(m,g,y){for(var p=-1,v=(g=bn(g,m)).length,C=!1;++p<v;){var k=Pe(g[p]);if(!(C=m!=null&&y(m,k)))break;m=m[k]}return C||++p!=v?C:!!(v=m==null?0:m.length)&&dt(v)&&lt(k,v)&&(T(m)||ht(m))}(u,h,Po)}(c,s):it(i,d,zo|Bo)}}(n[0],n[1]):(o=function(s){for(var i=Ee(s),c=i.length;c--;){var d=i[c],u=s[d];i[c]=[d,u,Yt(u)]}return i}(r=n),o.length==1&&o[0][2]?Xt(o[0][0],o[0][1]):function(s){return s===r||function(i,c,d,u){var h=d.length,m=h;if(i==null)return!m;for(i=Object(i);h--;){var g=d[h];if(g[2]?g[1]!==i[g[0]]:!(g[0]in i))return!1}for(;++h<m;){var y=(g=d[h])[0],p=i[y],v=g[1];if(g[2]){if(p===void 0&&!(y in i))return!1}else{var C=new Q;if(!it(v,p,$o|Io,void 0,C))return!1}}return!0}(s,0,o)}):Ke(e=n)?(t=Pe(e),function(s){return s==null?void 0:s[t]}):function(s){return function(i){return et(i,s)}}(e);var e,t,r,o}var Ro=function(n,e,t){for(var r=-1,o=Object(n),s=t(n),i=s.length;i--;){var c=s[++r];if(e(o[c],c,o)===!1)break}return n};function jn(n,e){return n&&Ro(n,e,Ee)}var Kt,No=(Kt=jn,function(n,e){if(n==null)return n;if(!ve(n))return Kt(n,e);for(var t=n.length,r=-1,o=Object(n);++r<t&&e(o[r],r,o)!==!1;);return n});function An(n,e){var t=-1,r=ve(n)?Array(n.length):[];return No(n,function(o,s,i){r[++t]=e(o,s,i)}),r}function To(n,e){return n>e}var Ho=Math.min;function Wo(n){return function(e){return te(e)&&ve(e)}(n)?n:[]}var qo=gn(function(n){var e=pe(n,Wo);return e.length&&e[0]===n[0]?function(t,r,o){for(var s=sr,i=t[0].length,c=t.length,d=c,u=Array(c),h=1/0,m=[];d--;){var g=t[d];h=Ho(g.length,h),u[d]=i>=120&&g.length>=120?new Se(d&&g):void 0}g=t[0];var y=-1,p=u[0];e:for(;++y<i&&m.length<h;){var v=g[y],C=v;if(v=v!==0?v:0,!(p?st(p,C):s(m,C,o))){for(d=c;--d;){var k=u[d];if(!(k?st(k,C):s(t[d],C,o)))continue e}p&&p.push(C),m.push(v)}}return m}(e):[]}),Do=qo;function Uo(n,e){return n<e}function M(n,e){var t={};return e=ce(e),jn(n,function(r,o,s){ct(t,o,e(r,o,s))}),t}function Mn(n,e,t){for(var r=-1,o=n.length;++r<o;){var s=n[r],i=e(s);if(i!=null&&(c===void 0?i==i&&!fe(i):t(i,c)))var c=i,d=s}return d}function Vo(n,e){return n&&n.length?Mn(n,ce(e),To):void 0}function Ln(n,e){for(var t,r=-1,o=n.length;++r<o;){var s=e(n[r]);s!==void 0&&(t=t===void 0?s:t+s)}return t}function Go(n,e){return function(t,r){var o=t==null?0:t.length;return o?Ln(t,r)/o:NaN}(n,ce(e))}function Zo(n,e){if(n!==e){var t=n!==void 0,r=n===null,o=n==n,s=fe(n),i=e!==void 0,c=e===null,d=e==e,u=fe(e);if(!c&&!u&&!s&&n>e||s&&i&&d&&!c&&!u||r&&i&&d||!t&&d||!o)return 1;if(!r&&!s&&!u&&n<e||u&&t&&o&&!r&&!s||c&&t&&o||!i&&o||!d)return-1}return 0}function Fn(n,e,t){e=e.length?pe(e,function(o){return T(o)?function(s){return et(s,o.length===1?o[0]:o)}:o}):[Te];var r=-1;return e=pe(e,We(ce)),function(o,s){var i=o.length;for(o.sort(function(c,d){return function(u,h,m){for(var g=-1,y=u.criteria,p=h.criteria,v=y.length,C=m.length;++g<v;){var k=Zo(y[g],p[g]);if(k)return g>=C?k:k*(m[g]=="desc"?-1:1)}return u.index-h.index}(c,d,t)});i--;)o[i]=o[i].value;return o}(An(n,function(o,s,i){return{criteria:pe(e,function(c){return c(o)}),index:++r,value:o}}))}function mt(n,e,t,r){return n==null?[]:(T(e)||(e=e==null?[]:[e]),T(t=t)||(t=t==null?[]:[t]),Fn(n,e,t))}var Qo=gn(function(n,e){if(n==null)return[];var t=e.length;return t>1&&jt(n,e[0],e[1])?e=[]:t>2&&jt(e[0],e[1],e[2])&&(e=[e[0]]),Fn(n,Ar(e),[])});function Jo(n,e){return n&&n.length?Ln(n,ce(e)):0}function A(n){if(this.words=[],n)if(Symbol&&Symbol.iterator&&n[Symbol.iterator]!==void 0){const e=n[Symbol.iterator]();let t=e.next();for(;!t.done;)this.add(t.value),t=e.next()}else for(let e=0;e<n.length;e++)this.add(n[e])}A.fromWords=function(n){const e=Object.create(A.prototype);return e.words=n,e},A.prototype.add=function(n){this.resize(n),this.words[n>>>5]|=1<<n},A.prototype.flip=function(n){this.resize(n),this.words[n>>>5]^=1<<n},A.prototype.clear=function(){this.words.length=0},A.prototype.remove=function(n){this.resize(n),this.words[n>>>5]&=~(1<<n)},A.prototype.isEmpty=function(n){const e=this.words.length;for(let t=0;t<e;t++)if(this.words[t]!==0)return!1;return!0},A.prototype.has=function(n){return(this.words[n>>>5]&1<<n)!=0},A.prototype.checkedAdd=function(n){this.resize(n);const e=this.words[n>>>5],t=e|1<<n;return this.words[n>>>5]=t,(t^e)>>>n},A.prototype.trim=function(n){let e=this.words.length;for(;e>0&&this.words[e-1]===0;)e--;this.words.length=e},A.prototype.resize=function(n){const e=n+32>>>5;for(let t=this.words.length;t<e;t++)this.words[t]=0},A.prototype.hammingWeight=function(n){return 16843009*((n=(858993459&(n-=n>>>1&1431655765))+(n>>>2&858993459))+(n>>>4)&252645135)>>>24},A.prototype.hammingWeight4=function(n,e,t,r){return 16843009*((n=(n=(858993459&(n-=n>>>1&1431655765))+(n>>>2&858993459))+(n>>>4)&252645135)+(e=(e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)+(t=(t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)+(r=(r=(858993459&(r-=r>>>1&1431655765))+(r>>>2&858993459))+(r>>>4)&252645135))>>>24},A.prototype.size=function(){let n=0;const e=this.words.length,t=this.words;for(let r=0;r<e;r++)n+=this.hammingWeight(t[r]);return n},A.prototype.array=function(){const n=new Array(this.size());let e=0;const t=this.words.length;for(let r=0;r<t;++r){let o=this.words[r];for(;o!=0;){const s=o&-o;n[e++]=(r<<5)+this.hammingWeight(s-1|0),o^=s}}return n},A.prototype.forEach=function(n){const e=this.words.length;for(let t=0;t<e;++t){let r=this.words[t];for(;r!=0;){const o=r&-r;n((t<<5)+this.hammingWeight(o-1|0)),r^=o}}},A.prototype[Symbol.iterator]=function(){const n=this.words.length;let e=0,t=this.words[e],r=this.hammingWeight,o=this.words;return{[Symbol.iterator](){return this},next(){for(;e<n;){if(t!==0){const s=t&-t,i=(e<<5)+r(s-1|0);return t^=s,{done:!1,value:i}}e++,e<n&&(t=o[e])}return{done:!0,value:void 0}}}},A.prototype.clone=function(){const n=Object.create(A.prototype);return n.words=this.words.slice(),n},A.prototype.intersects=function(n){const e=Math.min(this.words.length,n.words.length);for(let t=0;t<e;++t)if(this.words[t]&n.words[t])return!0;return!1},A.prototype.intersection=function(n){const e=Math.min(this.words.length,n.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]&=n.words[t],this.words[t+1]&=n.words[t+1],this.words[t+2]&=n.words[t+2],this.words[t+3]&=n.words[t+3],this.words[t+4]&=n.words[t+4],this.words[t+5]&=n.words[t+5],this.words[t+6]&=n.words[t+6],this.words[t+7]&=n.words[t+7];for(;t<e;++t)this.words[t]&=n.words[t];const r=this.words.length;for(t=e;t<r;++t)this.words[t]=0;return this},A.prototype.intersection_size=function(n){const e=Math.min(this.words.length,n.words.length);let t=0;for(let r=0;r<e;++r)t+=this.hammingWeight(this.words[r]&n.words[r]);return t},A.prototype.new_intersection=function(n){const e=Object.create(A.prototype),t=Math.min(this.words.length,n.words.length);e.words=new Array(t);let r=0;for(;r+7<t;r+=8)e.words[r]=this.words[r]&n.words[r],e.words[r+1]=this.words[r+1]&n.words[r+1],e.words[r+2]=this.words[r+2]&n.words[r+2],e.words[r+3]=this.words[r+3]&n.words[r+3],e.words[r+4]=this.words[r+4]&n.words[r+4],e.words[r+5]=this.words[r+5]&n.words[r+5],e.words[r+6]=this.words[r+6]&n.words[r+6],e.words[r+7]=this.words[r+7]&n.words[r+7];for(;r<t;++r)e.words[r]=this.words[r]&n.words[r];return e},A.prototype.equals=function(n){const e=Math.min(this.words.length,n.words.length);for(let t=0;t<e;++t)if(this.words[t]!=n.words[t])return!1;if(this.words.length<n.words.length){const t=n.words.length;for(let r=this.words.length;r<t;++r)if(n.words[r]!=0)return!1}else if(n.words.length<this.words.length){const t=this.words.length;for(let r=n.words.length;r<t;++r)if(this.words[r]!=0)return!1}return!0},A.prototype.difference=function(n){const e=Math.min(this.words.length,n.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]&=~n.words[t],this.words[t+1]&=~n.words[t+1],this.words[t+2]&=~n.words[t+2],this.words[t+3]&=~n.words[t+3],this.words[t+4]&=~n.words[t+4],this.words[t+5]&=~n.words[t+5],this.words[t+6]&=~n.words[t+6],this.words[t+7]&=~n.words[t+7];for(;t<e;++t)this.words[t]&=~n.words[t];return this},A.prototype.new_difference=function(n){return this.clone().difference(n)},A.prototype.difference2=function(n){const e=Math.min(this.words.length,n.words.length);let t=0;for(;t+7<e;t+=8)n.words[t]=this.words[t]&~n.words[t],n.words[t+1]=this.words[t+1]&~n.words[t+1],n.words[t+2]=this.words[t+2]&~n.words[t+2],n.words[t+3]=this.words[t+3]&~n.words[t+3],n.words[t+4]=this.words[t+4]&~n.words[t+4],n.words[t+5]=this.words[t+5]&~n.words[t+5],n.words[t+6]=this.words[t+6]&~n.words[t+6],n.words[t+7]=this.words[t+7]&~n.words[t+7];for(;t<e;++t)n.words[t]=this.words[t]&~n.words[t];for(t=this.words.length-1;t>=e;--t)n.words[t]=this.words[t];return n.words.length=this.words.length,n},A.prototype.difference_size=function(n){const e=Math.min(this.words.length,n.words.length);let t=0,r=0;for(;r<e;++r)t+=this.hammingWeight(this.words[r]&~n.words[r]);const o=this.words.length;for(;r<o;++r)t+=this.hammingWeight(this.words[r]);return t},A.prototype.change=function(n){const e=Math.min(this.words.length,n.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]^=n.words[t],this.words[t+1]^=n.words[t+1],this.words[t+2]^=n.words[t+2],this.words[t+3]^=n.words[t+3],this.words[t+4]^=n.words[t+4],this.words[t+5]^=n.words[t+5],this.words[t+6]^=n.words[t+6],this.words[t+7]^=n.words[t+7];for(;t<e;++t)this.words[t]^=n.words[t];for(t=n.words.length-1;t>=e;--t)this.words[t]=n.words[t];return this},A.prototype.new_change=function(n){const e=Object.create(A.prototype),t=Math.max(this.words.length,n.words.length);e.words=new Array(t);const r=Math.min(this.words.length,n.words.length);let o=0;for(;o+7<r;o+=8)e.words[o]=this.words[o]^n.words[o],e.words[o+1]=this.words[o+1]^n.words[o+1],e.words[o+2]=this.words[o+2]^n.words[o+2],e.words[o+3]=this.words[o+3]^n.words[o+3],e.words[o+4]=this.words[o+4]^n.words[o+4],e.words[o+5]=this.words[o+5]^n.words[o+5],e.words[o+6]=this.words[o+6]^n.words[o+6],e.words[o+7]=this.words[o+7]^n.words[o+7];for(;o<r;++o)e.words[o]=this.words[o]^n.words[o];const s=this.words.length;for(o=r;o<s;++o)e.words[o]=this.words[o];const i=n.words.length;for(o=r;o<i;++o)e.words[o]=n.words[o];return e},A.prototype.change_size=function(n){const e=Math.min(this.words.length,n.words.length);let t=0,r=0;for(;r<e;++r)t+=this.hammingWeight(this.words[r]^n.words[r]);const o=this.words.length>n.words.length?this:n,s=o.words.length;for(;r<s;++r)t+=this.hammingWeight(o.words[r]);return t},A.prototype.toString=function(){return"{"+this.array().join(",")+"}"},A.prototype.union=function(n){const e=Math.min(this.words.length,n.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]|=n.words[t],this.words[t+1]|=n.words[t+1],this.words[t+2]|=n.words[t+2],this.words[t+3]|=n.words[t+3],this.words[t+4]|=n.words[t+4],this.words[t+5]|=n.words[t+5],this.words[t+6]|=n.words[t+6],this.words[t+7]|=n.words[t+7];for(;t<e;++t)this.words[t]|=n.words[t];if(this.words.length<n.words.length){this.resize((n.words.length<<5)-1);const r=n.words.length;for(let o=e;o<r;++o)this.words[o]=n.words[o]}return this},A.prototype.new_union=function(n){const e=Object.create(A.prototype),t=Math.max(this.words.length,n.words.length);e.words=new Array(t);const r=Math.min(this.words.length,n.words.length);let o=0;for(;o+7<r;o+=8)e.words[o]=this.words[o]|n.words[o],e.words[o+1]=this.words[o+1]|n.words[o+1],e.words[o+2]=this.words[o+2]|n.words[o+2],e.words[o+3]=this.words[o+3]|n.words[o+3],e.words[o+4]=this.words[o+4]|n.words[o+4],e.words[o+5]=this.words[o+5]|n.words[o+5],e.words[o+6]=this.words[o+6]|n.words[o+6],e.words[o+7]=this.words[o+7]|n.words[o+7];for(;o<r;++o)e.words[o]=this.words[o]|n.words[o];const s=this.words.length;for(o=r;o<s;++o)e.words[o]=this.words[o];const i=n.words.length;for(o=r;o<i;++o)e.words[o]=n.words[o];return e},A.prototype.union_size=function(n){const e=Math.min(this.words.length,n.words.length);let t=0;for(let r=0;r<e;++r)t+=this.hammingWeight(this.words[r]|n.words[r]);if(this.words.length<n.words.length){const r=n.words.length;for(let o=this.words.length;o<r;++o)t+=this.hammingWeight(0|n.words[o])}else{const r=this.words.length;for(let o=n.words.length;o<r;++o)t+=this.hammingWeight(0|this.words[o])}return t};var q=A;function at(){return at=Object.assign||function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r])}return n},at.apply(this,arguments)}function Yo(n,e){var t=[];return n.forEach(function(r){e.forEach(function(o){t.push(r.concat(o))})}),t}function On(n){return!!~n.search(/\(|\)/)}function en(n,e){for(var t=e.split(" "+n+" "),r=[],o=[],s=0;s<t.length;s++)if(On(t[s])||o.length>0){o.push(t[s]);var i=""+o;(i.match(/\(/g)||[]).length===(i.match(/\)/g)||[]).length&&(r.push(o.join(" "+n+" ")),o=[])}else r.push(t[s]);return r}var Xo=function n(e){return function(r){for(var o=r[0],s=1;s<r.length;s++)o=o.concat(r[s]);return o}(en("OR",(t=e=function(r){if(r.charAt(0)==="("){for(var o=0,s=0;s<r.length;s++)if(r.charAt(s)==="("?o++:r.charAt(s)===")"&&o--,o===0)return s!==r.length-1?r:r.substring(1,r.length-1)}return r}(e),e=t.replace(/[\s]+/g," "))).map(function(r){for(var o=en("AND",r),s=[],i=[],c=0;c<o.length;c++)On(o[c])?s.push(n(o[c])):i.push(o[c]);return s.push([i]),function(d){for(var u=[[]],h=0;h<d.length;h++)u=Yo(u,d[h]);return u}(s)}));var t};const tn=function(n){try{return structuredClone(n)}catch{try{return JSON.parse(JSON.stringify(n))}catch{return n}}},nn=function(n,e){let t=new q([]),r=0;return M(e,function(o,s){o.forEach(i=>{++r,t=t.new_union(n[s][i]||new q([]))})}),r===0?null:t},Ko=function(n,e,t){let r=1;return M(n.bits_data_temp,(o,s)=>{let i,c,d,u,h,m,g;t[s]&&(i=t[s].order,c=t[s].sort,d=t[s].size,u=t[s].title,h=t[s].show_facet_stats||!1,m=t[s].chosen_filters_on_top!==!1,g=t[s].hide_zero_doc_count||!1);let y,p,v,C,k=Object.entries(o).map(j=>{let R=[];e&&e.filters&&e.filters[s]&&(R=e.filters[s]);const x=j[1].array().length;if(!g||x!==0||R.indexOf(j[0])!==-1)return{key:j[0],doc_count:x,selected:R.indexOf(j[0])!==-1}}).filter(Boolean);var F,P;return T(c)?(y=c||["key"],p=i||["asc"]):(c==="term"||c==="key"?(y=["key"],p=[i||"asc"]):(y=["doc_count","key"],p=[i||"desc","asc"]),m&&(y.unshift("selected"),p.unshift("desc"))),k=mt(k,y,p),k=k.slice(0,d||10),h&&(v=[],Object.entries(o).forEach(j=>{if(isNaN(j[0]))throw new Error("You cant use chars to calculate the facet_stats.");j[1].array().length>0&&j[1].forEach(()=>{v.push(parseInt(j[0]))})}),C={min:(F=v,F&&F.length?Mn(F,ce(void 0),Uo):void 0),max:Vo(v),avg:Go(v),sum:Jo(v)}),at({name:s,title:u||(P=s,P.replace(/^[\s_]+|[\s_]+$/g,"").replace(/[_\s]+/g," ").replace(/^[a-z]/,function(j){return j.toUpperCase()})),position:r++,buckets:k},h&&{facet_stats:C})})};function rn(n,e,t,r,o){e=e||Object.create(null);const s=parseInt(e.per_page||12),i=parseInt(e.page||1),c=e.is_all_filtered_items||!1;if(t.native_search_enabled===!1&&(e.query||e.filter))throw new Error('"query" and "filter" options are not working once native search is disabled');let d=0;const u=new Date().getTime();let h,m,g,y=o.bits_ids();if(e._ids)h=new q(e._ids),m=e._ids;else if(e.ids)m=o.internal_ids_from_ids_map(e.ids),h=new q(m);else if(r&&(e.query||e.filter)){const x=new Date().getTime();m=r.search(e.query,e.filter),d=new Date().getTime()-x,h=new q(m)}let p=new Date().getTime();const v=o.search(e,{query_ids:h});p=new Date().getTime()-p,h&&(y=h),v.ids&&(y=y.new_intersection(v.ids)),v.not_ids&&(y=y.new_difference(v.not_ids));let C=y.array(),k=C.map(x=>o.get_item(x)),F=!1;const P=new Date().getTime();let j=0;e.sort?k=function(x,E,B){return B&&B[E]&&(E=B[E]),E.field?mt(x,E.field,E.order||"asc"):x}(k,e.sort,t.sortings):m&&(C=m.filter(x=>y.has(x)),k=C.slice((i-1)*s,i*s).map(x=>o.get_item(x)),F=!0),F||(g=c?k:null,k=k.slice((i-1)*s,i*s)),j=new Date().getTime()-P;const R=new Date().getTime()-u;return{pagination:{per_page:s,page:i,total:C.length},timings:{total:R,facets:p,search:d,sorting:j},data:{items:k,allFilteredItems:g,aggregations:Ko(v,e,t.aggregations)}}}var Ie=function(n){var e={exports:{}};return function(t,r){(function(){var o,s,i,c,d,u,h,m,g,y,p,v,C,k,F,P,j,R,x,E,B,H,ne,W,V,Z,Y,X,f=function(a){var l=new f.Index;return l.pipeline.add(f.trimmer,f.stopWordFilter,f.stemmer),a&&a.call(l,l),l};f.version="1.0.0",f.utils={},f.utils.warn=function(a){return function(l){a.console&&console.warn&&console.warn(l)}}(this),f.utils.asString=function(a){return a==null?"":a.toString()},f.EventEmitter=function(){this.events={}},f.EventEmitter.prototype.addListener=function(){var a=Array.prototype.slice.call(arguments),l=a.pop(),w=a;if(typeof l!="function")throw new TypeError("last argument must be a function");w.forEach(function(b){this.hasHandler(b)||(this.events[b]=[]),this.events[b].push(l)},this)},f.EventEmitter.prototype.removeListener=function(a,l){if(this.hasHandler(a)){var w=this.events[a].indexOf(l);this.events[a].splice(w,1),this.events[a].length||delete this.events[a]}},f.EventEmitter.prototype.emit=function(a){if(this.hasHandler(a)){var l=Array.prototype.slice.call(arguments,1);this.events[a].forEach(function(w){w.apply(void 0,l)})}},f.EventEmitter.prototype.hasHandler=function(a){return a in this.events},f.tokenizer=function(a){return arguments.length&&a!=null&&a!=null?Array.isArray(a)?a.map(function(l){return f.utils.asString(l).toLowerCase()}):a.toString().trim().toLowerCase().split(f.tokenizer.separator):[]},f.tokenizer.separator=/[\s\-]+/,f.tokenizer.load=function(a){var l=this.registeredFunctions[a];if(!l)throw new Error("Cannot load un-registered function: "+a);return l},f.tokenizer.label="default",f.tokenizer.registeredFunctions={default:f.tokenizer},f.tokenizer.registerFunction=function(a,l){l in this.registeredFunctions&&f.utils.warn("Overwriting existing tokenizer: "+l),a.label=l,this.registeredFunctions[l]=a},f.Pipeline=function(){this._stack=[]},f.Pipeline.registeredFunctions={},f.Pipeline.registerFunction=function(a,l){l in this.registeredFunctions&&f.utils.warn("Overwriting existing registered function: "+l),a.label=l,f.Pipeline.registeredFunctions[a.label]=a},f.Pipeline.warnIfFunctionNotRegistered=function(a){a.label&&a.label in this.registeredFunctions||f.utils.warn(`Function is not registered with pipeline. This may cause problems when serialising the index.
`,a)},f.Pipeline.load=function(a){var l=new f.Pipeline;return a.forEach(function(w){var b=f.Pipeline.registeredFunctions[w];if(!b)throw new Error("Cannot load un-registered function: "+w);l.add(b)}),l},f.Pipeline.prototype.add=function(){Array.prototype.slice.call(arguments).forEach(function(a){f.Pipeline.warnIfFunctionNotRegistered(a),this._stack.push(a)},this)},f.Pipeline.prototype.after=function(a,l){f.Pipeline.warnIfFunctionNotRegistered(l);var w=this._stack.indexOf(a);if(w==-1)throw new Error("Cannot find existingFn");this._stack.splice(w+=1,0,l)},f.Pipeline.prototype.before=function(a,l){f.Pipeline.warnIfFunctionNotRegistered(l);var w=this._stack.indexOf(a);if(w==-1)throw new Error("Cannot find existingFn");this._stack.splice(w,0,l)},f.Pipeline.prototype.remove=function(a){var l=this._stack.indexOf(a);l!=-1&&this._stack.splice(l,1)},f.Pipeline.prototype.run=function(a){for(var l=[],w=a.length,b=this._stack.length,_=0;_<w;_++){for(var S=a[_],O=0;O<b&&(S=this._stack[O](S,_,a))!==void 0&&S!=="";O++);S!==void 0&&S!==""&&l.push(S)}return l},f.Pipeline.prototype.reset=function(){this._stack=[]},f.Pipeline.prototype.toJSON=function(){return this._stack.map(function(a){return f.Pipeline.warnIfFunctionNotRegistered(a),a.label})},f.Vector=function(){this._magnitude=null,this.list=void 0,this.length=0},f.Vector.Node=function(a,l,w){this.idx=a,this.val=l,this.next=w},f.Vector.prototype.insert=function(a,l){this._magnitude=void 0;var w=this.list;if(!w)return this.list=new f.Vector.Node(a,l,w),this.length++;if(a<w.idx)return this.list=new f.Vector.Node(a,l,w),this.length++;for(var b=w,_=w.next;_!=null;){if(a<_.idx)return b.next=new f.Vector.Node(a,l,_),this.length++;b=_,_=_.next}return b.next=new f.Vector.Node(a,l,_),this.length++},f.Vector.prototype.magnitude=function(){if(this._magnitude)return this._magnitude;for(var a,l=this.list,w=0;l;)w+=(a=l.val)*a,l=l.next;return this._magnitude=Math.sqrt(w)},f.Vector.prototype.dot=function(a){for(var l=this.list,w=a.list,b=0;l&&w;)l.idx<w.idx?l=l.next:(l.idx>w.idx||(b+=l.val*w.val,l=l.next),w=w.next);return b},f.Vector.prototype.similarity=function(a){return this.dot(a)/(this.magnitude()*a.magnitude())},f.SortedSet=function(){this.length=0,this.elements=[]},f.SortedSet.load=function(a){var l=new this;return l.elements=a,l.length=a.length,l},f.SortedSet.prototype.add=function(){var a,l;for(a=0;a<arguments.length;a++)~this.indexOf(l=arguments[a])||this.elements.splice(this.locationFor(l),0,l);this.length=this.elements.length},f.SortedSet.prototype.toArray=function(){return this.elements.slice()},f.SortedSet.prototype.map=function(a,l){return this.elements.map(a,l)},f.SortedSet.prototype.forEach=function(a,l){return this.elements.forEach(a,l)},f.SortedSet.prototype.indexOf=function(a){for(var l=0,w=this.elements.length,b=w-l,_=l+Math.floor(b/2),S=this.elements[_];b>1;){if(S===a)return _;S<a&&(l=_),S>a&&(w=_),b=w-l,_=l+Math.floor(b/2),S=this.elements[_]}return S===a?_:-1},f.SortedSet.prototype.locationFor=function(a){for(var l=0,w=this.elements.length,b=w-l,_=l+Math.floor(b/2),S=this.elements[_];b>1;)S<a&&(l=_),S>a&&(w=_),b=w-l,_=l+Math.floor(b/2),S=this.elements[_];return S>a?_:S<a?_+1:void 0},f.SortedSet.prototype.intersect=function(a){for(var l=new f.SortedSet,w=0,b=0,_=this.length,S=a.length,O=this.elements,N=a.elements;!(w>_-1||b>S-1);)O[w]!==N[b]?O[w]<N[b]?w++:O[w]>N[b]&&b++:(l.add(O[w]),w++,b++);return l},f.SortedSet.prototype.clone=function(){var a=new f.SortedSet;return a.elements=this.toArray(),a.length=a.elements.length,a},f.SortedSet.prototype.union=function(a){var l,w,b;this.length>=a.length?(l=this,w=a):(l=a,w=this),b=l.clone();for(var _=0,S=w.toArray();_<S.length;_++)b.add(S[_]);return b},f.SortedSet.prototype.toJSON=function(){return this.toArray()},f.Index=function(){this._fields=[],this._ref="id",this.pipeline=new f.Pipeline,this.documentStore=new f.Store,this.tokenStore=new f.TokenStore,this.corpusTokens=new f.SortedSet,this.eventEmitter=new f.EventEmitter,this.tokenizerFn=f.tokenizer,this._idfCache={},this.on("add","remove","update",(function(){this._idfCache={}}).bind(this))},f.Index.prototype.on=function(){var a=Array.prototype.slice.call(arguments);return this.eventEmitter.addListener.apply(this.eventEmitter,a)},f.Index.prototype.off=function(a,l){return this.eventEmitter.removeListener(a,l)},f.Index.load=function(a){a.version!==f.version&&f.utils.warn("version mismatch: current "+f.version+" importing "+a.version);var l=new this;return l._fields=a.fields,l._ref=a.ref,l.tokenizer(f.tokenizer.load(a.tokenizer)),l.documentStore=f.Store.load(a.documentStore),l.tokenStore=f.TokenStore.load(a.tokenStore),l.corpusTokens=f.SortedSet.load(a.corpusTokens),l.pipeline=f.Pipeline.load(a.pipeline),l},f.Index.prototype.field=function(a,l){return this._fields.push({name:a,boost:(l=l||{}).boost||1}),this},f.Index.prototype.ref=function(a){return this._ref=a,this},f.Index.prototype.tokenizer=function(a){return a.label&&a.label in f.tokenizer.registeredFunctions||f.utils.warn("Function is not a registered tokenizer. This may cause problems when serialising the index"),this.tokenizerFn=a,this},f.Index.prototype.add=function(a,l){var w={},b=new f.SortedSet,_=a[this._ref];l=l===void 0||l,this._fields.forEach(function(Ae){var he=this.pipeline.run(this.tokenizerFn(a[Ae.name]));w[Ae.name]=he;for(var ge=0;ge<he.length;ge++){var Me=he[ge];b.add(Me),this.corpusTokens.add(Me)}},this),this.documentStore.set(_,b);for(var S=0;S<b.length;S++){for(var O=b.elements[S],N=0,$=0;$<this._fields.length;$++){var de=this._fields[$],je=w[de.name],we=je.length;if(we){for(var re=0,ue=0;ue<we;ue++)je[ue]===O&&re++;N+=re/we*de.boost}}this.tokenStore.add(O,{ref:_,tf:N})}l&&this.eventEmitter.emit("add",a,this)},f.Index.prototype.remove=function(a,l){var w=a[this._ref];if(l=l===void 0||l,this.documentStore.has(w)){var b=this.documentStore.get(w);this.documentStore.remove(w),b.forEach(function(_){this.tokenStore.remove(_,w)},this),l&&this.eventEmitter.emit("remove",a,this)}},f.Index.prototype.update=function(a,l){l=l===void 0||l,this.remove(a,!1),this.add(a,!1),l&&this.eventEmitter.emit("update",a,this)},f.Index.prototype.idf=function(a){var l="@"+a;if(Object.prototype.hasOwnProperty.call(this._idfCache,l))return this._idfCache[l];var w=this.tokenStore.count(a),b=1;return w>0&&(b=1+Math.log(this.documentStore.length/w)),this._idfCache[l]=b},f.Index.prototype.search=function(a){var l=this.pipeline.run(this.tokenizerFn(a)),w=new f.Vector,b=[],_=this._fields.reduce(function(S,O){return S+O.boost},0);return l.some(function(S){return this.tokenStore.has(S)},this)?(l.forEach(function(S,O,N){var $=1/N.length*this._fields.length*_,de=this,je=this.tokenStore.expand(S).reduce(function(we,re){var ue=de.corpusTokens.indexOf(re),Ae=de.idf(re),he=1,ge=new f.SortedSet;if(re!==S){var Me=Math.max(3,re.length-S.length);he=1/Math.log(Me)}ue>-1&&w.insert(ue,$*Ae*he);for(var yt=de.tokenStore.get(re),vt=Object.keys(yt),$n=vt.length,qe=0;qe<$n;qe++)ge.add(yt[vt[qe]].ref);return we.union(ge)},new f.SortedSet);b.push(je)},this),b.reduce(function(S,O){return S.intersect(O)}).map(function(S){return{ref:S,score:w.similarity(this.documentVector(S))}},this).sort(function(S,O){return O.score-S.score})):[]},f.Index.prototype.documentVector=function(a){for(var l=this.documentStore.get(a),w=l.length,b=new f.Vector,_=0;_<w;_++){var S=l.elements[_],O=this.tokenStore.get(S)[a].tf,N=this.idf(S);b.insert(this.corpusTokens.indexOf(S),O*N)}return b},f.Index.prototype.toJSON=function(){return{version:f.version,fields:this._fields,ref:this._ref,tokenizer:this.tokenizerFn.label,documentStore:this.documentStore.toJSON(),tokenStore:this.tokenStore.toJSON(),corpusTokens:this.corpusTokens.toJSON(),pipeline:this.pipeline.toJSON()}},f.Index.prototype.use=function(a){var l=Array.prototype.slice.call(arguments,1);l.unshift(this),a.apply(this,l)},f.Store=function(){this.store={},this.length=0},f.Store.load=function(a){var l=new this;return l.length=a.length,l.store=Object.keys(a.store).reduce(function(w,b){return w[b]=f.SortedSet.load(a.store[b]),w},{}),l},f.Store.prototype.set=function(a,l){this.has(a)||this.length++,this.store[a]=l},f.Store.prototype.get=function(a){return this.store[a]},f.Store.prototype.has=function(a){return a in this.store},f.Store.prototype.remove=function(a){this.has(a)&&(delete this.store[a],this.length--)},f.Store.prototype.toJSON=function(){return{store:this.store,length:this.length}},f.stemmer=(o={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},s={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},u="^("+(c="[^aeiou][^aeiouy]*")+")?"+(d=(i="[aeiouy]")+"[aeiou]*")+c+"("+d+")?$",h="^("+c+")?"+d+c+d+c,m="^("+c+")?"+i,g=new RegExp("^("+c+")?"+d+c),y=new RegExp(h),p=new RegExp(u),v=new RegExp(m),C=/^(.+?)(ss|i)es$/,k=/^(.+?)([^s])s$/,F=/^(.+?)eed$/,P=/^(.+?)(ed|ing)$/,j=/.$/,R=/(at|bl|iz)$/,x=new RegExp("([^aeiouylsz])\\1$"),E=new RegExp("^"+c+i+"[^aeiouwxy]$"),B=/^(.+?[^aeiou])y$/,H=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/,ne=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,W=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/,V=/^(.+?)(s|t)(ion)$/,Z=/^(.+?)e$/,Y=/ll$/,X=new RegExp("^"+c+i+"[^aeiouwxy]$"),function(a){var l,w,b,_,S,O,N;if(a.length<3)return a;if((b=a.substr(0,1))=="y"&&(a=b.toUpperCase()+a.substr(1)),S=k,(_=C).test(a)?a=a.replace(_,"$1$2"):S.test(a)&&(a=a.replace(S,"$1$2")),S=P,(_=F).test(a)){var $=_.exec(a);(_=g).test($[1])&&(a=a.replace(_=j,""))}else S.test(a)&&($=S.exec(a),(S=v).test(l=$[1])&&(O=x,N=E,(S=R).test(a=l)?a+="e":O.test(a)?a=a.replace(_=j,""):N.test(a)&&(a+="e")));return(_=B).test(a)&&(a=(l=($=_.exec(a))[1])+"i"),(_=H).test(a)&&(w=($=_.exec(a))[2],(_=g).test(l=$[1])&&(a=l+o[w])),(_=ne).test(a)&&(w=($=_.exec(a))[2],(_=g).test(l=$[1])&&(a=l+s[w])),S=V,(_=W).test(a)?($=_.exec(a),(_=y).test(l=$[1])&&(a=l)):S.test(a)&&($=S.exec(a),(S=y).test(l=$[1]+$[2])&&(a=l)),(_=Z).test(a)&&($=_.exec(a),S=p,O=X,((_=y).test(l=$[1])||S.test(l)&&!O.test(l))&&(a=l)),S=y,(_=Y).test(a)&&S.test(a)&&(a=a.replace(_=j,"")),b=="y"&&(a=b.toLowerCase()+a.substr(1)),a}),f.Pipeline.registerFunction(f.stemmer,"stemmer"),f.generateStopWordFilter=function(a){var l=a.reduce(function(w,b){return w[b]=b,w},{});return function(w){if(w&&l[w]!==w)return w}},f.stopWordFilter=f.generateStopWordFilter(["a","able","about","across","after","all","almost","also","am","among","an","and","any","are","as","at","be","because","been","but","by","can","cannot","could","dear","did","do","does","either","else","ever","every","for","from","get","got","had","has","have","he","her","hers","him","his","how","however","i","if","in","into","is","it","its","just","least","let","like","likely","may","me","might","most","must","my","neither","no","nor","not","of","off","often","on","only","or","other","our","own","rather","said","say","says","she","should","since","so","some","than","that","the","their","them","then","there","these","they","this","tis","to","too","twas","us","wants","was","we","were","what","when","where","which","while","who","whom","why","will","with","would","yet","you","your"]),f.Pipeline.registerFunction(f.stopWordFilter,"stopWordFilter"),f.trimmer=function(a){return a.replace(/^\W+/,"").replace(/\W+$/,"")},f.Pipeline.registerFunction(f.trimmer,"trimmer"),f.TokenStore=function(){this.root={docs:{}},this.length=0},f.TokenStore.load=function(a){var l=new this;return l.root=a.root,l.length=a.length,l},f.TokenStore.prototype.add=function(a,l,w){w=w||this.root;var b=a.charAt(0),_=a.slice(1);return b in w||(w[b]={docs:{}}),_.length===0?(w[b].docs[l.ref]=l,void(this.length+=1)):this.add(_,l,w[b])},f.TokenStore.prototype.has=function(a){if(!a)return!1;for(var l=this.root,w=0;w<a.length;w++){if(!l[a.charAt(w)])return!1;l=l[a.charAt(w)]}return!0},f.TokenStore.prototype.getNode=function(a){if(!a)return{};for(var l=this.root,w=0;w<a.length;w++){if(!l[a.charAt(w)])return{};l=l[a.charAt(w)]}return l},f.TokenStore.prototype.get=function(a,l){return this.getNode(a,l).docs||{}},f.TokenStore.prototype.count=function(a,l){return Object.keys(this.get(a,l)).length},f.TokenStore.prototype.remove=function(a,l){if(a){for(var w=this.root,b=0;b<a.length;b++){if(!(a.charAt(b)in w))return;w=w[a.charAt(b)]}delete w.docs[l]}},f.TokenStore.prototype.expand=function(a,l){var w=this.getNode(a);return l=l||[],Object.keys(w.docs||{}).length&&l.push(a),Object.keys(w).forEach(function(b){b!=="docs"&&l.concat(this.expand(a+b,l))},this),l},f.TokenStore.prototype.toJSON=function(){return{root:this.root,length:this.length}},t.exports=f})()}(e),e.exports}();class on{constructor(e,t){this.store=new Map,this.idx=Ie(function(){this.field("name",{boost:10}),((t==null?void 0:t.searchableFields)||[]).forEach(o=>this.field(o)),this.ref("_id"),t!=null&&t.isExactSearch&&(this.pipeline.remove(Ie.stemmer),this.pipeline.remove(Ie.stopWordFilter)),t!=null&&t.removeStopWordFilter&&this.pipeline.remove(Ie.stopWordFilter)});let r=1;(e||[]).map(o=>{o._id=r,++r,this.idx.add(o),this.store.set(o._id,o)})}search_full(e,t){return this.search(e,t).map(r=>this.store.get(r))}search(e,t){return t instanceof Function?(e?this.idx.search(e).map(r=>this.store.get(r.ref)):[...this.store.values()]).filter(t).map(r=>r._id):e?this.idx.search(e).map(r=>r.ref):[...this.store.keys()]}}class sn{constructor(e,t){(t=t||Object.create(null)).aggregations=t.aggregations||Object.create(null),this._items=e,this.config=t.aggregations,this.facets=function(i,c){c=c||[];const d={data:Object.create(null),bits_data:Object.create(null),bits_data_temp:Object.create(null)};let u=1;return c.forEach(h=>{d.data[h]=Object.create(null)}),i&&i.map(h=>(h._id||(h._id=u,++u),h)),i&&i.map(h=>(c.forEach(m=>{if(h){if(Array.isArray(h[m]))h[m].forEach(g=>{h[m]&&(d.data[m][g]||(d.data[m][g]=[]),d.data[m][g].push(parseInt(h._id)))});else if(h[m]!==void 0){const g=h[m];d.data[m][g]||(d.data[m][g]=[]),d.data[m][g].push(parseInt(h._id))}}}),h)),d.data=M(d.data,function(h,m){return d.bits_data[m]||(d.bits_data[m]=Object.create(null),d.bits_data_temp[m]=Object.create(null)),M(h,function(g,y){const p=Qo(g);return d.bits_data[m][y]=new q(p),p})}),d}(e,Ee(t.aggregations)),this._items_map=Object.create(null),this._ids=[];let r=1;var o,s;s=i=>{this._ids.push(r),this._items_map[r]=i,i._id=r,++r},(T(o=e)?pe:An)(o,ce(s)),this.ids_map=Object.create(null),e&&e.forEach(i=>{const c=t.custom_id_field||"id";i[c]&&i._id&&(this.ids_map[i[c]]=i._id)}),this._bits_ids=new q(this._ids)}items(){return this._items}bits_ids(e){return e?new q(e):this._bits_ids}internal_ids_from_ids_map(e){return e.map(t=>this.ids_map[t])}index(){return this.facets}get_item(e){return this._items_map[e]}search(e,t){const r=this.config;t=t||Object.create(null);const o=Je(this.facets);let s;o.not_ids=nn(o.bits_data,e.not_filters);const i=function(c,d){const u=[];return M(c.filters,function(h,m){if(h&&h.length)if(d[m].conjunction!==!1)M(h,function(g){u.push([m,g])});else{const g=[];M(h,function(y){g.push([m,y])}),u.push(g)}}),M(c.not_filters,function(h,m){h&&h.length&&M(h,function(g){u.push([m,"-",g])})}),u}(e,r);return s=function(c,d){const u=Je(c);let h;d=d||[],M(u.bits_data,function(g,y){M(u.bits_data[y],function(p,v){u.bits_data_temp[y][v]=u.bits_data[y][v]})}),u.is_temp_copied=!0;const m=function(g,y){const p=Object.create(null);return M(y,function(v){if(Array.isArray(v[0])){let C=new q([]);M(v,function(k){const F=k[0];C=C.new_union(g.bits_data[F][k[1]]||new q([])),p[F]=C})}}),p}(c,d);return M(d,function(g){if(!Array.isArray(g[0])){const y=g[0],p=g[1];h=h&&u.bits_data_temp[y][p]?u.bits_data_temp[y][p].new_intersection(h):h&&!u.bits_data_temp[y][p]?new q([]):u.bits_data_temp[y][p]}}),h&&M(u.bits_data_temp,function(g,y){M(u.bits_data_temp[y],function(p,v){u.bits_data_temp[y][v]=u.bits_data_temp[y][v].new_intersection(h)})}),M(d,function(g){if(g.length===3&&g[1]==="-"){const y=u.bits_data_temp[g[0]][g[2]].clone();M(u.bits_data_temp,function(p,v){M(u.bits_data_temp[v],function(C,k){u.bits_data_temp[v][k]=u.bits_data_temp[v][k].new_difference(y)})})}}),M(u.bits_data_temp,function(g,y){M(u.bits_data_temp[y],function(p,v){M(m,function(C,k){k!==y&&(u.bits_data_temp[y][v]=u.bits_data_temp[y][v].new_intersection(C))})})}),u}(this.facets,i),e.filters_query&&(s=function(c,d){const u=Je(c);u.is_temp_copied||M(u.bits_data,function(m,g){M(u.bits_data[g],function(y,p){u.bits_data_temp[g][p]=u.bits_data[g][p]})});let h=null;return M(d,function(m){let g=null;M(m,function(y){const p=y[0],v=y[1];if(!u.bits_data_temp[p])throw new Error("Panic. The key does not exist in facets lists.");g=g&&u.bits_data_temp[p][v]?u.bits_data_temp[p][v].new_intersection(g):g&&!u.bits_data_temp[p][v]?new q([]):u.bits_data_temp[p][v]}),h=(h||new q([])).new_union(g||new q([]))}),h!==null&&M(u.bits_data_temp,function(m,g){M(u.bits_data_temp[g],function(y,p){u.bits_data_temp[g][p]=u.bits_data_temp[g][p].new_intersection(h)})}),u}(s,Xo(e.filters_query).map(c=>Array.isArray(c)?c.map(d=>Array.isArray(d)?d.map(u=>u):d.split(":")):c.split(":")))),o.bits_data_temp=s.bits_data_temp,M(o.bits_data_temp,function(c,d){M(o.bits_data_temp[d],function(u,h){t.query_ids&&(o.bits_data_temp[d][h]=t.query_ids.new_intersection(o.bits_data_temp[d][h])),t.test&&(o.data[d][h]=o.bits_data_temp[d][h].array())})}),o.ids=e.filters_query?function(c){let d=new q([]);return M(c,function(u,h){M(c[h],function(m,g){d=d.new_union(c[h][g])})}),d}(o.bits_data_temp):nn(o.bits_data_temp,e.filters),o}}function es(n,e){let t;(e=e||Object.create(null)).native_search_enabled!==!1&&(t=new on(n,e));let r=new sn(n,e);return{search:function(o){return(o=o||Object.create(null)).aggregations=function(s,i){return M(tn(s),(c,d)=>{c.field||(c.field=d);let u=[];i.filters&&i.filters[d]&&(u=i.filters[d]),c.filters=u;let h=[];return i.not_filters&&i.not_filters[d]&&(h=i.not_filters[d]),i.exclude_filters&&i.exclude_filters[d]&&(h=i.exclude_filters[d]),c.not_filters=h,c})}(e.aggregations,o),rn(0,o,e,t,r)},similar:function(o,s){return function(i,c,d){const u=d.per_page||10,h=d.minimum||0,m=d.page||1;let g;for(let v=0;v<i.length;++v)if(i[v].id==c){g=i[v];break}if(!d.field)throw new Error("Please define field in options");const y=d.field;let p=[];for(let v=0;v<i.length;++v)if(i[v].id!==c){const C=Do(g[y],i[v][y]);C.length>=h&&(p.push(i[v]),p[p.length-1].intersection_length=C.length)}return p=mt(p,["intersection_length"],["desc"]),{pagination:{per_page:u,page:m,total:p.length},data:{items:p.slice((m-1)*u,m*u)}}}(n,o,s)},aggregation:function(o){return function(s,i,c,d,u){const h=i.per_page||10,m=i.page||1;if(i.name&&(!c.aggregations||!c.aggregations[i.name]))throw new Error('Please define aggregation "'.concat(i.name,'" in config'));const g=tn(i);if(g.page=1,g.per_page=0,!i.name)throw new Error("field name is required");c.aggregations[i.name].size=1e4;const y=rn(0,g,c,d,u).data.aggregations[i.name].buckets;return{pagination:{per_page:h,page:m,total:y.length},data:{buckets:y.slice((m-1)*h,m*h)}}}(0,o,e,t,r)},reindex:function(o){t=new on(n=o,e),r=new sn(n,e)}}}class ts{constructor(){this.elements={},this.activeFiltersCount=0,this.resultsCount=0,this.isInitialized=!1,this.currentFilters={},this.currentQuery="",this.config=null,this.init()}init(){this.elements={filtersPanel:document.getElementById("filters-panel"),resultsPanel:document.getElementById("results-panel"),toggleFilters:document.getElementById("toggle-filters"),toggleResults:document.getElementById("toggle-results"),activeFiltersBadge:document.getElementById("active-filters-badge"),activeFiltersCount:document.getElementById("active-filters-count"),resultsCounter:document.getElementById("results-counter"),resultsCount:document.getElementById("results-count"),clearAllBtn:document.getElementById("clear-all-btn"),mapCenterBtn:document.getElementById("map-center-btn"),toggleLegendBtn:document.getElementById("toggle-legend-btn"),mapLegend:document.getElementById("map-legend"),closeLegendBtn:document.getElementById("close-legend-btn")},this.bindEventHandlers(),this.initializePanelStates(),this.setupResponsiveBehavior(),this.isInitialized=!0}setConfig(e){this.config=e}updateFromSearchState(e,t=0){if(!e)return;this.currentFilters={...e.filters},this.currentQuery=e.query||"";const r=this.calculateActiveFiltersCount(e.filters);this.updateActiveFiltersCount(r),this.updateResultsCount(t)}calculateActiveFiltersCount(e){if(!e||typeof e!="object")return 0;let t=0;return Object.values(e).forEach(r=>{Array.isArray(r)?t+=r.length:r&&typeof r=="object"&&(r.min!==void 0||r.max!==void 0)&&(t+=1)}),t}showActiveFiltersPopup(){this.hideActiveFiltersPopup();const e=document.createElement("div");e.id="active-filters-popup",e.className="fixed bottom-20 right-4 z-15 p-4 w-80 bg-white rounded-lg shadow-xl border border-gray-200 transform transition-all duration-300 translate-y-4 opacity-0";const t=document.createElement("div");t.className="flex items-center justify-between mb-3",t.innerHTML=`
            <h3 class="font-semibold text-gray-800">Filtri Attivi</h3>
            <button id="close-filters-popup" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        `;const r=document.createElement("div");r.className="space-y-2 max-h-80 overflow-y-auto";const o=this.buildFiltersContent();r.innerHTML=o;const s=document.createElement("div");s.className="flex items-center justify-between pt-3 mt-3 border-t border-gray-200",s.innerHTML=`
            <span class="text-sm text-gray-600">${this.activeFiltersCount} filtri attivi</span>
            <button id="clear-all-filters-popup" class="text-red-500 hover:text-red-700 text-sm font-medium">
                <i class="fas fa-trash-alt mr-1"></i>
                Cancella Tutti
            </button>
        `,e.appendChild(t),e.appendChild(r),e.appendChild(s),document.body.appendChild(e),requestAnimationFrame(()=>{e.classList.remove("translate-y-4","opacity-0"),e.classList.add("translate-y-0","opacity-100")}),this.bindPopupEvents(e)}buildFiltersContent(){if(!this.currentFilters||Object.keys(this.currentFilters).length===0)return`
                <div class="legend-item flex items-center p-2 rounded-lg">
                    <span class="text-sm text-gray-700">Nessun filtro attivo</span>
                </div>
            `;let e="";return this.currentQuery&&this.currentQuery.trim()&&(e+=`
                <div class="legend-item flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                    <div class="flex-1 min-w-0">
                        <span class="text-sm text-gray-700 font-medium">Ricerca:</span>
                        <span class="text-sm text-gray-600 ml-1">"${this.escapeHtml(this.currentQuery)}"</span>
                    </div>
                    <button class="text-gray-400 hover:text-red-500 ml-2 flex-shrink-0" onclick="navBarRenderer.clearSearchQuery()" title="Rimuovi ricerca">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            `),Object.entries(this.currentFilters).forEach(([t,r])=>{if(!r||Array.isArray(r)&&r.length===0)return;const o=this.getFacetLabel(t);if(Array.isArray(r))r.forEach(s=>{e+=`
                        <div class="legend-item flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                            <div class="flex-1 min-w-0">
                                <span class="text-sm text-gray-700 font-medium">${o}:</span>
                                <span class="text-sm text-gray-600 ml-1">${this.escapeHtml(s)}</span>
                            </div>
                            <button class="text-gray-400 hover:text-red-500 ml-2 flex-shrink-0" onclick="navBarRenderer.removeFilter('${t}', '${this.escapeHtml(s)}')" title="Rimuovi filtro">
                                <i class="fas fa-times text-xs"></i>
                            </button>
                        </div>
                    `});else if(typeof r=="object"){const s=this.formatRangeFilter(r);e+=`
                    <div class="legend-item flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex-1 min-w-0">
                            <span class="text-sm text-gray-700 font-medium">${o}:</span>
                            <span class="text-sm text-gray-600 ml-1">${s}</span>
                        </div>
                        <button class="text-gray-400 hover:text-red-500 ml-2 flex-shrink-0" onclick="navBarRenderer.removeFilter('${t}')" title="Rimuovi filtro">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                `}}),e||`
            <div class="legend-item flex items-center p-2 rounded-lg">
                <span class="text-sm text-gray-700">Nessun filtro attivo</span>
            </div>
        `}getFacetLabel(e){return this.config&&this.config.aggregations&&this.config.aggregations[e]?this.config.aggregations[e].title||e:e.replace(/[_-]/g," ").replace(/\b\w/g,t=>t.toUpperCase())}formatRangeFilter(e){return e.min!==void 0&&e.max!==void 0?`${e.min} - ${e.max}`:e.min!==void 0?`≥ ${e.min}`:e.max!==void 0?`≤ ${e.max}`:"Range filter"}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}hideActiveFiltersPopup(){const e=document.getElementById("active-filters-popup");e&&(e.classList.add("translate-y-4","opacity-0"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300))}bindPopupEvents(e){const t=e.querySelector("#close-filters-popup");t&&t.addEventListener("click",()=>this.hideActiveFiltersPopup());const r=e.querySelector("#clear-all-filters-popup");r&&r.addEventListener("click",()=>{this.handleClearAllFilters(),this.hideActiveFiltersPopup()});const o=i=>{i.key==="Escape"&&(this.hideActiveFiltersPopup(),document.removeEventListener("keydown",o))};document.addEventListener("keydown",o);const s=i=>{!e.contains(i.target)&&!this.elements.activeFiltersBadge.contains(i.target)&&(this.hideActiveFiltersPopup(),document.removeEventListener("click",s))};setTimeout(()=>{document.addEventListener("click",s)},100)}removeFilter(e,t=null){this.emitEvent("removeFilter",{facetKey:e,value:t}),this.hideActiveFiltersPopup()}clearSearchQuery(){this.emitEvent("clearSearchQuery"),this.hideActiveFiltersPopup()}bindEventHandlers(){this.elements.toggleFilters.addEventListener("click",()=>{this.togglePanel("filters")}),this.elements.toggleResults.addEventListener("click",()=>{this.togglePanel("results")}),this.elements.clearAllBtn.addEventListener("click",()=>{this.handleClearAllFilters()}),this.elements.mapCenterBtn.addEventListener("click",()=>{this.handleMapCenter()}),this.elements.toggleLegendBtn.addEventListener("click",()=>{this.toggleLegend()}),this.elements.closeLegendBtn.addEventListener("click",()=>{this.closeLegend()}),this.elements.activeFiltersBadge&&(this.elements.activeFiltersBadge.addEventListener("click",()=>{this.showActiveFiltersPopup()}),this.elements.activeFiltersBadge.style.cursor="pointer",this.elements.activeFiltersBadge.title="Clicca per vedere i filtri attivi")}initializePanelStates(){this.elements.filtersPanel.classList.add("panel-closed"),this.elements.resultsPanel.classList.add("panel-closed-right"),this.elements.toggleFilters.classList.remove("active"),this.elements.toggleResults.classList.remove("active")}togglePanel(e){if(e==="filters"){const t=!this.elements.filtersPanel.classList.contains("panel-closed");this.elements.filtersPanel.classList.toggle("panel-closed"),this.elements.toggleFilters.classList.toggle("active",!t),this.emitEvent("panelToggled",{type:"filters",isOpen:!t})}else if(e==="results"){const t=!this.elements.resultsPanel.classList.contains("panel-closed-right");this.elements.resultsPanel.classList.toggle("panel-closed-right"),this.elements.toggleResults.classList.toggle("active",!t),this.emitEvent("panelToggled",{type:"results",isOpen:!t})}}closeAllPanels(){this.elements.filtersPanel.classList.add("panel-closed"),this.elements.resultsPanel.classList.add("panel-closed-right"),this.elements.toggleFilters.classList.remove("active"),this.elements.toggleResults.classList.remove("active")}updateActiveFiltersCount(e){this.activeFiltersCount=e,this.elements.activeFiltersCount.textContent=e,e>0?(this.elements.activeFiltersBadge.classList.remove("hidden"),this.elements.clearAllBtn.classList.remove("hidden")):(this.elements.activeFiltersBadge.classList.add("hidden"),this.elements.clearAllBtn.classList.add("hidden")),this.emitEvent("activeFiltersChanged",{count:e})}updateResultsCount(e){this.resultsCount=e,this.elements.resultsCount.textContent=e,e>0?this.elements.resultsCounter.classList.remove("hidden"):this.elements.resultsCounter.classList.add("hidden"),this.emitEvent("resultsCountChanged",{count:e})}handleClearAllFilters(){this.emitEvent("clearAllFilters"),this.updateActiveFiltersCount(0),this.currentFilters={},this.currentQuery=""}handleMapCenter(){this.emitEvent("centerMap")}toggleLegend(){const e=this.elements.mapLegend.classList.contains("legend-hidden");this.elements.mapLegend.classList.toggle("legend-hidden"),this.elements.toggleLegendBtn.classList.toggle("active",e),this.emitEvent("legendToggled",{isVisible:e})}closeLegend(){this.elements.mapLegend.classList.add("legend-hidden"),this.elements.toggleLegendBtn.classList.remove("active"),this.emitEvent("legendClosed")}updateMapLegend(e){const t=document.querySelector(".map-legend-content");t&&(t.innerHTML="",e.forEach((r,o)=>{const s=document.createElement("div");s.className="legend-item flex items-center p-2 rounded-lg cursor-pointer",s.dataset.legendIndex=o,s.innerHTML=`
                <div class="w-4 h-4 rounded-full mr-3 flex-shrink-0" style="background-color: ${r.color}"></div>
                <span class="text-sm text-gray-700 flex-1">${r.label}</span>
                ${r.count!==void 0?`<span class="text-xs text-gray-500 ml-2">${r.count}</span>`:""}
            `,r.onClick&&typeof r.onClick=="function"&&s.addEventListener("click",i=>{r.onClick(r,o,i)}),t.appendChild(s)}),this.emitEvent("legendUpdated",{items:e}))}setupResponsiveBehavior(){window.addEventListener("resize",()=>{window.innerWidth<768&&this.closeAllPanels()}),window.innerWidth<768&&this.closeAllPanels()}getState(){return{activeFiltersCount:this.activeFiltersCount,resultsCount:this.resultsCount,isFiltersOpen:!this.elements.filtersPanel.classList.contains("panel-closed"),isResultsOpen:!this.elements.resultsPanel.classList.contains("panel-closed-right"),isLegendVisible:!this.elements.mapLegend.classList.contains("legend-hidden"),currentFilters:{...this.currentFilters},currentQuery:this.currentQuery}}setState(e){if(e.activeFiltersCount!==void 0&&this.updateActiveFiltersCount(e.activeFiltersCount),e.resultsCount!==void 0&&this.updateResultsCount(e.resultsCount),e.isFiltersOpen!==void 0){const t=!this.elements.filtersPanel.classList.contains("panel-closed");e.isFiltersOpen!==t&&this.togglePanel("filters")}if(e.isResultsOpen!==void 0){const t=!this.elements.resultsPanel.classList.contains("panel-closed-right");e.isResultsOpen!==t&&this.togglePanel("results")}if(e.isLegendVisible!==void 0){const t=!this.elements.mapLegend.classList.contains("legend-hidden");e.isLegendVisible!==t&&this.toggleLegend()}e.currentFilters!==void 0&&(this.currentFilters={...e.currentFilters}),e.currentQuery!==void 0&&(this.currentQuery=e.currentQuery)}emitEvent(e,t={}){const r=new CustomEvent(`navbar:${e}`,{detail:t,bubbles:!0,cancelable:!0});document.dispatchEvent(r)}addEventListener(e,t){document.addEventListener(`navbar:${e}`,t)}removeEventListener(e,t){document.removeEventListener(`navbar:${e}`,t)}showNotification(e,t="info",r=3e3){const o=document.createElement("div");o.className=`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg transition-all duration-300 ${this.getNotificationClasses(t)}`,o.textContent=e,document.body.appendChild(o),setTimeout(()=>{o.style.opacity="1",o.style.transform="translateX(-50%) translateY(0)"},10),setTimeout(()=>{o.style.opacity="0",o.style.transform="translateX(-50%) translateY(-20px)",setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},300)},r)}getNotificationClasses(e){const t={success:"bg-green-500 text-white",error:"bg-red-500 text-white",warning:"bg-yellow-500 text-white",info:"bg-blue-500 text-white"};return t[e]||t.info}destroy(){window.removeEventListener("resize",this.setupResponsiveBehavior),this.hideActiveFiltersPopup(),this.elements={},this.currentFilters={},this.currentQuery="",this.config=null,this.isInitialized=!1}}const ns=new ts,an="/leda/";class rs{constructor(e,t={}){this.map=e,this.config={polygonStyle:{color:"#3388ff",weight:2,opacity:.8,fillColor:"#3388ff",fillOpacity:.1,...t.polygonStyle},highlightStyle:{color:"#ff6b35",weight:3,opacity:1,fillColor:"#ff6b35",fillOpacity:.2,...t.highlightStyle},polygonRepositoryUrl:"/data/polygons.json",enableCache:!0,cacheExpiry:36e5,...t},this.polygonLayers=new Map,this.polygonCache=new Map,this.polygonRepository=null,this.currentHighlighted=null,this.polygonLayerGroup=L.layerGroup().addTo(this.map),this.loadPolygonRepository()}async loadPolygonRepository(){try{if(this.polygonRepository)return console.log("Polygon repository already loaded"),this.polygonRepository;console.log("Loading polygon repository from:",`${an}/data/polygons.json`);const e=await fetch(`${an}/data/polygons.json`);if(!e.ok)throw new Error(`Failed to load polygon repository: ${e.status}`);const t=await e.json();this.polygonRepository={};let r=0,o=0;for(const[s,i]of Object.entries(t))i&&typeof i=="object"&&i.osm_id?(this.polygonRepository[s]=i,r++):(console.warn(`Skipping invalid polygon entry: ${s}`,i),o++);return console.log(`Polygon repository loaded successfully. Valid polygons: ${r}, Invalid/skipped: ${o}`),console.log("Available polygon keys:",Object.keys(this.polygonRepository)),this.polygonRepository}catch(e){return console.error("Error loading polygon repository:",e),this.polygonRepository={},this.polygonRepository}}async loadPolygon(e,t=!1,r=!1){try{const o=this.getLocationId(e);this.removePolygon(o);let s=null;if(e.geojson?s=e.geojson:s=await this.fetchPolygonDataByOsmId(e),!s)return console.warn("No polygon data available for location:",e),null;const i=this.createPolygonLayer(s,e);return this.polygonLayers.set(o,{layer:i,data:e,geojson:s,isHighlighted:t}),this.polygonLayerGroup.addLayer(i),t&&this.highlightPolygon(o),r&&this.fitBoundsToPolygon(i),i}catch(o){return console.error("Error loading polygon:",o),null}}async fetchPolygonDataByOsmId(e){try{if(await this.loadPolygonRepository(),!e||!e.osm_id)return console.log("No OSM ID provided for location - skipping polygon load"),null;const t=e.osm_id.toString(),r=this.getLocationId(e);if(this.config.enableCache&&this.polygonCache.has(r)){const s=this.polygonCache.get(r);if(Date.now()-s.timestamp<this.config.cacheExpiry)return console.log("Using cached polygon data for OSM ID:",t),s.data;this.polygonCache.delete(r)}let o=null;return o=this.findPolygonByOsmId(t,e.osm_type),this.config.enableCache&&o&&this.polygonCache.set(r,{data:o,timestamp:Date.now()}),console.log(o?"Found polygon for OSM ID:":"No polygon found for OSM ID:",t),o}catch(t){return console.error("Error fetching polygon data by OSM ID:",t),null}}findPolygonByOsmId(e,t=null){if(!this.polygonRepository)return console.warn("Polygon repository not loaded"),null;const r=e.toString();console.log(`Searching for OSM ID: ${r} (type: ${t||"any"})`);for(const[o,s]of Object.entries(this.polygonRepository))if(console.log(`Checking polygon ${o}: OSM ID = ${s.osm_id}, Type = ${s.osm_type}`),s.osm_id&&s.osm_id.toString()===r){if(t&&s.osm_type&&s.osm_type!==t){console.log(`OSM ID matches but type doesn't: expected ${t}, got ${s.osm_type}`);continue}return console.log(`Found polygon by OSM ID match: ${r} (${o})`),s.geojson}return console.log(`No polygon found for OSM ID: ${r}`),null}async loadPolygonByOsmId(e,t=null,r=!1,o=!1){if(await this.loadPolygonRepository(),!this.findPolygonByOsmId(e,t))return console.warn("Polygon not found for OSM ID:",e),null;let i=null;for(const[d,u]of Object.entries(this.polygonRepository))if(u.osm_id&&u.osm_id.toString()===e.toString()&&(!t||!u.osm_type||u.osm_type===t)){i=u;break}if(!i)return console.warn("Polygon info not found for OSM ID:",e),null;const c={display_name:i.display_name||`OSM ${t||"object"} ${e}`,lat:i.lat,lon:i.lon,osm_type:i.osm_type||t,osm_id:i.osm_id,place_rank:i.place_rank,importance:i.importance,type:i.type,class:i.class,geojson:i.geojson};return this.loadPolygon(c,r,o)}findPolygonInRepository(e){if(!this.polygonRepository)return console.warn("Polygon repository not loaded"),null;if(e.osm_id){const r=this.findPolygonByOsmId(e.osm_id,e.osm_type);if(r)return r}const t=e.display_name||e.name;if(t){for(const[o,s]of Object.entries(this.polygonRepository))if(o.toLowerCase()===t.toLowerCase())return console.log("Found polygon by exact name match:",o),s.geojson;for(const[o,s]of Object.entries(this.polygonRepository))if(t.toLowerCase().includes(o.toLowerCase())||o.toLowerCase().includes(t.toLowerCase()))return console.log("Found polygon by partial name match:",o),s.geojson;const r=t.split(",").map(o=>o.trim());for(const o of r)for(const[s,i]of Object.entries(this.polygonRepository))if(s.toLowerCase()===o.toLowerCase())return console.log("Found polygon by name part match:",s),i.geojson}if(e.lat&&e.lon){const r=parseFloat(e.lat),o=parseFloat(e.lon);for(const[s,i]of Object.entries(this.polygonRepository))if(i.lat&&i.lon){const c=parseFloat(i.lat),d=parseFloat(i.lon),u=this.calculateDistance(r,o,c,d);if(u<50)return console.log("Found polygon by proximity match:",s,"Distance:",u.toFixed(2),"km"),i.geojson}}return console.log("No polygon found in repository for:",t||e),null}calculateDistance(e,t,r,o){const i=this.toRadians(r-e),c=this.toRadians(o-t),d=Math.sin(i/2)*Math.sin(i/2)+Math.cos(this.toRadians(e))*Math.cos(this.toRadians(r))*Math.sin(c/2)*Math.sin(c/2);return 6371*(2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)))}toRadians(e){return e*(Math.PI/180)}addPolygonToRepository(e,t){this.polygonRepository||(this.polygonRepository={}),this.polygonRepository[e]=t,console.log("Added polygon to repository:",e)}getAvailablePolygons(){return this.polygonRepository?Object.keys(this.polygonRepository):[]}async loadPolygonByName(e,t=!1,r=!1){if(await this.loadPolygonRepository(),!this.polygonRepository||!this.polygonRepository[e])return console.warn("Polygon not found in repository:",e),null;const o=this.polygonRepository[e],s={display_name:o.display_name||e,lat:o.lat,lon:o.lon,osm_type:o.osm_type,osm_id:o.osm_id,place_rank:o.place_rank,importance:o.importance,type:o.type,class:o.class,geojson:o.geojson};return this.loadPolygon(s,t,r)}createPolygonLayer(e,t){return L.geoJSON(e,{style:this.config.polygonStyle,onEachFeature:(o,s)=>{t.display_name&&s.bindPopup(`
            <div class="polygon-popup">
              <h4>${t.display_name}</h4>
              ${t.type?`<p><strong>Type:</strong> ${t.type}</p>`:""}
              ${t.class?`<p><strong>Class:</strong> ${t.class}</p>`:""}
              ${t.importance?`<p><strong>Importance:</strong> ${t.importance.toFixed(3)}</p>`:""}
              ${t.osm_id?`<p><strong>OSM ID:</strong> ${t.osm_type}/${t.osm_id}</p>`:""}
            </div>
          `),s.on({mouseover:i=>this.onPolygonHover(i,t),mouseout:i=>this.onPolygonMouseOut(i,t),click:i=>this.onPolygonClick(i,t)})}})}async loadSearchResultPolygons(e,t=null){this.clearAllPolygons();const r=e.filter(s=>s&&s.osm_id&&(typeof s.osm_id=="string"||typeof s.osm_id=="number"));if(r.length===0){console.log("No search results with valid OSM IDs found");return}console.log(`Loading polygons for ${r.length} results with OSM IDs`);const o=s=>new Promise(i=>setTimeout(i,s));for(let s=0;s<r.length;s++){const i=r[s],c=t&&this.getLocationId(i)===t;try{await this.loadPolygon(i,c,!1),s<r.length-1&&await o(50)}catch(d){console.error("Error loading polygon for result:",i,d)}}this.polygonLayers.size>0&&setTimeout(()=>{this.fitBoundsToAllPolygons()},100)}async onMarkerClick(e){if(!e||!e.osm_id){console.log("Marker data has no OSM ID - skipping polygon load:",e);return}const t=this.getLocationId(e);this.polygonLayers.has(t)?(this.highlightPolygon(t),this.fitBoundsToPolygon(this.polygonLayers.get(t).layer)):await this.loadPolygon(e,!0,!0)}highlightPolygon(e){this.clearHighlight();const t=this.polygonLayers.get(e);t&&(t.layer.setStyle(this.config.highlightStyle),t.isHighlighted=!0,this.currentHighlighted=e,t.layer.bringToFront())}clearHighlight(){if(this.currentHighlighted){const e=this.polygonLayers.get(this.currentHighlighted);e&&(e.layer.setStyle(this.config.polygonStyle),e.isHighlighted=!1),this.currentHighlighted=null}}removePolygon(e){const t=this.polygonLayers.get(e);t&&(this.polygonLayerGroup.removeLayer(t.layer),this.polygonLayers.delete(e),this.currentHighlighted===e&&(this.currentHighlighted=null))}clearAllPolygons(){this.polygonLayerGroup.clearLayers(),this.polygonLayers.clear(),this.currentHighlighted=null}fitBoundsToPolygon(e){try{const t=e.getBounds();t.isValid()&&this.map.fitBounds(t,{padding:[20,20],maxZoom:15})}catch(t){console.warn("Could not fit bounds to polygon:",t)}}fitBoundsToAllPolygons(){try{const t=new L.featureGroup(Array.from(this.polygonLayers.values()).map(r=>r.layer)).getBounds();t.isValid()&&this.map.fitBounds(t,{padding:[20,20],maxZoom:12})}catch(e){console.warn("Could not fit bounds to all polygons:",e)}}onPolygonHover(e,t){const r=e.target,o=this.getLocationId(t),s=this.polygonLayers.get(o);s&&!s.isHighlighted&&r.setStyle({weight:3,opacity:1,fillOpacity:.15}),this.map.fire("polygon:hover",{locationData:t,layer:r})}onPolygonMouseOut(e,t){const r=e.target,o=this.getLocationId(t),s=this.polygonLayers.get(o);s&&!s.isHighlighted&&r.setStyle(this.config.polygonStyle),this.map.fire("polygon:mouseout",{locationData:t,layer:r})}onPolygonClick(e,t){const r=this.getLocationId(t);this.highlightPolygon(r),this.map.fire("polygon:click",{locationData:t,layer:e.target,locationId:r}),L.DomEvent.stopPropagation(e)}getLocationId(e){return e.osm_id?`${e.osm_type||"unknown"}_${e.osm_id}`:e.lat&&e.lon?`coord_${e.lat}_${e.lon}`:`name_${this.simpleHash(e.display_name||"unknown")}`}simpleHash(e){let t=0;for(let r=0;r<e.length;r++){const o=e.charCodeAt(r);t=(t<<5)-t+o,t=t&t}return Math.abs(t).toString(36)}setPolygonVisibility(e){e?this.map.hasLayer(this.polygonLayerGroup)||this.polygonLayerGroup.addTo(this.map):this.map.hasLayer(this.polygonLayerGroup)&&this.map.removeLayer(this.polygonLayerGroup)}getAllPolygons(){return Array.from(this.polygonLayers.values())}hasPolygon(e){return this.polygonLayers.has(e)}updateStyles(e){this.config={...this.config,...e},this.polygonLayers.forEach((t,r)=>{const o=t.isHighlighted?this.config.highlightStyle:this.config.polygonStyle;t.layer.setStyle(o)})}clearCache(){this.polygonCache.clear()}destroy(){this.clearAllPolygons(),this.clearCache(),this.map.hasLayer(this.polygonLayerGroup)&&this.map.removeLayer(this.polygonLayerGroup),this.polygonLayers.clear(),this.polygonLayerGroup=null,this.polygonRepository=null,this.map=null}}class os{constructor(e){this.config=e}renderFacets(e,t,r){if(!e||!this.config.aggregations){console.error("No aggregations data or configuration available.");return}const o=document.getElementById("facets-container"),s=this._getCheckedState();o.innerHTML="";const i={};Object.entries(this.config.aggregations).forEach(([c,d])=>{const u=d.category||"Other";i[u]||(i[u]=[]),i[u].push({facetKey:c,facetConfig:d})}),Object.entries(i).forEach(([c,d])=>{const u=document.createElement("div");u.className="facet-category",u.setAttribute("data-category",c);const h=document.createElement("h3");h.className="facet-category-title",h.textContent=c,u.appendChild(h);const m=document.createElement("div");m.className="facet-category-content",d.forEach(({facetKey:g,facetConfig:y})=>{const p=this._createFacetGroup(g,y);y.type==="range"?this._renderRangeFacet(p,g,y,e,s,t,r):y.type==="taxonomy"?this._renderTaxonomyFacet(p,g,y,e,s):this._renderStandardFacet(p,g,y,e,s),m.appendChild(p)}),u.appendChild(m),o.appendChild(u)}),this._addFacetEventListeners(r)}_getCheckedState(){const e={};return Object.keys(this.config.aggregations).forEach(t=>{const r=document.getElementById(`${t}-facet`);r&&(e[t]=Array.from(r.querySelectorAll("input:checked")).map(o=>o.value))}),e}_createFacetGroup(e,t){const r=document.createElement("div");r.className="facet-group mb-4 p-4 bg-white rounded-lg shadow",r.id=`${e}-facet`;const o=document.createElement("h3");return o.className="text-lg font-semibold mb-2",o.textContent=t.title||e,r.appendChild(o),r}_renderRangeFacet(e,t,r,o,s,i,c){const d=document.createElement("div");d.className="facet-slider my-4";const h=(o[t]||[]).map(x=>{const E=parseInt(x.key,10);return isNaN(E)?null:{value:E,count:x.doc_count||0}}).filter(x=>x!==null),m=h.map(x=>x.value),g=Math.min(...m),y=Math.max(...m);d.innerHTML=`
      <label class="sr-only">Value range</label>
      <div class="relative">
        <div id="${t}-chart" class="w-full h-24 mb-2"></div>
      </div>
      <div id="${t}-slider" class="mt-2"></div>
      <div class="mt-5">
        <div class="text-sm font-medium mb-2">Custom range:</div>
        <div class="flex space-x-4">
          <div class="flex-1">
            <input id="${t}-min-input" type="number"
                   class="py-2 px-3 block w-full border rounded-md text-sm focus:ring focus:ring-blue-500 focus:outline-none dark:bg-gray-800 dark:text-gray-300"
                   value="${g}">
          </div>
          <div class="flex-1">
            <input id="${t}-max-input" type="number"
                   class="py-2 px-3 block w-full border rounded-md text-sm focus:ring focus:ring-blue-500 focus:outline-none dark:bg-gray-800 dark:text-gray-300"
                   value="${y}">
          </div>
        </div>
      </div>
    `,e.appendChild(d);const p=d.querySelector(`#${t}-chart`),v=d.querySelector(`#${t}-slider`),C=d.querySelector(`#${t}-min-input`),k=d.querySelector(`#${t}-max-input`);this._renderBarChart(p,h,g,y);const F=i.filters[t];let P,j;!F||F.length===0?(P=g,j=y):(P=F[0],j=F[1]),noUiSlider.create(v,{start:[P,j],connect:!0,step:1,range:{min:g,max:y},format:{to:x=>Math.round(x),from:x=>parseInt(x,10)}}),v.noUiSlider.on("update",x=>{C.value=Math.round(Number(x[0])),k.value=Math.round(Number(x[1]))}),v.noUiSlider.on("change",x=>{const[E,B]=x.map(H=>Math.round(Number(H)));!isNaN(E)&&!isNaN(B)&&(c({type:"RANGE_CHANGE",facetKey:t,value:[E,B]}),this._updateChartHighlight(p,h,E,B))});const R=this._debounce(x=>{const E=x.target===C,B=parseInt(x.target.value,10),[H,ne]=v.noUiSlider.get().map(Number);isNaN(B)||v.noUiSlider.set([E?B:H,E?ne:B])},200);C.addEventListener("input",R),k.addEventListener("input",R),this._updateChartHighlight(p,h,P,j)}_renderTaxonomyFacet(e,t,r,o,s){const i=document.createElement("div");i.className="taxonomy-container";const c={};(o[t]||[]).forEach(g=>{const y=g.key.split(" > ");let p=c;y.forEach((v,C)=>{p[v]||(p[v]={children:{},docCount:0,selfCount:0}),C===y.length-1&&(p[v].selfCount=g.doc_count),p=p[v].children})});function u(g){let y=g.selfCount||0;return Object.values(g.children).forEach(p=>{y+=u(p)}),g.docCount=y,y}Object.values(c).forEach(g=>{u(g)});function h(g,y=[],p=0){let v='<ul class="taxonomy-list" style="margin-left: '+p*20+'px;">';return Object.entries(g).forEach(([C,k])=>{var R;if(C==="children"||C==="docCount"||C==="selfCount")return;const F=[...y,C],P=F.join(" > "),j=Object.keys(k.children).length>0;v+=`
          <li class="taxonomy-item">
            <div class="taxonomy-row">
              ${j?`<span class="toggle-btn" data-path="${P}">▶</span>`:'<span class="toggle-placeholder"></span>'}
              <label>
                <input type="checkbox" 
                       value="${P}" 
                       data-facet-type="${t}"
                       ${(R=s[t])!=null&&R.includes(P)?"checked":""}>
                <span>${C} (${k.docCount})</span>
              </label>
            </div>
            ${j?`<div class="children" data-parent="${P}" style="display: none;">
                ${h(k.children,F,p+1)}
              </div>`:""}
          </li>
        `}),v+"</ul>"}const m=document.createElement("style");m.textContent=`
      .taxonomy-list {
        list-style: none;
        padding: 0;
      }
      .taxonomy-item {
        margin: 5px 0;
      }
      .taxonomy-row {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .toggle-btn {
        cursor: pointer;
        width: 20px;
        user-select: none;
      }
      .toggle-placeholder {
        width: 20px;
      }
      .children {
        margin-left: 20px;
      }
    `,document.head.appendChild(m),i.innerHTML=h(c),i.addEventListener("click",g=>{if(g.target.classList.contains("toggle-btn")){const y=g.target.dataset.path,p=i.querySelector(`[data-parent="${y}"]`);if(p){const v=p.style.display==="none";p.style.display=v?"block":"none",g.target.textContent=v?"▼":"▶"}}}),e.appendChild(i)}_renderStandardFacet(e,t,r,o,s){const i=document.createElement("div");i.className="facet-options space-y-2",(o[t]||[]).forEach(d=>{var g;const u=document.createElement("label");u.className="cursor-pointer block",u.style.display="block";const h=document.createElement("input");h.type="checkbox",h.value=d.key,h.className="form-checkbox mr-2",h.dataset.facetType=t,(g=s[t])!=null&&g.includes(d.key)&&(h.checked=!0);const m=document.createElement("span");m.textContent=`${d.key} (${d.doc_count})`,m.className="text-sm",u.appendChild(h),u.appendChild(m),i.appendChild(u)}),e.appendChild(i)}_renderBarChart(e,t,r,o){e.innerHTML="";const s=Math.max(...t.map(u=>u.count)),i=document.createElement("div");i.className="flex items-end w-full h-full relative",e.appendChild(i),[...t].sort((u,h)=>u.value-h.value).forEach(u=>{const h=s>0?u.count/s*100:0,m=document.createElement("div");m.className="flex-1 mx-px",m.style.height=`${h}%`,m.style.backgroundColor="#b0c4de",m.dataset.value=u.value,m.dataset.count=u.count,m.title=`Value: ${u.value}, Count: ${u.count}`,i.appendChild(m)});const d=document.createElement("div");d.className="absolute top-0 h-full pointer-events-none",d.style.backgroundColor="rgba(66, 153, 225, 0.3)",d.id=`${e.id}-highlight`,e.appendChild(d)}_updateChartHighlight(e,t,r,o){const s=e.querySelector(`#${e.id}-highlight`);if(!s)return;const i=t[t.length-1].value-t[0].value;if(i<=0)return;const c=(r-t[0].value)/i*100,d=(o-r)/i*100;s.style.left=`${c}%`,s.style.width=`${d}%`}_addFacetEventListeners(e){if(!this.config.aggregations){console.error("Aggregations configuration not found");return}Object.keys(this.config.aggregations).forEach(t=>{const r=document.getElementById(`${t}-facet`);r&&r.querySelectorAll("input").forEach(o=>{o.addEventListener("change",s=>{this._onFacetChange(s,e)})})})}_onFacetChange(e,t){const{value:r,checked:o}=e.target,s=e.target.dataset.facetType;t({type:"FACET_CHANGE",facetType:s,value:r,checked:o})}_debounce(e,t){let r;return function(){clearTimeout(r),r=setTimeout(()=>e.apply(this,arguments),t)}}}class ss{renderBarChart(e,t,r,o){e.innerHTML="";const s=Math.max(...t.map(u=>u.count)),i=document.createElement("div");i.className="flex items-end w-full h-full relative",e.appendChild(i),[...t].sort((u,h)=>u.value-h.value).forEach(u=>{const h=s>0?u.count/s*100:0,m=document.createElement("div");m.className="flex-1 mx-px",m.style.height=`${h}%`,m.style.backgroundColor="#b0c4de",m.dataset.value=u.value,m.dataset.count=u.count,m.title=`Value: ${u.value}, Count: ${u.count}`,i.appendChild(m)});const d=document.createElement("div");d.className="absolute top-0 h-full pointer-events-none",d.style.backgroundColor="rgba(66, 153, 225, 0.3)",d.id=`${e.id}-highlight`,e.appendChild(d)}updateChartHighlight(e,t,r,o){const s=e.querySelector(`#${e.id}-highlight`);if(!s)return;const i=t[t.length-1].value-t[0].value;if(i<=0)return;const c=(r-t[0].value)/i*100,d=(o-r)/i*100;s.style.left=`${c}%`,s.style.width=`${d}%`}}class is{renderTaxonomy(e,t,r,o){const s=this._buildHierarchy(t);this._calculateTotalCounts(s),this._addTaxonomyStyles(),e.innerHTML=this._createTaxonomyHTML(s,[],0,r,o),this._addToggleListeners(e)}_buildHierarchy(e){const t={};return e.forEach(r=>{const o=r.key.split(" > ");let s=t;o.forEach((i,c)=>{s[i]||(s[i]={children:{},docCount:0,selfCount:0}),c===o.length-1&&(s[i].selfCount=r.doc_count),s=s[i].children})}),t}_calculateTotalCounts(e){const t=r=>{let o=r.selfCount||0;return Object.values(r.children).forEach(s=>{o+=t(s)}),r.docCount=o,o};Object.values(e).forEach(r=>{t(r)})}_createTaxonomyHTML(e,t=[],r=0,o,s){let i=`<ul class="taxonomy-list" style="margin-left: ${r*20}px;">`;return Object.entries(e).forEach(([c,d])=>{var g;if(c==="children"||c==="docCount"||c==="selfCount")return;const u=[...t,c],h=u.join(" > "),m=Object.keys(d.children).length>0;i+=`
        <li class="taxonomy-item">
          <div class="taxonomy-row">
            ${m?`<span class="toggle-btn" data-path="${h}">▶</span>`:'<span class="toggle-placeholder"></span>'}
            <label>
              <input type="checkbox" 
                     value="${h}" 
                     data-facet-type="${o}"
                     ${(g=s[o])!=null&&g.includes(h)?"checked":""}>
              <span>${c} (${d.docCount})</span>
            </label>
          </div>
          ${m?`<div class="children" data-parent="${h}" style="display: none;">
              ${this._createTaxonomyHTML(d.children,u,r+1,o,s)}
            </div>`:""}
        </li>
      `}),i+"</ul>"}_addTaxonomyStyles(){if(document.getElementById("taxonomy-styles"))return;const e=document.createElement("style");e.id="taxonomy-styles",e.textContent=`
      .taxonomy-list {
        list-style: none;
        padding: 0;
      }
      .taxonomy-item {
        margin: 5px 0;
      }
      .taxonomy-row {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .toggle-btn {
        cursor: pointer;
        width: 20px;
        user-select: none;
      }
      .toggle-placeholder {
        width: 20px;
      }
      .children {
        margin-left: 20px;
      }
    `,document.head.appendChild(e)}_addToggleListeners(e){e.addEventListener("click",t=>{if(t.target.classList.contains("toggle-btn")){const r=t.target.dataset.path,o=e.querySelector(`[data-parent="${r}"]`);if(o){const s=o.style.display==="none";o.style.display=s?"block":"none",t.target.textContent=s?"▼":"▶"}}})}}class as{constructor(e,t){this.searchEngine=e,this.config=t}performSearch(e,t={}){if(!this.searchEngine){console.error("Search engine not initialized");return}const{filters:r}=e,{regularFilters:o,dateFilters:s,taxonomyFilters:i}=this._separateFilters(r),c=this.searchEngine.search({query:e.query||"",filters:o,sort:e.sort||"title_asc",per_page:526,filter:u=>this._customFilter(u,s,i)}),d=this._extractCoordinates(c.data.items);if(t.onMarkersUpdate&&t.onMarkersUpdate(c.data.items),t.onResultsUpdate&&t.onResultsUpdate(c.data.items),t.onAggregationsUpdate){const u=this._formatAggregations(c.data.aggregations);t.onAggregationsUpdate(u)}return{items:c.data.items,coordinates:d,aggregations:this._formatAggregations(c.data.aggregations)}}_separateFilters(e){const t={},r={},o={};return Object.entries(e).forEach(([s,i])=>{if(!i||i.length===0)return;const c=this.config.aggregations[s];if(c)switch(c.type){case"range":r[s]=i;break;case"taxonomy":o[s]=i;break;default:t[s]=i}}),{regularFilters:t,dateFilters:r,taxonomyFilters:o}}_customFilter(e,t,r){for(const[o,s]of Object.entries(t))if(s.length===2){const[i,c]=s,d=new Date(e[o]).getTime();if(!(d>=i&&d<=c))return!1}for(const[o,s]of Object.entries(r)){if(!e[o])return!1;const i=e[o];if(!s.some(d=>i===d||i.startsWith(d+" > ")))return!1}return!0}_extractCoordinates(e){return e.filter(t=>t.lat_long&&t.lat_long.length>0).map(t=>{const r=t.lat_long[0],[o,s]=r.split(",");return[parseFloat(o),parseFloat(s)]})}_formatAggregations(e){const t={};for(const r in e)e.hasOwnProperty(r)&&(t[r]=e[r].buckets);return t}}class ls{constructor(e,t=null){this.mapFocusCallback=e,this.config=t,this.allWorks=[],this.items=[],this.isModalOpen=!1,this.currentModalIndex=0}setData(e,t){this.allWorks=e,this.items=t}setConfig(e){this.config=e}_getCompleteWorkData(e){const t=this.items.filter(i=>i.ID_opera===e);if(t.length===0)return null;const r=t[0],o={ID_opera:e,Titolo:r.Titolo,Autore:r.Autore,Anno:r.Anno,"Spazi geografici":[],coordinates:[],allEntries:t,geodataBySpace:new Map},s=new Map;return t.forEach(i=>{i["Spazi geografici"]&&(Array.isArray(i["Spazi geografici"])?i["Spazi geografici"]:[i["Spazi geografici"]]).forEach((d,u)=>{if(!s.has(d)){const h=this._extractCoordinates(i,u);s.set(d,h);const m=this._getGeodataFields(),g={};m.forEach(y=>{i[y]!==void 0&&i[y]!==null&&i[y]!==""&&(Array.isArray(i[y])&&i[y].length>u?g[y]=i[y][u]:Array.isArray(i[y])||(g[y]=i[y]))}),o.geodataBySpace.set(d,g)}})}),o["Spazi geografici"]=Array.from(s.keys()),o.coordinates=Array.from(s.values()),o}_getCatalogueFields(){var e,t,r;return console.log(this.config),((r=(t=(e=this.config)==null?void 0:e.datasetConfig)==null?void 0:t.fields)==null?void 0:r.catalogue)||[]}_getGeodataFields(){var e,t,r;return((r=(t=(e=this.config)==null?void 0:e.datasetConfig)==null?void 0:t.fields)==null?void 0:r.geodata)||[]}_getAllMetadataFields(){const e=this._getCatalogueFields(),t=this._getGeodataFields();return[...new Set([...e,...t])]}toggleModal(e){this.isModalOpen?this._closeModal():(this.currentModalIndex=e,this._openModal())}_openModal(){let e=document.getElementById("works-modal");e||(e=this._createModal(),document.body.appendChild(e)),this._populateModal(),e.classList.remove("hidden"),this.isModalOpen=!0,document.body.style.overflow="hidden"}_closeModal(){const e=document.getElementById("works-modal");e&&e.classList.add("hidden"),this.isModalOpen=!1,document.body.style.overflow="auto"}_createModal(){const e=document.createElement("div");return e.id="works-modal",e.className="fixed inset-0 bg-gradient-to-br from-slate-800/95 to-gray-800/95 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 animate-in fade-in duration-300",e.innerHTML=`
      <div class="relative w-full max-w-7xl h-[90vh] overflow-hidden animate-in zoom-in-95 duration-300">
        <!-- Header with Close Button -->
        <div class="absolute top-0 left-0 right-0 px-6 py-4 z-20">
          <button id="close-modal-btn" class="absolute top-4 right-6 p-2.5 bg-red-500 hover:bg-red-600 active:bg-red-700 rounded-xl text-white shadow-lg hover:shadow-xl transition-all duration-200 group">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 group-hover:rotate-90 transition-transform duration-200">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        
        <!-- Content Container -->
        <div id="modal-content" class="h-full pt-16 pb-16"></div>
        
        <!-- Footer with Progress Indicator -->
        <div class="absolute bottom-0 left-0 right-0 px-6 py-3 z-20">
          <div class="flex items-center justify-center">
            <span id="modal-progress" class="text-sm font-medium text-gray-700 bg-white px-4 py-2 rounded-full shadow-sm ring-1 ring-gray-200">
            </span>
          </div>
        </div>
      </div>
    `,e.addEventListener("click",t=>{t.target===e&&this._closeModal()}),e.querySelector("#close-modal-btn").addEventListener("click",()=>{this._closeModal()}),document.addEventListener("keydown",t=>{this.isModalOpen&&(t.key==="Escape"?this._closeModal():t.key==="ArrowLeft"?this._navigateModal(-1):t.key==="ArrowRight"&&this._navigateModal(1))}),e}_navigateModal(e){const t=this.currentModalIndex+e;t>=0&&t<this.allWorks.length&&(this.currentModalIndex=t,this._populateModal())}_populateModal(){const e=document.getElementById("modal-content"),t=document.getElementById("modal-progress");if(!e)return;const r=this.allWorks[this.currentModalIndex],o=this._getCompleteWorkData(r.ID_opera),s=this.currentModalIndex>0?this.allWorks[this.currentModalIndex-1]:null,i=this.currentModalIndex<this.allWorks.length-1?this.allWorks[this.currentModalIndex+1]:null,c=s?this._getCompleteWorkData(s.ID_opera):null,d=i?this._getCompleteWorkData(i.ID_opera):null;if(!o){e.innerHTML='<div class="flex items-center justify-center h-full text-gray-500 text-lg">Dati non disponibili</div>';return}e.innerHTML=`
      <div class="flex h-full">
        <!-- Left Navigation Panel -->
        <div class="w-64 flex flex-col items-center justify-center p-6 space-y-6">
          <button id="prev-work-btn" class="group p-4 bg-white hover:bg-blue-50 active:bg-blue-100 rounded-2xl text-gray-600 hover:text-blue-600 transition-all duration-200 shadow-md hover:shadow-lg ring-1 ring-gray-200 hover:ring-blue-200 ${this.currentModalIndex===0?"opacity-40 cursor-not-allowed":"hover:scale-105"}" ${this.currentModalIndex===0?"disabled":""}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 group-hover:-translate-x-0.5 transition-transform duration-200">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
            </svg>
          </button>
          
          ${c?`
            <div class="text-center bg-white rounded-xl shadow-sm ring-1 ring-gray-200 px-4 py-6 max-w-48">
              <div class="w-12 h-1 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full mx-auto mb-4"></div>
              <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${c.Titolo}</h4>
              <p class="text-xs text-gray-600 font-medium">${c.Autore}</p>
              <p class="text-xs text-gray-500">(${c.Anno})</p>
            </div>
          `:`
            <div class="text-center px-4 py-6 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 max-w-48">
              <div class="text-sm text-gray-400 font-medium">Nessuna opera precedente</div>
            </div>
          `}
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 overflow-y-auto bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 border border-gray-200">
          ${this._renderMainCard(o)}
        </div>

        <!-- Right Navigation Panel -->
        <div class="w-64 flex flex-col items-center justify-center p-6 space-y-6">
          <button id="next-work-btn" class="group p-4 bg-white hover:bg-blue-50 active:bg-blue-100 rounded-2xl text-gray-600 hover:text-blue-600 transition-all duration-200 shadow-md hover:shadow-lg ring-1 ring-gray-200 hover:ring-blue-200 ${this.currentModalIndex===this.allWorks.length-1?"opacity-40 cursor-not-allowed":"hover:scale-105"}" ${this.currentModalIndex===this.allWorks.length-1?"disabled":""}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 group-hover:translate-x-0.5 transition-transform duration-200">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
            </svg>
          </button>
          
          ${d?`
            <div class="text-center px-4 py-6 bg-white rounded-xl shadow-sm ring-1 ring-gray-200 max-w-48">
              <div class="w-12 h-1 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full mx-auto mb-4"></div>
              <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${d.Titolo}</h4>
              <p class="text-xs text-gray-600 font-medium">${d.Autore}</p>
              <p class="text-xs text-gray-500">(${d.Anno})</p>
            </div>
          `:`
            <div class="text-center px-4 py-6 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 max-w-48">
              <div class="text-sm text-gray-400 font-medium">Nessuna opera successiva</div>
            </div>
          `}
        </div>
      </div>
    `,t&&(t.textContent=`${this.currentModalIndex+1} di ${this.allWorks.length}`);const u=document.getElementById("prev-work-btn"),h=document.getElementById("next-work-btn");u&&this.currentModalIndex>0&&u.addEventListener("click",()=>this._navigateModal(-1)),h&&this.currentModalIndex<this.allWorks.length-1&&h.addEventListener("click",()=>this._navigateModal(1)),this._addMapFocusListeners()}_renderMainCard(e){const t=e.allEntries[0],r=this._renderCombinedMetadata(t),o=this._renderGeographicalSpaces(e);return`
      <div class="p-8 space-y-8">
        <!-- Header Section -->
        <div class="bg-gradient-to-r from-slate-50 to-gray-50 rounded-2xl p-8 ring-1 ring-gray-200">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-1 h-12 bg-gradient-to-b from-blue-500 to-blue-600 rounded-full"></div>
                <div>
                  <h1 class="text-3xl font-bold text-gray-900 leading-tight">${e.Titolo}</h1>
                  <div class="flex items-center gap-4 mt-2">
                    <p class="text-lg text-gray-700 font-medium">${e.Autore}</p>
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full"></span>
                    <p class="text-lg text-gray-600 font-mono">${e.Anno}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        ${r}
        ${o}
      </div>
    `}_renderCombinedMetadata(e){const t=this._getCatalogueFields(),r=[],o=t.filter(s=>!r.includes(s)&&e[s]!=null&&e[s]!=="").map(s=>{const i=e[s];let c=i;return Array.isArray(i)?c=i.join(", "):typeof i=="string"&&i.length>150&&(c=i.substring(0,147)+"..."),`
          <div class="group bg-white hover:bg-gray-50 rounded-xl p-5 ring-1 ring-gray-200 hover:ring-gray-300 transition-all duration-200">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-2 h-2 bg-gradient-to-r from-green-400 to-green-600 rounded-full group-hover:scale-125 transition-transform duration-200"></div>
              <h4 class="text-sm font-semibold text-gray-800 uppercase tracking-wide">${s}</h4>
            </div>
            <div class="text-base text-gray-700 leading-relaxed pl-5">${c}</div>
          </div>
        `}).join("");return o?`
      <div>
        <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-green-600">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0-1.125.504-1.125 1.125V11.25a9 9 0 0 0-9-9Z" />
          </svg>
          Metadati del catalogo
        </h2>
        <div class="grid gap-4">
          ${o}
        </div>
      </div>
    `:""}_renderGeographicalSpaces(e){return!e["Spazi geografici"]||e["Spazi geografici"].length===0?`
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-8 ring-1 ring-blue-200">
          <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-blue-600">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
            </svg>
            Spazi geografici
          </h2>
          <div class="text-gray-500 italic">Nessun spazio geografico disponibile</div>
        </div>
      `:`
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-8 ring-1 ring-blue-200">
        <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-blue-600">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
          </svg>
          Spazi geografici
        </h2>
        <div class="grid gap-6">
          ${e["Spazi geografici"].map((r,o)=>{const s=e.coordinates[o],i=e.geodataBySpace.get(r)||{},c=this._getAllMetadataFields(),d=this._getCatalogueFields(),u=[],h=c.filter(g=>!u.includes(g)&&!d.includes(g)).map(g=>{let y=i[g];if(y==null||y==="")return"";let p=y;return typeof y=="string"&&y.length>100&&(p=y.substring(0,97)+"..."),`
            <div class="flex items-start gap-3 py-2">
              <div class="w-1.5 h-1.5 bg-blue-400 rounded-full mt-2 flex-shrink-0"></div>
              <div class="min-w-0 flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-xs font-semibold text-gray-600 uppercase tracking-wide">${g}</span>
                </div>
                <span class="text-sm text-gray-800">${p}</span>
              </div>
            </div>
          `}).filter(Boolean).join(""),m=s&&s.lat&&s.lng;return`
        <div class="bg-white rounded-xl p-6 ring-1 ring-gray-200 hover:ring-blue-300 transition-all duration-200 hover:shadow-md">
          <div class="flex items-start justify-between mb-4">
            <div class="flex items-center gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-5 h-5 text-blue-600 flex-shrink-0">
                <path fill-rule="evenodd" d="m7.539 14.841.003.003.002.002a.755.755 0 0 0 .912 0l.002-.002.003-.003.012-.009a5.57 5.57 0 0 0 .19-.153 15.588 15.588 0 0 0 2.046-2.082c1.101-1.362 2.291-3.342 2.291-5.597A5 5 0 0 0 3 7c0 2.255 1.19 4.235 2.292 5.597a15.591 15.591 0 0 0 2.046 2.082 8.916 8.916 0 0 0 .189.153l.012.01ZM8 8.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" clip-rule="evenodd" />
              </svg>
              <h3 class="text-lg font-semibold text-gray-900">${r}</h3>
            </div>
            
            ${m?`
              <button class="map-btn group px-4 py-2 text-sm font-medium bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 active:from-blue-700 active:to-blue-800 text-white rounded-lg shadow-sm hover:shadow-md transition-all duration-200 hover:scale-105" 
                      data-lat="${s.lat}" 
                      data-lng="${s.lng}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 inline mr-1">
                  <path fill-rule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V6h4.5a.75.75 0 0 1 0 1.5H8.75v4.25a.75.75 0 0 1-1.5 0V7.5H2.75a.75.75 0 0 1 0-1.5h4.5V1.75A.75.75 0 0 1 8 1Z" clip-rule="evenodd" />
                </svg>
                Visualizza sulla mappa
              </button>
            `:`
              <span class="px-4 py-2 text-sm font-medium bg-gray-100 text-gray-500 rounded-lg ring-1 ring-gray-200">
                Coordinate non disponibili
              </span>
            `}
          </div>
          
          ${h?`
            <div class="border-t border-gray-100 pt-4 mt-4">
              <h4 class="text-sm font-semibold text-gray-700 mb-3">Metadati geografici per questo spazio:</h4>
              <div class="space-y-2">
                ${h}
              </div>
            </div>
          `:`
            <div class="border-t border-gray-100 pt-4 mt-4">
              <div class="text-sm text-gray-500 italic">Nessun metadato geografico disponibile per questo spazio</div>
            </div>
          `}
        </div>
      `}).join("")}
        </div>
        <div class="mt-6 text-sm text-blue-700 bg-blue-100 rounded-lg p-3 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
            <path fill-rule="evenodd" d="M15 8A7 7 0 1 1 1 8a7 7 0 0 1 14 0ZM9 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0ZM6.75 8a.75.75 0 0 0 0 1.5h.75v1.75a.75.75 0 0 0 1.5 0v-2.5A.75.75 0 0 0 8.25 8h-1.5Z" clip-rule="evenodd" />
          </svg>
          <span>Clicca sui pulsanti per visualizzare i luoghi sulla mappa. Ogni spazio mostra solo i metadati geografici disponibili.</span>
        </div>
      </div>
    `}_addMapFocusListeners(){document.querySelectorAll(".map-btn").forEach(e=>{e.addEventListener("click",()=>{const t=parseFloat(e.getAttribute("data-lat")),r=parseFloat(e.getAttribute("data-lng"));t&&r&&this.mapFocusCallback&&(this.mapFocusCallback(t,r,8),this._closeModal())})})}_extractCoordinates(e,t){let r={lat:null,lng:null};if(Array.isArray(e.lat_long)&&e.lat_long.length>t){const o=e.lat_long[t];if(o&&typeof o=="string"){const s=o.split(",");if(s.length===2){const i=parseFloat(s[0].trim()),c=parseFloat(s[1].trim());!isNaN(i)&&!isNaN(c)&&(r={lat:i,lng:c})}}}else if(e.lat_long&&typeof e.lat_long=="string"){const o=e.lat_long.split(",");if(o.length===2){const s=parseFloat(o[0].trim()),i=parseFloat(o[1].trim());!isNaN(s)&&!isNaN(i)&&(r={lat:s,lng:i})}}return r}}class cs{constructor(e){this.mapFocusCallback=e,this.allWorks=[],this.modalRenderer=new ls(e)}updateResultsList(e,t){const r=document.getElementById("results");if(!r){console.error("Results container not found");return}this.items=e;const o=this._groupByIdOpera(e);this.allWorks=Object.values(o),this.modalRenderer.setData(this.allWorks,this.items),this.modalRenderer.setConfig(t),r.innerHTML=this.allWorks.map((s,i)=>this._renderResultItem(s,i)).join(""),this._addMapFocusListeners(),this._addModalListeners()}_groupByIdOpera(e){const t={};return e.forEach(r=>{const o=r.ID_opera;t[o]||(t[o]={ID_opera:o,Titolo:r.Titolo,Autore:r.Autore,Anno:r.Anno,"Spazi geografici":[],coordinates:[]}),r["Spazi geografici"]&&(Array.isArray(r["Spazi geografici"])?r["Spazi geografici"]:[r["Spazi geografici"]]).forEach((i,c)=>{if(!t[o]["Spazi geografici"].includes(i)){t[o]["Spazi geografici"].push(i);const d=this._extractCoordinatesFromItem(r,c);t[o].coordinates.push(d)}})}),t}_renderResultItem(e,t){const r=e["Spazi geografici"].map((o,s)=>{const i=e.coordinates[s];return i&&i.lat&&i.lng?`
          <button class="focus-map-btn mr-2 mb-2 px-2 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded transition-colors" 
                  data-space="${encodeURIComponent(o)}" 
                  data-lat="${i.lat}" 
                  data-lng="${i.lng}"
                  title="Clicca per visualizzare sulla mappa">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4 inline mr-1">
              <path fill-rule="evenodd" d="m7.539 14.841.003.003.002.002a.755.755 0 0 0 .912 0l.002-.002.003-.003.012-.009a5.57 5.57 0 0 0 .19-.153 15.588 15.588 0 0 0 2.046-2.082c1.101-1.362 2.291-3.342 2.291-5.597A5 5 0 0 0 3 7c0 2.255 1.19 4.235 2.292 5.597a15.591 15.591 0 0 0 2.046 2.082 8.916 8.916 0 0 0 .189.153l.012.01ZM8 8.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" clip-rule="evenodd" />
            </svg>
            ${o}
          </button>
        `:`
          <button class="focus-map-btn mr-2 mb-2 px-2 py-1 text-sm bg-gray-200 rounded cursor-default" 
                  data-space="${encodeURIComponent(o)}"
                  title="Coordinate non disponibili">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4 inline mr-1 opacity-50">
              <path fill-rule="evenodd" d="m7.539 14.841.003.003.002.002a.755.755 0 0 0 .912 0l.002-.002.003-.003.012-.009a5.57 5.57 0 0 0 .19-.153 15.588 15.588 0 0 0 2.046-2.082c1.101-1.362 2.291-3.342 2.291-5.597A5 5 0 0 0 3 7c0 2.255 1.19 4.235 2.292 5.597a15.591 15.591 0 0 0 2.046 2.082 8.916 8.916 0 0 0 .189.153l.012.01ZM8 8.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" clip-rule="evenodd" />
            </svg>
            ${o}
          </button>
        `}).join("");return`
      <div class="p-4 bg-white rounded-lg shadow hover:shadow-md transition-shadow">
        <h3 class="font-semibold flex items-center justify-between mb-3">
          <span>${e.Titolo}, ${e.Autore} (${e.Anno})</span>
          <button class="modal-toggle-btn ml-2 p-1 hover:bg-gray-100 rounded transition-colors"
                  data-work-index="${t}"
                  title="Visualizza tutte le opere">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z" />
            </svg>
          </button>
        </h3>
        <div class="mt-2">
          <p class="text-sm text-gray-600 mb-2">Spazi geografici descritti:</p>
          <div class="flex flex-wrap">
            ${r}
          </div>
        </div>
      </div>
    `}_addModalListeners(){document.querySelectorAll(".modal-toggle-btn").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const r=parseInt(e.getAttribute("data-work-index"));this.modalRenderer.toggleModal(r)})})}_extractCoordinatesFromItem(e,t){let r={lat:null,lng:null};if(Array.isArray(e.lat_long)&&e.lat_long.length>t){const o=e.lat_long[t];if(o&&typeof o=="string"){const s=o.split(",");if(s.length===2){const i=parseFloat(s[0].trim()),c=parseFloat(s[1].trim());!isNaN(i)&&!isNaN(c)&&(r.lat=i,r.lng=c)}}}else if(e.lat_long&&typeof e.lat_long=="string"){const o=e.lat_long.split(",");if(o.length===2){const s=parseFloat(o[0].trim()),i=parseFloat(o[1].trim());!isNaN(s)&&!isNaN(i)&&(r.lat=s,r.lng=i)}}return r}_addMapFocusListeners(){document.querySelectorAll(".focus-map-btn").forEach(e=>{e.addEventListener("click",t=>{const r=e.getAttribute("data-lat"),o=e.getAttribute("data-lng");r&&o&&this.mapFocusCallback?this.mapFocusCallback(parseFloat(r),parseFloat(o),8):console.warn("Coordinate non disponibili per questa opera:",e.getAttribute("data-space"))})})}}class ds{static debounce(e,t){let r;return function(){clearTimeout(r),r=setTimeout(()=>e.apply(this,arguments),t)}}static parseCoordinates(e){if(!e||typeof e!="string")return{lat:null,lng:null};const t=e.split(",");return t.length===2?{lat:parseFloat(t[0].trim()),lng:parseFloat(t[1].trim())}:{lat:null,lng:null}}static encodeForAttribute(e){return encodeURIComponent(e||"")}static createUniqueId(e="element"){return`${e}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}static isEmpty(e){return e==null?!0:typeof e=="string"?e.trim()==="":Array.isArray(e)?e.length===0:typeof e=="object"?Object.keys(e).length===0:!1}}class us{constructor(){this.loadConfiguration=Pn.bind(this),this.config=null,this.searchEngine=null,this.state={query:"",filters:{},sort:"",bounds:null},this.lastLoadedPolygonIds=new Set,this.loaderElement=document.getElementById("loader-container"),this.navBar=ns,this.initialize()}hideLoader(){this.loaderElement&&this.loaderElement.classList.add("loader-hidden")}async initialize(){try{this.config=await this.loadConfiguration();const e=await zn();this.config.searchConfig.per_page=e.length,this.searchEngine=es(e,this.config),console.log("Search engine initialized with data:",e.length,"items"),this.state.sort=this.config.searchConfig.defaultSort;const t={};for(const[o,s]of Object.entries(this.config.aggregations))t[o]=[];this.state.filters=t;const r=Bn(this.config);this.map=r.map,this.markers=r.markers,this.renderMarkers=r.renderMarkers,this.polygonManager=new rs(this.map),this.facetRenderer=new os(this.config),this.rangeRenderer=new ss,this.taxonomyRenderer=new is,this.searchHandler=new as(this.searchEngine,this.config),this.resultsRenderer=new cs((o,s,i)=>this.focusOnMap(o,s,i)),this.navBar.setConfig(this.config),this.debouncedSearch=ds.debounce(this.performSearch.bind(this),300),console.log("PolygonManager initialized:",this.polygonManager),this.bindEvents(),this.bindNavBarEvents(),await this.fetchAggregations(),await this.performSearch(),this.hideLoader()}catch(e){console.error("Initialization error:",e),this.hideLoader()}}bindNavBarEvents(){this.navBar.addEventListener("clearAllFilters",()=>{this.clearAllFilters()}),this.navBar.addEventListener("removeFilter",e=>{const{facetKey:t,value:r}=e.detail;this.removeSpecificFilter(t,r)}),this.navBar.addEventListener("clearSearchQuery",()=>{this.clearSearchQuery()})}clearAllFilters(){this.state.query="",this.state.filters={};for(const[t,r]of Object.entries(this.config.aggregations))this.state.filters[t]=[];const e=document.getElementById("search-input");e&&(e.value=""),this.performSearch(),this.fetchAggregations()}removeSpecificFilter(e,t){this.state.filters[e]&&(t?this.state.filters[e]=this.state.filters[e].filter(r=>r!==t):this.state.filters[e]=[],this.performSearch(),this.fetchAggregations())}clearSearchQuery(){this.state.query="";const e=document.getElementById("search-input");e&&(e.value=""),this.performSearch()}renderFacets(e){this.facetRenderer.renderFacets(e,this.state,t=>this.handleStateChange(t))}updateNavBar(e=0){this.navBar.updateFromSearchState(this.state,e)}performSearch(){const e=this.searchHandler.performSearch(this.state,{onMarkersUpdate:t=>this.renderMarkers(t),onResultsUpdate:t=>this.resultsRenderer.updateResultsList(t,this.config),onAggregationsUpdate:t=>this.renderFacets(t)});this.updateNavBar(e.items?e.items.length:0),e.items&&e.items.length<=50?this.loadPolygonsForSearchResults():(console.log(`Too many results (${e.items.length}) - skipping polygon loading`),this.polygonManager.clearAllPolygons()),console.log("Search completed:",e.items?e.items.length:0,"items")}handleStateChange(e){switch(e.type){case"FACET_CHANGE":this.updateFilters(e.facetType,e.value,e.checked);break;case"RANGE_CHANGE":this.state.filters[e.facetKey]=e.value,this.performSearch(),this.fetchAggregations();break;case"QUERY_CHANGE":this.state.query=e.query;break;case"SORT_CHANGE":this.state.sort=e.sort;break}e.type!=="RANGE_CHANGE"&&this.debouncedSearch(),this.debouncedSearch()}updateFilters(e,t,r){var o;r?(this.state.filters[e]||(this.state.filters[e]=[]),this.state.filters[e].push(t)):this.state.filters[e]=((o=this.state.filters[e])==null?void 0:o.filter(s=>s!==t))||[]}focusOnMap(e,t,r=15){if(!this.map){console.error("Map not initialized");return}try{this.map.setView([parseFloat(e),parseFloat(t)],r),console.log(`Map focused on coordinates: ${e}, ${t} with zoom level: ${r}`)}catch(o){console.error("Error focusing map on coordinates:",o),console.log("Map object:",this.map),console.log("Available methods:",Object.getOwnPropertyNames(this.map).filter(s=>typeof this.map[s]=="function"))}}bindEvents(){this.setupSearchInput(),this.setupSortSelect(),this.setupMarkerEvents();let e;this.map.on("moveend",()=>{e&&clearTimeout(e),e=setTimeout(()=>{const t=this.searchHandler.performSearch(this.state,{onMarkersUpdate:r=>this.renderMarkers(r),onResultsUpdate:r=>this.resultsRenderer.updateResultsList(r,this.config),onAggregationsUpdate:r=>this.renderFacets(r)});this.updateNavBar(t.items?t.items.length:0),console.log("Map move search completed:",t.items?t.items.length:0,"items")},200)})}setupMarkerEvents(){this.map.on("marker:click",e=>{const t=e.detail||e.data;t&&t.osm_id?(console.log("Marker clicked, loading polygon for OSM ID:",t.osm_id),this.polygonManager.onMarkerClick(t)):console.log("Marker clicked but no OSM ID found - skipping polygon load")})}setupSearchInput(){const e=document.getElementById("search-input");if(!e){console.error("Search input element not found");return}const t=this.debounce(()=>{this.state.query=e.value,this.performSearch()},this.config.searchConfig.debounceTime||300);e.addEventListener("input",t)}setupSortSelect(){const e=document.getElementById("sort-select");if(!e||!this.config.searchConfig.sortOptions){console.error("Sort select element not found or sort options not configured");return}e.innerHTML=this.config.searchConfig.sortOptions.map(t=>`<option value="${t.value}">${t.label}</option>`).join(""),e.addEventListener("change",t=>{this.state.sort=t.target.value,this.performSearch()})}async fetchAggregations(){if(!this.searchEngine){console.error("Search engine not initialized");return}const e=this.searchEngine.search({query:this.state.query||"",filters:this.state.filters}),t={};for(const r in e.data.aggregations)e.data.aggregations.hasOwnProperty(r)&&(t[r]=e.data.aggregations[r].buckets);this.renderFacets(t)}debounce(e,t){let r;return function(){clearTimeout(r),r=setTimeout(()=>e.apply(this,arguments),t)}}clearPolygons(){this.polygonManager&&this.polygonManager.clearAllPolygons()}togglePolygons(e){this.polygonManager&&this.polygonManager.setPolygonVisibility(e)}loadPolygonForItem(e,t=!0,r=!0){return!e||!e.osm_id?(console.log("Item has no OSM ID - cannot load polygon:",e),!1):this.polygonManager?(this.polygonManager.loadPolygon(e,t,r),!0):!1}loadPolygonsForSearchResults(){if(!this.searchEngine){console.error("Search engine not initialized");return}const e=this.searchEngine.search({query:this.state.query||"",filters:this.state.filters});if(e&&e.data&&e.data.items){const t=e.data.items.filter(r=>r&&r.osm_id&&(typeof r.osm_id=="string"||typeof r.osm_id=="number"));t.length>0?(console.log(`Loading polygons for ${t.length} items with OSM IDs`),this.polygonLoadTimeout&&clearTimeout(this.polygonLoadTimeout),this.polygonLoadTimeout=setTimeout(()=>{this.polygonManager.loadSearchResultPolygons(t),this.polygonLoadTimeout=null},100)):(console.log("No search results with OSM IDs found"),this.polygonManager.clearAllPolygons())}}getPolygonManager(){return this.polygonManager}}document.addEventListener("DOMContentLoaded",()=>{new us})});export default hs();
