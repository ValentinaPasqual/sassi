var Or=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);import"./modulepreload-polyfill-B5Qt9EMX.js";import{l as $r,p as Ir}from"./dataParser-DPL0y_Ss.js";import{i as Pr}from"./initMap-BNVLy5BH.js";var hs=Or((V,D)=>{var ir=typeof global=="object"&&global&&global.Object===Object&&global,Tr=typeof self=="object"&&self&&self.Object===Object&&self,Q=ir||Tr||Function("return this")(),U=Q.Symbol,ar=Object.prototype,Br=ar.hasOwnProperty,Nr=ar.toString,be=U?U.toStringTag:void 0,zr=Object.prototype.toString,Rr="[object Null]",Hr="[object Undefined]",wt=U?U.toStringTag:void 0;function ye(r){return r==null?r===void 0?Hr:Rr:wt&&wt in Object(r)?function(e){var t=Br.call(e,be),n=e[be];try{e[be]=void 0;var o=!0}catch{}var s=Nr.call(e);return o&&(t?e[be]=n:delete e[be]),s}(r):function(e){return zr.call(e)}(r)}function te(r){return r!=null&&typeof r=="object"}var Wr="[object Symbol]";function fe(r){return typeof r=="symbol"||te(r)&&ye(r)==Wr}function ge(r,e){for(var t=-1,n=r==null?0:r.length,o=Array(n);++t<n;)o[t]=e(r[t],t,r);return o}var R=Array.isArray,qr=1/0,bt=U?U.prototype:void 0,xt=bt?bt.toString:void 0;function lr(r){if(typeof r=="string")return r;if(R(r))return ge(r,lr)+"";if(fe(r))return xt?xt.call(r):"";var e=r+"";return e=="0"&&1/r==-qr?"-0":e}function ie(r){var e=typeof r;return r!=null&&(e=="object"||e=="function")}function Re(r){return r}var Vr="[object AsyncFunction]",Dr="[object Function]",Gr="[object GeneratorFunction]",Ur="[object Proxy]";function cr(r){if(!ie(r))return!1;var e=ye(r);return e==Dr||e==Gr||e==Vr||e==Ur}var _t,Ve=Q["__core-js_shared__"],Ct=(_t=/[^.]+$/.exec(Ve&&Ve.keys&&Ve.keys.IE_PROTO||""))?"Symbol(src)_1."+_t:"",Zr=Function.prototype.toString;function ae(r){if(r!=null){try{return Zr.call(r)}catch{}try{return r+""}catch{}}return""}var Yr=/^\[object .+?Constructor\]$/,Qr=RegExp("^"+Function.prototype.toString.call(Object.prototype.hasOwnProperty).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function le(r,e){var t=function(n,o){return n==null?void 0:n[o]}(r,e);return function(n){return!(!ie(n)||(o=n,Ct&&Ct in o))&&(cr(n)?Qr:Yr).test(ae(n));var o}(t)?t:void 0}var kt,De,Ge,Xe=le(Q,"WeakMap"),St=Object.create,Jr=function(){function r(){}return function(e){if(!ie(e))return{};if(St)return St(e);r.prototype=e;var t=new r;return r.prototype=void 0,t}}(),Xr=Date.now,Kr=function(){try{var r=le(Object,"defineProperty");return r({},"",{}),r}catch{}}(),Be=Kr,en=Be?function(r,e){return Be(r,"toString",{configurable:!0,enumerable:!1,value:(t=e,function(){return t}),writable:!0});var t}:Re,tn=(kt=en,De=0,Ge=0,function(){var r=Xr(),e=16-(r-Ge);if(Ge=r,e>0){if(++De>=800)return arguments[0]}else De=0;return kt.apply(void 0,arguments)});function rn(r){return r!=r}function nn(r,e){return!(r==null||!r.length)&&function(t,n,o){return n==n?function(s,i,l){for(var c=-1,d=s.length;++c<d;)if(s[c]===i)return c;return-1}(t,n):function(s,i,l,c){for(var d=s.length,h=-1;++h<d;)if(i(s[h],h,s))return h;return-1}(t,rn)}(r,e)>-1}var on=9007199254740991,sn=/^(?:0|[1-9]\d*)$/;function lt(r,e){var t=typeof r;return!!(e=e??on)&&(t=="number"||t!="symbol"&&sn.test(r))&&r>-1&&r%1==0&&r<e}function ct(r,e,t){e=="__proto__"&&Be?Be(r,e,{configurable:!0,enumerable:!0,value:t,writable:!0}):r[e]=t}function He(r,e){return r===e||r!=r&&e!=e}var an=Object.prototype.hasOwnProperty;function dr(r,e,t){var n=r[e];an.call(r,e)&&He(n,t)&&(t!==void 0||e in r)||ct(r,e,t)}function Fe(r,e,t,n){var o=!t;t||(t={});for(var s=-1,i=e.length;++s<i;){var l=e[s],c=void 0;c===void 0&&(c=r[l]),o?ct(t,l,c):dr(t,l,c)}return t}var Et=Math.max;function ur(r,e){return tn(function(t,n,o){return n=Et(n===void 0?t.length-1:n,0),function(){for(var s=arguments,i=-1,l=Et(s.length-n,0),c=Array(l);++i<l;)c[i]=s[n+i];i=-1;for(var d=Array(n+1);++i<n;)d[i]=s[i];return d[n]=o(c),function(h,m,p){switch(p.length){case 0:return h.call(m);case 1:return h.call(m,p[0]);case 2:return h.call(m,p[0],p[1]);case 3:return h.call(m,p[0],p[1],p[2])}return h.apply(m,p)}(t,this,d)}}(r,e,Re),r+"")}var ln=9007199254740991;function dt(r){return typeof r=="number"&&r>-1&&r%1==0&&r<=ln}function ve(r){return r!=null&&dt(r.length)&&!cr(r)}function Lt(r,e,t){if(!ie(t))return!1;var n=typeof e;return!!(n=="number"?ve(t)&&lt(e,t.length):n=="string"&&e in t)&&He(t[e],r)}var cn=Object.prototype;function ut(r){var e=r&&r.constructor;return r===(typeof e=="function"&&e.prototype||cn)}function At(r){return te(r)&&ye(r)=="[object Arguments]"}var hr=Object.prototype,dn=hr.hasOwnProperty,un=hr.propertyIsEnumerable,ht=At(function(){return arguments}())?At:function(r){return te(r)&&dn.call(r,"callee")&&!un.call(r,"callee")},pr=typeof V=="object"&&V&&!V.nodeType&&V,jt=pr&&typeof D=="object"&&D&&!D.nodeType&&D,Ft=jt&&jt.exports===pr?Q.Buffer:void 0,Ne=(Ft?Ft.isBuffer:void 0)||function(){return!1},T={};function We(r){return function(e){return r(e)}}T["[object Float32Array]"]=T["[object Float64Array]"]=T["[object Int8Array]"]=T["[object Int16Array]"]=T["[object Int32Array]"]=T["[object Uint8Array]"]=T["[object Uint8ClampedArray]"]=T["[object Uint16Array]"]=T["[object Uint32Array]"]=!0,T["[object Arguments]"]=T["[object Array]"]=T["[object ArrayBuffer]"]=T["[object Boolean]"]=T["[object DataView]"]=T["[object Date]"]=T["[object Error]"]=T["[object Function]"]=T["[object Map]"]=T["[object Number]"]=T["[object Object]"]=T["[object RegExp]"]=T["[object Set]"]=T["[object String]"]=T["[object WeakMap]"]=!1;var gr=typeof V=="object"&&V&&!V.nodeType&&V,_e=gr&&typeof D=="object"&&D&&!D.nodeType&&D,Ue=_e&&_e.exports===gr&&ir.process,me=function(){try{return _e&&_e.require&&_e.require("util").types||Ue&&Ue.binding&&Ue.binding("util")}catch{}}(),Mt=me&&me.isTypedArray,fr=Mt?We(Mt):function(r){return te(r)&&dt(r.length)&&!!T[ye(r)]},hn=Object.prototype.hasOwnProperty;function mr(r,e){var t=R(r),n=!t&&ht(r),o=!t&&!n&&Ne(r),s=!t&&!n&&!o&&fr(r),i=t||n||o||s,l=i?function(h,m){for(var p=-1,y=Array(h);++p<h;)y[p]=m(p);return y}(r.length,String):[],c=l.length;for(var d in r)!e&&!hn.call(r,d)||i&&(d=="length"||o&&(d=="offset"||d=="parent")||s&&(d=="buffer"||d=="byteLength"||d=="byteOffset")||lt(d,c))||l.push(d);return l}function yr(r,e){return function(t){return r(e(t))}}var pn=yr(Object.keys,Object),gn=Object.prototype.hasOwnProperty;function Ee(r){return ve(r)?mr(r):function(e){if(!ut(e))return pn(e);var t=[];for(var n in Object(e))gn.call(e,n)&&n!="constructor"&&t.push(n);return t}(r)}var fn=Object.prototype.hasOwnProperty;function mn(r){return ve(r)?mr(r,!0):function(e){if(!ie(e))return function(s){var i=[];if(s!=null)for(var l in Object(s))i.push(l);return i}(e);var t=ut(e),n=[];for(var o in e)(o!="constructor"||!t&&fn.call(e,o))&&n.push(o);return n}(r)}var yn=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,vn=/^\w*$/;function Ke(r,e){if(R(r))return!1;var t=typeof r;return!(t!="number"&&t!="symbol"&&t!="boolean"&&r!=null&&!fe(r))||vn.test(r)||!yn.test(r)||e!=null&&r in Object(e)}var xe=le(Object,"create"),wn=Object.prototype.hasOwnProperty,bn=Object.prototype.hasOwnProperty;function se(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var n=r[e];this.set(n[0],n[1])}}function Me(r,e){for(var t=r.length;t--;)if(He(r[t][0],e))return t;return-1}se.prototype.clear=function(){this.__data__=xe?xe(null):{},this.size=0},se.prototype.delete=function(r){var e=this.has(r)&&delete this.__data__[r];return this.size-=e?1:0,e},se.prototype.get=function(r){var e=this.__data__;if(xe){var t=e[r];return t==="__lodash_hash_undefined__"?void 0:t}return wn.call(e,r)?e[r]:void 0},se.prototype.has=function(r){var e=this.__data__;return xe?e[r]!==void 0:bn.call(e,r)},se.prototype.set=function(r,e){var t=this.__data__;return this.size+=this.has(r)?0:1,t[r]=xe&&e===void 0?"__lodash_hash_undefined__":e,this};var xn=Array.prototype.splice;function ee(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var n=r[e];this.set(n[0],n[1])}}ee.prototype.clear=function(){this.__data__=[],this.size=0},ee.prototype.delete=function(r){var e=this.__data__,t=Me(e,r);return!(t<0||(t==e.length-1?e.pop():xn.call(e,t,1),--this.size,0))},ee.prototype.get=function(r){var e=this.__data__,t=Me(e,r);return t<0?void 0:e[t][1]},ee.prototype.has=function(r){return Me(this.__data__,r)>-1},ee.prototype.set=function(r,e){var t=this.__data__,n=Me(t,r);return n<0?(++this.size,t.push([r,e])):t[n][1]=e,this};var ke=le(Q,"Map");function Oe(r,e){var t,n,o=r.__data__;return((n=typeof(t=e))=="string"||n=="number"||n=="symbol"||n=="boolean"?t!=="__proto__":t===null)?o[typeof e=="string"?"string":"hash"]:o.map}function K(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var n=r[e];this.set(n[0],n[1])}}function pt(r,e){if(typeof r!="function"||e!=null&&typeof e!="function")throw new TypeError("Expected a function");var t=function(){var n=arguments,o=e?e.apply(this,n):n[0],s=t.cache;if(s.has(o))return s.get(o);var i=r.apply(this,n);return t.cache=s.set(o,i)||s,i};return t.cache=new(pt.Cache||K),t}K.prototype.clear=function(){this.size=0,this.__data__={hash:new se,map:new(ke||ee),string:new se}},K.prototype.delete=function(r){var e=Oe(this,r).delete(r);return this.size-=e?1:0,e},K.prototype.get=function(r){return Oe(this,r).get(r)},K.prototype.has=function(r){return Oe(this,r).has(r)},K.prototype.set=function(r,e){var t=Oe(this,r),n=t.size;return t.set(r,e),this.size+=t.size==n?0:1,this},pt.Cache=K;var Ze,Ye,_n=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Cn=/\\(\\)?/g,kn=(Ze=pt(function(r){var e=[];return r.charCodeAt(0)===46&&e.push(""),r.replace(_n,function(t,n,o,s){e.push(o?s.replace(Cn,"$1"):n||t)}),e},function(r){return Ye.size===500&&Ye.clear(),r}),Ye=Ze.cache,Ze);function vr(r,e){return R(r)?r:Ke(r,e)?[r]:kn(function(t){return t==null?"":lr(t)}(r))}var Sn=1/0;function Pe(r){if(typeof r=="string"||fe(r))return r;var e=r+"";return e=="0"&&1/r==-Sn?"-0":e}function et(r,e){for(var t=0,n=(e=vr(e,r)).length;r!=null&&t<n;)r=r[Pe(e[t++])];return t&&t==n?r:void 0}function gt(r,e){for(var t=-1,n=e.length,o=r.length;++t<n;)r[o+t]=e[t];return r}var Ot=U?U.isConcatSpreadable:void 0;function En(r){return R(r)||ht(r)||!!(Ot&&r&&r[Ot])}function Ln(r,e,t,n,o){var s=-1,i=r.length;for(t||(t=En),o||(o=[]);++s<i;){var l=r[s];t(l)?gt(o,l):o[o.length]=l}return o}var wr=yr(Object.getPrototypeOf,Object);function Y(r){var e=this.__data__=new ee(r);this.size=e.size}Y.prototype.clear=function(){this.__data__=new ee,this.size=0},Y.prototype.delete=function(r){var e=this.__data__,t=e.delete(r);return this.size=e.size,t},Y.prototype.get=function(r){return this.__data__.get(r)},Y.prototype.has=function(r){return this.__data__.has(r)},Y.prototype.set=function(r,e){var t=this.__data__;if(t instanceof ee){var n=t.__data__;if(!ke||n.length<199)return n.push([r,e]),this.size=++t.size,this;t=this.__data__=new K(n)}return t.set(r,e),this.size=t.size,this};var br=typeof V=="object"&&V&&!V.nodeType&&V,$t=br&&typeof D=="object"&&D&&!D.nodeType&&D,It=$t&&$t.exports===br?Q.Buffer:void 0,Pt=It?It.allocUnsafe:void 0;function xr(){return[]}var An=Object.prototype.propertyIsEnumerable,Tt=Object.getOwnPropertySymbols,jn=Tt?function(r){return r==null?[]:(r=Object(r),function(e,t){for(var n=-1,o=e==null?0:e.length,s=0,i=[];++n<o;){var l=e[n];An.call(r,l)&&(i[s++]=l)}return i}(Tt(r)))}:xr,ft=jn,Fn=Object.getOwnPropertySymbols?function(r){for(var e=[];r;)gt(e,ft(r)),r=wr(r);return e}:xr;function Mn(r,e,t){var n=e(r);return R(r)?n:gt(n,t(r))}function tt(r){return Mn(r,Ee,ft)}var rt=le(Q,"DataView"),nt=le(Q,"Promise"),ot=le(Q,"Set"),Bt="[object Map]",Nt="[object Promise]",zt="[object Set]",Rt="[object WeakMap]",Ht="[object DataView]",On=ae(rt),$n=ae(ke),In=ae(nt),Pn=ae(ot),Tn=ae(Xe),oe=ye;(rt&&oe(new rt(new ArrayBuffer(1)))!=Ht||ke&&oe(new ke)!=Bt||nt&&oe(nt.resolve())!=Nt||ot&&oe(new ot)!=zt||Xe&&oe(new Xe)!=Rt)&&(oe=function(r){var e=ye(r),t=e=="[object Object]"?r.constructor:void 0,n=t?ae(t):"";if(n)switch(n){case On:return Ht;case $n:return Bt;case In:return Nt;case Pn:return zt;case Tn:return Rt}return e});var Se=oe,Bn=Object.prototype.hasOwnProperty,ze=Q.Uint8Array;function Nn(r){var e=new r.constructor(r.byteLength);return new ze(e).set(new ze(r)),e}var zn=/\w*$/,Wt=U?U.prototype:void 0,qt=Wt?Wt.valueOf:void 0,Rn="[object Boolean]",Hn="[object Date]",Wn="[object Map]",qn="[object Number]",Vn="[object RegExp]",Dn="[object Set]",Gn="[object String]",Un="[object Symbol]",Zn="[object ArrayBuffer]",Yn="[object DataView]",Qn="[object Float32Array]",Jn="[object Float64Array]",Xn="[object Int8Array]",Kn="[object Int16Array]",eo="[object Int32Array]",to="[object Uint8Array]",ro="[object Uint8ClampedArray]",no="[object Uint16Array]",oo="[object Uint32Array]",Vt=me&&me.isMap,so=Vt?We(Vt):function(r){return te(r)&&Se(r)=="[object Map]"},Dt=me&&me.isSet,io=Dt?We(Dt):function(r){return te(r)&&Se(r)=="[object Set]"},ao=1,lo=2,_r="[object Arguments]",Cr="[object Function]",co="[object GeneratorFunction]",kr="[object Object]",I={};function Te(r,e,t,n,o,s){var i,l=e&ao,c=e&lo;if(i!==void 0)return i;if(!ie(r))return r;var d=R(r);if(d){if(i=function(g){var v=g.length,k=new g.constructor(v);return v&&typeof g[0]=="string"&&Bn.call(g,"index")&&(k.index=g.index,k.input=g.input),k}(r),!l)return function(g,v){var k=-1,S=g.length;for(v||(v=Array(S));++k<S;)v[k]=g[k];return v}(r,i)}else{var h=Se(r),m=h==Cr||h==co;if(Ne(r))return function(g,v){var k=g.length,S=Pt?Pt(k):new g.constructor(k);return g.copy(S),S}(r);if(h==kr||h==_r||m&&!o){if(i=m?{}:function(g){return typeof g.constructor!="function"||ut(g)?{}:Jr(wr(g))}(r),!l)return c?function(g,v){return Fe(g,Fn(g),v)}(r,function(g,v){return g&&Fe(v,mn(v),g)}(i,r)):function(g,v){return Fe(g,ft(g),v)}(r,function(g,v){return g&&Fe(v,Ee(v),g)}(i,r))}else{if(!I[h])return o?r:{};i=function(g,v,k){var S,M,P=g.constructor;switch(v){case Zn:return Nn(g);case Rn:case Hn:return new P(+g);case Yn:return function(A,N){var _=A.buffer;return new A.constructor(_,A.byteOffset,A.byteLength)}(g);case Qn:case Jn:case Xn:case Kn:case eo:case to:case ro:case no:case oo:return function(A,N){var _=A.buffer;return new A.constructor(_,A.byteOffset,A.length)}(g);case Wn:return new P;case qn:case Gn:return new P(g);case Vn:return(M=new(S=g).constructor(S.source,zn.exec(S))).lastIndex=S.lastIndex,M;case Dn:return new P;case Un:return qt?Object(qt.call(g)):{}}}(r,h)}}s||(s=new Y);var p=s.get(r);if(p)return p;s.set(r,i),io(r)?r.forEach(function(g){i.add(Te(g,e,t,g,r,s))}):so(r)&&r.forEach(function(g,v){i.set(v,Te(g,e,t,v,r,s))});var y=d?void 0:tt(r);return function(g,v){for(var k=-1,S=g==null?0:g.length;++k<S&&v(g[k],k)!==!1;);}(y||r,function(g,v){y&&(g=r[v=g]),dr(i,v,Te(g,e,t,v,r,s))}),i}function Qe(r){return Te(r,4)}function Ce(r){var e=-1,t=r==null?0:r.length;for(this.__data__=new K;++e<t;)this.add(r[e])}function uo(r,e){for(var t=-1,n=r==null?0:r.length;++t<n;)if(e(r[t],t,r))return!0;return!1}function st(r,e){return r.has(e)}I[_r]=I["[object Array]"]=I["[object ArrayBuffer]"]=I["[object DataView]"]=I["[object Boolean]"]=I["[object Date]"]=I["[object Float32Array]"]=I["[object Float64Array]"]=I["[object Int8Array]"]=I["[object Int16Array]"]=I["[object Int32Array]"]=I["[object Map]"]=I["[object Number]"]=I[kr]=I["[object RegExp]"]=I["[object Set]"]=I["[object String]"]=I["[object Symbol]"]=I["[object Uint8Array]"]=I["[object Uint8ClampedArray]"]=I["[object Uint16Array]"]=I["[object Uint32Array]"]=!0,I["[object Error]"]=I[Cr]=I["[object WeakMap]"]=!1,Ce.prototype.add=Ce.prototype.push=function(r){return this.__data__.set(r,"__lodash_hash_undefined__"),this},Ce.prototype.has=function(r){return this.__data__.has(r)};var ho=1,po=2;function Gt(r,e,t,n,o,s){var i=t&ho,l=r.length,c=e.length;if(l!=c&&!(i&&c>l))return!1;var d=s.get(r),h=s.get(e);if(d&&h)return d==e&&h==r;var m=-1,p=!0,y=t&po?new Ce:void 0;for(s.set(r,e),s.set(e,r);++m<l;){var g=r[m],v=e[m];if(n)var k=i?n(v,g,m,e,r,s):n(g,v,m,r,e,s);if(k!==void 0){if(k)continue;p=!1;break}if(y){if(!uo(e,function(S,M){if(!st(y,M)&&(g===S||o(g,S,t,n,s)))return y.push(M)})){p=!1;break}}else if(g!==v&&!o(g,v,t,n,s)){p=!1;break}}return s.delete(r),s.delete(e),p}function go(r){var e=-1,t=Array(r.size);return r.forEach(function(n,o){t[++e]=[o,n]}),t}function fo(r){var e=-1,t=Array(r.size);return r.forEach(function(n){t[++e]=n}),t}var mo=1,yo=2,vo="[object Boolean]",wo="[object Date]",bo="[object Error]",xo="[object Map]",_o="[object Number]",Co="[object RegExp]",ko="[object Set]",So="[object String]",Eo="[object Symbol]",Lo="[object ArrayBuffer]",Ao="[object DataView]",Ut=U?U.prototype:void 0,Je=Ut?Ut.valueOf:void 0,jo=1,Fo=Object.prototype.hasOwnProperty,Mo=1,Zt="[object Arguments]",Yt="[object Array]",$e="[object Object]",Qt=Object.prototype.hasOwnProperty;function it(r,e,t,n,o){return r===e||(r==null||e==null||!te(r)&&!te(e)?r!=r&&e!=e:function(s,i,l,c,d,h){var m=R(s),p=R(i),y=m?Yt:Se(s),g=p?Yt:Se(i),v=(y=y==Zt?$e:y)==$e,k=(g=g==Zt?$e:g)==$e,S=y==g;if(S&&Ne(s)){if(!Ne(i))return!1;m=!0,v=!1}if(S&&!v)return h||(h=new Y),m||fr(s)?Gt(s,i,l,c,d,h):function(_,E,B,H,re,W,G){switch(B){case Ao:if(_.byteLength!=E.byteLength||_.byteOffset!=E.byteOffset)return!1;_=_.buffer,E=E.buffer;case Lo:return!(_.byteLength!=E.byteLength||!W(new ze(_),new ze(E)));case vo:case wo:case _o:return He(+_,+E);case bo:return _.name==E.name&&_.message==E.message;case Co:case So:return _==E+"";case xo:var Z=go;case ko:if(Z||(Z=fo),_.size!=E.size&&!(H&mo))return!1;var J=G.get(_);if(J)return J==E;H|=yo,G.set(_,E);var X=Gt(Z(_),Z(E),H,re,W,G);return G.delete(_),X;case Eo:if(Je)return Je.call(_)==Je.call(E)}return!1}(s,i,y,l,c,d,h);if(!(l&Mo)){var M=v&&Qt.call(s,"__wrapped__"),P=k&&Qt.call(i,"__wrapped__");if(M||P){var A=M?s.value():s,N=P?i.value():i;return h||(h=new Y),d(A,N,l,c,h)}}return!!S&&(h||(h=new Y),function(_,E,B,H,re,W){var G=B&jo,Z=tt(_),J=Z.length;if(J!=tt(E).length&&!G)return!1;for(var X=J;X--;){var f=Z[X];if(!(G?f in E:Fo.call(E,f)))return!1}var a=W.get(_),u=W.get(E);if(a&&u)return a==E&&u==_;var w=!0;W.set(_,E),W.set(E,_);for(var b=G;++X<J;){var x=_[f=Z[X]],C=E[f];if(H)var O=G?H(C,x,f,E,_,W):H(x,C,f,_,E,W);if(!(O===void 0?x===C||re(x,C,B,H,W):O)){w=!1;break}b||(b=f=="constructor")}if(w&&!b){var z=_.constructor,$=E.constructor;z==$||!("constructor"in _)||!("constructor"in E)||typeof z=="function"&&z instanceof z&&typeof $=="function"&&$ instanceof $||(w=!1)}return W.delete(_),W.delete(E),w}(s,i,l,c,d,h))}(r,e,t,n,it,o))}var Oo=1,$o=2;function Jt(r){return r==r&&!ie(r)}function Xt(r,e){return function(t){return t!=null&&t[r]===e&&(e!==void 0||r in Object(t))}}function Io(r,e){return r!=null&&e in Object(r)}var Po=1,To=2;function ce(r){return typeof r=="function"?r:r==null?Re:typeof r=="object"?R(r)?function(s,i){return Ke(s)&&Jt(i)?Xt(Pe(s),i):function(l){var c=function(d,h,m){var p=d==null?void 0:et(d,h);return p===void 0?void 0:p}(l,s);return c===void 0&&c===i?function(d,h){return d!=null&&function(m,p,y){for(var g=-1,v=(p=vr(p,m)).length,k=!1;++g<v;){var S=Pe(p[g]);if(!(k=m!=null&&y(m,S)))break;m=m[S]}return k||++g!=v?k:!!(v=m==null?0:m.length)&&dt(v)&&lt(S,v)&&(R(m)||ht(m))}(d,h,Io)}(l,s):it(i,c,Po|To)}}(r[0],r[1]):(o=function(s){for(var i=Ee(s),l=i.length;l--;){var c=i[l],d=s[c];i[l]=[c,d,Jt(d)]}return i}(n=r),o.length==1&&o[0][2]?Xt(o[0][0],o[0][1]):function(s){return s===n||function(i,l,c,d){var h=c.length,m=h;if(i==null)return!m;for(i=Object(i);h--;){var p=c[h];if(p[2]?p[1]!==i[p[0]]:!(p[0]in i))return!1}for(;++h<m;){var y=(p=c[h])[0],g=i[y],v=p[1];if(p[2]){if(g===void 0&&!(y in i))return!1}else{var k=new Y;if(!it(v,g,Oo|$o,void 0,k))return!1}}return!0}(s,0,o)}):Ke(e=r)?(t=Pe(e),function(s){return s==null?void 0:s[t]}):function(s){return function(i){return et(i,s)}}(e);var e,t,n,o}var Bo=function(r,e,t){for(var n=-1,o=Object(r),s=t(r),i=s.length;i--;){var l=s[++n];if(e(o[l],l,o)===!1)break}return r};function Sr(r,e){return r&&Bo(r,e,Ee)}var Kt,No=(Kt=Sr,function(r,e){if(r==null)return r;if(!ve(r))return Kt(r,e);for(var t=r.length,n=-1,o=Object(r);++n<t&&e(o[n],n,o)!==!1;);return r});function Er(r,e){var t=-1,n=ve(r)?Array(r.length):[];return No(r,function(o,s,i){n[++t]=e(o,s,i)}),n}function zo(r,e){return r>e}var Ro=Math.min;function Ho(r){return function(e){return te(e)&&ve(e)}(r)?r:[]}var Wo=ur(function(r){var e=ge(r,Ho);return e.length&&e[0]===r[0]?function(t,n,o){for(var s=nn,i=t[0].length,l=t.length,c=l,d=Array(l),h=1/0,m=[];c--;){var p=t[c];h=Ro(p.length,h),d[c]=i>=120&&p.length>=120?new Ce(c&&p):void 0}p=t[0];var y=-1,g=d[0];e:for(;++y<i&&m.length<h;){var v=p[y],k=v;if(v=v!==0?v:0,!(g?st(g,k):s(m,k,o))){for(c=l;--c;){var S=d[c];if(!(S?st(S,k):s(t[c],k,o)))continue e}g&&g.push(k),m.push(v)}}return m}(e):[]}),qo=Wo;function Vo(r,e){return r<e}function F(r,e){var t={};return e=ce(e),Sr(r,function(n,o,s){ct(t,o,e(n,o,s))}),t}function Lr(r,e,t){for(var n=-1,o=r.length;++n<o;){var s=r[n],i=e(s);if(i!=null&&(l===void 0?i==i&&!fe(i):t(i,l)))var l=i,c=s}return c}function Do(r,e){return r&&r.length?Lr(r,ce(e),zo):void 0}function Ar(r,e){for(var t,n=-1,o=r.length;++n<o;){var s=e(r[n]);s!==void 0&&(t=t===void 0?s:t+s)}return t}function Go(r,e){return function(t,n){var o=t==null?0:t.length;return o?Ar(t,n)/o:NaN}(r,ce(e))}function Uo(r,e){if(r!==e){var t=r!==void 0,n=r===null,o=r==r,s=fe(r),i=e!==void 0,l=e===null,c=e==e,d=fe(e);if(!l&&!d&&!s&&r>e||s&&i&&c&&!l&&!d||n&&i&&c||!t&&c||!o)return 1;if(!n&&!s&&!d&&r<e||d&&t&&o&&!n&&!s||l&&t&&o||!i&&o||!c)return-1}return 0}function jr(r,e,t){e=e.length?ge(e,function(o){return R(o)?function(s){return et(s,o.length===1?o[0]:o)}:o}):[Re];var n=-1;return e=ge(e,We(ce)),function(o,s){var i=o.length;for(o.sort(function(l,c){return function(d,h,m){for(var p=-1,y=d.criteria,g=h.criteria,v=y.length,k=m.length;++p<v;){var S=Uo(y[p],g[p]);if(S)return p>=k?S:S*(m[p]=="desc"?-1:1)}return d.index-h.index}(l,c,t)});i--;)o[i]=o[i].value;return o}(Er(r,function(o,s,i){return{criteria:ge(e,function(l){return l(o)}),index:++n,value:o}}))}function mt(r,e,t,n){return r==null?[]:(R(e)||(e=e==null?[]:[e]),R(t=t)||(t=t==null?[]:[t]),jr(r,e,t))}var Zo=ur(function(r,e){if(r==null)return[];var t=e.length;return t>1&&Lt(r,e[0],e[1])?e=[]:t>2&&Lt(e[0],e[1],e[2])&&(e=[e[0]]),jr(r,Ln(e),[])});function Yo(r,e){return r&&r.length?Ar(r,ce(e)):0}function j(r){if(this.words=[],r)if(Symbol&&Symbol.iterator&&r[Symbol.iterator]!==void 0){const e=r[Symbol.iterator]();let t=e.next();for(;!t.done;)this.add(t.value),t=e.next()}else for(let e=0;e<r.length;e++)this.add(r[e])}j.fromWords=function(r){const e=Object.create(j.prototype);return e.words=r,e},j.prototype.add=function(r){this.resize(r),this.words[r>>>5]|=1<<r},j.prototype.flip=function(r){this.resize(r),this.words[r>>>5]^=1<<r},j.prototype.clear=function(){this.words.length=0},j.prototype.remove=function(r){this.resize(r),this.words[r>>>5]&=~(1<<r)},j.prototype.isEmpty=function(r){const e=this.words.length;for(let t=0;t<e;t++)if(this.words[t]!==0)return!1;return!0},j.prototype.has=function(r){return(this.words[r>>>5]&1<<r)!=0},j.prototype.checkedAdd=function(r){this.resize(r);const e=this.words[r>>>5],t=e|1<<r;return this.words[r>>>5]=t,(t^e)>>>r},j.prototype.trim=function(r){let e=this.words.length;for(;e>0&&this.words[e-1]===0;)e--;this.words.length=e},j.prototype.resize=function(r){const e=r+32>>>5;for(let t=this.words.length;t<e;t++)this.words[t]=0},j.prototype.hammingWeight=function(r){return 16843009*((r=(858993459&(r-=r>>>1&1431655765))+(r>>>2&858993459))+(r>>>4)&252645135)>>>24},j.prototype.hammingWeight4=function(r,e,t,n){return 16843009*((r=(r=(858993459&(r-=r>>>1&1431655765))+(r>>>2&858993459))+(r>>>4)&252645135)+(e=(e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)+(t=(t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)+(n=(n=(858993459&(n-=n>>>1&1431655765))+(n>>>2&858993459))+(n>>>4)&252645135))>>>24},j.prototype.size=function(){let r=0;const e=this.words.length,t=this.words;for(let n=0;n<e;n++)r+=this.hammingWeight(t[n]);return r},j.prototype.array=function(){const r=new Array(this.size());let e=0;const t=this.words.length;for(let n=0;n<t;++n){let o=this.words[n];for(;o!=0;){const s=o&-o;r[e++]=(n<<5)+this.hammingWeight(s-1|0),o^=s}}return r},j.prototype.forEach=function(r){const e=this.words.length;for(let t=0;t<e;++t){let n=this.words[t];for(;n!=0;){const o=n&-n;r((t<<5)+this.hammingWeight(o-1|0)),n^=o}}},j.prototype[Symbol.iterator]=function(){const r=this.words.length;let e=0,t=this.words[e],n=this.hammingWeight,o=this.words;return{[Symbol.iterator](){return this},next(){for(;e<r;){if(t!==0){const s=t&-t,i=(e<<5)+n(s-1|0);return t^=s,{done:!1,value:i}}e++,e<r&&(t=o[e])}return{done:!0,value:void 0}}}},j.prototype.clone=function(){const r=Object.create(j.prototype);return r.words=this.words.slice(),r},j.prototype.intersects=function(r){const e=Math.min(this.words.length,r.words.length);for(let t=0;t<e;++t)if(this.words[t]&r.words[t])return!0;return!1},j.prototype.intersection=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]&=r.words[t],this.words[t+1]&=r.words[t+1],this.words[t+2]&=r.words[t+2],this.words[t+3]&=r.words[t+3],this.words[t+4]&=r.words[t+4],this.words[t+5]&=r.words[t+5],this.words[t+6]&=r.words[t+6],this.words[t+7]&=r.words[t+7];for(;t<e;++t)this.words[t]&=r.words[t];const n=this.words.length;for(t=e;t<n;++t)this.words[t]=0;return this},j.prototype.intersection_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(let n=0;n<e;++n)t+=this.hammingWeight(this.words[n]&r.words[n]);return t},j.prototype.new_intersection=function(r){const e=Object.create(j.prototype),t=Math.min(this.words.length,r.words.length);e.words=new Array(t);let n=0;for(;n+7<t;n+=8)e.words[n]=this.words[n]&r.words[n],e.words[n+1]=this.words[n+1]&r.words[n+1],e.words[n+2]=this.words[n+2]&r.words[n+2],e.words[n+3]=this.words[n+3]&r.words[n+3],e.words[n+4]=this.words[n+4]&r.words[n+4],e.words[n+5]=this.words[n+5]&r.words[n+5],e.words[n+6]=this.words[n+6]&r.words[n+6],e.words[n+7]=this.words[n+7]&r.words[n+7];for(;n<t;++n)e.words[n]=this.words[n]&r.words[n];return e},j.prototype.equals=function(r){const e=Math.min(this.words.length,r.words.length);for(let t=0;t<e;++t)if(this.words[t]!=r.words[t])return!1;if(this.words.length<r.words.length){const t=r.words.length;for(let n=this.words.length;n<t;++n)if(r.words[n]!=0)return!1}else if(r.words.length<this.words.length){const t=this.words.length;for(let n=r.words.length;n<t;++n)if(this.words[n]!=0)return!1}return!0},j.prototype.difference=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]&=~r.words[t],this.words[t+1]&=~r.words[t+1],this.words[t+2]&=~r.words[t+2],this.words[t+3]&=~r.words[t+3],this.words[t+4]&=~r.words[t+4],this.words[t+5]&=~r.words[t+5],this.words[t+6]&=~r.words[t+6],this.words[t+7]&=~r.words[t+7];for(;t<e;++t)this.words[t]&=~r.words[t];return this},j.prototype.new_difference=function(r){return this.clone().difference(r)},j.prototype.difference2=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)r.words[t]=this.words[t]&~r.words[t],r.words[t+1]=this.words[t+1]&~r.words[t+1],r.words[t+2]=this.words[t+2]&~r.words[t+2],r.words[t+3]=this.words[t+3]&~r.words[t+3],r.words[t+4]=this.words[t+4]&~r.words[t+4],r.words[t+5]=this.words[t+5]&~r.words[t+5],r.words[t+6]=this.words[t+6]&~r.words[t+6],r.words[t+7]=this.words[t+7]&~r.words[t+7];for(;t<e;++t)r.words[t]=this.words[t]&~r.words[t];for(t=this.words.length-1;t>=e;--t)r.words[t]=this.words[t];return r.words.length=this.words.length,r},j.prototype.difference_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0,n=0;for(;n<e;++n)t+=this.hammingWeight(this.words[n]&~r.words[n]);const o=this.words.length;for(;n<o;++n)t+=this.hammingWeight(this.words[n]);return t},j.prototype.change=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]^=r.words[t],this.words[t+1]^=r.words[t+1],this.words[t+2]^=r.words[t+2],this.words[t+3]^=r.words[t+3],this.words[t+4]^=r.words[t+4],this.words[t+5]^=r.words[t+5],this.words[t+6]^=r.words[t+6],this.words[t+7]^=r.words[t+7];for(;t<e;++t)this.words[t]^=r.words[t];for(t=r.words.length-1;t>=e;--t)this.words[t]=r.words[t];return this},j.prototype.new_change=function(r){const e=Object.create(j.prototype),t=Math.max(this.words.length,r.words.length);e.words=new Array(t);const n=Math.min(this.words.length,r.words.length);let o=0;for(;o+7<n;o+=8)e.words[o]=this.words[o]^r.words[o],e.words[o+1]=this.words[o+1]^r.words[o+1],e.words[o+2]=this.words[o+2]^r.words[o+2],e.words[o+3]=this.words[o+3]^r.words[o+3],e.words[o+4]=this.words[o+4]^r.words[o+4],e.words[o+5]=this.words[o+5]^r.words[o+5],e.words[o+6]=this.words[o+6]^r.words[o+6],e.words[o+7]=this.words[o+7]^r.words[o+7];for(;o<n;++o)e.words[o]=this.words[o]^r.words[o];const s=this.words.length;for(o=n;o<s;++o)e.words[o]=this.words[o];const i=r.words.length;for(o=n;o<i;++o)e.words[o]=r.words[o];return e},j.prototype.change_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0,n=0;for(;n<e;++n)t+=this.hammingWeight(this.words[n]^r.words[n]);const o=this.words.length>r.words.length?this:r,s=o.words.length;for(;n<s;++n)t+=this.hammingWeight(o.words[n]);return t},j.prototype.toString=function(){return"{"+this.array().join(",")+"}"},j.prototype.union=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(;t+7<e;t+=8)this.words[t]|=r.words[t],this.words[t+1]|=r.words[t+1],this.words[t+2]|=r.words[t+2],this.words[t+3]|=r.words[t+3],this.words[t+4]|=r.words[t+4],this.words[t+5]|=r.words[t+5],this.words[t+6]|=r.words[t+6],this.words[t+7]|=r.words[t+7];for(;t<e;++t)this.words[t]|=r.words[t];if(this.words.length<r.words.length){this.resize((r.words.length<<5)-1);const n=r.words.length;for(let o=e;o<n;++o)this.words[o]=r.words[o]}return this},j.prototype.new_union=function(r){const e=Object.create(j.prototype),t=Math.max(this.words.length,r.words.length);e.words=new Array(t);const n=Math.min(this.words.length,r.words.length);let o=0;for(;o+7<n;o+=8)e.words[o]=this.words[o]|r.words[o],e.words[o+1]=this.words[o+1]|r.words[o+1],e.words[o+2]=this.words[o+2]|r.words[o+2],e.words[o+3]=this.words[o+3]|r.words[o+3],e.words[o+4]=this.words[o+4]|r.words[o+4],e.words[o+5]=this.words[o+5]|r.words[o+5],e.words[o+6]=this.words[o+6]|r.words[o+6],e.words[o+7]=this.words[o+7]|r.words[o+7];for(;o<n;++o)e.words[o]=this.words[o]|r.words[o];const s=this.words.length;for(o=n;o<s;++o)e.words[o]=this.words[o];const i=r.words.length;for(o=n;o<i;++o)e.words[o]=r.words[o];return e},j.prototype.union_size=function(r){const e=Math.min(this.words.length,r.words.length);let t=0;for(let n=0;n<e;++n)t+=this.hammingWeight(this.words[n]|r.words[n]);if(this.words.length<r.words.length){const n=r.words.length;for(let o=this.words.length;o<n;++o)t+=this.hammingWeight(0|r.words[o])}else{const n=this.words.length;for(let o=r.words.length;o<n;++o)t+=this.hammingWeight(0|this.words[o])}return t};var q=j;function at(){return at=Object.assign||function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r},at.apply(this,arguments)}function Qo(r,e){var t=[];return r.forEach(function(n){e.forEach(function(o){t.push(n.concat(o))})}),t}function Fr(r){return!!~r.search(/\(|\)/)}function er(r,e){for(var t=e.split(" "+r+" "),n=[],o=[],s=0;s<t.length;s++)if(Fr(t[s])||o.length>0){o.push(t[s]);var i=""+o;(i.match(/\(/g)||[]).length===(i.match(/\)/g)||[]).length&&(n.push(o.join(" "+r+" ")),o=[])}else n.push(t[s]);return n}var Jo=function r(e){return function(n){for(var o=n[0],s=1;s<n.length;s++)o=o.concat(n[s]);return o}(er("OR",(t=e=function(n){if(n.charAt(0)==="("){for(var o=0,s=0;s<n.length;s++)if(n.charAt(s)==="("?o++:n.charAt(s)===")"&&o--,o===0)return s!==n.length-1?n:n.substring(1,n.length-1)}return n}(e),e=t.replace(/[\s]+/g," "))).map(function(n){for(var o=er("AND",n),s=[],i=[],l=0;l<o.length;l++)Fr(o[l])?s.push(r(o[l])):i.push(o[l]);return s.push([i]),function(c){for(var d=[[]],h=0;h<c.length;h++)d=Qo(d,c[h]);return d}(s)}));var t};const tr=function(r){try{return structuredClone(r)}catch{try{return JSON.parse(JSON.stringify(r))}catch{return r}}},rr=function(r,e){let t=new q([]),n=0;return F(e,function(o,s){o.forEach(i=>{++n,t=t.new_union(r[s][i]||new q([]))})}),n===0?null:t},Xo=function(r,e,t){let n=1;return F(r.bits_data_temp,(o,s)=>{let i,l,c,d,h,m,p;t[s]&&(i=t[s].order,l=t[s].sort,c=t[s].size,d=t[s].title,h=t[s].show_facet_stats||!1,m=t[s].chosen_filters_on_top!==!1,p=t[s].hide_zero_doc_count||!1);let y,g,v,k,S=Object.entries(o).map(A=>{let N=[];e&&e.filters&&e.filters[s]&&(N=e.filters[s]);const _=A[1].array().length;if(!p||_!==0||N.indexOf(A[0])!==-1)return{key:A[0],doc_count:_,selected:N.indexOf(A[0])!==-1}}).filter(Boolean);var M,P;return R(l)?(y=l||["key"],g=i||["asc"]):(l==="term"||l==="key"?(y=["key"],g=[i||"asc"]):(y=["doc_count","key"],g=[i||"desc","asc"]),m&&(y.unshift("selected"),g.unshift("desc"))),S=mt(S,y,g),S=S.slice(0,c||10),h&&(v=[],Object.entries(o).forEach(A=>{if(isNaN(A[0]))throw new Error("You cant use chars to calculate the facet_stats.");A[1].array().length>0&&A[1].forEach(()=>{v.push(parseInt(A[0]))})}),k={min:(M=v,M&&M.length?Lr(M,ce(void 0),Vo):void 0),max:Do(v),avg:Go(v),sum:Yo(v)}),at({name:s,title:d||(P=s,P.replace(/^[\s_]+|[\s_]+$/g,"").replace(/[_\s]+/g," ").replace(/^[a-z]/,function(A){return A.toUpperCase()})),position:n++,buckets:S},h&&{facet_stats:k})})};function nr(r,e,t,n,o){e=e||Object.create(null);const s=parseInt(e.per_page||12),i=parseInt(e.page||1),l=e.is_all_filtered_items||!1;if(t.native_search_enabled===!1&&(e.query||e.filter))throw new Error('"query" and "filter" options are not working once native search is disabled');let c=0;const d=new Date().getTime();let h,m,p,y=o.bits_ids();if(e._ids)h=new q(e._ids),m=e._ids;else if(e.ids)m=o.internal_ids_from_ids_map(e.ids),h=new q(m);else if(n&&(e.query||e.filter)){const _=new Date().getTime();m=n.search(e.query,e.filter),c=new Date().getTime()-_,h=new q(m)}let g=new Date().getTime();const v=o.search(e,{query_ids:h});g=new Date().getTime()-g,h&&(y=h),v.ids&&(y=y.new_intersection(v.ids)),v.not_ids&&(y=y.new_difference(v.not_ids));let k=y.array(),S=k.map(_=>o.get_item(_)),M=!1;const P=new Date().getTime();let A=0;e.sort?S=function(_,E,B){return B&&B[E]&&(E=B[E]),E.field?mt(_,E.field,E.order||"asc"):_}(S,e.sort,t.sortings):m&&(k=m.filter(_=>y.has(_)),S=k.slice((i-1)*s,i*s).map(_=>o.get_item(_)),M=!0),M||(p=l?S:null,S=S.slice((i-1)*s,i*s)),A=new Date().getTime()-P;const N=new Date().getTime()-d;return{pagination:{per_page:s,page:i,total:k.length},timings:{total:N,facets:g,search:c,sorting:A},data:{items:S,allFilteredItems:p,aggregations:Xo(v,e,t.aggregations)}}}var Ie=function(r){var e={exports:{}};return function(t,n){(function(){var o,s,i,l,c,d,h,m,p,y,g,v,k,S,M,P,A,N,_,E,B,H,re,W,G,Z,J,X,f=function(a){var u=new f.Index;return u.pipeline.add(f.trimmer,f.stopWordFilter,f.stemmer),a&&a.call(u,u),u};f.version="1.0.0",f.utils={},f.utils.warn=function(a){return function(u){a.console&&console.warn&&console.warn(u)}}(this),f.utils.asString=function(a){return a==null?"":a.toString()},f.EventEmitter=function(){this.events={}},f.EventEmitter.prototype.addListener=function(){var a=Array.prototype.slice.call(arguments),u=a.pop(),w=a;if(typeof u!="function")throw new TypeError("last argument must be a function");w.forEach(function(b){this.hasHandler(b)||(this.events[b]=[]),this.events[b].push(u)},this)},f.EventEmitter.prototype.removeListener=function(a,u){if(this.hasHandler(a)){var w=this.events[a].indexOf(u);this.events[a].splice(w,1),this.events[a].length||delete this.events[a]}},f.EventEmitter.prototype.emit=function(a){if(this.hasHandler(a)){var u=Array.prototype.slice.call(arguments,1);this.events[a].forEach(function(w){w.apply(void 0,u)})}},f.EventEmitter.prototype.hasHandler=function(a){return a in this.events},f.tokenizer=function(a){return arguments.length&&a!=null&&a!=null?Array.isArray(a)?a.map(function(u){return f.utils.asString(u).toLowerCase()}):a.toString().trim().toLowerCase().split(f.tokenizer.separator):[]},f.tokenizer.separator=/[\s\-]+/,f.tokenizer.load=function(a){var u=this.registeredFunctions[a];if(!u)throw new Error("Cannot load un-registered function: "+a);return u},f.tokenizer.label="default",f.tokenizer.registeredFunctions={default:f.tokenizer},f.tokenizer.registerFunction=function(a,u){u in this.registeredFunctions&&f.utils.warn("Overwriting existing tokenizer: "+u),a.label=u,this.registeredFunctions[u]=a},f.Pipeline=function(){this._stack=[]},f.Pipeline.registeredFunctions={},f.Pipeline.registerFunction=function(a,u){u in this.registeredFunctions&&f.utils.warn("Overwriting existing registered function: "+u),a.label=u,f.Pipeline.registeredFunctions[a.label]=a},f.Pipeline.warnIfFunctionNotRegistered=function(a){a.label&&a.label in this.registeredFunctions||f.utils.warn(`Function is not registered with pipeline. This may cause problems when serialising the index.
`,a)},f.Pipeline.load=function(a){var u=new f.Pipeline;return a.forEach(function(w){var b=f.Pipeline.registeredFunctions[w];if(!b)throw new Error("Cannot load un-registered function: "+w);u.add(b)}),u},f.Pipeline.prototype.add=function(){Array.prototype.slice.call(arguments).forEach(function(a){f.Pipeline.warnIfFunctionNotRegistered(a),this._stack.push(a)},this)},f.Pipeline.prototype.after=function(a,u){f.Pipeline.warnIfFunctionNotRegistered(u);var w=this._stack.indexOf(a);if(w==-1)throw new Error("Cannot find existingFn");this._stack.splice(w+=1,0,u)},f.Pipeline.prototype.before=function(a,u){f.Pipeline.warnIfFunctionNotRegistered(u);var w=this._stack.indexOf(a);if(w==-1)throw new Error("Cannot find existingFn");this._stack.splice(w,0,u)},f.Pipeline.prototype.remove=function(a){var u=this._stack.indexOf(a);u!=-1&&this._stack.splice(u,1)},f.Pipeline.prototype.run=function(a){for(var u=[],w=a.length,b=this._stack.length,x=0;x<w;x++){for(var C=a[x],O=0;O<b&&(C=this._stack[O](C,x,a))!==void 0&&C!=="";O++);C!==void 0&&C!==""&&u.push(C)}return u},f.Pipeline.prototype.reset=function(){this._stack=[]},f.Pipeline.prototype.toJSON=function(){return this._stack.map(function(a){return f.Pipeline.warnIfFunctionNotRegistered(a),a.label})},f.Vector=function(){this._magnitude=null,this.list=void 0,this.length=0},f.Vector.Node=function(a,u,w){this.idx=a,this.val=u,this.next=w},f.Vector.prototype.insert=function(a,u){this._magnitude=void 0;var w=this.list;if(!w)return this.list=new f.Vector.Node(a,u,w),this.length++;if(a<w.idx)return this.list=new f.Vector.Node(a,u,w),this.length++;for(var b=w,x=w.next;x!=null;){if(a<x.idx)return b.next=new f.Vector.Node(a,u,x),this.length++;b=x,x=x.next}return b.next=new f.Vector.Node(a,u,x),this.length++},f.Vector.prototype.magnitude=function(){if(this._magnitude)return this._magnitude;for(var a,u=this.list,w=0;u;)w+=(a=u.val)*a,u=u.next;return this._magnitude=Math.sqrt(w)},f.Vector.prototype.dot=function(a){for(var u=this.list,w=a.list,b=0;u&&w;)u.idx<w.idx?u=u.next:(u.idx>w.idx||(b+=u.val*w.val,u=u.next),w=w.next);return b},f.Vector.prototype.similarity=function(a){return this.dot(a)/(this.magnitude()*a.magnitude())},f.SortedSet=function(){this.length=0,this.elements=[]},f.SortedSet.load=function(a){var u=new this;return u.elements=a,u.length=a.length,u},f.SortedSet.prototype.add=function(){var a,u;for(a=0;a<arguments.length;a++)~this.indexOf(u=arguments[a])||this.elements.splice(this.locationFor(u),0,u);this.length=this.elements.length},f.SortedSet.prototype.toArray=function(){return this.elements.slice()},f.SortedSet.prototype.map=function(a,u){return this.elements.map(a,u)},f.SortedSet.prototype.forEach=function(a,u){return this.elements.forEach(a,u)},f.SortedSet.prototype.indexOf=function(a){for(var u=0,w=this.elements.length,b=w-u,x=u+Math.floor(b/2),C=this.elements[x];b>1;){if(C===a)return x;C<a&&(u=x),C>a&&(w=x),b=w-u,x=u+Math.floor(b/2),C=this.elements[x]}return C===a?x:-1},f.SortedSet.prototype.locationFor=function(a){for(var u=0,w=this.elements.length,b=w-u,x=u+Math.floor(b/2),C=this.elements[x];b>1;)C<a&&(u=x),C>a&&(w=x),b=w-u,x=u+Math.floor(b/2),C=this.elements[x];return C>a?x:C<a?x+1:void 0},f.SortedSet.prototype.intersect=function(a){for(var u=new f.SortedSet,w=0,b=0,x=this.length,C=a.length,O=this.elements,z=a.elements;!(w>x-1||b>C-1);)O[w]!==z[b]?O[w]<z[b]?w++:O[w]>z[b]&&b++:(u.add(O[w]),w++,b++);return u},f.SortedSet.prototype.clone=function(){var a=new f.SortedSet;return a.elements=this.toArray(),a.length=a.elements.length,a},f.SortedSet.prototype.union=function(a){var u,w,b;this.length>=a.length?(u=this,w=a):(u=a,w=this),b=u.clone();for(var x=0,C=w.toArray();x<C.length;x++)b.add(C[x]);return b},f.SortedSet.prototype.toJSON=function(){return this.toArray()},f.Index=function(){this._fields=[],this._ref="id",this.pipeline=new f.Pipeline,this.documentStore=new f.Store,this.tokenStore=new f.TokenStore,this.corpusTokens=new f.SortedSet,this.eventEmitter=new f.EventEmitter,this.tokenizerFn=f.tokenizer,this._idfCache={},this.on("add","remove","update",(function(){this._idfCache={}}).bind(this))},f.Index.prototype.on=function(){var a=Array.prototype.slice.call(arguments);return this.eventEmitter.addListener.apply(this.eventEmitter,a)},f.Index.prototype.off=function(a,u){return this.eventEmitter.removeListener(a,u)},f.Index.load=function(a){a.version!==f.version&&f.utils.warn("version mismatch: current "+f.version+" importing "+a.version);var u=new this;return u._fields=a.fields,u._ref=a.ref,u.tokenizer(f.tokenizer.load(a.tokenizer)),u.documentStore=f.Store.load(a.documentStore),u.tokenStore=f.TokenStore.load(a.tokenStore),u.corpusTokens=f.SortedSet.load(a.corpusTokens),u.pipeline=f.Pipeline.load(a.pipeline),u},f.Index.prototype.field=function(a,u){return this._fields.push({name:a,boost:(u=u||{}).boost||1}),this},f.Index.prototype.ref=function(a){return this._ref=a,this},f.Index.prototype.tokenizer=function(a){return a.label&&a.label in f.tokenizer.registeredFunctions||f.utils.warn("Function is not a registered tokenizer. This may cause problems when serialising the index"),this.tokenizerFn=a,this},f.Index.prototype.add=function(a,u){var w={},b=new f.SortedSet,x=a[this._ref];u=u===void 0||u,this._fields.forEach(function(Ae){var he=this.pipeline.run(this.tokenizerFn(a[Ae.name]));w[Ae.name]=he;for(var pe=0;pe<he.length;pe++){var je=he[pe];b.add(je),this.corpusTokens.add(je)}},this),this.documentStore.set(x,b);for(var C=0;C<b.length;C++){for(var O=b.elements[C],z=0,$=0;$<this._fields.length;$++){var de=this._fields[$],Le=w[de.name],we=Le.length;if(we){for(var ne=0,ue=0;ue<we;ue++)Le[ue]===O&&ne++;z+=ne/we*de.boost}}this.tokenStore.add(O,{ref:x,tf:z})}u&&this.eventEmitter.emit("add",a,this)},f.Index.prototype.remove=function(a,u){var w=a[this._ref];if(u=u===void 0||u,this.documentStore.has(w)){var b=this.documentStore.get(w);this.documentStore.remove(w),b.forEach(function(x){this.tokenStore.remove(x,w)},this),u&&this.eventEmitter.emit("remove",a,this)}},f.Index.prototype.update=function(a,u){u=u===void 0||u,this.remove(a,!1),this.add(a,!1),u&&this.eventEmitter.emit("update",a,this)},f.Index.prototype.idf=function(a){var u="@"+a;if(Object.prototype.hasOwnProperty.call(this._idfCache,u))return this._idfCache[u];var w=this.tokenStore.count(a),b=1;return w>0&&(b=1+Math.log(this.documentStore.length/w)),this._idfCache[u]=b},f.Index.prototype.search=function(a){var u=this.pipeline.run(this.tokenizerFn(a)),w=new f.Vector,b=[],x=this._fields.reduce(function(C,O){return C+O.boost},0);return u.some(function(C){return this.tokenStore.has(C)},this)?(u.forEach(function(C,O,z){var $=1/z.length*this._fields.length*x,de=this,Le=this.tokenStore.expand(C).reduce(function(we,ne){var ue=de.corpusTokens.indexOf(ne),Ae=de.idf(ne),he=1,pe=new f.SortedSet;if(ne!==C){var je=Math.max(3,ne.length-C.length);he=1/Math.log(je)}ue>-1&&w.insert(ue,$*Ae*he);for(var yt=de.tokenStore.get(ne),vt=Object.keys(yt),Mr=vt.length,qe=0;qe<Mr;qe++)pe.add(yt[vt[qe]].ref);return we.union(pe)},new f.SortedSet);b.push(Le)},this),b.reduce(function(C,O){return C.intersect(O)}).map(function(C){return{ref:C,score:w.similarity(this.documentVector(C))}},this).sort(function(C,O){return O.score-C.score})):[]},f.Index.prototype.documentVector=function(a){for(var u=this.documentStore.get(a),w=u.length,b=new f.Vector,x=0;x<w;x++){var C=u.elements[x],O=this.tokenStore.get(C)[a].tf,z=this.idf(C);b.insert(this.corpusTokens.indexOf(C),O*z)}return b},f.Index.prototype.toJSON=function(){return{version:f.version,fields:this._fields,ref:this._ref,tokenizer:this.tokenizerFn.label,documentStore:this.documentStore.toJSON(),tokenStore:this.tokenStore.toJSON(),corpusTokens:this.corpusTokens.toJSON(),pipeline:this.pipeline.toJSON()}},f.Index.prototype.use=function(a){var u=Array.prototype.slice.call(arguments,1);u.unshift(this),a.apply(this,u)},f.Store=function(){this.store={},this.length=0},f.Store.load=function(a){var u=new this;return u.length=a.length,u.store=Object.keys(a.store).reduce(function(w,b){return w[b]=f.SortedSet.load(a.store[b]),w},{}),u},f.Store.prototype.set=function(a,u){this.has(a)||this.length++,this.store[a]=u},f.Store.prototype.get=function(a){return this.store[a]},f.Store.prototype.has=function(a){return a in this.store},f.Store.prototype.remove=function(a){this.has(a)&&(delete this.store[a],this.length--)},f.Store.prototype.toJSON=function(){return{store:this.store,length:this.length}},f.stemmer=(o={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},s={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},d="^("+(l="[^aeiou][^aeiouy]*")+")?"+(c=(i="[aeiouy]")+"[aeiou]*")+l+"("+c+")?$",h="^("+l+")?"+c+l+c+l,m="^("+l+")?"+i,p=new RegExp("^("+l+")?"+c+l),y=new RegExp(h),g=new RegExp(d),v=new RegExp(m),k=/^(.+?)(ss|i)es$/,S=/^(.+?)([^s])s$/,M=/^(.+?)eed$/,P=/^(.+?)(ed|ing)$/,A=/.$/,N=/(at|bl|iz)$/,_=new RegExp("([^aeiouylsz])\\1$"),E=new RegExp("^"+l+i+"[^aeiouwxy]$"),B=/^(.+?[^aeiou])y$/,H=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/,re=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,W=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/,G=/^(.+?)(s|t)(ion)$/,Z=/^(.+?)e$/,J=/ll$/,X=new RegExp("^"+l+i+"[^aeiouwxy]$"),function(a){var u,w,b,x,C,O,z;if(a.length<3)return a;if((b=a.substr(0,1))=="y"&&(a=b.toUpperCase()+a.substr(1)),C=S,(x=k).test(a)?a=a.replace(x,"$1$2"):C.test(a)&&(a=a.replace(C,"$1$2")),C=P,(x=M).test(a)){var $=x.exec(a);(x=p).test($[1])&&(a=a.replace(x=A,""))}else C.test(a)&&($=C.exec(a),(C=v).test(u=$[1])&&(O=_,z=E,(C=N).test(a=u)?a+="e":O.test(a)?a=a.replace(x=A,""):z.test(a)&&(a+="e")));return(x=B).test(a)&&(a=(u=($=x.exec(a))[1])+"i"),(x=H).test(a)&&(w=($=x.exec(a))[2],(x=p).test(u=$[1])&&(a=u+o[w])),(x=re).test(a)&&(w=($=x.exec(a))[2],(x=p).test(u=$[1])&&(a=u+s[w])),C=G,(x=W).test(a)?($=x.exec(a),(x=y).test(u=$[1])&&(a=u)):C.test(a)&&($=C.exec(a),(C=y).test(u=$[1]+$[2])&&(a=u)),(x=Z).test(a)&&($=x.exec(a),C=g,O=X,((x=y).test(u=$[1])||C.test(u)&&!O.test(u))&&(a=u)),C=y,(x=J).test(a)&&C.test(a)&&(a=a.replace(x=A,"")),b=="y"&&(a=b.toLowerCase()+a.substr(1)),a}),f.Pipeline.registerFunction(f.stemmer,"stemmer"),f.generateStopWordFilter=function(a){var u=a.reduce(function(w,b){return w[b]=b,w},{});return function(w){if(w&&u[w]!==w)return w}},f.stopWordFilter=f.generateStopWordFilter(["a","able","about","across","after","all","almost","also","am","among","an","and","any","are","as","at","be","because","been","but","by","can","cannot","could","dear","did","do","does","either","else","ever","every","for","from","get","got","had","has","have","he","her","hers","him","his","how","however","i","if","in","into","is","it","its","just","least","let","like","likely","may","me","might","most","must","my","neither","no","nor","not","of","off","often","on","only","or","other","our","own","rather","said","say","says","she","should","since","so","some","than","that","the","their","them","then","there","these","they","this","tis","to","too","twas","us","wants","was","we","were","what","when","where","which","while","who","whom","why","will","with","would","yet","you","your"]),f.Pipeline.registerFunction(f.stopWordFilter,"stopWordFilter"),f.trimmer=function(a){return a.replace(/^\W+/,"").replace(/\W+$/,"")},f.Pipeline.registerFunction(f.trimmer,"trimmer"),f.TokenStore=function(){this.root={docs:{}},this.length=0},f.TokenStore.load=function(a){var u=new this;return u.root=a.root,u.length=a.length,u},f.TokenStore.prototype.add=function(a,u,w){w=w||this.root;var b=a.charAt(0),x=a.slice(1);return b in w||(w[b]={docs:{}}),x.length===0?(w[b].docs[u.ref]=u,void(this.length+=1)):this.add(x,u,w[b])},f.TokenStore.prototype.has=function(a){if(!a)return!1;for(var u=this.root,w=0;w<a.length;w++){if(!u[a.charAt(w)])return!1;u=u[a.charAt(w)]}return!0},f.TokenStore.prototype.getNode=function(a){if(!a)return{};for(var u=this.root,w=0;w<a.length;w++){if(!u[a.charAt(w)])return{};u=u[a.charAt(w)]}return u},f.TokenStore.prototype.get=function(a,u){return this.getNode(a,u).docs||{}},f.TokenStore.prototype.count=function(a,u){return Object.keys(this.get(a,u)).length},f.TokenStore.prototype.remove=function(a,u){if(a){for(var w=this.root,b=0;b<a.length;b++){if(!(a.charAt(b)in w))return;w=w[a.charAt(b)]}delete w.docs[u]}},f.TokenStore.prototype.expand=function(a,u){var w=this.getNode(a);return u=u||[],Object.keys(w.docs||{}).length&&u.push(a),Object.keys(w).forEach(function(b){b!=="docs"&&u.concat(this.expand(a+b,u))},this),u},f.TokenStore.prototype.toJSON=function(){return{root:this.root,length:this.length}},t.exports=f})()}(e),e.exports}();class or{constructor(e,t){this.store=new Map,this.idx=Ie(function(){this.field("name",{boost:10}),((t==null?void 0:t.searchableFields)||[]).forEach(o=>this.field(o)),this.ref("_id"),t!=null&&t.isExactSearch&&(this.pipeline.remove(Ie.stemmer),this.pipeline.remove(Ie.stopWordFilter)),t!=null&&t.removeStopWordFilter&&this.pipeline.remove(Ie.stopWordFilter)});let n=1;(e||[]).map(o=>{o._id=n,++n,this.idx.add(o),this.store.set(o._id,o)})}search_full(e,t){return this.search(e,t).map(n=>this.store.get(n))}search(e,t){return t instanceof Function?(e?this.idx.search(e).map(n=>this.store.get(n.ref)):[...this.store.values()]).filter(t).map(n=>n._id):e?this.idx.search(e).map(n=>n.ref):[...this.store.keys()]}}class sr{constructor(e,t){(t=t||Object.create(null)).aggregations=t.aggregations||Object.create(null),this._items=e,this.config=t.aggregations,this.facets=function(i,l){l=l||[];const c={data:Object.create(null),bits_data:Object.create(null),bits_data_temp:Object.create(null)};let d=1;return l.forEach(h=>{c.data[h]=Object.create(null)}),i&&i.map(h=>(h._id||(h._id=d,++d),h)),i&&i.map(h=>(l.forEach(m=>{if(h){if(Array.isArray(h[m]))h[m].forEach(p=>{h[m]&&(c.data[m][p]||(c.data[m][p]=[]),c.data[m][p].push(parseInt(h._id)))});else if(h[m]!==void 0){const p=h[m];c.data[m][p]||(c.data[m][p]=[]),c.data[m][p].push(parseInt(h._id))}}}),h)),c.data=F(c.data,function(h,m){return c.bits_data[m]||(c.bits_data[m]=Object.create(null),c.bits_data_temp[m]=Object.create(null)),F(h,function(p,y){const g=Zo(p);return c.bits_data[m][y]=new q(g),g})}),c}(e,Ee(t.aggregations)),this._items_map=Object.create(null),this._ids=[];let n=1;var o,s;s=i=>{this._ids.push(n),this._items_map[n]=i,i._id=n,++n},(R(o=e)?ge:Er)(o,ce(s)),this.ids_map=Object.create(null),e&&e.forEach(i=>{const l=t.custom_id_field||"id";i[l]&&i._id&&(this.ids_map[i[l]]=i._id)}),this._bits_ids=new q(this._ids)}items(){return this._items}bits_ids(e){return e?new q(e):this._bits_ids}internal_ids_from_ids_map(e){return e.map(t=>this.ids_map[t])}index(){return this.facets}get_item(e){return this._items_map[e]}search(e,t){const n=this.config;t=t||Object.create(null);const o=Qe(this.facets);let s;o.not_ids=rr(o.bits_data,e.not_filters);const i=function(l,c){const d=[];return F(l.filters,function(h,m){if(h&&h.length)if(c[m].conjunction!==!1)F(h,function(p){d.push([m,p])});else{const p=[];F(h,function(y){p.push([m,y])}),d.push(p)}}),F(l.not_filters,function(h,m){h&&h.length&&F(h,function(p){d.push([m,"-",p])})}),d}(e,n);return s=function(l,c){const d=Qe(l);let h;c=c||[],F(d.bits_data,function(p,y){F(d.bits_data[y],function(g,v){d.bits_data_temp[y][v]=d.bits_data[y][v]})}),d.is_temp_copied=!0;const m=function(p,y){const g=Object.create(null);return F(y,function(v){if(Array.isArray(v[0])){let k=new q([]);F(v,function(S){const M=S[0];k=k.new_union(p.bits_data[M][S[1]]||new q([])),g[M]=k})}}),g}(l,c);return F(c,function(p){if(!Array.isArray(p[0])){const y=p[0],g=p[1];h=h&&d.bits_data_temp[y][g]?d.bits_data_temp[y][g].new_intersection(h):h&&!d.bits_data_temp[y][g]?new q([]):d.bits_data_temp[y][g]}}),h&&F(d.bits_data_temp,function(p,y){F(d.bits_data_temp[y],function(g,v){d.bits_data_temp[y][v]=d.bits_data_temp[y][v].new_intersection(h)})}),F(c,function(p){if(p.length===3&&p[1]==="-"){const y=d.bits_data_temp[p[0]][p[2]].clone();F(d.bits_data_temp,function(g,v){F(d.bits_data_temp[v],function(k,S){d.bits_data_temp[v][S]=d.bits_data_temp[v][S].new_difference(y)})})}}),F(d.bits_data_temp,function(p,y){F(d.bits_data_temp[y],function(g,v){F(m,function(k,S){S!==y&&(d.bits_data_temp[y][v]=d.bits_data_temp[y][v].new_intersection(k))})})}),d}(this.facets,i),e.filters_query&&(s=function(l,c){const d=Qe(l);d.is_temp_copied||F(d.bits_data,function(m,p){F(d.bits_data[p],function(y,g){d.bits_data_temp[p][g]=d.bits_data[p][g]})});let h=null;return F(c,function(m){let p=null;F(m,function(y){const g=y[0],v=y[1];if(!d.bits_data_temp[g])throw new Error("Panic. The key does not exist in facets lists.");p=p&&d.bits_data_temp[g][v]?d.bits_data_temp[g][v].new_intersection(p):p&&!d.bits_data_temp[g][v]?new q([]):d.bits_data_temp[g][v]}),h=(h||new q([])).new_union(p||new q([]))}),h!==null&&F(d.bits_data_temp,function(m,p){F(d.bits_data_temp[p],function(y,g){d.bits_data_temp[p][g]=d.bits_data_temp[p][g].new_intersection(h)})}),d}(s,Jo(e.filters_query).map(l=>Array.isArray(l)?l.map(c=>Array.isArray(c)?c.map(d=>d):c.split(":")):l.split(":")))),o.bits_data_temp=s.bits_data_temp,F(o.bits_data_temp,function(l,c){F(o.bits_data_temp[c],function(d,h){t.query_ids&&(o.bits_data_temp[c][h]=t.query_ids.new_intersection(o.bits_data_temp[c][h])),t.test&&(o.data[c][h]=o.bits_data_temp[c][h].array())})}),o.ids=e.filters_query?function(l){let c=new q([]);return F(l,function(d,h){F(l[h],function(m,p){c=c.new_union(l[h][p])})}),c}(o.bits_data_temp):rr(o.bits_data_temp,e.filters),o}}function Ko(r,e){let t;(e=e||Object.create(null)).native_search_enabled!==!1&&(t=new or(r,e));let n=new sr(r,e);return{search:function(o){return(o=o||Object.create(null)).aggregations=function(s,i){return F(tr(s),(l,c)=>{l.field||(l.field=c);let d=[];i.filters&&i.filters[c]&&(d=i.filters[c]),l.filters=d;let h=[];return i.not_filters&&i.not_filters[c]&&(h=i.not_filters[c]),i.exclude_filters&&i.exclude_filters[c]&&(h=i.exclude_filters[c]),l.not_filters=h,l})}(e.aggregations,o),nr(0,o,e,t,n)},similar:function(o,s){return function(i,l,c){const d=c.per_page||10,h=c.minimum||0,m=c.page||1;let p;for(let v=0;v<i.length;++v)if(i[v].id==l){p=i[v];break}if(!c.field)throw new Error("Please define field in options");const y=c.field;let g=[];for(let v=0;v<i.length;++v)if(i[v].id!==l){const k=qo(p[y],i[v][y]);k.length>=h&&(g.push(i[v]),g[g.length-1].intersection_length=k.length)}return g=mt(g,["intersection_length"],["desc"]),{pagination:{per_page:d,page:m,total:g.length},data:{items:g.slice((m-1)*d,m*d)}}}(r,o,s)},aggregation:function(o){return function(s,i,l,c,d){const h=i.per_page||10,m=i.page||1;if(i.name&&(!l.aggregations||!l.aggregations[i.name]))throw new Error('Please define aggregation "'.concat(i.name,'" in config'));const p=tr(i);if(p.page=1,p.per_page=0,!i.name)throw new Error("field name is required");l.aggregations[i.name].size=1e4;const y=nr(0,p,l,c,d).data.aggregations[i.name].buckets;return{pagination:{per_page:h,page:m,total:y.length},data:{buckets:y.slice((m-1)*h,m*h)}}}(0,o,e,t,n)},reindex:function(o){t=new or(r=o,e),n=new sr(r,e)}}}class es{constructor(){this.elements={},this.activeFiltersCount=0,this.resultsCount=0,this.isInitialized=!1,this.currentFilters={},this.currentQuery="",this.config=null,this.init()}init(){this.elements={filtersPanel:document.getElementById("filters-panel"),resultsPanel:document.getElementById("results-panel"),toggleFilters:document.getElementById("toggle-filters"),toggleResults:document.getElementById("toggle-results"),activeFiltersBadge:document.getElementById("active-filters-badge"),activeFiltersCount:document.getElementById("active-filters-count"),resultsCounter:document.getElementById("results-counter"),resultsCount:document.getElementById("results-count"),clearAllBtn:document.getElementById("clear-all-btn"),mapCenterBtn:document.getElementById("map-center-btn"),toggleLegendBtn:document.getElementById("toggle-legend-btn"),mapLegend:document.getElementById("map-legend"),closeLegendBtn:document.getElementById("close-legend-btn")},this.bindEventHandlers(),this.initializePanelStates(),this.setupResponsiveBehavior(),this.styleClearAllButton(),this.isInitialized=!0}styleClearAllButton(){this.elements.clearAllBtn&&(this.elements.clearAllBtn.className="ml-2 px-3 py-1 bg-pink-100 hover:bg-pink-200 text-red-500 text-xs rounded-full transition-colors duration-200 hidden",this.elements.clearAllBtn.innerHTML='<i class="fas fa-times mr-1"></i>Cancella tutto')}setConfig(e){this.config=e}updateFromSearchState(e,t=0,n={}){if(!e)return;this.currentFilters={...e.filters},this.currentQuery=e.query||"";const o=this.calculateActiveFiltersCount(e.filters);this.updateActiveFiltersCount(o,n.skipAnimation),this.updateResultsCount(t,n.skipAnimation)}calculateActiveFiltersCount(e){if(!e||typeof e!="object")return 0;let t=0;return Object.values(e).forEach(n=>{Array.isArray(n)?n.length===2&&typeof n[0]=="number"&&typeof n[1]=="number"?t+=1:t+=n.length:n&&typeof n=="object"&&(n.min!==void 0||n.max!==void 0)&&(t+=1)}),t}updateActiveFiltersCount(e,t=!1){this.activeFiltersCount=e,this.elements.activeFiltersCount.textContent=e,e>0?(this.showElementWithAnimation(this.elements.activeFiltersBadge,t),this.showElementWithAnimation(this.elements.clearAllBtn,t)):(this.hideElementWithAnimation(this.elements.activeFiltersBadge),this.hideElementWithAnimation(this.elements.clearAllBtn)),this.emitEvent("activeFiltersChanged",{count:e})}updateResultsCount(e,t=!1){this.resultsCount=e,this.elements.resultsCount.textContent=e,e>0?this.showElementWithAnimation(this.elements.resultsCounter,t):this.hideElementWithAnimation(this.elements.resultsCounter),this.emitEvent("resultsCountChanged",{count:e})}showElementWithAnimation(e,t=!1){if(e){if(t){e.classList.remove("hidden"),e.style.opacity="1",e.style.transform="scale(1) translateY(0px)",e.style.transition="none";return}e.dataset.animating!=="true"&&(e.dataset.animating="true",e.classList.remove("hidden"),e.classList.remove("opacity-0","scale-95","-translate-y-2","opacity-100","scale-100","translate-y-0"),e.style.opacity="0",e.style.transform="scale(0.7) translateY(-25px)",e.style.transition="none",e.offsetHeight,requestAnimationFrame(()=>{e.style.transition="all 0.15s cubic-bezier(0.68, -0.55, 0.265, 1.55)",e.style.opacity="1",e.style.transform="scale(1.08) translateY(-3px)",setTimeout(()=>{e.style.transition="all 0.12s cubic-bezier(0.25, 0.46, 0.45, 0.94)",e.style.transform="scale(0.98) translateY(2px)",setTimeout(()=>{e.style.transition="all 0.1s ease-out",e.style.transform="scale(1) translateY(0px)",setTimeout(()=>{e.dataset.animating="false"},100)},120)},150)}))}}hideElementWithAnimation(e){e&&(e.classList.remove("opacity-100","scale-100","translate-y-0"),e.classList.add("opacity-0","scale-95","-translate-y-2"),setTimeout(()=>{e.classList.contains("opacity-0")&&e.classList.add("hidden")},300))}showActiveFiltersPopup(){if(document.getElementById("active-filters-popup")){this.hideActiveFiltersPopup();return}const t=this.elements.activeFiltersBadge.getBoundingClientRect(),n=document.createElement("div");n.id="active-filters-popup",n.className="fixed p-2 w-72 max-w-sm bg-white rounded-lg shadow-2xl border border-gray-200 transform transition-all duration-300 translate-y-4 opacity-0 max-h-96 overflow-hidden",n.style.zIndex="9999",n.style.left=`${t.left}px`,n.style.bottom=`${window.innerHeight-t.top+10}px`;const o=288;t.left+o>window.innerWidth&&(n.style.left=`${window.innerWidth-o-16}px`);const s=document.createElement("div");s.className="flex items-center justify-between mb-2",s.innerHTML=`
            <h3 class="p-2 text-sm font-semibold text-gray-800">Filtri Attivi</h3>
            <button id="close-filters-popup" class="absolute top-2 right-2 p-1.5 bg-pink-100 hover:bg-pink-200 active:bg-pink-200 rounded-full text-red-500 shadow-md hover:shadow-lg transition-all duration-200 group">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4 group-hover:rotate-90 transition-transform duration-200">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `;const i=document.createElement("div");i.className="space-y-1 max-h-64 overflow-y-auto overflow-x-hidden";const l=this.buildFiltersContent();i.innerHTML=l,n.appendChild(s),n.appendChild(i),document.body.appendChild(n),requestAnimationFrame(()=>{n.classList.remove("translate-y-4","opacity-0"),n.classList.add("translate-y-0","opacity-100")}),this.bindPopupEvents(n)}buildFiltersContent(){if(!this.currentFilters||Object.keys(this.currentFilters).length===0)return`
                <div class="flex items-center p-4 rounded-lg bg-gray-50">
                    <span class="text-sm text-gray-700">Nessun filtro attivo</span>
                </div>
            `;let e="";this.currentQuery&&this.currentQuery.trim()&&(e+=`
                <div class="mb-3 p-3 rounded-lg bg-blue-50 border border-blue-100">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 text-blue-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <div class="flex-1 min-w-0">
                            <span class="text-sm font-medium text-blue-700">Ricerca:</span>
                            <span class="text-sm text-blue-600 ml-1 font-mono bg-blue-100 px-2 py-1 rounded text-xs">"${this.escapeHtml(this.currentQuery)}"</span>
                        </div>
                    </div>
                </div>
            `);const t={};return Object.entries(this.currentFilters).forEach(([n,o])=>{if(!o||Array.isArray(o)&&o.length===0)return;const s=this.getFacetLabel(n);t[s]||(t[s]=[]),Array.isArray(o)?o.length===2&&typeof o[0]=="number"&&typeof o[1]=="number"?t[s].push({type:"range",value:this.formatRangeFilter({min:o[0],max:o[1]}),facetKey:n}):o.forEach(i=>{t[s].push({type:"value",value:i,facetKey:n})}):typeof o=="object"&&t[s].push({type:"range",value:this.formatRangeFilter(o),facetKey:n})}),Object.entries(t).forEach(([n,o])=>{e+=`
                <div class="mb-3 p-3 rounded-lg bg-gray-50 border border-gray-200">
                    <div class="flex items-start">
                        <div class="w-2 h-2 rounded-full bg-indigo-500 mt-2 mr-3 flex-shrink-0"></div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-sm font-semibold text-gray-800 mb-2">${n}</h4>
                            <div class="flex flex-wrap gap-1.5">
            `,o.forEach((s,i)=>{const l=s.type==="range";e+=`
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border ${l?"bg-orange-100 text-orange-700 border-orange-200":"bg-indigo-100 text-indigo-700 border-indigo-200"} transition-all duration-200 hover:shadow-sm">
                        ${l?`<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>`:`<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`}
                        ${this.escapeHtml(s.value)}
                    </span>
                `}),e+=`
                            </div>
                        </div>
                    </div>
                </div>
            `}),e||`
            <div class="flex items-center p-4 rounded-lg bg-gray-50">
                <span class="text-sm text-gray-700">Nessun filtro attivo</span>
            </div>
        `}getFacetLabel(e){return this.config&&this.config.aggregations&&this.config.aggregations[e]?this.config.aggregations[e].title||e:e.replace(/[_-]/g," ").replace(/\b\w/g,t=>t.toUpperCase())}formatRangeFilter(e){return e.min!==void 0&&e.max!==void 0?`${e.min} - ${e.max}`:e.min!==void 0?` ${e.min}`:e.max!==void 0?` ${e.max}`:"Range filter"}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}hideActiveFiltersPopup(){const e=document.getElementById("active-filters-popup");e&&(e.classList.add("translate-y-4","opacity-0"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300))}bindPopupEvents(e){const t=e.querySelector("#close-filters-popup");t&&t.addEventListener("click",()=>this.hideActiveFiltersPopup());const n=e.querySelector("#popup-clear-all-btn");n&&n.addEventListener("click",()=>this.handleClearAllFilters());const o=i=>{i.key==="Escape"&&(this.hideActiveFiltersPopup(),document.removeEventListener("keydown",o))};document.addEventListener("keydown",o);const s=i=>{!e.contains(i.target)&&!this.elements.activeFiltersBadge.contains(i.target)&&(this.hideActiveFiltersPopup(),document.removeEventListener("click",s))};setTimeout(()=>{document.addEventListener("click",s)},100)}bindEventHandlers(){this.elements.toggleFilters.addEventListener("click",()=>{this.togglePanel("filters")}),this.elements.toggleResults.addEventListener("click",()=>{this.togglePanel("results")}),this.elements.clearAllBtn.addEventListener("click",()=>{this.handleClearAllFilters()}),this.elements.mapCenterBtn.addEventListener("click",()=>{this.handleMapCenter()}),this.elements.toggleLegendBtn.addEventListener("click",()=>{this.toggleLegend()}),this.elements.closeLegendBtn.addEventListener("click",()=>{this.closeLegend()}),this.elements.activeFiltersBadge&&(this.elements.activeFiltersBadge.addEventListener("click",()=>{this.showActiveFiltersPopup()}),this.elements.activeFiltersBadge.style.cursor="pointer",this.elements.activeFiltersBadge.title="Clicca per vedere i filtri attivi")}initializePanelStates(){this.elements.filtersPanel.classList.add("panel-closed"),this.elements.resultsPanel.classList.add("panel-closed-right"),this.elements.toggleFilters.classList.remove("active"),this.elements.toggleResults.classList.remove("active")}togglePanel(e){if(e==="filters"){const t=!this.elements.filtersPanel.classList.contains("panel-closed");this.elements.filtersPanel.classList.toggle("panel-closed"),this.elements.toggleFilters.classList.toggle("active",!t),this.emitEvent("panelToggled",{type:"filters",isOpen:!t})}else if(e==="results"){const t=!this.elements.resultsPanel.classList.contains("panel-closed-right");this.elements.resultsPanel.classList.toggle("panel-closed-right"),this.elements.toggleResults.classList.toggle("active",!t),this.emitEvent("panelToggled",{type:"results",isOpen:!t})}}closeAllPanels(){this.elements.filtersPanel.classList.add("panel-closed"),this.elements.resultsPanel.classList.add("panel-closed-right"),this.elements.toggleFilters.classList.remove("active"),this.elements.toggleResults.classList.remove("active")}handleClearAllFilters(){this.hideActiveFiltersPopup(),this.currentFilters={},this.currentQuery="",this.updateActiveFiltersCount(0),this.updateResultsCount(0),this.emitEvent("clearAllFilters",{resetInterface:!0,clearSearch:!0,clearFacets:!0,clearMap:!0}),setTimeout(()=>{this.resetFacetsInterface()},100),this.clearSearchInput(),this.showNotification("Tutti i filtri sono stati rimossi","success",2e3)}handleMapCenter(){this.emitEvent("centerMap")}toggleLegend(){const e=this.elements.mapLegend.classList.contains("legend-hidden");this.elements.mapLegend.classList.toggle("legend-hidden"),this.elements.toggleLegendBtn.classList.toggle("active",e),this.emitEvent("legendToggled",{isVisible:e})}closeLegend(){this.elements.mapLegend.classList.add("legend-hidden"),this.elements.toggleLegendBtn.classList.remove("active"),this.emitEvent("legendClosed")}updateMapLegend(e){const t=document.querySelector(".map-legend-content");t&&(t.innerHTML="",e.forEach((n,o)=>{const s=document.createElement("div");s.className="legend-item flex items-center p-2 rounded-lg cursor-pointer",s.dataset.legendIndex=o,s.innerHTML=`
                <div class="w-4 h-4 rounded-full mr-3 flex-shrink-0" style="background-color: ${n.color}"></div>
                <span class="text-sm text-gray-700 flex-1">${n.label}</span>
                ${n.count!==void 0?`<span class="text-xs text-gray-500 ml-2">${n.count}</span>`:""}
            `,n.onClick&&typeof n.onClick=="function"&&s.addEventListener("click",i=>{n.onClick(n,o,i)}),t.appendChild(s)}),this.emitEvent("legendUpdated",{items:e}))}setupResponsiveBehavior(){window.addEventListener("resize",()=>{window.innerWidth<768&&this.closeAllPanels()}),window.innerWidth<768&&this.closeAllPanels()}getState(){return{activeFiltersCount:this.activeFiltersCount,resultsCount:this.resultsCount,isFiltersOpen:!this.elements.filtersPanel.classList.contains("panel-closed"),isResultsOpen:!this.elements.resultsPanel.classList.contains("panel-closed-right"),isLegendVisible:!this.elements.mapLegend.classList.contains("legend-hidden"),currentFilters:{...this.currentFilters},currentQuery:this.currentQuery}}setState(e){if(e.activeFiltersCount!==void 0&&this.updateActiveFiltersCount(e.activeFiltersCount),e.resultsCount!==void 0&&this.updateResultsCount(e.resultsCount),e.isFiltersOpen!==void 0){const t=!this.elements.filtersPanel.classList.contains("panel-closed");e.isFiltersOpen!==t&&this.togglePanel("filters")}if(e.isResultsOpen!==void 0){const t=!this.elements.resultsPanel.classList.contains("panel-closed-right");e.isResultsOpen!==t&&this.togglePanel("results")}if(e.isLegendVisible!==void 0){const t=!this.elements.mapLegend.classList.contains("legend-hidden");e.isLegendVisible!==t&&this.toggleLegend()}e.currentFilters!==void 0&&(this.currentFilters={...e.currentFilters}),e.currentQuery!==void 0&&(this.currentQuery=e.currentQuery)}emitEvent(e,t={}){const n=new CustomEvent(`navbar:${e}`,{detail:t,bubbles:!0,cancelable:!0});document.dispatchEvent(n)}addEventListener(e,t){document.addEventListener(`navbar:${e}`,t)}removeEventListener(e,t){document.removeEventListener(`navbar:${e}`,t)}showNotification(e,t="info",n=3e3){const o=document.createElement("div");o.className=`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg transition-all duration-300 ${this.getNotificationClasses(t)}`,o.textContent=e,document.body.appendChild(o),setTimeout(()=>{o.style.opacity="1",o.style.transform="translateX(-50%) translateY(0)"},10),setTimeout(()=>{o.style.opacity="0",o.style.transform="translateX(-50%) translateY(-20px)",setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},300)},n)}getNotificationClasses(e){const t={success:"bg-green-500 text-white",error:"bg-red-500 text-white",warning:"bg-yellow-500 text-white",info:"bg-blue-500 text-white"};return t[e]||t.info}destroy(){window.removeEventListener("resize",this.setupResponsiveBehavior),this.hideActiveFiltersPopup(),this.elements={},this.currentFilters={},this.currentQuery="",this.config=null,this.isInitialized=!1}forceUpdate(e={},t="",n=0){this.currentFilters={...e},this.currentQuery=t;const o=this.calculateActiveFiltersCount(e);this.updateActiveFiltersCount(o),this.updateResultsCount(n),this.hideActiveFiltersPopup(),Object.keys(e).length===0&&!t&&setTimeout(()=>{this.resetFacetsInterface()},50)}resetInterface(){this.currentFilters={},this.currentQuery="",this.updateActiveFiltersCount(0),this.updateResultsCount(0),this.hideActiveFiltersPopup(),this.closeAllPanels(),this.resetFacetsInterface(),this.clearSearchInput()}resetFacetsInterface(){const e=document.getElementById("facets-container");if(!e)return;e.querySelectorAll('input[type="checkbox"]').forEach(s=>{s.checked=!1}),e.querySelectorAll('[id$="-slider"]').forEach(s=>{if(s.noUiSlider)try{const i=s.noUiSlider.options.range;s.noUiSlider.set([i.min,i.max]);const l=s.id.replace("-slider",""),c=document.getElementById(`${l}-min-input`),d=document.getElementById(`${l}-max-input`);c&&(c.value=i.min),d&&(d.value=i.max);const h=document.getElementById(`${l}-chart`);if(h){const m=h.querySelector(`#${l}-chart-highlight`);m&&(m.style.left="0%",m.style.width="100%")}}catch(i){console.warn(`Failed to reset slider ${s.id}:`,i)}}),e.querySelectorAll(".toggle-btn").forEach(s=>{const i=s.dataset.path,l=e.querySelector(`[data-parent="${i}"]`);l&&l.style.display!=="none"&&(l.style.display="none",s.textContent="")})}clearSearchInput(){const e=["#search-input","#query-input",".search-input",'input[type="search"]','input[placeholder*="search" i]','input[placeholder*="cerca" i]'];for(const t of e){const n=document.querySelector(t);if(n){n.value="",n.dispatchEvent(new Event("input",{bubbles:!0}));break}}}_updateChartHighlight(e,t,n,o){if(!e||!t||t.length===0)return;const s=e.querySelector(`#${e.id}-highlight`);if(!s)return;const i=t[t.length-1].value-t[0].value;if(i<=0)return;const l=(n-t[0].value)/i*100,c=(o-n)/i*100;s.style.left=`${Math.max(0,l)}%`,s.style.width=`${Math.max(0,Math.min(100,c))}%`}}const ts=new es,rs="/leda/";class ns{constructor(e,t={}){this.map=e,this.config={polygonStyle:{color:"#3388ff",weight:2,opacity:.8,fillColor:"#3388ff",fillOpacity:.1,...t.polygonStyle},highlightStyle:{color:"#ff6b35",weight:3,opacity:1,fillColor:"#ff6b35",fillOpacity:.2,...t.highlightStyle},polygonRepositoryUrl:"/data/polygons.json",enableCache:!0,cacheExpiry:36e5,...t},this.polygonLayers=new Map,this.polygonCache=new Map,this.polygonRepository=null,this.currentHighlighted=null,this.polygonLayerGroup=L.layerGroup().addTo(this.map),this.loadPolygonRepository()}isValidPolygonGeometry(e){return!e||!e.type?!1:e.type==="FeatureCollection"?e.features&&e.features.some(n=>this.isValidPolygonGeometry(n)):e.type==="Feature"?this.isValidPolygonGeometry(e.geometry):["Polygon","MultiPolygon","LineString","MultiLineString"].includes(e.type)}filterValidGeometries(e){if(!e||!e.type)return null;if(e.type==="FeatureCollection"){const t=e.features.filter(n=>this.isValidPolygonGeometry(n));return t.length===0?null:{...e,features:t}}return e.type==="Feature"?this.isValidPolygonGeometry(e.geometry)?e:null:this.isValidPolygonGeometry(e)?e:null}async loadPolygonRepository(){try{if(this.polygonRepository)return console.log("Polygon repository already loaded"),this.polygonRepository;const e=await fetch(`${rs}/data/polygons.json`);if(!e.ok)throw new Error(`Failed to load polygon repository: ${e.status}`);const t=await e.json();this.polygonRepository={};let n=0,o=0,s=0;for(const[i,l]of Object.entries(t))if(l&&typeof l=="object"&&l.osm_id)if(l.geojson&&this.isValidPolygonGeometry(l.geojson)){const c=this.filterValidGeometries(l.geojson);c?(this.polygonRepository[i]={...l,geojson:c},n++):s++}else console.log(`Skipping entry with Point geometry or invalid geojson: ${i}`),s++;else console.warn(`Skipping invalid polygon entry: ${i}`,l),o++;return console.log(`Polygon repository loaded successfully. Valid polygons: ${n}, Invalid/skipped: ${o}, Points skipped: ${s}`),this.polygonRepository}catch(e){return console.error("Error loading polygon repository:",e),this.polygonRepository={},this.polygonRepository}}async loadPolygon(e,t=!1,n=!1){try{const o=this.getLocationId(e);this.removePolygon(o);let s=null;if(e.geojson)if(this.isValidPolygonGeometry(e.geojson))s=this.filterValidGeometries(e.geojson);else return console.log("Skipping location with Point geometry:",e.display_name),null;else s=await this.fetchPolygonDataByOsmId(e);if(!s)return console.warn("No valid polygon data available for location:",e),null;const i=this.createPolygonLayer(s,e);return this.polygonLayers.set(o,{layer:i,data:e,geojson:s,isHighlighted:t}),this.polygonLayerGroup.addLayer(i),t&&this.highlightPolygon(o),n&&this.fitBoundsToPolygon(i),i}catch(o){return console.error("Error loading polygon:",o),null}}async fetchPolygonDataByOsmId(e){try{if(await this.loadPolygonRepository(),!e||!e.osm_id)return console.log("No OSM ID provided for location - skipping polygon load"),null;const t=e.osm_id.toString(),n=this.getLocationId(e);if(this.config.enableCache&&this.polygonCache.has(n)){const s=this.polygonCache.get(n);if(Date.now()-s.timestamp<this.config.cacheExpiry)return s.data;this.polygonCache.delete(n)}let o=null;return o=this.findPolygonByOsmId(t,e.osm_type),this.config.enableCache&&o&&this.polygonCache.set(n,{data:o,timestamp:Date.now()}),o}catch(t){return console.error("Error fetching polygon data by OSM ID:",t),null}}findPolygonByOsmId(e,t=null){if(!this.polygonRepository)return console.warn("Polygon repository not loaded"),null;const n=e.toString();for(const[o,s]of Object.entries(this.polygonRepository))if(s.osm_id&&s.osm_id.toString()===n){if(t&&s.osm_type&&s.osm_type!==t){console.log(`OSM ID matches but type doesn't: expected ${t}, got ${s.osm_type}`);continue}return this.isValidPolygonGeometry(s.geojson)?s.geojson:(console.log(`Found OSM ID ${n} but geometry is Point type - skipping`),null)}return console.log(`No polygon found for OSM ID: ${n}`),null}async loadPolygonByOsmId(e,t=null,n=!1,o=!1){if(await this.loadPolygonRepository(),!this.findPolygonByOsmId(e,t))return console.warn("Polygon not found for OSM ID:",e),null;let i=null;for(const[c,d]of Object.entries(this.polygonRepository))if(d.osm_id&&d.osm_id.toString()===e.toString()&&(!t||!d.osm_type||d.osm_type===t)){i=d;break}if(!i)return console.warn("Polygon info not found for OSM ID:",e),null;const l={display_name:i.display_name||`OSM ${t||"object"} ${e}`,lat:i.lat,lon:i.lon,osm_type:i.osm_type||t,osm_id:i.osm_id,place_rank:i.place_rank,importance:i.importance,type:i.type,class:i.class,geojson:i.geojson};return this.loadPolygon(l,n,o)}findPolygonInRepository(e){if(!this.polygonRepository)return console.warn("Polygon repository not loaded"),null;if(e.osm_id){const n=this.findPolygonByOsmId(e.osm_id,e.osm_type);if(n)return n}const t=e.display_name||e.name;if(t){for(const[o,s]of Object.entries(this.polygonRepository))if(o.toLowerCase()===t.toLowerCase()&&this.isValidPolygonGeometry(s.geojson))return console.log("Found polygon by exact name match:",o),s.geojson;for(const[o,s]of Object.entries(this.polygonRepository))if((t.toLowerCase().includes(o.toLowerCase())||o.toLowerCase().includes(t.toLowerCase()))&&this.isValidPolygonGeometry(s.geojson))return console.log("Found polygon by partial name match:",o),s.geojson;const n=t.split(",").map(o=>o.trim());for(const o of n)for(const[s,i]of Object.entries(this.polygonRepository))if(s.toLowerCase()===o.toLowerCase()&&this.isValidPolygonGeometry(i.geojson))return console.log("Found polygon by name part match:",s),i.geojson}if(e.lat&&e.lon){const n=parseFloat(e.lat),o=parseFloat(e.lon);for(const[s,i]of Object.entries(this.polygonRepository))if(i.lat&&i.lon&&this.isValidPolygonGeometry(i.geojson)){const l=parseFloat(i.lat),c=parseFloat(i.lon),d=this.calculateDistance(n,o,l,c);if(d<50)return console.log("Found polygon by proximity match:",s,"Distance:",d.toFixed(2),"km"),i.geojson}}return console.log("No polygon found in repository for:",t||e),null}calculateDistance(e,t,n,o){const i=this.toRadians(n-e),l=this.toRadians(o-t),c=Math.sin(i/2)*Math.sin(i/2)+Math.cos(this.toRadians(e))*Math.cos(this.toRadians(n))*Math.sin(l/2)*Math.sin(l/2);return 6371*(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)))}toRadians(e){return e*(Math.PI/180)}addPolygonToRepository(e,t){if(this.polygonRepository||(this.polygonRepository={}),t.geojson&&this.isValidPolygonGeometry(t.geojson)){const n=this.filterValidGeometries(t.geojson);n?(this.polygonRepository[e]={...t,geojson:n},console.log("Added polygon to repository:",e)):console.warn("Cannot add polygon - contains only Point geometries:",e)}else console.warn("Cannot add polygon - invalid or Point geometry:",e)}getAvailablePolygons(){return this.polygonRepository?Object.keys(this.polygonRepository):[]}async loadPolygonByName(e,t=!1,n=!1){if(await this.loadPolygonRepository(),!this.polygonRepository||!this.polygonRepository[e])return console.warn("Polygon not found in repository:",e),null;const o=this.polygonRepository[e];if(!this.isValidPolygonGeometry(o.geojson))return console.warn("Polygon has Point geometry - cannot visualize:",e),null;const s={display_name:o.display_name||e,lat:o.lat,lon:o.lon,osm_type:o.osm_type,osm_id:o.osm_id,place_rank:o.place_rank,importance:o.importance,type:o.type,class:o.class,geojson:o.geojson};return this.loadPolygon(s,t,n)}createPolygonLayer(e,t){return L.geoJSON(e,{style:this.config.polygonStyle,onEachFeature:(o,s)=>{t.display_name&&s.bindPopup(`
            <div class="polygon-popup">
              <h4>${t.display_name}</h4>
              ${t.type?`<p><strong>Type:</strong> ${t.type}</p>`:""}
              ${t.class?`<p><strong>Class:</strong> ${t.class}</p>`:""}
              ${t.importance?`<p><strong>Importance:</strong> ${t.importance.toFixed(3)}</p>`:""}
              ${t.osm_id?`<p><strong>OSM ID:</strong> ${t.osm_type}/${t.osm_id}</p>`:""}
            </div>
          `),s.on({mouseover:i=>this.onPolygonHover(i,t),mouseout:i=>this.onPolygonMouseOut(i,t),click:i=>this.onPolygonClick(i,t)})}})}async loadSearchResultPolygons(e,t=null){this.clearAllPolygons();const n=e.filter(i=>i&&i.osm_id&&(typeof i.osm_id=="string"||typeof i.osm_id=="number"));if(n.length===0){console.log("No search results with valid OSM IDs found");return}console.log(`Loading polygons for ${n.length} results with OSM IDs`);const o=i=>new Promise(l=>setTimeout(l,i));let s=0;for(let i=0;i<n.length;i++){const l=n[i],c=t&&this.getLocationId(l)===t;try{await this.loadPolygon(l,c,!1)&&s++,i<n.length-1&&await o(50)}catch(d){console.error("Error loading polygon for result:",l,d)}}console.log(`Successfully loaded ${s} polygons out of ${n.length} results`),this.polygonLayers.size>0&&setTimeout(()=>{this.fitBoundsToAllPolygons()},100)}highlightPolygon(e){this.clearHighlight();const t=this.polygonLayers.get(e);t&&(t.layer.setStyle(this.config.highlightStyle),t.isHighlighted=!0,this.currentHighlighted=e,t.layer.bringToFront())}clearHighlight(){if(this.currentHighlighted){const e=this.polygonLayers.get(this.currentHighlighted);e&&(e.layer.setStyle(this.config.polygonStyle),e.isHighlighted=!1),this.currentHighlighted=null}}removePolygon(e){const t=this.polygonLayers.get(e);t&&(this.polygonLayerGroup.removeLayer(t.layer),this.polygonLayers.delete(e),this.currentHighlighted===e&&(this.currentHighlighted=null))}clearAllPolygons(){this.polygonLayerGroup.clearLayers(),this.polygonLayers.clear(),this.currentHighlighted=null}fitBoundsToPolygon(e){try{const t=e.getBounds();t.isValid()&&this.map.fitBounds(t,{padding:[20,20],maxZoom:15})}catch(t){console.warn("Could not fit bounds to polygon:",t)}}fitBoundsToAllPolygons(){try{const t=new L.featureGroup(Array.from(this.polygonLayers.values()).map(n=>n.layer)).getBounds();t.isValid()&&this.map.fitBounds(t,{padding:[20,20],maxZoom:12})}catch(e){console.warn("Could not fit bounds to all polygons:",e)}}onPolygonHover(e,t){const n=e.target,o=this.getLocationId(t),s=this.polygonLayers.get(o);s&&!s.isHighlighted&&n.setStyle({weight:3,opacity:1,fillOpacity:.15}),this.map.fire("polygon:hover",{locationData:t,layer:n})}onPolygonMouseOut(e,t){const n=e.target,o=this.getLocationId(t),s=this.polygonLayers.get(o);s&&!s.isHighlighted&&n.setStyle(this.config.polygonStyle),this.map.fire("polygon:mouseout",{locationData:t,layer:n})}onPolygonClick(e,t){const n=this.getLocationId(t);this.highlightPolygon(n),this.map.fire("polygon:click",{locationData:t,layer:e.target,locationId:n}),L.DomEvent.stopPropagation(e)}getLocationId(e){return e.osm_id?`${e.osm_type||"unknown"}_${e.osm_id}`:e.lat&&e.lon?`coord_${e.lat}_${e.lon}`:`name_${this.simpleHash(e.display_name||"unknown")}`}simpleHash(e){let t=0;for(let n=0;n<e.length;n++){const o=e.charCodeAt(n);t=(t<<5)-t+o,t=t&t}return Math.abs(t).toString(36)}setPolygonVisibility(e){e?this.map.hasLayer(this.polygonLayerGroup)||this.polygonLayerGroup.addTo(this.map):this.map.hasLayer(this.polygonLayerGroup)&&this.map.removeLayer(this.polygonLayerGroup)}getAllPolygons(){return Array.from(this.polygonLayers.values())}hasPolygon(e){return this.polygonLayers.has(e)}updateStyles(e){this.config={...this.config,...e},this.polygonLayers.forEach((t,n)=>{const o=t.isHighlighted?this.config.highlightStyle:this.config.polygonStyle;t.layer.setStyle(o)})}clearCache(){this.polygonCache.clear()}destroy(){this.clearAllPolygons(),this.clearCache(),this.map.hasLayer(this.polygonLayerGroup)&&this.map.removeLayer(this.polygonLayerGroup),this.polygonLayers.clear(),this.polygonLayerGroup=null,this.polygonRepository=null,this.map=null}}class os{constructor(e){this.config=e}renderFacets(e,t,n){if(!e||!this.config.aggregations){console.error("No aggregations data or configuration available.");return}const o=document.getElementById("facets-container"),s=this._getCheckedState();o.innerHTML="";const i={};Object.entries(this.config.aggregations).forEach(([l,c])=>{const d=c.category||"Other";i[d]||(i[d]=[]),i[d].push({facetKey:l,facetConfig:c})}),Object.entries(i).forEach(([l,c])=>{const d=document.createElement("div");d.className="facet-category",d.setAttribute("data-category",l);const h=document.createElement("h3");h.className="facet-category-title",h.textContent=l,d.appendChild(h);const m=document.createElement("div");m.className="facet-category-content",c.forEach(({facetKey:p,facetConfig:y})=>{const g=this._createFacetGroup(p,y);y.type==="range"?this._renderRangeFacet(g,p,y,e,s,t,n):y.type==="taxonomy"?this._renderTaxonomyFacet(g,p,y,e,s):this._renderStandardFacet(g,p,y,e,s),m.appendChild(g)}),d.appendChild(m),o.appendChild(d)}),this._addFacetEventListeners(n)}_getCheckedState(){const e={};return Object.keys(this.config.aggregations).forEach(t=>{const n=document.getElementById(`${t}-facet`);n&&(e[t]=Array.from(n.querySelectorAll("input:checked")).map(o=>o.value))}),e}_createFacetGroup(e,t){const n=document.createElement("div");n.className="facet-group mb-4 p-4 bg-white rounded-lg shadow",n.id=`${e}-facet`;const o=document.createElement("h3");return o.className="text-lg font-semibold mb-2",o.textContent=t.title||e,n.appendChild(o),n}_renderRangeFacet(e,t,n,o,s,i,l){const c=document.createElement("div");c.className="facet-slider my-4";const h=(o[t]||[]).map(_=>{const E=parseInt(_.key,10);return isNaN(E)?null:{value:E,count:_.doc_count||0}}).filter(_=>_!==null),m=h.map(_=>_.value),p=Math.min(...m),y=Math.max(...m);c.innerHTML=`
      <label class="sr-only">Value range</label>
      <div class="relative">
        <div id="${t}-chart" class="w-full h-24 mb-2"></div>
      </div>
      <div id="${t}-slider" class="mt-2"></div>
      <div class="mt-5">
        <div class="text-sm font-medium mb-2">Custom range:</div>
        <div class="flex space-x-4">
          <div class="flex-1">
            <input id="${t}-min-input" type="number"
                   class="py-2 px-3 block w-full border rounded-md text-sm focus:ring focus:ring-blue-500 focus:outline-none dark:bg-gray-800 dark:text-gray-300"
                   value="${p}">
          </div>
          <div class="flex-1">
            <input id="${t}-max-input" type="number"
                   class="py-2 px-3 block w-full border rounded-md text-sm focus:ring focus:ring-blue-500 focus:outline-none dark:bg-gray-800 dark:text-gray-300"
                   value="${y}">
          </div>
        </div>
      </div>
    `,e.appendChild(c);const g=c.querySelector(`#${t}-chart`),v=c.querySelector(`#${t}-slider`),k=c.querySelector(`#${t}-min-input`),S=c.querySelector(`#${t}-max-input`);this._renderBarChart(g,h,p,y);const M=i.filters[t];let P,A;!M||M.length===0?(P=p,A=y):(P=M[0],A=M[1]),noUiSlider.create(v,{start:[P,A],connect:!0,step:1,range:{min:p,max:y},format:{to:_=>Math.round(_),from:_=>parseInt(_,10)}}),v.noUiSlider.on("update",_=>{k.value=Math.round(Number(_[0])),S.value=Math.round(Number(_[1]))}),v.noUiSlider.on("change",_=>{const[E,B]=_.map(H=>Math.round(Number(H)));!isNaN(E)&&!isNaN(B)&&(l({type:"RANGE_CHANGE",facetKey:t,value:[E,B]}),this._updateChartHighlight(g,h,E,B))});const N=this._debounce(_=>{const E=_.target===k,B=parseInt(_.target.value,10),[H,re]=v.noUiSlider.get().map(Number);isNaN(B)||v.noUiSlider.set([E?B:H,E?re:B])},200);k.addEventListener("input",N),S.addEventListener("input",N),this._updateChartHighlight(g,h,P,A)}_renderTaxonomyFacet(e,t,n,o,s){const i=document.createElement("div");i.className="taxonomy-container";const l={};(o[t]||[]).forEach(p=>{const y=p.key.split(" > ");let g=l;y.forEach((v,k)=>{g[v]||(g[v]={children:{},docCount:0,selfCount:0}),k===y.length-1&&(g[v].selfCount=p.doc_count),g=g[v].children})});function d(p){let y=p.selfCount||0;return Object.values(p.children).forEach(g=>{y+=d(g)}),p.docCount=y,y}Object.values(l).forEach(p=>{d(p)});function h(p,y=[],g=0){let v='<ul class="taxonomy-list" style="margin-left: '+g*20+'px;">';return Object.entries(p).forEach(([k,S])=>{var N;if(k==="children"||k==="docCount"||k==="selfCount")return;const M=[...y,k],P=M.join(" > "),A=Object.keys(S.children).length>0;v+=`
          <li class="taxonomy-item">
            <div class="taxonomy-row">
              ${A?`<span class="toggle-btn" data-path="${P}"></span>`:'<span class="toggle-placeholder"></span>'}
              <label>
                <input type="checkbox" 
                       value="${P}" 
                       data-facet-type="${t}"
                       ${(N=s[t])!=null&&N.includes(P)?"checked":""}>
                <span>${k} (${S.docCount})</span>
              </label>
            </div>
            ${A?`<div class="children" data-parent="${P}" style="display: none;">
                ${h(S.children,M,g+1)}
              </div>`:""}
          </li>
        `}),v+"</ul>"}const m=document.createElement("style");m.textContent=`
      .taxonomy-list {
        list-style: none;
        padding: 0;
      }
      .taxonomy-item {
        margin: 5px 0;
      }
      .taxonomy-row {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .toggle-btn {
        cursor: pointer;
        width: 20px;
        user-select: none;
      }
      .toggle-placeholder {
        width: 20px;
      }
      .children {
        margin-left: 20px;
      }
    `,document.head.appendChild(m),i.innerHTML=h(l),i.addEventListener("click",p=>{if(p.target.classList.contains("toggle-btn")){const y=p.target.dataset.path,g=i.querySelector(`[data-parent="${y}"]`);if(g){const v=g.style.display==="none";g.style.display=v?"block":"none",p.target.textContent=v?"":""}}}),e.appendChild(i)}_renderStandardFacet(e,t,n,o,s){const i=document.createElement("div");i.className="facet-options space-y-2",(o[t]||[]).forEach(c=>{var p;const d=document.createElement("label");d.className="cursor-pointer block",d.style.display="block";const h=document.createElement("input");h.type="checkbox",h.value=c.key,h.className="form-checkbox mr-2",h.dataset.facetType=t,(p=s[t])!=null&&p.includes(c.key)&&(h.checked=!0);const m=document.createElement("span");m.textContent=`${c.key} (${c.doc_count})`,m.className="text-sm",d.appendChild(h),d.appendChild(m),i.appendChild(d)}),e.appendChild(i)}_renderBarChart(e,t,n,o){e.innerHTML="";const s=Math.max(...t.map(d=>d.count)),i=document.createElement("div");i.className="flex items-end w-full h-full relative",e.appendChild(i),[...t].sort((d,h)=>d.value-h.value).forEach(d=>{const h=s>0?d.count/s*100:0,m=document.createElement("div");m.className="flex-1 mx-px",m.style.height=`${h}%`,m.style.backgroundColor="#b0c4de",m.dataset.value=d.value,m.dataset.count=d.count,m.title=`Value: ${d.value}, Count: ${d.count}`,i.appendChild(m)});const c=document.createElement("div");c.className="absolute top-0 h-full pointer-events-none",c.style.backgroundColor="rgba(66, 153, 225, 0.3)",c.id=`${e.id}-highlight`,e.appendChild(c)}_updateChartHighlight(e,t,n,o){const s=e.querySelector(`#${e.id}-highlight`);if(!s)return;const i=t[t.length-1].value-t[0].value;if(i<=0)return;const l=(n-t[0].value)/i*100,c=(o-n)/i*100;s.style.left=`${l}%`,s.style.width=`${c}%`}_addFacetEventListeners(e){if(!this.config.aggregations){console.error("Aggregations configuration not found");return}Object.keys(this.config.aggregations).forEach(t=>{const n=document.getElementById(`${t}-facet`);n&&n.querySelectorAll("input").forEach(o=>{o.addEventListener("change",s=>{this._onFacetChange(s,e)})})})}_onFacetChange(e,t){const{value:n,checked:o}=e.target,s=e.target.dataset.facetType;t({type:"FACET_CHANGE",facetType:s,value:n,checked:o})}_debounce(e,t){let n;return function(){clearTimeout(n),n=setTimeout(()=>e.apply(this,arguments),t)}}}class ss{renderBarChart(e,t,n,o){e.innerHTML="";const s=Math.max(...t.map(d=>d.count)),i=document.createElement("div");i.className="flex items-end w-full h-full relative",e.appendChild(i),[...t].sort((d,h)=>d.value-h.value).forEach(d=>{const h=s>0?d.count/s*100:0,m=document.createElement("div");m.className="flex-1 mx-px",m.style.height=`${h}%`,m.style.backgroundColor="#b0c4de",m.dataset.value=d.value,m.dataset.count=d.count,m.title=`Value: ${d.value}, Count: ${d.count}`,i.appendChild(m)});const c=document.createElement("div");c.className="absolute top-0 h-full pointer-events-none",c.style.backgroundColor="rgba(66, 153, 225, 0.3)",c.id=`${e.id}-highlight`,e.appendChild(c)}updateChartHighlight(e,t,n,o){const s=e.querySelector(`#${e.id}-highlight`);if(!s)return;const i=t[t.length-1].value-t[0].value;if(i<=0)return;const l=(n-t[0].value)/i*100,c=(o-n)/i*100;s.style.left=`${l}%`,s.style.width=`${c}%`}}class is{renderTaxonomy(e,t,n,o){const s=this._buildHierarchy(t);this._calculateTotalCounts(s),this._addTaxonomyStyles(),e.innerHTML=this._createTaxonomyHTML(s,[],0,n,o),this._addToggleListeners(e)}_buildHierarchy(e){const t={};return e.forEach(n=>{const o=n.key.split(" > ");let s=t;o.forEach((i,l)=>{s[i]||(s[i]={children:{},docCount:0,selfCount:0}),l===o.length-1&&(s[i].selfCount=n.doc_count),s=s[i].children})}),t}_calculateTotalCounts(e){const t=n=>{let o=n.selfCount||0;return Object.values(n.children).forEach(s=>{o+=t(s)}),n.docCount=o,o};Object.values(e).forEach(n=>{t(n)})}_createTaxonomyHTML(e,t=[],n=0,o,s){let i=`<ul class="taxonomy-list" style="margin-left: ${n*20}px;">`;return Object.entries(e).forEach(([l,c])=>{var p;if(l==="children"||l==="docCount"||l==="selfCount")return;const d=[...t,l],h=d.join(" > "),m=Object.keys(c.children).length>0;i+=`
        <li class="taxonomy-item">
          <div class="taxonomy-row">
            ${m?`<span class="toggle-btn" data-path="${h}"></span>`:'<span class="toggle-placeholder"></span>'}
            <label>
              <input type="checkbox" 
                     value="${h}" 
                     data-facet-type="${o}"
                     ${(p=s[o])!=null&&p.includes(h)?"checked":""}>
              <span>${l} (${c.docCount})</span>
            </label>
          </div>
          ${m?`<div class="children" data-parent="${h}" style="display: none;">
              ${this._createTaxonomyHTML(c.children,d,n+1,o,s)}
            </div>`:""}
        </li>
      `}),i+"</ul>"}_addTaxonomyStyles(){if(document.getElementById("taxonomy-styles"))return;const e=document.createElement("style");e.id="taxonomy-styles",e.textContent=`
      .taxonomy-list {
        list-style: none;
        padding: 0;
      }
      .taxonomy-item {
        margin: 5px 0;
      }
      .taxonomy-row {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .toggle-btn {
        cursor: pointer;
        width: 20px;
        user-select: none;
      }
      .toggle-placeholder {
        width: 20px;
      }
      .children {
        margin-left: 20px;
      }
    `,document.head.appendChild(e)}_addToggleListeners(e){e.addEventListener("click",t=>{if(t.target.classList.contains("toggle-btn")){const n=t.target.dataset.path,o=e.querySelector(`[data-parent="${n}"]`);if(o){const s=o.style.display==="none";o.style.display=s?"block":"none",t.target.textContent=s?"":""}}})}}class as{constructor(e,t){this.searchEngine=e,this.config=t}performSearch(e,t={}){if(!this.searchEngine){console.error("Search engine not initialized");return}const{filters:n}=e,{regularFilters:o,dateFilters:s,taxonomyFilters:i}=this._separateFilters(n),l=this.searchEngine.search({query:e.query||"",filters:o,sort:e.sort||"title_asc",per_page:526,filter:d=>this._customFilter(d,s,i)}),c=this._extractCoordinates(l.data.items);if(t.onMarkersUpdate&&t.onMarkersUpdate(l.data.items),t.onResultsUpdate&&t.onResultsUpdate(l.data.items),t.onAggregationsUpdate){const d=this._formatAggregations(l.data.aggregations);t.onAggregationsUpdate(d)}return{items:l.data.items,coordinates:c,aggregations:this._formatAggregations(l.data.aggregations)}}_separateFilters(e){const t={},n={},o={};return Object.entries(e).forEach(([s,i])=>{if(!i||i.length===0)return;const l=this.config.aggregations[s];if(l)switch(l.type){case"range":n[s]=i;break;case"taxonomy":o[s]=i;break;default:t[s]=i}}),{regularFilters:t,dateFilters:n,taxonomyFilters:o}}_customFilter(e,t,n){for(const[o,s]of Object.entries(t))if(s.length===2){const[i,l]=s,c=new Date(e[o]).getTime();if(!(c>=i&&c<=l))return!1}for(const[o,s]of Object.entries(n)){if(!e[o])return!1;const i=e[o];if(!s.some(c=>i===c||i.startsWith(c+" > ")))return!1}return!0}_extractCoordinates(e){return e.filter(t=>t.lat_long&&t.lat_long.length>0).map(t=>{const n=t.lat_long[0],[o,s]=n.split(",");return[parseFloat(o),parseFloat(s)]})}_formatAggregations(e){const t={};for(const n in e)e.hasOwnProperty(n)&&(t[n]=e[n].buckets);return t}}class ls{constructor(e,t=null){this.mapFocusCallback=e,this.config=t,this.allWorks=[],this.items=[],this.searchState=null,this.isModalOpen=!1,this.currentModalIndex=0,this.isAnimating=!1}setData(e,t){this.allWorks=e,this.items=t}setConfig(e){this.config=e}setSearchState(e){this.searchState=e}_getCompleteWorkData(e){const t=this.items.filter(i=>i.ID_opera===e);if(t.length===0)return null;const n=t[0],o={ID_opera:e,Titolo:n.Titolo,Autore:n.Autore,Anno:n.Anno,"Spazi geografici":[],coordinates:[],allEntries:t,geodataBySpace:new Map},s=new Map;return t.forEach(i=>{i["Spazi geografici"]&&(Array.isArray(i["Spazi geografici"])?i["Spazi geografici"]:[i["Spazi geografici"]]).forEach((c,d)=>{if(!s.has(c)){const h=this._extractCoordinates(i,d);s.set(c,h);const m=this._getGeodataFields(),p={};m.forEach(y=>{i[y]!==void 0&&i[y]!==null&&i[y]!==""&&(Array.isArray(i[y])&&i[y].length>d?p[y]=i[y][d]:Array.isArray(i[y])||(p[y]=i[y]))}),o.geodataBySpace.set(c,p)}})}),o["Spazi geografici"]=Array.from(s.keys()),o.coordinates=Array.from(s.values()),o}_getCatalogueFields(){var e,t,n;return((n=(t=(e=this.config)==null?void 0:e.datasetConfig)==null?void 0:t.fields)==null?void 0:n.catalogue)||[]}_getGeodataFields(){var e,t,n;return((n=(t=(e=this.config)==null?void 0:e.datasetConfig)==null?void 0:t.fields)==null?void 0:n.geodata)||[]}_getAllMetadataFields(){const e=this._getCatalogueFields(),t=this._getGeodataFields();return[...new Set([...e,...t])]}_renderSelectedFilters(){if(!this.searchState||!this.searchState.filters)return"";const e=[];return this.searchState.query&&this.searchState.query.trim()&&e.push(`
        <div class="inline-flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
            <path fill-rule="evenodd" d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z" clip-rule="evenodd" />
          </svg>
          <span>Ricerca: "${this.searchState.query}"</span>
        </div>
      `),Object.entries(this.searchState.filters).forEach(([t,n])=>{Array.isArray(n)&&n.length>0?n.forEach(o=>{e.push(`
            <div class="inline-flex items-center gap-2 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
                <path d="M2 3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1a1 1 0 0 1-.293.707L10 8.414V12a1 1 0 0 1-.293.707l-2 2A1 1 0 0 1 6 14v-5.586L2.293 4.707A1 1 0 0 1 2 4V3Z" />
              </svg>
              <span>${t}: ${o}</span>
            </div>
          `)}):n&&!Array.isArray(n)&&e.push(`
          <div class="inline-flex items-center gap-2 px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
              <path d="M2 3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1a1 1 0 0 1-.293.707L10 8.414V12a1 1 0 0 1-.293.707l-2 2A1 1 0 0 1 6 14v-5.586L2.293 4.707A1 1 0 0 1 2 4V3Z" />
            </svg>
            <span>${t}: ${n}</span>
          </div>
        `)}),e.length===0?"":`
      <div class="flex flex-wrap items-center gap-2 bg-white/80 backdrop-blur-sm rounded-xl px-4 py-3 shadow-md ring-1 ring-gray-200/50 border border-gray-200/30">
        <div class="text-sm font-medium text-gray-700 mr-2">Filtri attivi:</div>
        ${e.join("")}
      </div>
    `}async toggleModal(e){this.isAnimating||(this.isModalOpen?await this._closeModal():(this.currentModalIndex=e,await this._openModal()))}async _openModal(){this.isAnimating=!0;let e=document.getElementById("works-modal");e||(e=this._createModal(),document.body.appendChild(e)),e.classList.remove("hidden"),e.style.opacity="0";const t=e.querySelector(".modal-container");t&&(t.style.transform="scale(0.8) translateY(20px)",t.style.opacity="0"),this._populateModal(),this.isModalOpen=!0,document.body.style.overflow="hidden",e.offsetHeight,e.style.transition="opacity 300ms cubic-bezier(0.4, 0, 0.2, 1)",e.style.opacity="1",t&&(t.style.transition="all 400ms cubic-bezier(0.34, 1.56, 0.64, 1)",t.style.transform="scale(1) translateY(0)",t.style.opacity="1"),setTimeout(()=>{this._animateContentItems(),this.isAnimating=!1},200)}async _closeModal(){if(!this.isModalOpen)return;this.isAnimating=!0;const e=document.getElementById("works-modal");if(e){const t=e.querySelector(".modal-container");e.style.transition="opacity 250ms cubic-bezier(0.4, 0, 1, 1)",e.style.opacity="0",t&&(t.style.transition="all 250ms cubic-bezier(0.4, 0, 1, 1)",t.style.transform="scale(0.95) translateY(-10px)",t.style.opacity="0"),await new Promise(n=>setTimeout(n,250)),e.classList.add("hidden"),e.style.opacity="",t&&(t.style.transform="",t.style.opacity="")}this.isModalOpen=!1,document.body.style.overflow="auto",this.isAnimating=!1}_animateContentItems(){const e=document.querySelector(".modal-header");e&&(e.style.opacity="0",e.style.transform="translateY(-20px)",e.style.transition="all 500ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{e.style.opacity="1",e.style.transform="translateY(0)"},100));const t=document.querySelector(".filters-section");t&&(t.style.opacity="0",t.style.transform="translateY(-10px)",t.style.transition="all 400ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{t.style.opacity="1",t.style.transform="translateY(0)"},150)),document.querySelectorAll(".metadata-card").forEach((s,i)=>{s.style.opacity="0",s.style.transform="translateY(20px)",s.style.transition="all 400ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{s.style.opacity="1",s.style.transform="translateY(0)"},200+i*50)}),document.querySelectorAll(".space-card").forEach((s,i)=>{s.style.opacity="0",s.style.transform="translateX(-20px)",s.style.transition="all 500ms cubic-bezier(0.4, 0, 0.2, 1)",setTimeout(()=>{s.style.opacity="1",s.style.transform="translateX(0)"},300+i*75)})}_createModal(){const e=document.createElement("div");return e.id="works-modal",e.className="fixed inset-0 bg-gradient-to-br from-slate-900/90 to-gray-900/90 backdrop-blur-md z-50 hidden flex items-center justify-center p-4",e.innerHTML=`
      <div class="modal-container relative w-full max-w-7xl h-[90vh] overflow-hidden">
        <!-- Enhanced Header with Close Button and Filters -->
        <div class="absolute top-0 left-0 right-0 px-6 py-4 z-20">
          <div class="flex items-center justify-between">
            <!-- Filters section on the left -->
            <div class="filters-section flex-1 mr-6">
              <!-- Filters will be populated here -->
            </div>
            
            <!-- Close button on the right -->
            <button id="close-modal-btn" class="p-3 bg-white/90 hover:bg-white active:bg-gray-100 rounded-full text-gray-600 hover:text-red-500 shadow-lg hover:shadow-xl transition-all duration-300 group backdrop-blur-sm border border-gray-200/50 hover:border-red-200 flex-shrink-0">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 group-hover:rotate-90 transition-transform duration-300">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
        
        <!-- Content Container with fixed width to prevent resizing -->
        <div id="modal-content" class="h-full pt-20 pb-16 rounded-2xl w-full max-w-none overflow-hidden"></div>
        
        <!-- Enhanced Footer with Progress Indicator -->
        <div class="absolute bottom-0 left-0 right-0 px-6 py-4 z-20">
          <div class="flex items-center justify-center">
            <span id="modal-progress" class="text-sm font-semibold text-gray-700 bg-white/90 backdrop-blur-sm px-6 py-3 rounded-full shadow-lg ring-1 ring-white/20 border border-gray-200/50 transition-all duration-300 hover:shadow-xl">
            </span>
          </div>
        </div>
      </div>
    `,e.addEventListener("click",t=>{t.target===e&&this._closeModal()}),e.querySelector("#close-modal-btn").addEventListener("click",()=>{this._closeModal()}),document.addEventListener("keydown",t=>{!this.isModalOpen||this.isAnimating||(t.key==="Escape"?this._closeModal():t.key==="ArrowLeft"?this._navigateModal(-1):t.key==="ArrowRight"&&this._navigateModal(1))}),e}async _navigateModal(e){if(this.isAnimating)return;const t=this.currentModalIndex+e;if(t>=0&&t<this.allWorks.length){this.isAnimating=!0;const n=document.getElementById("modal-content");if(!n)return;const o=n.querySelector(".main-content-panel");if(!o)return;const s=document.createElement("div");s.className="relative w-full h-full overflow-hidden";const i=document.createElement("div");i.className="absolute inset-0 w-full h-full transition-transform duration-500 ease-out overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl border border-gray-200/50 ring-1 ring-white/20",i.innerHTML=o.innerHTML;const l=document.createElement("div");l.className="absolute inset-0 w-full h-full transition-transform duration-500 ease-out overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl border border-gray-200/50 ring-1 ring-white/20";const c="100%";l.style.transform=`translateX(${e>0?c:`-${c}`})`,this.currentModalIndex=t;const d=this.allWorks[this.currentModalIndex],h=this._getCompleteWorkData(d.ID_opera);h&&(l.innerHTML=this._renderMainCard(h)),o.parentNode.replaceChild(s,o),s.appendChild(i),s.appendChild(l),this._updateNavigationButtons(),s.offsetHeight,i.style.transform=`translateX(${e>0?`-${c}`:c})`,l.style.transform="translateX(0)",i.style.opacity="0.8",l.style.opacity="1",await new Promise(y=>setTimeout(y,500));const m=document.createElement("div");m.className="main-content-panel flex-1 min-w-0 overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl hover:shadow-2xl transition-all duration-500 border border-gray-200/50 ring-1 ring-white/20",m.innerHTML=l.innerHTML,s.parentNode.replaceChild(m,s);const p=document.getElementById("modal-progress");p&&(p.textContent=`${this.currentModalIndex+1} di ${this.allWorks.length}`),this._addMapFocusListeners(),setTimeout(()=>{this._animateContentItems(),this.isAnimating=!1},100)}}_updateNavigationButtons(){const e=document.getElementById("prev-work-btn"),t=document.getElementById("next-work-btn");e&&(this.currentModalIndex===0?(e.disabled=!0,e.className=e.className.replace("hover:scale-110 hover:-translate-y-1","opacity-40 cursor-not-allowed")):(e.disabled=!1,e.className=e.className.replace("opacity-40 cursor-not-allowed","hover:scale-110 hover:-translate-y-1"))),t&&(this.currentModalIndex===this.allWorks.length-1?(t.disabled=!0,t.className=t.className.replace("hover:scale-110 hover:-translate-y-1","opacity-40 cursor-not-allowed")):(t.disabled=!1,t.className=t.className.replace("opacity-40 cursor-not-allowed","hover:scale-110 hover:-translate-y-1"))),this._updatePreviewCards()}_updatePreviewCards(){const e=this.currentModalIndex>0?this.allWorks[this.currentModalIndex-1]:null,t=this.currentModalIndex<this.allWorks.length-1?this.allWorks[this.currentModalIndex+1]:null,n=e?this._getCompleteWorkData(e.ID_opera):null,o=t?this._getCompleteWorkData(t.ID_opera):null,s=document.querySelector(".left-nav-panel .preview-card");s&&(n?(s.className="preview-card text-center bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 px-4 py-6 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1",s.innerHTML=`
          <div class="w-12 h-1 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full mx-auto mb-4"></div>
          <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${n.Titolo}</h4>
          <p class="text-xs text-gray-600 font-medium">${n.Autore}</p>
          <p class="text-xs text-gray-500">(${n.Anno})</p>
        `):(s.className="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48",s.innerHTML='<div class="text-sm text-gray-400 font-medium">Nessuna opera precedente</div>'));const i=document.querySelector(".right-nav-panel .preview-card");i&&(o?(i.className="preview-card text-center px-4 py-6 bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1",i.innerHTML=`
          <div class="w-12 h-1 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full mx-auto mb-4"></div>
          <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${o.Titolo}</h4>
          <p class="text-xs text-gray-600 font-medium">${o.Autore}</p>
          <p class="text-xs text-gray-500">(${o.Anno})</p>
        `):(i.className="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48",i.innerHTML='<div class="text-sm text-gray-400 font-medium">Nessuna opera successiva</div>'))}_addNavigationListeners(){const e=document.getElementById("prev-work-btn"),t=document.getElementById("next-work-btn");e&&this.currentModalIndex>0&&e.addEventListener("click",()=>this._navigateModal(-1)),t&&this.currentModalIndex<this.allWorks.length-1&&t.addEventListener("click",()=>this._navigateModal(1))}_populateModal(){const e=document.getElementById("modal-content"),t=document.getElementById("modal-progress"),n=document.querySelector(".filters-section");if(!e)return;n&&(n.innerHTML=this._renderSelectedFilters());const o=this.allWorks[this.currentModalIndex],s=this._getCompleteWorkData(o.ID_opera),i=this.currentModalIndex>0?this.allWorks[this.currentModalIndex-1]:null,l=this.currentModalIndex<this.allWorks.length-1?this.allWorks[this.currentModalIndex+1]:null,c=i?this._getCompleteWorkData(i.ID_opera):null,d=l?this._getCompleteWorkData(l.ID_opera):null;if(!s){e.innerHTML='<div class="flex items-center justify-center h-full text-gray-500 text-lg">Dati non disponibili</div>';return}e.innerHTML=`
      <div class="flex h-full w-full">
        <!-- Enhanced Left Navigation Panel with fixed width -->
        <div class="left-nav-panel flex flex-col items-center justify-center p-6 space-y-6 w-64 flex-shrink-0">
          <button id="prev-work-btn" class="group p-4 bg-white/90 hover:bg-white active:bg-gray-50 rounded-2xl text-gray-600 hover:text-blue-600 transition-all duration-300 shadow-lg hover:shadow-xl ring-1 ring-gray-200/50 hover:ring-blue-200 backdrop-blur-sm border border-gray-200/30 ${this.currentModalIndex===0?"opacity-40 cursor-not-allowed":"hover:scale-110 hover:-translate-y-1"}" ${this.currentModalIndex===0?"disabled":""}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 group-hover:-translate-x-1 transition-transform duration-300">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
            </svg>
          </button>
          
          ${c?`
            <div class="preview-card text-center bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 px-4 py-6 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
              <div class="w-12 h-1 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full mx-auto mb-4"></div>
              <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${c.Titolo}</h4>
              <p class="text-xs text-gray-600 font-medium">${c.Autore}</p>
              <p class="text-xs text-gray-500">(${c.Anno})</p>
            </div>
          `:`
            <div class="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48">
              <div class="text-sm text-gray-400 font-medium">Nessuna opera precedente</div>
            </div>
          `}
        </div>

        <!-- Enhanced Main Content Area with fixed flex properties -->
        <div class="main-content-panel flex-1 min-w-0 overflow-y-auto bg-white/95 backdrop-blur-sm rounded-xl shadow-xl hover:shadow-2xl transition-all duration-500 border border-gray-200/50 ring-1 ring-white/20">
          ${this._renderMainCard(s)}
        </div>

        <!-- Enhanced Right Navigation Panel with fixed width -->
        <div class="right-nav-panel flex flex-col items-center justify-center p-6 space-y-6 w-64 flex-shrink-0">
          <button id="next-work-btn" class="group p-4 bg-white/90 hover:bg-white active:bg-gray-50 rounded-2xl text-gray-600 hover:text-blue-600 transition-all duration-300 shadow-lg hover:shadow-xl ring-1 ring-gray-200/50 hover:ring-blue-200 backdrop-blur-sm border border-gray-200/30 ${this.currentModalIndex===this.allWorks.length-1?"opacity-40 cursor-not-allowed":"hover:scale-110 hover:-translate-y-1"}" ${this.currentModalIndex===this.allWorks.length-1?"disabled":""}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7 group-hover:translate-x-1 transition-transform duration-300">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
            </svg>
          </button>
          
          ${d?`
            <div class="preview-card text-center px-4 py-6 bg-white/90 backdrop-blur-sm rounded-xl shadow-lg ring-1 ring-gray-200/50 border border-gray-200/30 w-48 transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
              <div class="w-12 h-1 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full mx-auto mb-4"></div>
              <h4 class="text-sm font-semibold text-gray-800 leading-relaxed mb-2">${d.Titolo}</h4>
              <p class="text-xs text-gray-600 font-medium">${d.Autore}</p>
              <p class="text-xs text-gray-500">(${d.Anno})</p>
            </div>
          `:`
            <div class="preview-card text-center px-4 py-6 bg-gray-50/80 backdrop-blur-sm rounded-xl border-2 border-dashed border-gray-300/50 w-48">
              <div class="text-sm text-gray-400 font-medium">Nessuna opera successiva</div>
            </div>
          `}
        </div>
      </div>
    `,t&&(t.textContent=`${this.currentModalIndex+1} di ${this.allWorks.length}`),this._addNavigationListeners(),this._addMapFocusListeners()}_renderMainCard(e){const t=e.allEntries[0],n=this._renderCombinedMetadata(t),o=this._renderGeographicalSpaces(e);return`
      <div class="p-8 space-y-8 w-full">
        <!-- Enhanced Header Section -->
        <div class="modal-header bg-gradient-to-r from-slate-50/90 to-gray-50/90 backdrop-blur-sm rounded-2xl p-8 ring-1 ring-gray-200/50 border border-gray-200/30">
          <div class="flex items-start justify-between">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-1 h-12 bg-gradient-to-b from-blue-500 to-blue-600 rounded-full shadow-sm flex-shrink-0"></div>
                <div class="min-w-0 flex-1">
                  <h1 class="text-3xl font-bold text-gray-900 leading-tight truncate">${e.Titolo}</h1>
                  <div class="flex items-center gap-4 mt-2">
                    <p class="text-lg text-gray-700 font-medium truncate">${e.Autore}</p>
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full flex-shrink-0"></span>
                    <p class="text-lg text-gray-600 font-mono flex-shrink-0">${e.Anno}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        ${n}
        ${o}
      </div>
    `}_renderCombinedMetadata(e){const t=this._getCatalogueFields(),n=[],o=t.filter(s=>!n.includes(s)&&e[s]!=null&&e[s]!=="").map(s=>{const i=e[s];let l=i;return Array.isArray(i)?l=i.join(", "):typeof i=="string"&&i.length>150&&(l=i.substring(0,147)+"..."),`
          <div class="metadata-card group bg-white/90 hover:bg-white backdrop-blur-sm hover:shadow-lg rounded-xl p-5 ring-1 ring-gray-200/50 hover:ring-gray-300/70 transition-all duration-300 border border-gray-200/30 hover:border-gray-300/50 hover:-translate-y-0.5">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-2 h-2 bg-gradient-to-r from-green-400 to-green-600 rounded-full group-hover:scale-125 transition-transform duration-300 shadow-sm"></div>
              <h4 class="text-sm font-semibold text-gray-800 uppercase tracking-wide">${s}</h4>
            </div>
            <div class="text-base text-gray-700 leading-relaxed pl-5">${l}</div>
          </div>
        `}).join("");return o?`
      <div>
        <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-green-600">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0-1.125.504-1.125 1.125V11.25a9 9 0 0 0-9-9Z" />
          </svg>
          Metadati del catalogo
        </h2>
        <div class="grid gap-4">
          ${o}
        </div>
      </div>
    `:""}_renderGeographicalSpaces(e){return!e["Spazi geografici"]||e["Spazi geografici"].length===0?`
        <div class="bg-gradient-to-r from-blue-50/90 to-indigo-50/90 backdrop-blur-sm rounded-2xl p-8 ring-1 ring-blue-200/50 border border-blue-200/30">
          <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-blue-600">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
            </svg>
            Spazi geografici
          </h2>
          <div class="text-gray-500 italic">Nessun spazio geografico disponibile</div>
        </div>
      `:`
      <div class="bg-gradient-to-r from-blue-50/90 to-indigo-50/90 backdrop-blur-sm rounded-2xl p-8 ring-1 ring-blue-200/50 border border-blue-200/30">
        <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-blue-600">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
          </svg>
          Spazi geografici
        </h2>
        <div class="grid gap-6">
          ${e["Spazi geografici"].map((n,o)=>{const s=e.coordinates[o],i=e.geodataBySpace.get(n)||{},l=this._getAllMetadataFields(),c=this._getCatalogueFields(),d=[],h=l.filter(p=>!d.includes(p)&&!c.includes(p)).map(p=>{let y=i[p];if(y==null||y==="")return"";let g=y;return typeof y=="string"&&y.length>100&&(g=y.substring(0,97)+"..."),`
            <div class="flex items-start gap-3 py-2">
              <div class="w-1.5 h-1.5 bg-blue-400 rounded-full mt-2 flex-shrink-0"></div>
              <div class="min-w-0 flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-xs font-semibold text-gray-600 uppercase tracking-wide">${p}</span>
                </div>
                <span class="text-sm text-gray-800">${g}</span>
              </div>
            </div>
          `}).filter(Boolean).join(""),m=s&&s.lat&&s.lng;return`
        <div class="space-card bg-white/90 backdrop-blur-sm rounded-xl p-6 ring-1 ring-gray-200/50 hover:ring-blue-300/70 transition-all duration-300 hover:shadow-lg border border-gray-200/30 hover:border-blue-300/50 hover:-translate-y-1">
          <div class="flex items-start justify-between mb-4">
            <div class="flex items-center gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-5 h-5 text-blue-600 flex-shrink-0">
                <path fill-rule="evenodd" d="m7.539 14.841.003.003.002.002a.755.755 0 0 0 .912 0l.002-.002.003-.003.012-.009a5.57 5.57 0 0 0 .19-.153 15.588 15.588 0 0 0 2.046-2.082c1.101-1.362 2.291-3.342 2.291-5.597A5 5 0 0 0 3 7c0 2.255 1.19 4.235 2.292 5.597a15.591 15.591 0 0 0 2.046 2.082 8.916 8.916 0 0 0 .189.153l.012.01ZM8 8.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" clip-rule="evenodd" />
              </svg>
              <h3 class="text-lg font-semibold text-gray-900">${n}</h3>
            </div>
            
            ${m?`
              <button class="map-btn group px-4 py-2 text-sm font-medium bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 active:from-blue-700 active:to-blue-800 text-white rounded-lg shadow-md hover:shadow-lg transition-all duration-300 hover:scale-105 hover:-translate-y-0.5" 
                      data-lat="${s.lat}" 
                      data-lng="${s.lng}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 inline mr-1">
                  <path fill-rule="evenodd" d="M8 1a.75.75 0 0 1 .75.75V6h4.5a.75.75 0 0 1 0 1.5H8.75v4.25a.75.75 0 0 1-1.5 0V7.5H2.75a.75.75 0 0 1 0-1.5h4.5V1.75A.75.75 0 0 1 8 1Z" clip-rule="evenodd" />
                </svg>
                Visualizza sulla mappa
              </button>
            `:`
              <span class="px-4 py-2 text-sm font-medium bg-gray-100/80 text-gray-500 rounded-lg ring-1 ring-gray-200/50 backdrop-blur-sm">
                Coordinate non disponibili
              </span>
            `}
          </div>
          
          ${h?`
            <div class="border-t border-gray-100/50 pt-4 mt-4">
              <h4 class="text-sm font-semibold text-gray-700 mb-3">Metadati geografici per questo spazio:</h4>
              <div class="space-y-2">
                ${h}
              </div>
            </div>
          `:`
            <div class="border-t border-gray-100/50 pt-4 mt-4">
              <div class="text-sm text-gray-500 italic">Nessun metadato geografico disponibile per questo spazio</div>
            </div>
          `}
        </div>
      `}).join("")}
        </div>
        <div class="mt-6 text-sm text-blue-700 bg-blue-100/80 backdrop-blur-sm rounded-lg p-3 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
            <path fill-rule="evenodd" d="M15 8A7 7 0 1 1 1 8a7 7 0 0 1 14 0ZM9 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0ZM6.75 8a.75.75 0 0 0 0 1.5h.75v1.75a.75.75 0 0 0 1.5 0v-2.5A.75.75 0 0 0 8.25 8h-1.5Z" clip-rule="evenodd" />
          </svg>
          <span>Clicca sui pulsanti per visualizzare i luoghi sulla mappa. Ogni spazio mostra solo i metadati geografici disponibili.</span>
        </div>
      </div>
    `}_addMapFocusListeners(){document.querySelectorAll(".map-btn").forEach(e=>{e.addEventListener("click",()=>{const t=parseFloat(e.getAttribute("data-lat")),n=parseFloat(e.getAttribute("data-lng"));t&&n&&this.mapFocusCallback&&(this.mapFocusCallback(t,n,8),this._closeModal())})})}_extractCoordinates(e,t){let n={lat:null,lng:null};if(Array.isArray(e.lat_long)&&e.lat_long.length>t){const o=e.lat_long[t];if(o&&typeof o=="string"){const s=o.split(",");if(s.length===2){const i=parseFloat(s[0].trim()),l=parseFloat(s[1].trim());!isNaN(i)&&!isNaN(l)&&(n={lat:i,lng:l})}}}else if(e.lat_long&&typeof e.lat_long=="string"){const o=e.lat_long.split(",");if(o.length===2){const s=parseFloat(o[0].trim()),i=parseFloat(o[1].trim());!isNaN(s)&&!isNaN(i)&&(n={lat:s,lng:i})}}return n}}class cs{constructor(e){this.mapFocusCallback=e,this.allWorks=[],this.modalRenderer=new ls(e)}updateResultsList(e,t,n={}){const o=document.getElementById("results");if(!o){console.error("Results container not found");return}this.items=e,this.searchState=n;const s=this._groupByIdOpera(e);this.allWorks=Object.values(s),this.modalRenderer.setData(this.allWorks,this.items),this.modalRenderer.setConfig(t),this.modalRenderer.setSearchState(n),o.innerHTML=this.allWorks.map((i,l)=>this._renderResultItem(i,l)).join(""),this._addMapFocusListeners(),this._addModalListeners()}_groupByIdOpera(e){const t={};return e.forEach(n=>{const o=n.ID_opera;t[o]||(t[o]={ID_opera:o,Titolo:n.Titolo,Autore:n.Autore,Anno:n.Anno,"Spazi geografici":[],coordinates:[]}),n["Spazi geografici"]&&(Array.isArray(n["Spazi geografici"])?n["Spazi geografici"]:[n["Spazi geografici"]]).forEach((i,l)=>{if(!t[o]["Spazi geografici"].includes(i)){t[o]["Spazi geografici"].push(i);const c=this._extractCoordinatesFromItem(n,l);t[o].coordinates.push(c)}})}),t}_renderResultItem(e,t){const n=e["Spazi geografici"].map((o,s)=>{const i=e.coordinates[s];return i&&i.lat&&i.lng?`
          <button class="focus-map-btn mr-2 mb-2 inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border bg-indigo-100 text-indigo-700 border-indigo-200 transition-all duration-200 hover:shadow-sm hover:bg-indigo-200 hover:scale-105 active:scale-95 cursor-pointer transform" 
                  data-space="${encodeURIComponent(o)}" 
                  data-lat="${i.lat}" 
                  data-lng="${i.lng}"
                  title="Clicca per visualizzare sulla mappa">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4 inline mr-1">
              <path fill-rule="evenodd" d="m7.539 14.841.003.003.002.002a.755.755 0 0 0 .912 0l.002-.002.003-.003.012-.009a5.57 5.57 0 0 0 .19-.153 15.588 15.588 0 0 0 2.046-2.082c1.101-1.362 2.291-3.342 2.291-5.597A5 5 0 0 0 3 7c0 2.255 1.19 4.235 2.292 5.597a15.591 15.591 0 0 0 2.046 2.082 8.916 8.916 0 0 0 .189.153l.012.01ZM8 8.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" clip-rule="evenodd" />
            </svg>
            ${o}
          </button>
        `:`
            <button class="focus-map-btn mr-2 mb-2 inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border bg-slate-100 text-slate-700 border-slate-200 transition-all duration-200 hover:shadow-sm hover:bg-slate-200 hover:scale-105 active:scale-95 cursor-pointer transform"
                  data-space="${encodeURIComponent(o)}"
                  title="Coordinate non disponibili">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4 inline mr-1 opacity-50">
              <path fill-rule="evenodd" d="m7.539 14.841.003.003.002.002a.755.755 0 0 0 .912 0l.002-.002.003-.003.012-.009a5.57 5.57 0 0 0 .19-.153 15.588 15.588 0 0 0 2.046-2.082c1.101-1.362 2.291-3.342 2.291-5.597A5 5 0 0 0 3 7c0 2.255 1.19 4.235 2.292 5.597a15.591 15.591 0 0 0 2.046 2.082 8.916 8.916 0 0 0 .189.153l.012.01ZM8 8.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" clip-rule="evenodd" />
            </svg>
            ${o}
          </button>
        `}).join("");return`
      <div class="result-card p-4 bg-white rounded-lg shadow hover:shadow-md transition-shadow">
        <h3 class="font-semibold flex items-center justify-between mb-3">
          <span>${e.Titolo}, ${e.Autore} (${e.Anno})</span>
            <button class="modal-toggle-btn ml-2 inline-flex items-center justify-center p-2 rounded-full border bg-slate-100 text-slate-700 border-slate-200 transition-all duration-200 hover:shadow-sm hover:bg-slate-200 hover:scale-105 active:scale-95 cursor-pointer transform"
                    data-work-index="${t}"
                    title="Visualizza tutte le opere">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z" />
                </svg>
            </button>
        </h3>
<div class="w-full max-w-6xl mx-auto px-4">
    <div class="flex items-start mt-2">
        <div class="w-2 h-2 rounded-full bg-indigo-500 mt-2 mr-3 flex-shrink-0"></div>
        <div class="flex-1 min-w-0">
            <h4 class="text-sm font-semibold text-gray-800 mb-2">Spazi geografici descritti</h4>
            <div class="flex flex-wrap gap-1">
                ${n}
            </div>
        </div>
    </div>
</div>
      </div>
    `}_addModalListeners(){document.querySelectorAll(".modal-toggle-btn").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const n=parseInt(e.getAttribute("data-work-index"));this.modalRenderer.toggleModal(n)})})}_extractCoordinatesFromItem(e,t){let n={lat:null,lng:null};if(Array.isArray(e.lat_long)&&e.lat_long.length>t){const o=e.lat_long[t];if(o&&typeof o=="string"){const s=o.split(",");if(s.length===2){const i=parseFloat(s[0].trim()),l=parseFloat(s[1].trim());!isNaN(i)&&!isNaN(l)&&(n.lat=i,n.lng=l)}}}else if(e.lat_long&&typeof e.lat_long=="string"){const o=e.lat_long.split(",");if(o.length===2){const s=parseFloat(o[0].trim()),i=parseFloat(o[1].trim());!isNaN(s)&&!isNaN(i)&&(n.lat=s,n.lng=i)}}return n}_addMapFocusListeners(){document.querySelectorAll(".focus-map-btn").forEach(e=>{e.addEventListener("click",t=>{const n=e.getAttribute("data-lat"),o=e.getAttribute("data-lng");n&&o&&this.mapFocusCallback?this.mapFocusCallback(parseFloat(n),parseFloat(o),8):console.warn("Coordinate non disponibili per questa opera:",e.getAttribute("data-space"))})})}}class ds{static debounce(e,t){let n;return function(){clearTimeout(n),n=setTimeout(()=>e.apply(this,arguments),t)}}static parseCoordinates(e){if(!e||typeof e!="string")return{lat:null,lng:null};const t=e.split(",");return t.length===2?{lat:parseFloat(t[0].trim()),lng:parseFloat(t[1].trim())}:{lat:null,lng:null}}static encodeForAttribute(e){return encodeURIComponent(e||"")}static createUniqueId(e="element"){return`${e}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}static isEmpty(e){return e==null?!0:typeof e=="string"?e.trim()==="":Array.isArray(e)?e.length===0:typeof e=="object"?Object.keys(e).length===0:!1}}class us{constructor(){this.loadConfiguration=$r.bind(this),this.config=null,this.searchEngine=null,this.state={query:"",filters:{},sort:"",bounds:null},this.lastLoadedPolygonIds=new Set,this.initializeMapLoader(),this.initializeLoaderSystem(),this.navBar=ts,this.initialize()}async initialize(){try{this.showFilterLoader(),this.config=await this.loadConfiguration();const e=await Ir();this.config.searchConfig.per_page=e.length,this.searchEngine=Ko(e,this.config),console.log("Search engine initialized with data:",e.length,"items"),this.state.sort=this.config.searchConfig.defaultSort;const t={};for(const[o,s]of Object.entries(this.config.aggregations))t[o]=[];this.state.filters=t;const n=Pr(this.config);this.map=n.map,this.markers=n.markers,this.renderMarkers=n.renderMarkers,this.polygonManager=new ns(this.map),this.facetRenderer=new os(this.config),this.rangeRenderer=new ss,this.taxonomyRenderer=new is,this.searchHandler=new as(this.searchEngine,this.config),this.resultsRenderer=new cs((o,s,i)=>this.focusOnMap(o,s,i)),this.navBar.setConfig(this.config),this.debouncedSearch=ds.debounce(this.performSearch.bind(this),300),console.log("PolygonManager initialized:",this.polygonManager),this.bindEvents(),this.bindNavBarEvents(),await this.fetchAggregations(),await this.performSearch(),this.showMap(),setTimeout(()=>{this.hideFilterLoader()},500)}catch(e){console.error("Initialization error:",e),this.hideFilterLoader()}}initializeMapLoader(){if(this.mapContainer=document.getElementById("map")||document.querySelector(".map-container")||document.querySelector("#map-container"),this.mapContainer){this.mapContainer.style.opacity="0.2",this.mapContainer.style.pointerEvents="none",this.mapContainer.style.transition="opacity 0.8s ease-in-out";const e=document.createElement("div");e.id="map-loading-overlay",e.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(3px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #666;
      transition: opacity 0.8s ease-in-out;
    `,e.innerHTML="Loading map and data...",this.mapContainer.style.position="relative",this.mapContainer.appendChild(e),this.mapOverlay=e}this.isFullyLoaded=!1}showMap(){this.isFullyLoaded=!0,setTimeout(()=>{this.mapContainer&&(this.mapContainer.style.opacity="1",this.mapContainer.style.pointerEvents="auto"),this.mapOverlay&&(this.mapOverlay.style.opacity="0",setTimeout(()=>{this.mapOverlay&&this.mapOverlay.parentNode&&this.mapOverlay.parentNode.removeChild(this.mapOverlay)},800))},1500)}showMapAfterFirstSearch(){this.isFullyLoaded&&(this.mapContainer&&(this.mapContainer.style.opacity="1",this.mapContainer.style.pointerEvents="auto"),this.mapOverlay&&(this.mapOverlay.style.opacity="0",setTimeout(()=>{this.mapOverlay&&this.mapOverlay.parentNode&&this.mapOverlay.parentNode.removeChild(this.mapOverlay)},800)))}initializeLoaderSystem(){this.createFilterLoader()}createFilterLoader(){this.filterLoader=document.createElement("div"),this.filterLoader.id="filter-loader",this.filterLoader.className=`
      fixed top-0 left-0 right-0 z-40 
      bg-gradient-to-r from-blue-500 to-purple-500 
      h-1 transform scale-x-0 origin-left
      transition-transform duration-300 ease-out
      shadow-lg
    `,document.body.appendChild(this.filterLoader)}showFilterLoader(){this.filterLoader&&(this.filterLoader.style.transform="scaleX(1)")}hideFilterLoader(){this.filterLoader&&setTimeout(()=>{this.filterLoader&&(this.filterLoader.style.transform="scaleX(0)")},150)}bindNavBarEvents(){this.navBar.addEventListener("clearAllFilters",()=>{this.showFilterLoader(),this.clearAllFilters()}),this.navBar.addEventListener("removeFilter",e=>{const{facetKey:t,value:n}=e.detail;this.showFilterLoader(),this.removeSpecificFilter(t,n)}),this.navBar.addEventListener("clearSearchQuery",()=>{this.showFilterLoader(),this.clearSearchQuery()})}clearAllFilters(){this.state.query="",this.state.filters={};for(const[t,n]of Object.entries(this.config.aggregations))this.state.filters[t]=[];const e=document.getElementById("search-input");e&&(e.value=""),this.performSearchWithLoader().finally(()=>{this.hideFilterLoader()})}removeSpecificFilter(e,t){this.state.filters[e]&&(t?this.state.filters[e]=this.state.filters[e].filter(n=>n!==t):this.state.filters[e]=[],this.performSearchWithLoader().finally(()=>{this.hideFilterLoader()}))}clearSearchQuery(){this.state.query="";const e=document.getElementById("search-input");e&&(e.value=""),this.performSearchWithLoader().finally(()=>{this.hideFilterLoader()})}renderFacets(e){this.facetRenderer.renderFacets(e,this.state,t=>this.handleStateChange(t))}updateNavBar(e=0,t={}){this.navBar.updateFromSearchState(this.state,e,t)}async performSearchWithLoader(){return new Promise(e=>{const t=this.performSearch();setTimeout(()=>{e(t)},300)})}performSearch(){const e=this.searchHandler.performSearch(this.state,{onMarkersUpdate:t=>this.renderMarkers(t),onResultsUpdate:t=>this.resultsRenderer.updateResultsList(t,this.config,{filters:this.state.filters,query:this.state.query,sort:this.state.sort}),onAggregationsUpdate:t=>this.renderFacets(t)});return this.updateNavBar(e.items?e.items.length:0),e.items&&e.items.length<=400?this.loadPolygonsForSearchResults():(console.log(`Too many results (${e.items.length}) - skipping polygon loading`),this.polygonManager.clearAllPolygons()),console.log("Search completed:",e.items?e.items.length:0,"items"),e}handleStateChange(e){switch(this.showFilterLoader(),e.type){case"FACET_CHANGE":this.updateFilters(e.facetType,e.value,e.checked);break;case"RANGE_CHANGE":this.state.filters[e.facetKey]=e.value,this.performSearchWithLoader().finally(()=>{this.hideFilterLoader()}),this.fetchAggregations();return;case"QUERY_CHANGE":this.state.query=e.query;break;case"SORT_CHANGE":this.state.sort=e.sort;break}e.type!=="RANGE_CHANGE"&&this.performSearchWithLoader().finally(()=>{this.hideFilterLoader()})}updateFilters(e,t,n){var o;n?(this.state.filters[e]||(this.state.filters[e]=[]),this.state.filters[e].push(t)):this.state.filters[e]=((o=this.state.filters[e])==null?void 0:o.filter(s=>s!==t))||[]}focusOnMap(e,t,n=15){if(!this.map){console.error("Map not initialized");return}try{this.map.setView([parseFloat(e),parseFloat(t)],n),console.log(`Map focused on coordinates: ${e}, ${t} with zoom level: ${n}`)}catch(o){console.error("Error focusing map on coordinates:",o),console.log("Map object:",this.map),console.log("Available methods:",Object.getOwnPropertyNames(this.map).filter(s=>typeof this.map[s]=="function"))}}bindEvents(){this.setupSearchInput(),this.setupSortSelect(),this.setupMarkerEvents();let e;this.map.on("moveend",()=>{e&&clearTimeout(e),e=setTimeout(()=>{this.showFilterLoader();const t=this.searchHandler.performSearch(this.state,{onMarkersUpdate:n=>this.renderMarkers(n),onResultsUpdate:n=>this.resultsRenderer.updateResultsList(n,this.config,{filters:this.state.filters,query:this.state.query,sort:this.state.sort}),onAggregationsUpdate:n=>this.renderFacets(n)});this.updateNavBar(t.items?t.items.length:0,{skipAnimation:!0}),console.log("Map move search completed:",t.items?t.items.length:0,"items"),setTimeout(()=>{this.hideFilterLoader()},500)},200)})}setupMarkerEvents(){this.map.on("marker:click",e=>{const t=e.detail||e.data;t&&t.osm_id?(console.log("Marker clicked, loading polygon for OSM ID:",t.osm_id),this.showFilterLoader(),this.polygonManager.onMarkerClick(t),setTimeout(()=>{this.hideFilterLoader()},1e3)):console.log("Marker clicked but no OSM ID found - skipping polygon load")})}setupSearchInput(){const e=document.getElementById("search-input");if(!e){console.error("Search input element not found");return}const t=this.debounce(()=>{this.showFilterLoader(),this.state.query=e.value,this.performSearchWithLoader().finally(()=>{this.hideFilterLoader()})},this.config.searchConfig.debounceTime||300);e.addEventListener("input",t)}setupSortSelect(){const e=document.getElementById("sort-select");if(!e||!this.config.searchConfig.sortOptions){console.error("Sort select element not found or sort options not configured");return}e.innerHTML=this.config.searchConfig.sortOptions.map(t=>`<option value="${t.value}">${t.label}</option>`).join(""),e.addEventListener("change",t=>{this.showFilterLoader(),this.state.sort=t.target.value,this.performSearchWithLoader().finally(()=>{this.hideFilterLoader()})})}async fetchAggregations(){if(!this.searchEngine){console.error("Search engine not initialized");return}const e=this.searchEngine.search({query:this.state.query||"",filters:this.state.filters}),t={};for(const n in e.data.aggregations)e.data.aggregations.hasOwnProperty(n)&&(t[n]=e.data.aggregations[n].buckets);this.renderFacets(t)}debounce(e,t){let n;return function(){clearTimeout(n),n=setTimeout(()=>e.apply(this,arguments),t)}}clearPolygons(){this.polygonManager&&this.polygonManager.clearAllPolygons()}togglePolygons(e){this.polygonManager&&this.polygonManager.setPolygonVisibility(e)}loadPolygonForItem(e,t=!0,n=!0){return!e||!e.osm_id?(console.log("Item has no OSM ID - cannot load polygon:",e),!1):this.polygonManager?(this.showFilterLoader(),this.polygonManager.loadPolygon(e,t,n),setTimeout(()=>{this.hideFilterLoader()},1e3),!0):!1}loadPolygonsForSearchResults(){if(!this.searchEngine){console.error("Search engine not initialized");return}const e=this.searchEngine.search({query:this.state.query||"",filters:this.state.filters});if(e&&e.data&&e.data.items){const t=e.data.items.filter(n=>n&&n.osm_id&&(typeof n.osm_id=="string"||typeof n.osm_id=="number"));t.length>0?(console.log(`Loading polygons for ${t.length} items with OSM IDs`),this.polygonLoadTimeout&&clearTimeout(this.polygonLoadTimeout),this.polygonLoadTimeout=setTimeout(()=>{this.polygonManager.loadSearchResultPolygons(t),this.polygonLoadTimeout=null},100)):(console.log("No search results with OSM IDs found"),this.polygonManager.clearAllPolygons())}}getPolygonManager(){return this.polygonManager}}document.addEventListener("DOMContentLoaded",()=>{new us})});export default hs();
